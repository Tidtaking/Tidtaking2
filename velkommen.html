<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dagens deltakere – Lørenskog Skiklubb</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --brand:#18469a; --brand2:#dbe723; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- HEADER -->
  <header class="mb-6 flex flex-wrap items-center justify-between gap-4 bg-[var(--brand)] text-white p-3 rounded-2xl">
    <div class="flex items-center gap-3">
      <img src="Logo LSK Klubb farger JPG.jpeg" alt="Lørenskog Skiklubb" class="h-14 w-20 rounded-xl bg-white p-1 object-contain">
      <div>
        <h1 class="text-2xl font-bold">Lørenskog Skiklubb</h1>
        <p class="text-sm opacity-80">Dagens deltakere</p>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-3xl px-3 space-y-6">
    <!-- Filter -->
    <div class="rounded-2xl border bg-white shadow-sm p-4">
      <h2 class="text-lg font-semibold mb-3">Filtrer</h2>
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="block text-sm font-medium mb-1" for="competitionInput">Konkurransenavn:</label>
          <input id="competitionInput" type="text" placeholder="F.eks. Klubbløp-2025"
            class="w-full h-10 rounded-xl border px-3" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="dateInput">Dato:</label>
          <input id="dateInput" type="date"
            class="w-full h-10 rounded-xl border px-3" />
        </div>
      </div>
      <div class="mt-4">
        <button id="filterBtn" class="rounded-xl border bg-[var(--brand)] text-white px-4 py-2 shadow-sm">
          Vis deltakere
        </button>
      </div>
    </div>

    <!-- Tabell -->
    <div id="participantTable" class="rounded-2xl border bg-white shadow-sm p-4 text-center text-slate-600">
      <p>Laster deltakere…</p>
    </div>

    <!-- Navigasjon -->
    <div class="rounded-2xl border bg-white shadow-sm p-4">
      <h2 class="text-lg font-semibold mb-3">Navigasjon</h2>
      <div class="flex flex-wrap gap-2">
        <a href="https://tidtaking.github.io/Tidtaking2/" class="navlink">Oppsett</a>
        <a href="https://tidtaking.github.io/Tidtaking2/live.html" class="navlink">Livevisning</a>
        <a href="https://tidtaking.github.io/Tidtaking2/rundetider.html" class="navlink">Rundetider</a>
        <a href="https://tidtaking.github.io/Tidtaking2/skyting.html" class="navlink">Skyting</a>
        <a href="https://tidtaking.github.io/Tidtaking2/maal.html" class="navlink">Mål</a>
        <a href="https://tidtaking.github.io/Tidtaking2/strafferunder.html" class="navlink">Strafferunder</a>
        <a href="https://tidtaking.github.io/Tidtaking2/starter.html" class="navlink">Starter</a>
        <a href="https://tidtaking.github.io/Tidtaking2/import" class="navlink">Import</a>
        <a href="https://tidtaking.github.io/Tidtaking2/resultat" class="navlink">Resultater</a>
        <a href="https://tidtaking.github.io/Tidtaking2/sim" class="navlink">Simulator</a>
        <a href="https://tidtaking.github.io/Tidtaking2/historikk" class="navlink">Historikk</a>
        <a href="https://tidtaking.github.io/Tidtaking2/huskeliste" class="navlink">Huskeliste</a>
        <a href="https://tidtaking.github.io/Tidtaking2/selvanviser" class="navlink">Selvanviser</a>
      </div>
    </div>
  </main>

  <style>
    .navlink {
      @apply rounded-xl border bg-[var(--brand)] text-white px-3 py-2 shadow-sm hover:bg-blue-900;
    }
    table {
      @apply w-full border-collapse text-left;
    }
    th, td {
      @apply border px-3 py-2;
    }
    th {
      @apply bg-slate-100 font-medium;
    }
  </style>

  <!-- Supabase JS -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.3/+esm";

    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabase = createClient(supabaseUrl, supabaseKey);

    document.getElementById("dateInput").value = new Date().toISOString().split("T")[0];

    async function fetchParticipants() {
      const comp = document.getElementById("competitionInput").value.trim();
      const date = document.getElementById("dateInput").value;

      let query = supabase.from("participants").select("*").eq("comp_date", date);
      if (comp) query = query.eq("competition", comp);

      const { data, error } = await query;
      if (error) {
        console.error(error);
        document.getElementById("participantTable").innerHTML = "<p>Feil ved henting av deltakere.</p>";
        return;
      }

      if (!data || data.length === 0) {
        document.getElementById("participantTable").innerHTML = `<p>Ingen deltakere funnet for <b>${comp||'valgt konkurranse'}</b> ${date}.</p>`;
        return;
      }

      data.sort((a, b) => (parseInt(a.snr)||0) - (parseInt(b.snr)||0));

      const rows = data.map(p => `
        <tr>
          <td>${p.snr||''}</td>
          <td>${p.name||''}</td>
        </tr>
      `).join("");

      document.getElementById("participantTable").innerHTML = `
        <table class="mt-3">
          <thead><tr><th>Startnr</th><th>Navn</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // Init load
    document.addEventListener("DOMContentLoaded", fetchParticipants);
    document.getElementById("filterBtn").addEventListener("click", fetchParticipants);

    // Realtime oppdatering
    supabase.channel("participants-rt")
      .on("postgres_changes", { event: "*", schema: "public", table: "participants" }, (payload) => {
        console.log("Realtime endring i participants:", payload);
        fetchParticipants(); // Oppdater listen
      })
      .subscribe();
  </script>
</body>
</html>
