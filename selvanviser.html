<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utvidet analyse av skyting</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 20px;
    }
    #targetCanvas {
      background: #fff;
      border: 2px solid #333;
      display: block;
      margin: 0 auto;
      width: 90vw;
      height: 90vw;
      max-width: 600px;
      max-height: 600px;
    }
    #controls, #competitionInfo {
      margin: 15px;
    }
    button, input {
      font-size: 18px;
      padding: 10px 16px;
      margin: 5px;
      cursor: pointer;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
      font-size: 1em;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Utvidet analyse av skyting</h1>

  <div id="competitionInfo">
    <input type="date" id="shootingDate">
    <input type="text" id="shootingLocation" placeholder="Sted for vær/vinddata">
    <br>
    <button id="startTimerBtn">Start tidtaking</button>
    <button id="stopTimerBtn" disabled>Stopp tidtaking</button>
    <div id="timerDisplay">Tid: 00:00</div>
  </div>

  <canvas id="targetCanvas" width="600" height="600"></canvas>

  <div id="controls">
    <button id="undoShotBtn" disabled>Angre skudd</button>
    <button id="saveSeriesBtn" disabled>Lagre serie</button>
  </div>

  <div id="seriesTableContainer">
    <h2>Siste 3 serier (10 skudd hver)</h2>
    <table>
      <thead>
        <tr>
          <th>Dato</th>
          <th>Serie #</th>
          <th>Sted</th>
          <th>Totalpoeng</th>
          <th>Tid (mm:ss)</th>
        </tr>
      </thead>
      <tbody id="seriesTableBody"></tbody>
    </table>
    <div id="totalSeriesScore">Total for alle serier: 0</div>
  </div>

  <script>
    let timerInterval, secondsElapsed = 0;

    const startTimerBtn = document.getElementById('startTimerBtn');
    const stopTimerBtn = document.getElementById('stopTimerBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const shootingDate = document.getElementById('shootingDate');
    const shootingLocation = document.getElementById('shootingLocation');

    startTimerBtn.onclick = () => {
      clearInterval(timerInterval);
      secondsElapsed = 0;
      timerInterval = setInterval(() => {
        secondsElapsed++;
        let mins = String(Math.floor(secondsElapsed / 60)).padStart(2,'0');
        let secs = String(secondsElapsed % 60).padStart(2,'0');
        timerDisplay.textContent = `Tid: ${mins}:${secs}`;
      }, 1000);
      startTimerBtn.disabled = true;
      stopTimerBtn.disabled = false;
    };

    stopTimerBtn.onclick = () => {
      clearInterval(timerInterval);
      startTimerBtn.disabled = false;
      stopTimerBtn.disabled = true;
    };

    // Oppdater lagre funksjon for å inkludere dato, sted og tid
    function saveSeries() {
      if (currentShots.length !== 10) return;
      const seriesTotal = currentShots.reduce((sum, shot) => sum + shot.score, 0);
      const date = shootingDate.value || new Date().toISOString().split('T')[0];
      const location = shootingLocation.value || 'Ikke angitt';
      const time = timerDisplay.textContent.replace('Tid: ', '');
      seriesCount++;
      const seriesObj = { date, serie: seriesCount, location, total: seriesTotal, time };
      seriesHistory.push(seriesObj);
      if (seriesHistory.length > 3) seriesHistory.shift();
      updateSeriesTable();
      currentShots = [];
      updateCurrentDisplay();
      redrawShots();
      clearInterval(timerInterval);
      timerDisplay.textContent = "Tid: 00:00";
      secondsElapsed = 0;
      startTimerBtn.disabled = false;
      stopTimerBtn.disabled = true;
    }

    function updateSeriesTable() {
      seriesTableBody.innerHTML = "";
      const reversed = [...seriesHistory].reverse();
      reversed.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${item.date}</td><td>${item.serie}</td><td>${item.location}</td><td>${item.total}</td><td>${item.time}</td>`;
        seriesTableBody.appendChild(row);
      });
      const totalSeriesSum = seriesHistory.reduce((sum, s) => sum + s.total, 0);
      totalSeriesScoreEl.innerText = `Total for alle serier: ${totalSeriesSum}`;
    }

    // Her må eksisterende kode fra original side inkluderes (canvas-tegning, håndtering av skudd, osv.)
  </script>
</body>
</html>
