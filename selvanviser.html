<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utvidet analyse av skyting</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 10px; background: #f5f5f5; }
    h1 { margin-top: 20px; }
    #targetCanvas { background: #fff; border: 2px solid #333; display: block; margin: 0 auto; width: 90vw; height: 90vw; max-width: 600px; max-height: 600px; }
    #controls, #competitionInfo { margin: 15px; }
    button, input, select, textarea { font-size: 18px; padding: 10px 16px; margin: 5px; cursor: pointer; }
    table { margin: 0 auto; border-collapse: collapse; font-size: 1em; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; }
    #hourlyForecast { margin-top: 10px; font-size: 0.9em; }
    .logo { max-width: 120px; margin-bottom: 10px; }
    .wind-arrow {
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 10px solid red;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      margin-left: 6px;
      transform-origin: center;
    }
  </style>
</head>
<body>
  <img src="lsk_logo.jpg" alt="LSK Logo" class="logo">
  <h1>Utvidet analyse av skyting</h1>
  
  <canvas id="targetCanvas" width="600" height="600"></canvas>

  <div id="controls">
    <button id="undoShotBtn" disabled>Angre skudd</button>
    <button id="saveSeriesBtn" disabled>Lagre serie</button>
    <button id="startTimerBtn">Start tidtaking</button>
    <button id="stopTimerBtn" disabled>Stopp tidtaking</button>
    <div id="timerDisplay">Tid: 00:00</div>
  </div>

  <div id="historySection" style="margin-top: 40px;">
    <h3>Historiske resultater</h3>
    <input type="text" id="searchName" placeholder="Navn">
    <input type="date" id="searchDate">
    <input type="text" id="searchPlace" placeholder="Sted">
    <button id="searchBtn">Søk i historikk</button>
    <button id="clearBtn">Tøm søk</button>
    <div id="searchResults"></div>
  </div>

  <!-- Legg til Supabase script her -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Initialiser Supabase etter at skriptet er lastet inn
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let currentShots = [];
    let seriesCount = 0;
    let timerInterval = null;
    let secondsElapsed = 0;
    let lastWindDir = null;
    let adjustment = { up: 0, down: 0, left: 0, right: 0 };

    // Tegne skive på canvas
    const canvas = document.getElementById('targetCanvas');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const R = canvas.width / 2;
    const ringWidth = R / 10;

    function drawTarget() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let j = 10; j >= 1; j--) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, j * ringWidth, 0, 2 * Math.PI);
        ctx.fillStyle = (j % 2 === 0) ? '#eee' : '#fff';
        ctx.fill();
        ctx.lineWidth = (j === 3) ? 4 : 1;
        ctx.strokeStyle = '#333';
        ctx.stroke();

        ctx.fillStyle = '#000';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(11 - j, centerX, centerY - (j * ringWidth) + ringWidth / 2);
      }
    }

    // Beregn poeng basert på avstand fra sentrum
    function computeScore(x, y) {
      const dx = x - centerX;
      const dy = y - centerY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      if (distance > R) return 0;
      const ring = Math.floor(distance / ringWidth);
      return 10 - ring;
    }

    // Tegne skudd på skiven
    function drawShot(shot, index) {
      ctx.beginPath();
      ctx.arc(shot.x, shot.y, 5, 0, 2 * Math.PI);
      ctx.fillStyle = shot.score >= 7.8 ? 'green' : 'red';
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = 'black';
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(index + 1, shot.x, shot.y - 10);
    }

    // Tegne alle skudd på skiven
    function redrawShots() {
      drawTarget();
      currentShots.forEach((shot, i) => drawShot(shot, i));
    }

    drawTarget();  // Initialiser skiven

    // Legg til funksjonalitet for å registrere skudd på canvas
    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      const score = computeScore(x, y);
      currentShots.push({ score, x, y });
      redrawShots();
      document.getElementById('undoShotBtn').disabled = false;
      document.getElementById('saveSeriesBtn').disabled = false;
    });

    // Angre skudd funksjon
    document.getElementById('undoShotBtn').addEventListener('click', () => {
      currentShots.pop();
      redrawShots();
      document.getElementById('saveSeriesBtn').disabled = currentShots.length === 0;
    });

    // Manuell justering
    const manualDisplay = document.getElementById('manualAdjustmentDisplay');
    document.querySelectorAll('#adjustmentControls button').forEach(btn => {
      btn.addEventListener('click', () => {
        const dir = btn.id;
        if (dir === 'adjUp') { adjustment.up++; adjustment.down = 0; }
        else if (dir === 'adjDown') { adjustment.down++; adjustment.up = 0; }
        else if (dir === 'adjLeft') { adjustment.left++; adjustment.right = 0; }
        else if (dir === 'adjRight') { adjustment.right++; adjustment.left = 0; }
        manualDisplay.textContent = `Opp: ${adjustment.up} | Ned: ${adjustment.down} | Venstre: ${adjustment.left} | Høyre: ${adjustment.right}`;
      });
    });

    // Lagre serie til Supabase
    document.getElementById('saveSeriesBtn').addEventListener('click', async () => {
      const adjText = `Opp: ${adjustment.up} | Ned: ${adjustment.down} | Venstre: ${adjustment.left} | Høyre: ${adjustment.right}`;
      const total = currentShots.reduce((sum, s) => sum + s.score, 0);
      const treff = currentShots.filter(s => s.score >= 7.8).length;
      const table = document.getElementById('resultTable').querySelector('tbody');
      const date = document.getElementById('shootingDate')?.value || new Date().toISOString().split('T')[0];
      const place = document.getElementById('shootingLocation')?.value || 'Ukjent';
      const timeText = document.getElementById('timerDisplay')?.textContent.replace('Tid: ', '') || '00:00';
      seriesCount++;
      const row = document.createElement('tr');
      row.innerHTML = `<td>${date}</td><td>${seriesCount}</td><td>${place}</td><td>${currentShots.length}</td><td>${total} (${treff} treff)</td><td>${timeText}</td><td><span class='wind-arrow' style='transform: rotate(${lastWindDir ?? 0}deg);'></span> ${getCompassDirection(lastWindDir ?? 0)}</td><td><img src="" id="preview-${seriesCount}" width="100"></td><td>${adjText}</td>`;

      const previewCanvas = document.createElement('canvas');
      previewCanvas.width = 100;
      previewCanvas.height = 100;
      const pctx = previewCanvas.getContext('2d');
      const scale = previewCanvas.width / canvas.width;
      pctx.fillStyle = '#fff';
      pctx.fillRect(0, 0, 100, 100);
      for (let j = 10; j >= 1; j--) {
        pctx.beginPath();
        pctx.arc(50, 50, j * ringWidth * scale, 0, 2 * Math.PI);
        pctx.strokeStyle = j === 3 ? '#000' : '#ccc';
        pctx.lineWidth = j === 3 ? 2 : 0.5;
        pctx.stroke();
      }
      currentShots.forEach(s => {
        pctx.beginPath();
        pctx.arc(s.x * scale, s.y * scale, 2, 0, 2 * Math.PI);
        pctx.fillStyle = s.score >= 7.8 ? 'green' : 'red';
        pctx.fill();
      });
      const previewImg = row.querySelector(`#preview-${seriesCount}`);
      previewImg.src = previewCanvas.toDataURL();

      table.appendChild(row);
      currentShots = [];
      adjustment = { up: 0, down: 0, left: 0, right: 0 };
      manualDisplay.textContent = `Opp: 0 | Ned: 0 | Venstre: 0 | Høyre: 0`;
      redrawShots();
      document.getElementById('saveSeriesBtn').disabled = true;

      // Send til Supabase
      const insertResult = await supabase.from('selvanviser').insert([
        {
          dato: date,
          serie: seriesCount,
          sted: place,
          skudd: currentShots.length,
          poeng: total,
          treff: treff,
          tid: timeText,
          vindretning: getCompassDirection(lastWindDir ?? 0),
          vindgrader: lastWindDir ?? 0,
          skrumelding: adjText,
          skudddata: currentShots,
          miniatur_dataurl: previewImg.src
        }
      ]);
      console.log('Supabase insert:', insertResult);
      document.getElementById('undoShotBtn').disabled = true;
    });

    // Start og stopp timer
    document.getElementById('startTimerBtn').addEventListener('click', () => {
      secondsElapsed = 0;
      document.getElementById('startTimerBtn').disabled = true;
      document.getElementById('stopTimerBtn').disabled = false;
      timerInterval = setInterval(() => {
        secondsElapsed++;
        const min = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
        const sec = String(secondsElapsed % 60).padStart(2, '0');
        document.getElementById('timerDisplay').textContent = `Tid: ${min}:${sec}`;
      }, 1000);
    });

    document.getElementById('stopTimerBtn').addEventListener('click', () => {
      clearInterval(timerInterval);
      document.getElementById('startTimerBtn').disabled = false;
      document.getElementById('stopTimerBtn').disabled = true;
    });

    // Historikk søkefunksjon
    document.getElementById('searchBtn').addEventListener('click', async () => {
      const name = document.getElementById('searchName').value.trim();
      const date = document.getElementById('searchDate').value;
      const place = document.getElementById('searchPlace').value.trim();

      let query = supabase.from('selvanviser').select('*').order('dato', { ascending: false });

      if (name) query = query.ilike('navn', `%${name}%`);
      if (date) query = query.eq('dato', date);
      if (place) query = query.ilike('sted', `%${place}%`);

      try {
        const { data, error } = await query;
        const container = document.getElementById('searchResults');
        if (error) {
          container.innerHTML = 'Feil ved henting av data.';
          return;
        }
        if (!data.length) {
          container.innerHTML = 'Ingen resultater funnet.';
          return;
        }
        const rows = data.map(r => `<tr><td>${r.navn}</td><td>${r.dato}</td><td>${r.serie}</td><td>${r.sted}</td><td>${r.skudd}</td><td>${r.poeng}</td><td>${r.tid}</td><td>${r.vindretning}</td><td>${r.skrumelding}</td><td><img src='${r.miniatur_dataurl}' width='80'></td></tr>`).join('');
        container.innerHTML = `<table><thead><tr><th>Navn</th><th>Dato</th><th>Serie</th><th>Sted</th><th>Skudd</th><th>Poeng</th><th>Tid</th><th>Vind</th><th>Skrudd</th><th>Miniatyr</th></tr></thead><tbody>${rows}</tbody></table>`;
      } catch (err) {
        console.error('Uventet feil:', err);
        document.getElementById('searchResults').innerHTML = 'Uventet feil ved søk.';
      }
    });
  </script>
</body>
</html>
