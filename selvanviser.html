<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utvidet analyse av skyting</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 10px; background: #f5f5f5; }
    h1 { margin-top: 20px; }
    #targetCanvas { background: #fff; border: 2px solid #333; display: block; margin: 0 auto; width: 90vw; height: 90vw; max-width: 600px; max-height: 600px; }
    #controls, #competitionInfo { margin: 15px; }
    button, input, select, textarea { font-size: 18px; padding: 10px 16px; margin: 5px; cursor: pointer; }
    table { margin: 0 auto; border-collapse: collapse; font-size: 1em; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; }
    #hourlyForecast { margin-top: 10px; font-size: 0.9em; }
    .logo { max-width: 120px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <img src="lsk_logo.jpg" alt="LSK Logo" class="logo">
  <h1>Utvidet analyse av skyting</h1>

  <!-- resten av siden beholdes likt -->

  <script>
    // ...eksisterende funksjoner beholdes...

    // Legg til én PDF-knapp kun én gang
    const pdfKnapp = document.createElement('button');
    pdfKnapp.textContent = 'Last ned som PDF';
    pdfKnapp.onclick = () => {
      const printWindow = window.open('', '_blank');
      const weather = document.getElementById('weatherData').textContent;
      const forecast = document.getElementById('hourlyForecast').innerHTML;
      const table = document.getElementById('seriesTableContainer').innerHTML;
      const logo = '<img src="lsk_logo.jpg" alt="LSK Logo" style="max-width:120px;">';
      const style = `
        <style>
          body{font-family:Arial;padding:20px}
          h1{text-align:center}
          table{border-collapse:collapse;width:100%}
          td,th{border:1px solid #ccc;padding:8px;text-align:center}
          img{max-width:100px}
        </style>`;
      const html = `
        <html><head><title>Skyteresultat</title>${style}</head><body>
        ${logo}
        <h1>Skyting – Rapport</h1>
        <h3>Værdata:</h3>
        <p>${weather}</p>
        <div>${forecast}</div>
        <h3>Resultater:</h3>
        ${table}
        </body></html>`;
      printWindow.document.write(html);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };
    window.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('seriesTableContainer');
      if (container) {
        container.appendChild(pdfKnapp);
      }
    });

    // Automatisk hent værdata når sted og dato er valgt
    const shootingDate = document.getElementById('shootingDate');
    const shootingLocation = document.getElementById('shootingLocation');

    function attemptFetchWeather() {
      const location = shootingLocation.value;
      const dateInput = shootingDate.value;
      if (location && dateInput) {
        document.getElementById('fetchWeatherBtn').click();
      }
    }

    shootingDate.addEventListener('change', attemptFetchWeather);
    shootingLocation.addEventListener('change', attemptFetchWeather);

    // Endre værdata for alltid kl 05-15 for valgt dato
    document.getElementById('fetchWeatherBtn').onclick = async () => {
      const location = shootingLocation.value;
      const dateInput = shootingDate.value;
      const output = document.getElementById('weatherData');
      const forecast = document.getElementById('hourlyForecast');

      if (!dateInput) {
        output.textContent = 'Du må velge dato først.';
        return;
      }
      if (!location) {
        output.textContent = 'Du må skrive inn sted først.';
        return;
      }

      output.textContent = 'Henter værdata...';
      try {
        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`);
        const geoData = await geoRes.json();
        if (!geoData.length) throw new Error('Sted ikke funnet');
        const { lat, lon } = geoData[0];

        const weatherRes = await fetch(`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`, {
          headers: { 'User-Agent': 'skyteanalyse/1.0 kontakt@example.com' }
        });
        const data = await weatherRes.json();

        const forecasts = data.properties.timeseries.filter(f => {
          const dt = new Date(f.time);
          const h = dt.getHours();
          return f.time.startsWith(dateInput) && h >= 5 && h <= 15;
        });

        if (!forecasts.length) {
          output.textContent = 'Ingen værdata for valgt dato.';
          forecast.innerHTML = '';
          return;
        }

        const now = forecasts[0].data.instant.details;
        output.textContent = `Temp: ${now.air_temperature}°C, Vind: ${now.wind_speed} m/s`;

        const hourly = forecasts.map(item => {
          const time = new Date(item.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const d = item.data.instant.details;
          return `${time}: ${d.air_temperature}°C, ${d.wind_speed} m/s`;
        }).join('<br>');

        forecast.innerHTML = `<strong>Vær time for time (${dateInput} 05–15):</strong><br>${hourly}`;
      } catch (e) {
        output.textContent = 'Klarte ikke hente værdata.';
        forecast.innerHTML = '';
      }
    };
  </script>
</body>
</html>
