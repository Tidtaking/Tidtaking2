<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Utvidet analyse av skyting ‚Äì v2.0</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --bg:#f5f5f5; --card:#fff; --ink:#111; --muted:#666; --border:#d0d0d0; --accent:#007aff; --danger:#ff3b30; --success:#34c759; }
    @media (prefers-color-scheme: dark) { :root { --bg:#0f1115; --card:#1c1e26; --ink:#e9eef5; --muted:#a3afc2; --border:#2a2f3a; --accent:#0a84ff; } }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, sans-serif; height: 100%; }
    
    .wrap { max-width: 1100px; margin: 0 auto; padding: 12px; padding-bottom: 40px; }
    h1 { margin: 8px 0 12px; font-size: clamp(1.4rem, 4vw, 2rem); text-align: center; }
    h2 { font-size: 1.2rem; margin: 0 0 10px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
    
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgb(0 0 0 / 5%); }

    /* Input & Grid */
    #competitionInfo { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 8px; }
    input, button { font-size: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--ink); width: 100%; }
    input:focus { outline: 2px solid var(--accent); border-color: transparent; }
    
    /* Buttons */
    button { cursor: pointer; font-weight: 600; transition: filter 0.2s, transform 0.1s; touch-action: manipulation; }
    button:active { transform: scale(0.98); }
    button.primary { background: var(--ink); color: var(--card); border-color: var(--ink); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* Canvas Area */
    .canvas-container { display: flex; flex-direction: column; align-items: center; }
    #targetCanvas { 
      display: block; 
      background: var(--card); 
      border: 2px solid #333; 
      border-radius: 50%; /* Rund skive */
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: crosshair; 
      touch-action: none; /* VIKTIG: Hindrer scrolling n√•r man drar skudd */
      max-width: 100%;
      height: auto;
    }

    /* Live Overlay (boble over fingeren) */
    #liveOverlay { 
      position: absolute; left: 0; top: 0; 
      transform: translate(-50%, -180%); /* Flyttet h√∏yere opp */
      padding: 6px 10px; border-radius: 20px; 
      background: var(--accent); color: #fff; 
      font-weight: bold; font-size: 14px; 
      pointer-events: none; opacity: 0; transition: opacity 0.1s; 
      white-space: nowrap; z-index: 100; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .canvas-wrap { position: relative; width: fit-content; margin: 0 auto; }

    /* Controls Grid */
    #controls, #adjustmentControls { display: grid; gap: 10px; grid-template-columns: repeat(2, 1fr); margin-top: 10px; }
    #adjustmentControls button { height: 44px; } /* St√∏rre trykkflate */
    
    /* Timer */
    #timerControls { display: flex; align-items: center; gap: 12px; background: var(--bg); padding: 8px; border-radius: 12px; margin-top: 12px; border: 1px solid var(--border); }
    #timerDisplay { font-variant-numeric: tabular-nums; font-size: 1.2rem; font-weight: bold; margin-left: auto; }

    /* Table */
    .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-weight: 600; position: sticky; top: 0; }
    tr:last-child td { border-bottom: none; }

    .wind-arrow { display: inline-block; width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 12px solid var(--danger); }
    .muted { color: var(--muted); font-size: 0.85rem; }
    
    /* Mobil-tilpasninger */
    @media (max-width: 600px) {
      .wrap { padding: 8px; }
      .card { border-radius: 12px; padding: 12px; }
      h1 { font-size: 1.5rem; }
      #targetCanvas { width: 90vw; height: 90vw; }
      #controls { grid-template-columns: 1fr; } /* Stable knapper p√• liten skjerm */
    }

    /* Testing */
    #testPanel details { margin-top: 8px; cursor: pointer; }
    #testResults li { padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; font-size: 0.85rem; }
    .pass { background: rgba(52, 199, 89, 0.2); color: var(--ink); }
    .fail { background: rgba(255, 59, 48, 0.2); color: var(--ink); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<div class="wrap">
  <h1>üéØ Utvidet Analyse</h1>

  <section class="card">
    <div id="competitionInfo">
      <input id="nameInput" placeholder="Navn p√• ut√∏ver" aria-label="Navn" />
      <input id="shootingDate" type="date" aria-label="Dato" />
      <input id="shootingLocation" placeholder="Sted/Bane" aria-label="Sted" />
      <button id="fetchWeatherBtn" class="primary">‚òÅÔ∏è Hent v√¶r</button>
    </div>
    <div class="muted">
      <div id="weatherData" style="margin-top: 8px;">V√¶rdata ikke hentet.</div>
      <div id="hourlyForecast" style="margin-top: 6px; line-height: 1.4;"></div>
    </div>
    <div style="text-align: right; margin-top: 4px;">
      <small id="dbStatus" class="muted">DB: Sjekker...</small>
    </div>
  </section>

  <section class="card">
    <h2>Skive & Anvisning</h2>
    
    <div class="canvas-container">
      <div class="canvas-wrap">
        <canvas id="targetCanvas" width="600" height="600" aria-label="Skyteskive. Dra for √• plassere skudd."></canvas>
        <div id="liveOverlay">10.0</div>
      </div>
      <div id="liveReadout" class="muted" style="margin-top: 6px;">Klar til anvisning</div>
    </div>

    <div id="timerControls">
      <button id="startStopTimerBtn">‚è±Ô∏è Start</button>
      <div id="timerDisplay">00:00</div>
    </div>

    <div style="margin-top: 16px;">
      <h3 style="font-size: 1rem; margin-bottom: 8px; text-align: center;">Skrumelding</h3>
      <div id="manualAdjustmentDisplay" style="text-align: center; font-family: monospace; margin-bottom: 8px;">Opp: 0 | Ned: 0 | V: 0 | H: 0</div>
      <div id="adjustmentControls">
        <button id="adjUp">Opp</button>
        <button id="adjDown">Ned</button>
        <button id="adjLeft">Venstre</button>
        <button id="adjRight">H√∏yre</button>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Serie & Historikk</h2>
    <div id="controls">
      <button id="undoShotBtn" disabled>‚Ü©Ô∏è Angre siste</button>
      <button id="saveSeriesBtn" class="primary" disabled>üíæ Lagre serie</button>
      <button id="exportCsvBtn" type="button">üì• Eksporter CSV</button>
    </div>

    <div class="table-scroll">
      <table id="resultTable">
        <thead>
          <tr>
            <th>#</th><th>Tid</th><th>Skudd</th><th>Sum</th><th>Retning</th><th>Skrudd</th><th>Gruppe</th><th>Bilde</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div style="margin-top: 12px; text-align: center;">
        <a href="https://tidtaking.github.io/Tidtaking2/Selvanviser_historikk" style="color: var(--accent); text-decoration: none;">G√• til full historikk ‚Üí</a>
    </div>
  </section>

  <section id="testPanel" class="card" style="border: 1px dashed var(--muted);">
    <details>
      <summary style="font-size: 0.9rem; color: var(--muted);">Systemstatus & Tester</summary>
      <button id="runTestsBtn" style="margin-top: 8px; font-size: 0.8rem;">Kj√∏r tester</button>
      <ul id="testResults" style="list-style: none; padding: 0; margin-top: 8px;"></ul>
    </details>
  </section>
</div>

<script>
/**
 * 1. KONFIGURASJON & GLOBALE VARIABLER
 */
const SB_URL = 'https://chzfewhbfkdtcizdxyzk.supabase.co';
const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA';

// VIKTIG: Endret variabelnavn til 'sb' for √• unng√• konflikt
const sb = (window.supabase && window.supabase.createClient) ? window.supabase.createClient(SB_URL, SB_ANON) : null;

const DRAG_RADIUS = 20; // St√∏rre treffsone for finger (pixel units p√• canvas)
const DRAFT_KEY = 'selvanviser_draft_v2';

const state = {
  currentShots: [], // {x, y, score, ts}
  seriesCount: 0,
  timerRunning: false,
  startMs: null,
  elapsedMs: 0,
  lastWindDir: null,
  adjustment: { up: 0, down: 0, left: 0, right: 0 },
  dragging: { index: -1, offsetX: 0, offsetY: 0 }
};

const els = {
  canvas: document.getElementById('targetCanvas'),
  timerBtn: document.getElementById('startStopTimerBtn'),
  timerDisplay: document.getElementById('timerDisplay'),
  saveBtn: document.getElementById('saveSeriesBtn'),
  undoBtn: document.getElementById('undoShotBtn'),
  exportBtn: document.getElementById('exportCsvBtn'),
  weatherBox: document.getElementById('weatherData'),
  forecastBox: document.getElementById('hourlyForecast'),
  date: document.getElementById('shootingDate'),
  loc: document.getElementById('shootingLocation'),
  name: document.getElementById('nameInput'),
  adjDisp: document.getElementById('manualAdjustmentDisplay'),
  dbStatus: document.getElementById('dbStatus'),
  testList: document.getElementById('testResults'),
  runTestsBtn: document.getElementById('runTestsBtn'),
  liveOverlay: document.getElementById('liveOverlay'),
  liveReadout: document.getElementById('liveReadout'),
  tableBody: document.querySelector('#resultTable tbody')
};

// Sett dagens dato
els.date.value = new Date().toISOString().split('T')[0];
const ctx = els.canvas.getContext('2d');

/**
 * 2. CANVAS & TEGNING
 */
function resizeCanvas() {
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = els.canvas.getBoundingClientRect();
  els.canvas.width = Math.round(rect.width * dpr);
  els.canvas.height = Math.round(rect.width * dpr); // Kvadratisk
  
  // Normaliser koordinatsystemet slik at vi tegner i "CSS piksler"
  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
  draw();
}
window.addEventListener('resize', resizeCanvas);

function getGeom() {
  const w = els.canvas.getBoundingClientRect().width;
  const center = w / 2;
  const ringWidth = center / 10;
  return { w, center, R: center, ringWidth };
}

function computeScore(x, y) {
  const { center, R, ringWidth } = getGeom();
  const dx = x - center;
  const dy = y - center;
  const dist = Math.sqrt(dx*dx + dy*dy);
  
  if (dist > R) return 0;
  // DFS (Desimal) beregning kunne v√¶rt her, men vi bruker heltall 0-10
  let score = 10 - Math.floor(dist / ringWidth);
  return Math.max(0, Math.min(10, score));
}

function computeDecimal(x, y) {
    // Enkel desimaltiln√¶rming for visning
    const { center, ringWidth } = getGeom();
    const dist = Math.hypot(x - center, y - center);
    const val = 10.9 - (dist / ringWidth);
    return Math.max(0, val).toFixed(1);
}

function drawTarget() {
  const { w, center, ringWidth } = getGeom();
  ctx.clearRect(0, 0, w, w);
  
  // Tegn ringer
  for (let val = 1; val <= 10; val++) {
    const r = (11 - val) * ringWidth; // 10er innerst
    ctx.beginPath();
    ctx.arc(center, center, r, 0, Math.PI*2);
    
    // Farger: 1-6 hvit, 7-10 svart (standard DFS 200m/300m logikk, forenklet)
    // Her bruker vi en lys/gr√• stil for appen
    ctx.fillStyle = (val % 2 !== 0) ? '#fff' : '#eef'; 
    ctx.fill();
    ctx.strokeStyle = '#ccc';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    // Tykk strek mellom svart og hvitt (mellom 6 og 7 i DFS grovfelt, her bare visuelt)
    if (val === 4) { ctx.lineWidth = 2; ctx.strokeStyle = '#000'; ctx.stroke(); }
  }
  
  // Senterkryss
  ctx.beginPath(); ctx.moveTo(center-4, center); ctx.lineTo(center+4, center); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(center, center-4); ctx.lineTo(center, center+4); ctx.stroke();
}

function drawShots() {
  state.currentShots.forEach((s, i) => {
    ctx.beginPath();
    ctx.arc(s.x, s.y, 6, 0, Math.PI*2);
    ctx.fillStyle = s.score >= 9 ? '#28a745' : (s.score >= 7 ? '#ffc107' : '#dc3545'); // Gr√∏nn/Gul/R√∏d
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Skuddnummer
    ctx.fillStyle = '#000';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'center'; 
    ctx.textBaseline = 'middle';
    // Tegn nummer ved siden av, ikke opp√•
    ctx.fillText(i+1, s.x, s.y - 12);
  });
}

function drawStats() {
  if (state.currentShots.length < 2) return;
  const n = state.currentShots.length;
  const cx = state.currentShots.reduce((a,s)=>a+s.x,0)/n;
  const cy = state.currentShots.reduce((a,s)=>a+s.y,0)/n;
  
  // Middeltreffpunkt (bl√•tt kryss)
  ctx.strokeStyle = 'blue'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx-5, cy); ctx.lineTo(cx+5, cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, cy-5); ctx.lineTo(cx, cy+5); ctx.stroke();
}

function draw() {
  drawTarget();
  drawShots();
  drawStats();
}

/**
 * 3. INPUT & INTERAKSJON (Pointer Events)
 */
function getCanvasPoint(e) {
  const r = els.canvas.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  // Bruk f√∏rste touch point eller mus
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  
  // Map til CSS-piksler internt i logikken v√•r
  const x = (clientX - r.left); 
  const y = (clientY - r.top);
  return { x, y, clientX, clientY };
}

function hitTest(x, y) {
  // S√∏k baklengs for √• ta det √∏verste skuddet f√∏rst
  for (let i = state.currentShots.length - 1; i >= 0; i--) {
    const s = state.currentShots[i];
    if (Math.hypot(s.x - x, s.y - y) <= DRAG_RADIUS) return i;
  }
  return -1;
}

function updateLiveUI(x, y, score) {
  const dec = computeDecimal(x, y);
  els.liveOverlay.textContent = dec;
  els.liveReadout.textContent = `Siktepunkt: ${score} (${dec})`;
}

function moveOverlay(clientX, clientY) {
  const r = els.canvas.getBoundingClientRect();
  els.liveOverlay.style.left = (clientX - r.left) + 'px';
  els.liveOverlay.style.top = (clientY - r.top) + 'px';
  els.liveOverlay.style.opacity = '1';
}

// Handlers
let isDragging = false;

els.canvas.addEventListener('pointerdown', (e) => {
  e.preventDefault(); // Hindre scroll
  els.canvas.setPointerCapture(e.pointerId);
  
  const {x, y, clientX, clientY} = getCanvasPoint(e);
  const idx = hitTest(x, y);
  
  if (idx >= 0) {
    state.dragging.index = idx;
    state.dragging.offsetX = x - state.currentShots[idx].x;
    state.dragging.offsetY = y - state.currentShots[idx].y;
    isDragging = true;
  } else {
    state.dragging.index = -1;
    isDragging = false;
  }
  
  moveOverlay(clientX, clientY);
  updateLiveUI(x, y, computeScore(x,y));
});

els.canvas.addEventListener('pointermove', (e) => {
  e.preventDefault();
  const {x, y, clientX, clientY} = getCanvasPoint(e);
  moveOverlay(clientX, clientY);
  
  // Begrens til innenfor canvas
  const { w } = getGeom();
  const safeX = Math.max(0, Math.min(w, x));
  const safeY = Math.max(0, Math.min(w, y));
  
  const score = computeScore(safeX, safeY);
  updateLiveUI(safeX, safeY, score);

  if (state.dragging.index >= 0) {
    // Flytt eksisterende skudd
    const s = state.currentShots[state.dragging.index];
    s.x = safeX - state.dragging.offsetX; // Forenklet, fjerner offset for "snappier" f√∏lelse
    s.x = safeX; 
    s.y = safeY;
    s.score = score;
    draw();
  }
});

els.canvas.addEventListener('pointerup', (e) => {
  els.canvas.releasePointerCapture(e.pointerId);
  const {x, y} = getCanvasPoint(e);
  els.liveOverlay.style.opacity = '0';
  
  if (state.dragging.index >= 0) {
    // Ferdig med √• dra
    state.dragging.index = -1;
  } else if (!isDragging) {
    // Nytt skudd (hvis vi ikke dro)
    const score = computeScore(x, y);
    state.currentShots.push({ x, y, score, ts: Date.now() });
  }
  
  isDragging = false;
  updateButtons();
  draw();
  saveDraft();
});

function updateButtons() {
  const hasShots = state.currentShots.length > 0;
  els.undoBtn.disabled = !hasShots;
  els.saveBtn.disabled = !hasShots;
}

els.undoBtn.addEventListener('click', () => {
  state.currentShots.pop();
  updateButtons();
  draw();
  saveDraft();
});

/**
 * 4. TIDTAKER & LOGIKK
 */
function fmtTime(ms) {
  const s = Math.floor(ms/1000);
  const m = Math.floor(s/60);
  const rs = s % 60;
  return `${String(m).padStart(2,'0')}:${String(rs).padStart(2,'0')}`;
}

let timerReq;
function tick() {
  if (!state.timerRunning) return;
  const now = Date.now();
  const currentTotal = state.elapsedMs + (now - state.startMs);
  els.timerDisplay.textContent = fmtTime(currentTotal);
  timerReq = requestAnimationFrame(tick);
}

els.timerBtn.addEventListener('click', () => {
  if (!state.timerRunning) {
    state.timerRunning = true;
    state.startMs = Date.now();
    els.timerBtn.textContent = '‚èπÔ∏è Stopp';
    els.timerBtn.classList.add('active'); // CSS hook
    tick();
  } else {
    state.timerRunning = false;
    state.elapsedMs += Date.now() - state.startMs;
    els.timerBtn.textContent = '‚è±Ô∏è Fortsett';
    els.timerBtn.classList.remove('active');
    cancelAnimationFrame(timerReq);
    saveDraft();
  }
});

/**
 * 5. SKRUMELDING
 */
function updateAdjDisplay() {
  const a = state.adjustment;
  els.adjDisp.textContent = `Opp: ${a.up} | Ned: ${a.down} | V: ${a.left} | H: ${a.right}`;
  saveDraft();
}
// Helpers for buttons
const adjClick = (keyAdd, keySub) => {
  if (state.adjustment[keySub] > 0) state.adjustment[keySub]--;
  else state.adjustment[keyAdd]++;
  updateAdjDisplay();
};
document.getElementById('adjUp').onclick = () => adjClick('up', 'down');
document.getElementById('adjDown').onclick = () => adjClick('down', 'up');
document.getElementById('adjLeft').onclick = () => adjClick('left', 'right');
document.getElementById('adjRight').onclick = () => adjClick('right', 'left');

/**
 * 6. V√ÜRDATA (API)
 */
function getDirText(deg) {
  const dirs=['Nord','N√ò','√òst','S√ò','S√∏r','SV','Vest','NV'];
  return dirs[Math.round(deg/45)%8];
}

els.fetchWeatherBtn.addEventListener('click', async () => {
  const loc = els.loc.value.trim();
  const dateStr = els.date.value;
  if (!loc) return alert('Du m√• skrive inn et sted.');

  els.weatherBox.textContent = 'Laster v√¶r...';
  try {
    // 1. Geocoding
    const gRes = await fetch(`https://geocode.maps.co/search?format=json&q=${encodeURIComponent(loc)}`);
    const gData = await gRes.json();
    if (!gData.length) throw new Error('Fant ikke sted');
    const {lat, lon} = gData[0];

    // 2. Met.no
    const mRes = await fetch(`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`, 
      { headers: { 'User-Agent': 'SelvanviserApp/2.0 kontakt@ukjent.no' } }
    );
    if (!mRes.ok) throw new Error('Met.no feil');
    const mData = await mRes.json();
    
    // 3. Finn riktig tid
    const series = mData.properties.timeseries.filter(t => t.time.startsWith(dateStr));
    if (!series.length) {
      els.weatherBox.textContent = 'Ingen data for denne datoen.';
      return;
    }
    
    const nowData = series[0].data.instant.details;
    state.lastWindDir = nowData.wind_from_direction;
    
    els.weatherBox.innerHTML = `
      <strong>${nowData.air_temperature}¬∞C</strong>, Vind: ${nowData.wind_speed} m/s 
      <span class="wind-arrow" style="transform: rotate(${state.lastWindDir}deg)"></span> 
      (${getDirText(state.lastWindDir)})
    `;
    
    // Vis neste par timer
    const forecastHtml = series.slice(0, 3).map(s => {
      const time = s.time.split('T')[1].substring(0,5);
      const d = s.data.instant.details;
      return `${time}: ${d.air_temperature}¬∞C, ${d.wind_speed}m/s`;
    }).join(' | ');
    els.forecastBox.textContent = forecastHtml;
    
    saveDraft();
  } catch (err) {
    els.weatherBox.textContent = 'Feil: ' + err.message;
  }
});

/**
 * 7. LAGRING & DATABASE
 */
function getMiniatureUrl() {
  const mCan = document.createElement('canvas');
  mCan.width = 100; mCan.height = 100;
  const mc = mCan.getContext('2d');
  
  // Hvit bakgrunn
  mc.fillStyle = '#fff'; mc.fillRect(0,0,100,100);
  
  // Mini skive
  for (let j=1; j<=10; j+=3) {
      mc.beginPath(); mc.arc(50,50, (11-j)*5, 0, Math.PI*2); mc.stroke();
  }
  
  // Skudd
  const { w } = getGeom();
  const scale = 100 / w;
  state.currentShots.forEach(s => {
    mc.beginPath(); mc.arc(s.x*scale, s.y*scale, 2, 0, Math.PI*2);
    mc.fillStyle = s.score >= 8 ? 'green' : 'red'; mc.fill();
  });
  
  return mCan.toDataURL('image/png');
}

function calculateGroup() {
  if (state.currentShots.length < 2) return null;
  const cx = state.currentShots.reduce((a,s)=>a+s.x,0) / state.currentShots.length;
  const cy = state.currentShots.reduce((a,s)=>a+s.y,0) / state.currentShots.length;
  // Extreme Spread (Diameter)
  const dists = state.currentShots.map(s => Math.hypot(s.x-cx, s.y-cy));
  const maxR = Math.max(...dists);
  return (maxR * 2).toFixed(1); // px
}

els.saveBtn.addEventListener('click', async () => {
  els.saveBtn.disabled = true;
  els.saveBtn.textContent = 'Lagrer...';

  const navn = els.name.value || 'Ukjent';
  const serieNr = ++state.seriesCount;
  const sum = state.currentShots.reduce((a,b)=>a+b.score, 0);
  const tidStr = fmtTime(state.timerRunning ? state.elapsedMs + (Date.now()-state.startMs) : state.elapsedMs);
  const grp = calculateGroup();
  const imgData = getMiniatureUrl();
  const windTxt = state.lastWindDir ? getDirText(state.lastWindDir) : '-';
  const skruTxt = `O:${state.adjustment.up} N:${state.adjustment.down} V:${state.adjustment.left} H:${state.adjustment.right}`;

  // 1. Legg til i tabell
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${serieNr}</td>
    <td>${tidStr}</td>
    <td>${state.currentShots.length}</td>
    <td><strong>${sum}</strong></td>
    <td>${windTxt}</td>
    <td><small>${skruTxt}</small></td>
    <td>${grp ? grp + 'px' : '-'}</td>
    <td><img src="${imgData}" style="width:40px;height:40px;border-radius:50%;border:1px solid #ccc"></td>
  `;
  els.tableBody.insertBefore(row, els.tableBody.firstChild);

  // 2. Send til Supabase
  if (sb) {
    const payload = {
      navn: navn,
      dato: els.date.value,
      sted: els.loc.value,
      serie: serieNr
