<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lørenskog Skiskyting – Årsplan & Øktbank</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --brand:#18469a; --brand2:#dbe723; }
    html,body{height:100%}
    @media print{ .no-print{display:none!important} }
    #lss-tooltip{ position:fixed; z-index:1000; pointer-events:none; transform:translate(-50%,-100%); max-width: min(88vw, 22rem); }
    @media (max-width: 767px){
      header h1{ font-size:1.125rem }
      header .no-print button,
      header .no-print label{ padding: .4rem .6rem; border-radius: .75rem; }
      #dialog .dialog-card{ width:100%; max-width:none; height:92vh; border-radius:0; display:flex; flex-direction:column; }
      #dialog .dialog-body{ overflow:auto; -webkit-overflow-scrolling: touch; flex:1 1 auto; }
    }

    .card{ border:1px solid rgb(226 232 240); box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .daycell{ transition: background-color .15s ease; }
    @media print{
      aside, nav, .no-print { display:none!important; }
      body { background:white; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/nb.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

  <header class="mb-4 flex flex-wrap items-center justify-between gap-4 bg-[var(--brand)] text-white p-3 rounded-2xl">
    <div class="flex items-center gap-3">
      <img id="club-logo" src="Logo LSK Klubb farger JPG.jpeg" class="h-14 w-20 rounded-xl bg-white p-1 object-contain" alt="Lørenskog Skiskyting" onerror="this.replaceWith(fallbackLogo())">
      <div>
        <h1 class="text-2xl font-bold">Lørenskog Skiskyting</h1>
        <p class="text-sm opacity-80">Årsplan • Øktbank</p>
      </div>
    </div>
    <div class="mb-4 flex flex-wrap items-center justify-between gap-2 no-print md:sticky md:top-2 md:z-40">
      <button id="btn-new" class="inline-flex items-center gap-2 rounded-2xl border bg-white px-3 py-2 text-[var(--brand)] shadow-sm">Ny hendelse</button>
      <button id="btn-print" class="inline-flex items-center gap-2 rounded-2xl border bg-white px-3 py-2 text-[var(--brand)] shadow-sm">Skriv ut</button>
      <button id="btn-export-xlsx" class="inline-flex items-center gap-2 rounded-2xl border bg-white px-3 py-2 text-[var(--brand)] shadow-sm">Eksporter Excel</button>
      <label class="inline-flex items-center gap-2 rounded-2xl border bg-white px-3 py-2 text-[var(--brand)] shadow-sm cursor-pointer">
        <input id="file-import" type="file" accept="application/json" class="hidden" />Importer
      </label>
    </div>
  </header>

  <div class="mx-auto max-w-[96rem] px-3">

    <div class="mb-4 flex flex-wrap items-center justify-between gap-3 no-print">
      <div class="flex items-center gap-2">
        <button id="year-prev" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">◀</button>
        <div id="year-label" class="rounded-xl border bg-white px-4 py-1.5 text-lg font-semibold shadow-sm"></div>
        <button id="year-next" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">▶</button>
      </div>
      <nav class="flex flex-wrap gap-2">
        <button data-tab="calendar" class="tab-btn rounded-2xl border bg-white px-3 py-2 shadow-sm">Årsplan</button>
        <button data-tab="bank" class="tab-btn rounded-2xl border bg-white px-3 py-2 shadow-sm">Øktbank</button>
        <button data-tab="admin" class="tab-btn rounded-2xl border bg-white px-3 py-2 shadow-sm">Admin</button>
        <button data-tab="results" class="tab-btn rounded-2xl border bg-white px-3 py-2 shadow-sm">Skyteresultat</button>

        <a href="https://tidtaking.github.io/Tidtaking2/selvanviser" target="_blank" rel="noopener"
           class="rounded-2xl border bg-white px-3 py-2 shadow-sm hover:bg-slate-50">
          Selvanviser
        </a>
        <a href="https://tidtaking.github.io/Tidtaking2/velkommen.html" target="_blank" rel="noopener"
           class="rounded-2xl border bg-white px-3 py-2 shadow-sm hover:bg-slate-50">
          Tidtaking
        </a>
        <a href="https://tidtaking.github.io/Tidtaking2/årsplan_view.html" target="_blank" rel="noopener"
           class="rounded-2xl border bg-white px-3 py-2 shadow-sm hover:bg-slate-50">
          View-Only
        </a>
        <button id="btn-toggle-sidebar" class="rounded-2xl border bg-white px-3 py-2 shadow-sm">Sidepanel</button>
      </nav>
    </div>

    <div id="page-grid" class="grid grid-cols-1 gap-4 lg:grid-cols-[minmax(0,1fr)_360px]">
      <main id="main-content" class="space-y-4">
        <section id="tab-calendar" class="tab-section">
          <div id="calendar-grid" class="grid grid-cols-1 gap-4 md:grid-cols-2 2xl:grid-cols-3">
            <p class="text-center p-8 text-slate-500 md:col-span-2 2xl:col-span-3">Laster årsplan...</p>
          </div>

          <div class="rounded-2xl border bg-white shadow-sm card">
            <div class="flex items-center justify-between border-b p-4">
              <h3 class="text-lg font-semibold">Hendelser <span id="event-year"></span></h3>
              <button id="toggle-list" class="rounded-xl border bg-white px-3 py-1.5 text-sm shadow-sm no-print">Vis/skjul liste</button>
            </div>
            <div id="event-list" class="max-h-[320px] overflow-auto p-2 hidden">
              <table class="w-full table-fixed text-sm">
                <thead>
                  <tr class="text-left text-slate-500">
                    <th class="py-1">Dato</th><th>Tittel</th><th>Type</th><th>Sted</th><th>Modalitet</th><th>Int</th><th>Skudd</th><th class="text-right">…</th>
                  </tr>
                </thead>
                <tbody id="tbl-events"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="tab-bank" class="tab-section hidden">
          <div class="rounded-2xl border bg-white shadow-sm card">
            <div class="border-b p-4"><h3 class="text-lg font-semibold">Øktbank</h3></div>
            <div class="p-4 grid grid-cols-1 gap-3 md:grid-cols-3">
              <div class="p-4 pt-0">
                <button id="bank-new" class="rounded-xl border bg-white px-3 py-2 shadow-sm">
                  Ny mal i Øktbank
                </button>
              </div>
              <div>
                <label class="text-sm font-medium">Søk</label>
                <input id="q-bank" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="Søk i øktbank…"/>
              </div>
              <div>
                <label class="text-sm font-medium">Målgruppe</label>
                <select id="f-age" class="mt-1 w-full h-10 rounded-xl border px-3"></select>
              </div>
              <div>
                <label class="text-sm font-medium">Type</label>
                <select id="f-type" class="mt-1 w-full h-10 rounded-xl border px-3">
                  <option value="">Alle</option>
                  <option>Trening</option>
                  <option>Konkurranse</option>
                  <option>Restitusjon</option>
                </select>
              </div>
            </div>
            <div id="bank-cards" class="p-4 grid grid-cols-1 gap-4 md:grid-cols-2 2xl:grid-cols-3"></div>
          </div>
        </section>


        <section id="tab-admin" class="tab-section hidden">
          <div class="rounded-2xl border bg-white shadow-sm card">
            <div class="border-b p-4"><h3 class="text-lg font-semibold">Admin</h3></div>
            <div class="p-4 grid grid-cols-1 gap-6">
              <div class="rounded-2xl border bg-white shadow-sm card p-4">
                <h4 class="font-semibold mb-2">Rediger hendelser</h4>
                <div class="flex flex-wrap items-end gap-2">
                  <div>
                    <label class="text-sm font-medium">Søk</label>
                    <input id="admin-q" class="mt-1 w-64 h-10 rounded-xl border px-3" placeholder="Søk i tittel, type, sted…">
                  </div>
                  <div>
                    <label class="text-sm font-medium">Fra dato</label>
                    <input id="admin-from" type="date" class="mt-1 h-10 rounded-xl border px-3">
                  </div>
                  <div>
                    <label class="text-sm font-medium">Til dato</label>
                    <input id="admin-to" type="date" class="mt-1 h-10 rounded-xl border px-3">
                  </div>
                  <button id="admin-search" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Filtrer</button>
                </div>
                <div class="mt-3 max-h-[360px] overflow-auto rounded-xl border">
                  <table class="w-full table-fixed text-sm">
                    <thead class="bg-slate-50 sticky top-0">
                      <tr class="text-left text-slate-600">
                        <th class="p-2">Dato</th><th class="p-2">Tittel</th><th class="p-2">Type</th><th class="p-2">Sted</th><th class="p-2">Int</th><th class="p-2 text-right pr-2">…</th>
                      </tr>
                    </thead>
                    <tbody id="admin-events"></tbody>
                  </table>
                </div>
              </div>

              <div class="rounded-2xl border bg-white shadow-sm card p-4">
                <h4 class="font-semibold mb-2">Årsklasser (målgrupper)</h4>
                <p class="text-xs text-slate-600 mb-2">Endre etikett/ID eller legg til nye.</p>
                <div id="age-editor" class="space-y-2"></div>
                <div class="mt-2 flex gap-2">
                  <button id="age-add" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">Legg til gruppe</button>
                  <button id="age-save" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">Lagre grupper</button>
                </div>
              </div>

              <div class="rounded-2xl border bg-white shadow-sm card p-4">
                <h4 class="font-semibold mb-2">Ukekoder (BAS/OPP/KONK/RES/EKS)</h4>
                <div class="max-h-72 overflow-auto rounded-xl border">
                  <table class="w-full text-sm">
                    <thead><tr class="text-left text-slate-500"><th class="p-2">Uke</th><th>Kode</th><th>Notat</th></tr></thead>
                    <tbody id="tbl-weeks"></tbody>
                  </table>
                </div>
              </div>

              <div class="rounded-2xl border bg-white shadow-sm card p-4">
                <h4 class="font-semibold mb-2">Kalender</h4>
                <button id="btn-ics" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">Last ned .ics</button>
              </div>

              <div class="rounded-2xl border bg-white shadow-sm card p-4">
                <h4 class="font-semibold mb-2">Øktbank</h4>
                <button id="btn-seed-bank" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">
                  Legg inn 25 standardøkter i Øktbank
                </button>
                <p class="text-xs text-slate-500 mt-1">Trygg å kjøre flere ganger – hopper over maler som allerede finnes (matcher på navn).</p>
              </div>

              <div class="rounded-2xl border bg-white shadow-sm card p-4">
                <h4 class="font-semibold mb-2">Varslinger</h4>
                <p class="text-xs text-slate-600 mb-3">
                  Abonnenter mottar e-post ved <b>per endring</b>, som <b>sum dag</b> (daglig digest) eller <b>sum uke</b> (ukentlig digest).
                </p>
                <div class="mt-3 flex flex-wrap gap-2">
                  <button id="nf-drain" class="rounded-xl border bg-white px-3 py-2 shadow-sm">
                    Send ventende (per endring)
                  </button>
                  <button id="nf-send-daily" class="rounded-xl border bg-white px-3 py-2 shadow-sm">
                    Send daglig oppsummering (nå)
                  </button>
                  <button id="nf-send-weekly" class="rounded-xl border bg-white px-3 py-2 shadow-sm">
                    Send ukentlig oppsummering (nå)
                  </button>
                </div>


                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-medium">Avsender navn</label>
                    <input id="nf-from-name" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="Lørenskog Skiskyting"/>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Avsender e-post</label>
                    <input id="nf-from-email" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="noreply@din-domene.no"/>
                  </div>
                  <div class="md:col-span-2">
                    <button id="nf-save-sender" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Lagre avsender</button>
                  </div>
                </div>

                <div class="flex flex-wrap items-end gap-2 mb-2">
                  <div>
                    <label class="text-sm font-medium">E-post</label>
                    <input id="nf-email" class="mt-1 w-64 h-10 rounded-xl border px-3" placeholder="person@eksempel.no">
                  </div>
                  <div>
                    <label class="text-sm font-medium">Frekvens</label>
                    <select id="nf-frequency" class="mt-1 h-10 rounded-xl border px-3">
                      <option value="per_change">Per endring</option>
                      <option value="daily">Sum dag</option>
                      <option value="weekly">Sum uke</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Typer (valgfritt)</label>
                    <select id="nf-types" multiple class="mt-1 h-24 rounded-xl border px-3 min-w-[12rem]">
                      <option>Trening</option><option>Skyting</option><option>Konkurranse</option>
                      <option>Samling</option><option>Restitusjon</option><option>Annet</option>
                    </select>
                    <div class="text-[11px] text-slate-500">Hold Ctrl/Cmd for flere</div>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Aldersgrupper (valgfritt)</label>
                    <select id="nf-ages" multiple class="mt-1 h-24 rounded-xl border px-3 min-w-[12rem]"></select>
                    <div class="text-[11px] text-slate-500">Hold Ctrl/Cmd for flere</div>
                  </div>
                  <button id="nf-add" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Legg til/oppdater</button>
                </div>

                <div class="mt-2 max-h-[300px] overflow-auto rounded-xl border">
                  <table class="w-full text-sm">
                    <thead class="bg-slate-50 sticky top-0">
                      <tr class="text-left text-slate-600">
                        <th class="p-2">E-post</th><th>Frekvens</th><th>Typer</th><th>Aldersgrupper</th><th>Aktiv</th><th class="text-right pr-2">…</th>
                      </tr>
                    </thead>
                    <tbody id="nf-table"></tbody>
                  </table>
                </div>
              </div>
              </div>
        </section>
        <section id="tab-results" class="tab-section hidden">
          <div class="rounded-2xl border bg-white shadow-sm card">
            <div class="border-b p-4 flex justify-between items-center">
              <h3 class="text-lg font-semibold">Registrer skyteresultat</h3>
              <div class="text-xs text-slate-500"><span id="res-best-meta"></span></div>
            </div>

            <div class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div class="rounded-xl border bg-white">
                <div class="p-3 font-semibold">Topp 5 – totalsum</div>
                <ul id="res-best-top5" class="p-3 space-y-1 text-sm"></ul>
              </div>

              <div class="rounded-xl border bg-white">
                <div class="p-3 font-semibold">Topp 5 – liggende</div>
                <ul id="res-best-top5-prone" class="p-3 space-y-1 text-sm"></ul>
              </div>

              <div class="rounded-xl border bg-white">
                <div class="p-3 font-semibold">Topp 5 – stående</div>
                <ul id="res-best-top5-stand" class="p-3 space-y-1 text-sm"></ul>
              </div>

              <div class="rounded-xl border bg-white lg:col-span-2">
                <div class="p-3 font-semibold">PB per øvelse</div>
                <table class="w-full text-sm">
                  <thead class="bg-slate-50">
                    <tr><th class="p-2">Utøver</th><th class="p-2">Øvelse</th><th class="p-2 text-right">PB</th><th class="p-2">Dato</th></tr>
                  </thead>
                  <tbody id="res-best-pb-ex"></tbody>
                </table>
              </div>

              <div class="rounded-xl border bg-white">
                <div class="p-3 font-semibold flex items-center justify-between gap-2">
                  <span>Personlige rekorder (PB)</span>
                  <input id="res-pb-q" class="h-8 w-48 rounded-lg border px-2 text-sm" placeholder="Søk utøver…"/>
                </div>
                <table class="w-full text-sm">
                  <thead class="bg-slate-50">
                    <tr><th class="p-2">Utøver</th><th class="p-2 text-right">PB</th><th class="p-2">Øvelse</th><th class="p-2">Dato</th></tr>
                  </thead>
                  <tbody id="res-best-pb">
                    <tr><td colspan="4" class="p-3 text-slate-500">Søk etter en utøver for å se PB.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>


            <div class="border-t p-4 grid grid-cols-1 gap-3">
              <div>
                <label class="text-sm font-medium">Utøver</label>
                <input id="res-athlete" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="F.eks. Ola Nordmann" list="res-athlete-list"/>
                <datalist id="res-athlete-list"></datalist>
              </div>
              <div>
                <label class="text-sm font-medium">Skyteøvelse</label>
                <input id="res-ex" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="F.eks. 30 ligg + 30 stå" list="res-exercise-list"/>
                <datalist id="res-exercise-list"></datalist>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label class="text-sm font-medium">Dato</label>
                  <input id="res-date" type="date" class="mt-1 w-full h-10 rounded-xl border px-3"/>
                </div>
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="text-sm font-medium">Liggende</label>
                    <input id="res-prone" type="number" class="mt-1 w-full h-10 rounded-xl border px-3" min="0" step="1" placeholder="0"/>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Stående</label>
                    <input id="res-stand" type="number" class="mt-1 w-full h-10 rounded-xl border px-3" min="0" step="1" placeholder="0"/>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Sum</label>
                    <input id="res-total" type="number" class="mt-1 w-full h-10 rounded-xl border px-3 bg-slate-50" readonly/>
                  </div>
                </div>
              </div>
              <div class="pt-1">
                <button id="res-save" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Lagre resultat</button>
              </div>
            </div>

            <div class="border-t p-4 grid grid-cols-1 md:grid-cols-5 gap-3">
              <div class="md:col-span-2">
                <label class="text-sm font-medium">Filtrer på utøver</label>
                <input id="res-filter-name" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="Søk navn…"/>
              </div>
              <div class="md:col-span-2">
                <label class="text-sm font-medium">Filtrer på øvelse</label>
                <input id="res-filter-ex" class="mt-1 w-full h-10 rounded-xl border px-3" placeholder="Søk øvelse…"/>
              </div>
              <div>
                <label class="text-sm font-medium">Sorter</label>
                <select id="res-sort" class="mt-1 w-full h-10 rounded-xl border px-3">
                  <option value="date_desc">Dato ↓</option>
                  <option value="date_asc">Dato ↑</option>
                  <option value="total_desc">Sum ↓</option>
                  <option value="total_asc">Sum ↑</option>
                  <option value="prone_desc">Liggende ↓</option>
                  <option value="stand_desc">Stående ↓</option>
                  <option value="name_asc">Navn A–Å</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-medium">Fra</label>
                <input id="res-filter-from" type="date" class="mt-1 w-full h-10 rounded-xl border px-3"/>
              </div>
              <div>
                <label class="text-sm font-medium">Til</label>
                <input id="res-filter-to" type="date" class="mt-1 w-full h-10 rounded-xl border px-3"/>
              </div>
              <div class="md:col-span-2 flex items-end gap-2">
                <button id="res-clear" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Tøm</button>
                <button id="res-refresh" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Oppdater</button>
                <button id="res-export-csv" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Eksporter filtrert CSV</button>
              </div>
            </div>

            <div class="p-4">
              <div class="max-h-[420px] overflow-auto rounded-xl border">
                <table class="w-full text-sm">
                  <thead class="bg-slate-50 sticky top-0">
                    <tr class="text-left text-slate-600">
                      <th class="p-2">Dato</th>
                      <th class="p-2">Utøver</th>
                      <th class="p-2">Øvelse</th>
                      <th class="p-2 text-right">Lig.</th>
                      <th class="p-2 text-right">Stå.</th>
                      <th class="p-2 text-right">Sum</th>
                    </tr>
                  </thead>
                  <tbody id="res-table"></tbody>
                </table>
              </div>
              <div class="mt-2 flex items-center justify-between">
                <div class="text-xs text-slate-600" id="res-count"></div>
                <button id="res-load-more" class="rounded-xl border bg-white px-3 py-1.5 text-sm shadow-sm">Last inn flere</button>
              </div>
            </div>
          </div>
        </section>
      </main>

      <aside id="sidebar" class="space-y-4 hidden">
        <div class="rounded-2xl border bg-white shadow-sm card">
          <div class="border-b p-4"><h3 class="text-lg font-semibold">Fargekode</h3></div>
          <div id="legend" class="p-4 space-y-1 text-sm"></div>
        </div>

        <div class="rounded-2xl border bg-white shadow-sm card">
          <div class="border-b p-4"><h3 class="text-lg font-semibold">Utviklingstrapp (kort)</h3></div>
          <div class="p-4 text-sm text-slate-700 space-y-1">
            <p><span class="font-medium">Skiskytterskolen:</span> Introduksjon, sikkerhet, enkel liggende, lek.</p>
            <p><span class="font-medium">9–10 år:</span> Variasjon/lek, korte økter, koordinasjon og balanse.</p>
            <p><span class="font-medium">11–12 år:</span> Mer struktur, enkel intensitetsforståelse, liggende videreutvikles.</p>
            <p><span class="font-medium">13–14 år:</span> Tydelig progresjon, stående introduseres/videreutvikles.</p>
            <p><span class="font-medium">HL gruppe (15+):</span> Individtilpasning, helhetlig belastning, konk-spesifikt.</p>
          </div>
        </div>

        <div class="rounded-2xl border bg-white shadow-sm card">
          <div class="border-b p-4">
            <h3 class="text-lg font-semibold">Intensitetssoner (I1–I5) for barn</h3>
          </div>
          <div class="p-4">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-left text-slate-500">
                  <th class="py-1">Sone</th>
                  <th class="py-1">Følelse</th>
                </tr>
              </thead>
              <tbody class="align-top">
                <tr>
                  <td class="py-2">
                    <span class="inline-flex items-center gap-2">
                      <span class="inline-block h-2.5 w-2.5 rounded-full" style="background:#22c55e"></span>
                      <span>I1 Svært lett</span>
                    </span>
                  </td>
                  <td class="py-2">Helt rolig, kan prate og le hele tiden</td>
                </tr>
                <tr class="border-t">
                  <td class="py-2">
                    <span class="inline-flex items-center gap-2">
                      <span class="inline-block h-2.5 w-2.5 rounded-full" style="background:#eab308"></span>
                      <span>I2 Lett</span>
                    </span>
                  </td>
                  <td class="py-2">Puster litt mer, men kan snakke i setninger</td>
                </tr>
                <tr class="border-t">
                  <td class="py-2">
                    <span class="inline-flex items-center gap-2">
                      <span class="inline-block h-2.5 w-2.5 rounded-full" style="background:#f59e0b"></span>
                      <span>I3 Middels</span>
                    </span>
                  </td>
                  <td class="py-2">Blir varm og andpusten, kan snakke i korte setninger</td>
                </tr>
                <tr class="border-t">
                  <td class="py-2">
                    <span class="inline-flex items-center gap-2">
                      <span class="inline-block h-2.5 w-2.5 rounded-full" style="background:#ef4444"></span>
                      <span>I4 Hardt</span>
                    </span>
                  </td>
                  <td class="py-2">Ordentlig sliten, kan bare si noen få ord</td>
                </tr>
                <tr class="border-t">
                  <td class="py-2">
                    <span class="inline-flex items-center gap-2">
                      <span>⚡</span>
                      <span>I5 Maks</span>
                    </span>
                  </td>
                  <td class="py-2">Alt du har! Klarer bare noen sekunder–minutter</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-2xl border bg-white shadow-sm card">
          <div class="border-b p-4"><h3 class="text-lg font-semibold">Hurtigverktøy</h3></div>
          <div class="p-4 flex flex-col gap-2 no-print">
            <button id="quick-trening" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Ny trening</button>
            <button id="quick-skyting" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Ny skyteøkt</button>
            <button id="quick-konk" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Ny konkurranse</button>
          </div>
        </div>
      </aside>
    </div>
  </div><div id="dialog" role="dialog" aria-modal="true" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
    <div class="dialog-card w-full max-w-2xl rounded-2xl bg-white shadow-xl">
      <div class="flex items-center justify-between border-b p-4">
        <h3 id="dlg-title" class="text-lg font-semibold">Ny hendelse</h3>
        <button id="dlg-close" aria-label="Lukk dialog" class="rounded-full p-1 hover:bg-slate-100">✕</button>
      </div>
      <div class="dialog-body p-4 space-y-3" id="dlg-body"></div>
      <div class="border-t p-4 flex justify-end gap-2">
        <button id="btn-delete" class="mr-auto hidden rounded-xl border border-red-300 bg-red-50 px-3 py-1.5 text-red-700">Slett</button>
        <button id="btn-cancel" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">Avbryt</button>
        <button id="btn-save" class="rounded-xl border bg-white px-3 py-1.5 shadow-sm">Lagre</button>
      </div>
    </div>
  </div>

  <div id="lss-tooltip" class="hidden rounded-xl border bg-white shadow-lg p-3 text-xs text-slate-700"></div>

  <script>
    // ---------- Dayjs ----------
    dayjs.extend(dayjs_plugin_isoWeek);
    dayjs.extend(dayjs_plugin_weekday);
    dayjs.extend(dayjs_plugin_localizedFormat);
    dayjs.locale('nb');

    // --- Sidebar toggle (med knappestil) ---
    function setSidebarButtonStyle(isVisible){
      const btn = document.getElementById('btn-toggle-sidebar');
      if(!btn) return;
      const isHidden = !isVisible;
      btn.classList.toggle('bg-blue-50', isHidden);
      btn.classList.toggle('border-blue-300', isHidden);
      btn.classList.toggle('text-[var(--brand)]', isHidden);
      btn.setAttribute('aria-pressed', String(isHidden));
      btn.textContent = isHidden ? 'Sidepanel (skjult)' : 'Sidepanel';
    }
    function applySidebarLayout(visible){
      const grid = document.getElementById('page-grid');
      const aside = document.getElementById('sidebar');
      if(!grid || !aside) return;
      if(visible){
        aside.classList.remove('hidden');
        grid.classList.remove('lg:grid-cols-1');
        grid.classList.add('lg:grid-cols-[minmax(0,1fr)_360px]');
      }else{
        aside.classList.add('hidden');
        grid.classList.remove('lg:grid-cols-[minmax(0,1fr)_360px]');
        grid.classList.add('lg:grid-cols-1');
      }
      setSidebarButtonStyle(visible);
    }
    function setupSidebarToggle(){
      const btn = document.getElementById('btn-toggle-sidebar');
      if(!btn) return;
      const saved = localStorage.getItem('lss:sidebar:visible');
      const visible = saved === null ? true : (saved === 'true');
      applySidebarLayout(visible);
      btn.addEventListener('click', () => {
        const aside = document.getElementById('sidebar');
        const nowVisible = aside.classList.contains('hidden');
        applySidebarLayout(nowVisible);
        localStorage.setItem('lss:sidebar:visible', String(nowVisible));
      });
    }

    // ---------- Konstanter ----------
    const COLORS = { Trening:'#2563eb', Skyting:'#0ea5e9', Konkurranse:'#dc2626', Samling:'#a855f7', Annet:'#6b7280', Restitusjon:'#16a34a' };
    const MODALITETER = ['Ski skøyting','Ski klassisk','Rulleski skøyting','Rulleski klassisk','Løp','Sykkel','Styrke','Basistrening'];
    const INTENS = ['I1','I2','I3','I4','I5'];
    const WEEKCODES = ['BAS','OPP','KONK','RES','EKS'];

    const DEFAULT_AGE_GROUPS = [
      { id:'HL', label:'HL gruppe (15+)' },
      { id:'13-14', label:'13–14 år' },
      { id:'11-12', label:'11–12 år' },
      { id:'9-10', label:'9–10 år' },
      { id:'Skiskytterskolen', label:'Skiskytterskolen' }
    ];
    const AGE_MAP = { 'U12':'11-12', 'U14':'13-14', 'U16':'HL', 'JR':'HL' };

    const KEY = {
      EVENTS:   'lss:events:v1',
      BANK:     'lss:bank:v3',
      WEEKS:    'lss:weeks:v1',
      YEAR:     'lss:year:v1',
      DAYORDER: 'lss:dayorder:v2',
      AGES:     'lss:ages:v1',
      VIEW:     'lss:view:v1'     // lagrer visningsmodus
    };


    // ---------- Hjelpefunksjoner ----------
    const $=(q,el=document)=>el.querySelector(q);
    const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
    const uid=()=> (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2));
    const lsGet=(k,d)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):d;}catch{return d;} };
    const lsSet=(k,v)=>{ try{localStorage.setItem(k, JSON.stringify(v));}catch{} };
    // ENDRING: Standardisert escapeHTML-funksjon
    const escapeHTML = (str) => (str||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

    function fallbackLogo(){
      const img=document.createElement('div');
      img.className='h-14 w-20 rounded-xl bg-white grid place-items-center text-xs text-slate-500';
      img.textContent='Logo';
      return img;
    }
    function bindDialogChrome(){
      const dlg = $('#dialog');
      const doClose = (e) => { e?.preventDefault?.(); closeDialog(); };
      $('#btn-cancel')?.addEventListener('click', doClose);
      $('#dlg-close')?.addEventListener('click', doClose);
      dlg?.addEventListener('click', (e) => {
        if (e.target === dlg) {
          if (confirm("Vil du lukke uten å lagre endringer?")) {
            closeDialog();
          }
        }
      });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !dlg.classList.contains('hidden')) closeDialog(); });
    }

    // ---------- Supabase ----------
    const SUPA_URL = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabase = window.supabase.createClient(SUPA_URL, SUPA_ANON);
    const TBL = { events:'events', bank:'bank_templates', weeks:'weeks', dayOrder:'day_order', settings:'settings', results:'shoot_results' };


    // ---------- State ----------
    let state = {
      year:     lsGet(KEY.YEAR, dayjs().year()),
      month:    dayjs().month() + 1,
      viewMode: lsGet(KEY.VIEW, 'rolling'), // 'rolling' | 'full'
      events:   [],
      bank:     [],
      weeks:    {},
      dayOrder: lsGet(KEY.DAYORDER, {}),
      ageGroups:lsGet(KEY.AGES, DEFAULT_AGE_GROUPS),
      results:  []
    };

    if (state.viewMode === 'year') state.viewMode = 'full';
    if (!['rolling','full'].includes(state.viewMode)) state.viewMode = 'rolling';

    const MOBILE_BREAKPOINT = 768;
    const isMobile = () => window.innerWidth < MOBILE_BREAKPOINT;

    // ---------- I/O (Supabase-kommunikasjon) ----------
    async function supaLoadAll(year = state.year){
      // Events
      const { data: ev, error: evErr } = await supabase.from(TBL.events).select('*').eq('year', year).order('date', { ascending: true });
      if(!evErr && ev){ state.events = ev.map(mapEventFromDb); lsSet(KEY.EVENTS, state.events); }
      else { state.events = lsGet(KEY.EVENTS, state.events); }

      // Bank
      const { data: bk, error: bkErr } = await supabase.from(TBL.bank).select('*').order('created_at', { ascending: false });
      if(!bkErr && bk){ state.bank = bk.map(mapBankFromDb); if(state.bank.length===0){ state.bank=getDefaultTemplates(); } lsSet(KEY.BANK, state.bank); }
      else { state.bank = lsGet(KEY.BANK, getDefaultTemplates()); }

      // Weeks
      const { data: wks, error: wErr } = await supabase.from(TBL.weeks).select('*').eq('year', year);
      if(!wErr && wks){
        const dict={}; for(const r of wks){ dict[r.week] = { code: r.code || 'BAS', note: r.note || '' }; }
        state.weeks = dict;
      } else {
        state.weeks = lsGet(KEY.WEEKS, getDefaultWeeks(year));
      }

      await supaLoadAgeGroups();
      await supaLoadDayOrderForYear(year);
      migrateAllAgesInState();
      render();
    }

    async function supaLoadAgeGroups(){
      const { data, error } = await supabase.from(TBL.settings).select('value').eq('key','age_groups').maybeSingle();
      if(!error && data && Array.isArray(data.value)){ state.ageGroups = data.value; }
      else { state.ageGroups = DEFAULT_AGE_GROUPS; await supabase.from(TBL.settings).upsert({ key:'age_groups', value: state.ageGroups }); }
      lsSet(KEY.AGES, state.ageGroups);
    }
    async function supaSaveAgeGroups(){
      const { error } = await supabase.from(TBL.settings).upsert({ key:'age_groups', value: state.ageGroups });
      // ENDRING: Byttet console.warn med alert for bedre brukerfeedback
      if(error){ console.error('Lagre age_groups feilet', error); alert('Kunne ikke lagre grupper til skyen.'); }
    }
    async function notifyPerChange(eventId, change = 'upsert'){
      try {
        const { data, error } = await supabase.functions.invoke('notify-dispatch', {
          body: { mode: 'per_change', change, eventId }
        });
        if (error) throw error;
        console.log('[notify] OK', data);
      } catch (err) {
        console.error('[notify] FEIL', err);
      }
    }
    function mapResultToDb(r){
      return {
        id: r.id,
        date: r.date,
        athlete: r.athlete || null,
        exercise: r.exercise || null,
        points_prone: r.pointsProne ?? 0,
        points_stand: r.pointsStand ?? 0,
        points_total: (r.pointsProne||0) + (r.pointsStand||0)
      };
    }
    function mapResultFromDb(r){
      return {
        id: r.id,
        date: r.date,
        athlete: r.athlete || '',
        exercise: r.exercise || '',
        pointsProne: r.points_prone ?? 0,
        pointsStand: r.points_stand ?? 0,
        pointsTotal: r.points_total ?? ((r.points_prone||0)+(r.points_stand||0))
      };
    }

    async function supaInsertResult(row){
      const dbRow = mapResultToDb(row);
      const { data, error } = await supabase.from(TBL.results).insert(dbRow).select('*').single();
      if(error) throw error;
      return mapResultFromDb(data);
    }

    function replaceIdEverywhere(oldId, newId, dateISO){
      if (!oldId || !newId || oldId === newId) return;
      const i = state.events.findIndex(x => x.id === oldId);
      if (i >= 0) { state.events[i] = { ...state.events[i], id: newId }; }
      const key = dateISO || (state.events[i]?.date);
      if (key && state.dayOrder[key]) {
        state.dayOrder[key] = state.dayOrder[key].map(x => x === oldId ? newId : x);
      }
      lsSet(KEY.EVENTS, state.events);
      lsSet(KEY.DAYORDER, state.dayOrder);
      lsSet(KEY.VIEW, state.viewMode);
      render();
    }

    async function supaUpsertEvent(model){
      const row = mapEventToDb(model);
      try{
        const { data, error } = await supabase
          .from(TBL.events)
          .upsert(row, { onConflict: 'id' })
          .select('id, date')
          .single();

        if (error){
          console.error('Upsert event feilet', error);
          alert('Kunne ikke lagre til skyen. Lagret lokalt.');
          return;
        }

        if (data && data.id && data.id !== model.id){
          replaceIdEverywhere(model.id, data.id, data.date || model.date);
          model.id = data.id;
        }

        await notifyPerChange(model.id);
      }catch(err){
        console.error('Upsert event exception:', err);
        alert('Uventet feil ved lagring (se konsoll).');
      }
    }

    async function findServerCandidates(ev){
      const title = (ev.title || '').trim();
      const queries = [
        supabase.from(TBL.events).select('id, title, type, date').eq('date', ev.date).eq('title', title).eq('type', ev.type || null).limit(10),
        supabase.from(TBL.events).select('id, title, type, date').eq('date', ev.date).ilike('title', `%${title}%`).limit(10),
        supabase.from(TBL.events).select('id, title, type, date').eq('date', ev.date).order('created_at', { ascending: false }).limit(1)
      ];
      for (const q of queries) {
          const { data, error } = await q;
          if (!error && data && data.length) return data;
      }
      return [];
    }

    async function supaDeleteEvent(ev){
      try{
        let { data, error } = await supabase.from(TBL.events).delete().eq('id', ev.id).select('id');
        if (error){ alert('Kunne ikke slette i skyen.'); return; }
        if (data && data.length){ await notifyPerChange(null); return; }

        const candidates = await findServerCandidates(ev);
        if (!candidates.length){ alert('Fant ingen match i skyen for sletting.'); return; }

        const chosen = candidates.find(r => (r.title||'') === (ev.title||'') && (r.type||'') === (ev.type||'')) || candidates[0];
        const res2 = await supabase.from(TBL.events).delete().eq('id', chosen.id).select('id');
        if (res2.error){ alert('Kunne ikke slette i skyen via fallback.'); return; }
        if (chosen.id !== ev.id) replaceIdEverywhere(ev.id, chosen.id, ev.date);
        await notifyPerChange(null);
      }catch(err){
        console.error('Delete exception:', err);
        alert('Uventet feil ved sletting (se konsoll).');
      }
    }

    async function supaUpsertWeek(year, week, code, note){
      const { error } = await supabase.from(TBL.weeks).upsert({ year, week, code, note });
      if(error){ console.warn('Upsert week feilet', error); } // Mindre kritisk, ingen alert.
    }
    async function supaUpsertBankTemplate(t){
      const row = mapBankToDb(t);
      const { error } = await supabase.from(TBL.bank).upsert(row);
      if(error){ alert('Kunne ikke lagre mal til skyen.'); }
    }
    async function supaDeleteBankTemplate(id){
      const { error } = await supabase.from(TBL.bank).delete().eq('id', id);
      if(error){ alert('Kunne ikke slette mal fra skyen.'); }
    }
    async function supaLoadDayOrderForYear(year){
      const from = `${year}-01-01`;
      const to   = `${year+1}-01-01`;
      const { data, error } = await supabase.from(TBL.dayOrder).select('*').gte('date', from).lt('date', to);
      if(error){ console.warn('Henting av dagssortering feilet', error); return; }
      const map = {};
      for(const r of data||[]){ map[r.date] = Array.isArray(r.ids) ? r.ids : []; }
      state.dayOrder = { ...state.dayOrder, ...map };
      lsSet(KEY.DAYORDER, state.dayOrder);
    }
    async function supaUpsertDayOrder(dateISO, ids){
      const { error } = await supabase.from(TBL.dayOrder).upsert({ date: dateISO, ids });
      if(error){ console.warn('Upsert day_order feilet', error); }
    }

    function supaRealtimeInit(){
      supabase.channel('events-rt')
        .on('postgres_changes', { event: '*', schema: 'public', table: TBL.events }, payload => {
          if(payload.new?.year === state.year || payload.old?.year === state.year){ supaLoadAll(state.year); }
        }).subscribe();
      supabase.channel('weeks-rt')
        .on('postgres_changes', { event: '*', schema: 'public', table: TBL.weeks }, payload => {
          if((payload.new?.year||payload.old?.year) === state.year){ supaLoadAll(state.year); }
        }).subscribe();
      supabase.channel('bank-rt')
        .on('postgres_changes', { event: '*', schema: 'public', table: TBL.bank }, () => supaLoadAll(state.year))
        .subscribe();
      supabase.channel('dayorder-rt')
        .on('postgres_changes', { event: '*', schema: 'public', table: TBL.dayOrder }, payload => {
          const d = (payload.new?.date || payload.old?.date); if(!d) return;
          if(dayjs(d).year() !== state.year) return;
          if(payload.eventType === 'DELETE'){ delete state.dayOrder[d]; }
          else { state.dayOrder[d] = payload.new?.ids || []; }
          lsSet(KEY.DAYORDER, state.dayOrder);
          render();
        }).subscribe();
      supabase.channel('settings-rt')
        .on('postgres_changes', { event: '*', schema: 'public', table: TBL.settings }, payload => {
          if(payload.new?.key === 'age_groups'){
            state.ageGroups = payload.new?.value || DEFAULT_AGE_GROUPS;
            lsSet(KEY.AGES, state.ageGroups);
            render();
          }
        }).subscribe();
      supabase.channel('results-rt')
        .on('postgres_changes', { event:'*', schema:'public', table: TBL.results }, () => supaLoadResults(50))
        .subscribe();
    }

    // ---------- Datamapping (til/fra DB-format) ----------
    function mapEventToDb(e){
      return {
        id: e.id, date: e.date, title: e.title || null, type: e.type || null,
        modality: e.modality || null, intensity: e.intensity || null, duration_min: e.durationMin ?? null,
        age: e.age || [], shooting: e.shooting || { stilling:'', skudd:0, tema:[] },
        race_subtype: e.raceSubtype || null, notes: e.notes || null, roles: e.roles || {}, location: e.location || null
      };
    }
    function mapEventFromDb(r){
      return {
        id: r.id, date: r.date, title: r.title || '', type: r.type ?? r.event_type ?? 'Trening',
        modality: r.modality || '', intensity: r.intensity || '', durationMin: r.duration_min ?? 60,
        age: r.age || [], shooting: r.shooting || { stilling:'', skudd:0, tema:[] },
        raceSubtype: r.race_subtype || '', notes: r.notes || '', roles: r.roles || {}, location: r.location || ''
      };
    }
    function mapBankToDb(t){
      return {
        id: t.id, name: t.name, type: t.type, modality: t.modality, intensity: t.intensity,
        duration_min: t.durationMin ?? null, age: t.age || [], shooting: t.shooting || { stilling:'', skudd:0, tema:[] },
        race_subtype: t.raceSubtype || null, notes: t.notes || null
      };
    }
    function mapBankFromDb(r){
      return {
        id: r.id, name: r.name, type: r.type, modality: r.modality, intensity: r.intensity,
        durationMin: r.duration_min ?? null, age: r.age || [], shooting: r.shooting || { stilling:'', skudd:0, tema:[] },
        raceSubtype: r.race_subtype || null, notes: r.notes || null
      };
    }

    // ---------- Defaults / migrering ----------
    function getDefaultWeeks(year){
      const weeks={}; let d=dayjs(year+'-01-01').startOf('isoWeek');
      const last=dayjs(year+'-12-31');
      while(d.isBefore(last.add(1,'day'))){
        const wk=d.isoWeek(); if(!weeks[wk]) weeks[wk]={code:'BAS',note:''}; d=d.add(7,'day');
      }
      return weeks;
    }
    function migrateAllAgesInState(){
      const migrate = arr => Array.isArray(arr) ? arr.map(a => AGE_MAP[a] || a) : [];
      state.events = (state.events || []).map(e => ({ ...e, age: migrate(e.age) }));
      state.bank   = (state.bank   || []).map(t => ({ ...t, age: migrate(t.age) }));
    }

    // ---------- Tooltip ----------
    const tipEl = $('#lss-tooltip');
    function showTooltip(html, x, y){
      if(!tipEl) return;
      tipEl.innerHTML = html;
      tipEl.style.left = x+'px';
      tipEl.style.top = (y-12)+'px';
      tipEl.classList.remove('hidden');
    }
    function hideTooltip(){ if(tipEl) tipEl.classList.add('hidden'); }
    function attachTipHandlers(el, html){
      let pressTimer = null, last = {x:0, y:0};
      const onEnter = (ev)=> showTooltip(html, ev.clientX, ev.clientY);
      const onMove  = (ev)=> showTooltip(html, ev.clientX, ev.clientY);
      const onLeave = ()=> hideTooltip();
      el.addEventListener('mouseenter', onEnter);
      el.addEventListener('mousemove', onMove);
      el.addEventListener('mouseleave', onLeave);
      const startPress = (ev)=>{
        const t = ev.touches?.[0]; if(!t) return;
        last = { x: t.clientX, y: t.clientY };
        pressTimer = setTimeout(()=> showTooltip(html, last.x, last.y), 300);
      };
      const endPress = ()=>{ clearTimeout(pressTimer); setTimeout(hideTooltip, 1200); };
      el.addEventListener('touchstart', startPress, { passive:true });
      el.addEventListener('touchend',   endPress,   { passive:true });
      el.addEventListener('touchcancel',endPress,   { passive:true });
    }
    function eventTooltipHTML(e){
      const title = escapeHTML(e.title || e.type || '');
      const rolesList = Object.entries(e.roles||{}).filter(([,v])=> (v||'').trim().length).map(([k,v])=> `<div><span class="font-medium">${escapeHTML(k)}:</span> ${escapeHTML(v)}</div>`).join('');
      const ageChips = (e.age||[]).map(a=>`<span class="rounded-full border px-1.5 py-0.5 text-[10px] mr-1">${escapeHTML(a)}</span>`).join('');
      const race = e.type==='Konkurranse' && (e.raceSubtype||'').trim() ? `<div><span class="font-medium">Konkurranse:</span> ${escapeHTML(e.raceSubtype)}</div>` : '';
      const notes = (e.notes||'').trim() ? `<div class="mt-2 text-slate-600 whitespace-pre-wrap">${escapeHTML(e.notes)}</div>` : '';
      const tema = (e.shooting?.tema||[]).length ? `<div class="mt-1 flex flex-wrap gap-1">${e.shooting.tema.map(t=>`<span class="rounded-full border px-1.5 py-0.5 text-[10px]">${escapeHTML(t)}</span>`).join('')}</div>` : '';
      return `
        <div class="font-semibold mb-1">${title}</div>
        <div><span class="font-medium">Type:</span> ${escapeHTML(e.type||'–')}</div>
        <div><span class="font-medium">Sted:</span> ${escapeHTML(e.location||'–')}</div>
        <div><span class="font-medium">Modalitet:</span> ${escapeHTML(e.modality||'–')}</div>
        <div><span class="font-medium">Intensitet:</span> ${escapeHTML(e.intensity||'–')}</div>
        <div><span class="font-medium">Varighet:</span> ${e.durationMin? escapeHTML(String(e.durationMin))+' min' : '–'}</div>
        <div class="mt-1"><span class="font-medium">Aldersklasser:</span> ${ageChips||'–'}</div>
        <div class="mt-1"><span class="font-medium">Skyting:</span> ${escapeHTML(e.shooting?.stilling||'–')}, skudd: ${e.shooting?.skudd||0}</div>
        ${tema} ${race}
        ${rolesList? `<div class="mt-1">${rolesList}</div>`:''}
        ${notes}
      `;
    }

    // ---------- Dagssortering (Drag and Drop) ----------
    function getOrderForDate(dateISO){ return state.dayOrder[dateISO] || []; }
    function setOrderForDate(dateISO, ids){ state.dayOrder[dateISO] = ids; lsSet(KEY.DAYORDER, state.dayOrder); supaUpsertDayOrder(dateISO, ids); }
    function sortEventsByDayOrder(dateISO, events){
      const order = getOrderForDate(dateISO);
      const idx = new Map(order.map((id, i)=>[id, i]));
      return [...events].sort((a,b)=>{
        const ai = idx.has(a.id) ? idx.get(a.id) : Infinity;
        const bi = idx.has(b.id) ? idx.get(b.id) : Infinity;
        if (ai !== bi) return ai - bi;
        return (a.title||'').localeCompare(b.title||'');
      });
    }

    function previewCardHTML(e){
      const dot = `<span class="inline-block h-2.5 w-2.5 rounded-full" style="background:${COLORS[e.type]||'#6b7280'}"></span>`;
      const title = escapeHTML(e.title || (e.type + (e.raceSubtype? ' – '+e.raceSubtype : '')));
      const meta = [e.type ? `<span class="inline-flex items-center gap-2">${dot}<span>${escapeHTML(e.type)}</span></span>` : '', e.location ? `<span>${escapeHTML(e.location)}</span>` : '', e.modality ? `<span>${escapeHTML(e.modality)}</span>` : '', e.intensity ? `<span>${escapeHTML(e.intensity)}</span>` : '', e.durationMin ? `<span>${String(e.durationMin)} min</span>` : ''].filter(Boolean).join(' • ');
      const ages = (e.age||[]).length ? `<div class="mt-1 flex flex-wrap gap-1">${(e.age||[]).map(a=>`<span class="rounded-full border px-2 py-0.5 text-[11px]">${escapeHTML(a)}</span>`).join('')}</div>` : '';
      const notes = e.notes ? `<div class="mt-2 text-sm text-slate-700 whitespace-pre-wrap">${escapeHTML(e.notes)}</div>` : '';
      return `
        <div class="flex items-start justify-between gap-3">
          <div class="flex-1">
            <div class="text-base font-semibold flex items-center gap-2">
              <span class="cursor-grab select-none text-slate-400" title="Dra for å flytte">≡</span>
              ${title}
            </div>
            <div class="mt-1 text-xs text-slate-600 flex flex-wrap gap-2">${meta}</div>
            ${ages} ${notes}
          </div>
          <div class="shrink-0 flex gap-1">
            <button data-act="view" class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm">Vis</button>
            <button data-act="edit" class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm">Rediger</button>
            <button data-act="dup" class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm">Dupliser</button>
            <button data-act="copy" class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm">Kopier</button>
            <button data-act="del" class="rounded-xl border border-red-300 bg-red-50 px-2 py-1 text-xs text-red-700 shadow-sm">Slett</button>
          </div>
        </div>
      `;
    }

    // ---------- Render-funksjoner (tegner UI) ----------
    function render(){
      const systemYear  = dayjs().year();
      const systemMonth = dayjs().month() + 1;
      const crossesYear = !isMobile() && state.viewMode === 'rolling' && state.year === systemYear && systemMonth !== 1;
      const yearLabelText = state.viewMode === 'rolling' ? (crossesYear ? `${state.year}–${state.year + 1}` : `${state.year}`) : `${state.year}`;

      $('#year-label').textContent = yearLabelText;
      $('#event-year').textContent = String(state.year);

      renderLegend();
      renderCalendar();
      renderList();
      renderBank();
      renderWeeks();
      renderAgeEditor();
      renderAdminEvents();

      const fAge = $('#f-age');
      if(fAge){
        fAge.innerHTML = `<option value="">Alle</option>` + (state.ageGroups||[]).map(g=>`<option value="${g.id}">${g.label}</option>`).join('');
      }

      lsSet(KEY.YEAR, state.year);
      lsSet(KEY.VIEW, state.viewMode);
    }

    function renderLegend(){
      const el=$('#legend'); el.innerHTML='';
      Object.entries(COLORS).forEach(([k,c])=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between';
        row.innerHTML=`<span class="flex items-center gap-2"><span class="inline-block h-2.5 w-2.5 rounded-full" style="background:${c}"></span>${k}</span>`;
        el.appendChild(row);
      });
    }

    function renderCalendar(){
      const grid = $('#calendar-grid');
      grid.innerHTML = '';

      if (isMobile()){
        grid.appendChild(renderMonth(state.year, state.month, { withNav:true }));
        return;
      }

      const systemYear = dayjs().year(), systemMonth = dayjs().month() + 1;
      let months = [], crossesYear = false;
      if (state.viewMode === 'full'){
        for (let m = 1; m <= 12; m++) months.push({ y: state.year, m });
      } else {
        if (state.year === systemYear){
          for (let m = systemMonth; m <= 12; m++) months.push({ y: state.year, m });
          for (let m = 1; m <  systemMonth; m++) months.push({ y: state.year + 1, m });
          crossesYear = (systemMonth !== 1);
        } else {
          for (let m = 1; m <= 12; m++) months.push({ y: state.year, m });
        }
      }

      const oldHeader = grid.previousElementSibling;
      if (oldHeader && oldHeader.dataset?.role === 'year-header') oldHeader.remove();
      const h = document.createElement('h2');
      h.dataset.role = 'year-header';
      h.className = 'text-xl font-bold text-center mb-4';
      h.textContent = state.viewMode === 'rolling' ? (crossesYear ? `${state.year}–${state.year + 1}` : `${state.year}`) : `${state.year}`;
      grid.parentNode.insertBefore(h, grid);

      months.forEach(({ y, m }) => {
        const el = renderMonth(y, m);
        el.title = dayjs(`${y}-${String(m).padStart(2,'0')}-01`).format('MMMM YYYY');
        grid.appendChild(el);
      });
    }

    function renderMonth(year, month, opts = { withNav:false }){
      const wrap=document.createElement('div'); wrap.className='rounded-2xl border bg-white shadow-sm card';
      const header=document.createElement('div'); header.className='flex items-center justify-between border-b p-4';
      const title = dayjs(`${year}-${String(month).padStart(2,'0')}-01`).format('MMMM');

      if (opts.withNav){
        header.innerHTML = `
          <button class="nav-btn rounded-xl border bg-white px-3 py-1.5 shadow-sm">◀</button>
          <div class="text-lg font-semibold">${title} ${year}</div>
          <button class="nav-btn rounded-xl border bg-white px-3 py-1.5 shadow-sm">▶</button>
        `;
        const btns = header.querySelectorAll('.nav-btn');
        btns[0].onclick = () => { let m = state.month - 1, y = state.year; if (m < 1){ m = 12; y--; } state.month = m; state.year = y; render(); };
        btns[1].onclick = () => { let m = state.month + 1, y = state.year; if (m > 12){ m = 1; y++; } state.month = m; state.year = y; render(); };
      } else {
        header.innerHTML=`<h3 class="text-lg font-semibold">${title}</h3>`;
      }

      const body=document.createElement('div'); body.className='p-2';
      const daysHeader=document.createElement('div'); daysHeader.className='grid grid-cols-7 gap-1 text-xs text-slate-500 px-1';
      'man tir ons tor fre lør søn'.split(' ').forEach(w=>{ const d=document.createElement('div'); d.className='px-1 py-1 text-center font-medium uppercase'; d.textContent=w; daysHeader.appendChild(d); });

      const cells=document.createElement('div'); cells.className='mt-1 grid grid-cols-7 gap-1';
      const first=dayjs(`${year}-${String(month).padStart(2,'0')}-01`);
      const leading=(first.day()+6)%7; const days=first.daysInMonth();
      for(let i=0;i<leading;i++) cells.appendChild(emptyCell());
      for(let d=1; d<=days; d++) cells.appendChild(dayCell(first.date(d)));
      const total=leading+days; const trail=(7-(total%7))%7; for(let i=0;i<trail;i++) cells.appendChild(emptyCell());

      body.append(daysHeader, cells); wrap.append(header, body); return wrap;
    }

    function emptyCell(){ const d = document.createElement('div'); d.className = 'min-h-[80px] rounded-xl border bg-white/70 p-1 opacity-50'; return d; }
    function dayCell(d){
      const key = d.format('YYYY-MM-DD');
      let evts = sortEventsByDayOrder(key, state.events.filter(e => dayjs(e.date).isSame(d, 'day')));
      const box = document.createElement('div');
      box.className = 'daycell relative min-h-[100px] rounded-xl border bg-white/70 p-1.5 hover:bg-blue-50 cursor-pointer';
      box.addEventListener('click', () => { hideTooltip(); if (evts.length > 0) openDayView(key, evts); else openDialog({ date: key }); });
      if(evts.length === 0){ attachTipHandlers(box, `<div class="font-semibold">${d.format('dddd D. MMMM')}</div>`); }

      if (d.day() === 1) {
        box.classList.add('pb-5');
        const chip = document.createElement('div');
        chip.className = 'absolute left-1 bottom-1 rounded-md bg-slate-200 text-[10px] px-1.5 py-0.5 shadow-sm';
        chip.textContent = `Uke ${d.isoWeek()}`;
        box.appendChild(chip);
      }

      const uniqueTypes = Array.from(new Set(evts.map(e => e.type))).slice(0,4);
      const dotsHTML = uniqueTypes.map(t => `<span class='inline-block h-2.5 w-2.5 rounded-full' style='background:${COLORS[t]||'#6b7280'}'></span>`).join('');
      const top = document.createElement('div');
      top.className = 'flex items-center justify-between text-xs text-slate-600';
      top.innerHTML = `<span class="font-medium">${d.date()}</span><span class="flex gap-1">${dotsHTML}</span>`;

      const list = document.createElement('div'); list.className = 'mt-1 flex flex-col gap-0.5';
      evts.slice(0,3).forEach(e => {
        const row = document.createElement('div');
        row.className = 'truncate text-xs flex items-center gap-1';
        row.innerHTML = `<span class='inline-block h-2 w-2 rounded-full' style='background:${COLORS[e.type]||'#6b7280'}'></span><span class='font-medium truncate'>${escapeHTML(e.title || e.type)}</span>`;
        attachTipHandlers(row, eventTooltipHTML(e));
        list.appendChild(row);
      });
      if(evts.length > 3){ const more = document.createElement('div'); more.className = 'text-[10px] text-slate-500'; more.textContent = `+${evts.length-3} flere…`; list.appendChild(more); }

      box.append(top, list); return box;
    }

    function renderList(){
      const tbody=$('#tbl-events'); tbody.innerHTML='';
      const yearEvents = state.events
        .filter(e => dayjs(e.date).year() === state.year)
        .sort((a,b)=>{
          if (a.date !== b.date) return a.date.localeCompare(b.date);
          const order = getOrderForDate(a.date);
          const ia = order.indexOf(a.id), ib = order.indexOf(b.id);
          const A = ia === -1 ? Infinity : ia, B = ib === -1 ? Infinity : ib;
          return A - B || (a.title||'').localeCompare(b.title||'');
        });

      yearEvents.forEach(e=>{
        const tr=document.createElement('tr'); tr.className='border-t';
        const safeTitle = e.title ? escapeHTML(e.title) : '<span class="opacity-50">(uten tittel)</span>';
        tr.innerHTML=`
          <td class='py-1 whitespace-nowrap'>${dayjs(e.date).format('DD.MM.YYYY')}</td>
          <td class='max-w-[260px] truncate'>${safeTitle}</td>
          <td><span class='inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs'><span class='inline-block h-2.5 w-2.5 rounded-full' style='background:${COLORS[e.type]||'#6b7280'}'></span>${escapeHTML(e.type||'')}</span></td>
          <td class='max-w-[160px] truncate'>${escapeHTML(e.location||'–')}</td>
          <td>${escapeHTML(e.modality||'–')}</td>
          <td>${escapeHTML(e.intensity||'–')}</td>
          <td>${(e.shooting&&e.shooting.skudd)||0}</td>
          <td class='text-right'>
            <div class="inline-flex gap-1">
              <button class='btn-view rounded-xl border bg-white px-2 py-1 text-xs shadow-sm'>Vis</button>
              <button class='btn-edit rounded-xl border bg-white px-2 py-1 text-xs shadow-sm'>Rediger</button>
            </div>
          </td>`;
        tr.querySelector('.btn-edit').addEventListener('click', ()=> openDialog({...e}));
        tr.querySelector('.btn-view').addEventListener('click', ()=> openViewDialog(e));
        attachTipHandlers(tr, eventTooltipHTML(e));
        tbody.appendChild(tr);
      });
    }

    function renderBank(){
      const q=($('#q-bank').value||'').toLowerCase();
      const age=$('#f-age').value;
      const type=$('#f-type').value;
      const box=$('#bank-cards'); box.innerHTML='';
      state.bank
        .filter(t=> (!q||t.name.toLowerCase().includes(q)) && (!age||(t.age||[]).includes(age)) && (!type||t.type===type))
        .forEach(t=> box.appendChild(bankCard(t)) );
    }

    function bankCard(t){
      const c=document.createElement('div');
      c.className='rounded-2xl border bg-white shadow-sm card';
      c.innerHTML=`
        <div class='border-b p-4 flex items-center justify-between'>
          <h4 class='text-base font-semibold text-[color:var(--brand)]'>
            <span class='inline-block h-2.5 w-2.5 rounded-full mr-2' style='background:${COLORS[t.type]||'#6b7280'}'></span>
            ${escapeHTML(t.name)}
          </h4>
          <div class='flex gap-1 text-xs'>${(t.age||[]).map(a=>`<span class='rounded-full border px-2 py-0.5'>${escapeHTML(a)}</span>`).join('')}</div>
        </div>
        <div class='p-4 text-sm space-y-1'>
          <div><span class='font-medium'>Modalitet:</span> ${escapeHTML(t.modality||'–')}</div>
          <div><span class='font-medium'>Intensitet:</span> ${escapeHTML(t.intensity||'–')}</div>
          <div><span class='font-medium'>Varighet:</span> ${t.durationMin? escapeHTML(String(t.durationMin))+' min':'–'}</div>
          <div><span class='font-medium'>Skudd:</span> ${(t.shooting&&t.shooting.skudd)||0}</div>
          ${(t.shooting?.tema?.length) ? `<div class='flex flex-wrap gap-1 mt-2'>${t.shooting.tema.map(x=>`<span class='rounded-full border px-2 py-0.5 text-xs'>${escapeHTML(x)}</span>`).join('')}</div>` : ''}
          <div class='pt-2 flex flex-wrap gap-2'>
            <button data-act="plan" class='rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Planlegg</button>
            <button data-act="edit" class='rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Rediger</button>
            <button data-act="dup"  class='rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Dupliser</button>
            <button data-act="del"  class='text-red-700 border-red-300 bg-red-50 rounded-xl border px-3 py-1.5 shadow-sm'>Slett</button>
          </div>
        </div>`;

      c.querySelector('[data-act="plan"]').addEventListener('click', ()=> openDialog(fromTemplate(t)));
      c.querySelector('[data-act="edit"]').addEventListener('click', ()=> openBankDialog({...t}));
      c.querySelector('[data-act="dup"]').addEventListener('click', ()=> openBankDialog({ ...t, id: uid(), name: (t.name||'') + ' (kopi)' }));
      c.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
        if(!confirm('Slette denne bank-malen?')) return;
        state.bank = state.bank.filter(x=>x.id!==t.id);
        lsSet(KEY.BANK, state.bank);
        renderBank();
        await supaDeleteBankTemplate(t.id);
      });
      return c;
    }

    function fromTemplate(t){
      return {
        id:uid(), title:t.name, type:t.type, date:dayjs().format('YYYY-MM-DD'),
        modality:t.modality, intensity:t.intensity, durationMin:t.durationMin,
        age:t.age||[], shooting:t.shooting||{stilling:'',skudd:0,tema:[]},
        raceSubtype:t.raceSubtype, notes:t.notes||'', roles:{}, location:''
      };
    }

    // ---------- Dialog-funksjoner (åpner/lukker popups) ----------
    function openDialog(data){
      const existing = state.events.find(x=>x.id===data.id);
      const isEdit = !!existing;
      const model = { id:uid(), title:'', type:'Trening', date:dayjs().format('YYYY-MM-DD'), modality:'', intensity:'', durationMin:60, age:[], shooting:{stilling:'',skudd:0,tema:[]}, notes:'', raceSubtype:'', roles:{}, location:'', ...data };

      const body=$('#dlg-body');
      $('#dlg-title').textContent = isEdit?'Rediger hendelse':'Ny hendelse';
      $('#btn-delete').classList.toggle('hidden',!isEdit);
      $('#btn-save')?.classList.remove('hidden');

      const field=(label,inputHTML)=>`<div><label class='text-sm font-medium'>${label}</label>${inputHTML}</div>`;
      const ageChks = (state.ageGroups||[]).map(g=>`<label class='inline-flex items-center gap-2 rounded-xl border px-2 py-1'><input data-age='${g.id}' type='checkbox' ${model.age.includes(g.id)?'checked':''}/> <span class='text-sm'>${g.label}</span></label>`).join('');

      body.innerHTML=`
        ${field('Tittel', `<input id='f-title' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.title)}" placeholder='F.eks. I3 drag + 30 skudd'/>`)}
        <div class='grid grid-cols-2 gap-3'>
          ${field('Type', select('f-type', ['Trening','Skyting','Konkurranse','Samling','Restitusjon','Annet'], model.type))}
          ${field('Dato', `<input id='f-date' type='date' class='mt-1 w-full rounded-xl border px-3 py-2' value='${dayjs(model.date).format('YYYY-MM-DD')}'/>`)}
        </div>
        ${field('Sted/plassering', `<input id='f-loc' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.location||'')}" placeholder='F.eks. Sørli'/>`)}
        <div class='grid grid-cols-2 gap-3'>
          ${field('Modalitet', select('f-mod', MODALITETER, model.modality))}
          ${field('Intensitet', select('f-int', INTENS, model.intensity))}
        </div>
        <div class='grid grid-cols-3 gap-3'>
          ${field('Varighet (min)', `<input id='f-dur' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.durationMin||60}'/>`)}
          ${field('Skytestilling', select('f-still', ['Liggende','Stående','Kombinert','Variert','Konk'], model.shooting.stilling||''))}
          ${field('Skudd', `<input id='f-skudd' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.shooting.skudd||0}'/>`)}
        </div>
        <div>
          <label class='text-sm font-medium'>Tema (skyting)</label>
          <div class='mt-1 flex flex-wrap gap-1' id='tema-tags'></div>
          <div class='mt-1 flex gap-2'>
            <input id='f-tema' class='w-full rounded-xl border px-3 py-2' placeholder='Skriv tema og Enter'/>
            <button id='add-tema' class='rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Legg til</button>
          </div>
        </div>
        <div>
          <label class='text-sm font-medium'>Målgruppe</label>
          <div class='mt-1 flex flex-wrap gap-2'>${ageChks}</div>
        </div>
        <div>
          <label class='text-sm font-medium'>Notater</label>
          <textarea id='f-notes' rows='4' class='mt-1 w-full rounded-xl border px-3 py-2' placeholder='Detaljer, fokus, utstyr…'>${escapeHTML(model.notes||'')}</textarea>
        </div>`;

      function refreshTema(){
        const holder = $('#tema-tags'); holder.innerHTML = '';
        (model.shooting.tema || []).forEach((t, i) => {
          const b = document.createElement('span');
          b.className = 'inline-flex items-center gap-2 rounded-full border px-2 py-0.5 text-xs';
          b.textContent = t;
          const x = document.createElement('button'); x.textContent = '×'; x.className = 'ml-1';
          x.onclick = () => { model.shooting.tema.splice(i, 1); refreshTema(); };
          b.appendChild(x); holder.appendChild(b);
        });
      }
      refreshTema();
      const addTemaFunc = () => {
        const input = $('#f-tema');
        const v = input.value.trim(); if(!v) return;
        model.shooting.tema = Array.from(new Set([...(model.shooting.tema||[]), v]));
        input.value=''; refreshTema();
      };
      $('#add-tema').onclick = addTemaFunc;
      $('#f-tema').onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); addTemaFunc(); }};

      $('#btn-save').onclick = async () => {
        const wasNew = !state.events.some(x => x.id === model.id);
        Object.assign(model, {
          title: $('#f-title').value.trim(), type: $('#f-type').value, date: $('#f-date').value,
          location: $('#f-loc').value.trim(), modality: $('#f-mod').value, intensity: $('#f-int').value,
          durationMin: parseInt($('#f-dur').value) || 60,
          shooting: { stilling: $('#f-still').value, skudd: parseInt($('#f-skudd').value) || 0, tema: model.shooting.tema || [] },
          notes: $('#f-notes').value,
          age: (state.ageGroups||[]).map(g => g.id).filter(id => $(`[data-age="${id}"]`).checked),
        });

        const i = state.events.findIndex(x => x.id === model.id);
        if (i >= 0) state.events[i] = model; else state.events.push(model);
        lsSet(KEY.EVENTS, state.events);
        if (wasNew){ const ids = getOrderForDate(model.date); setOrderForDate(model.date, [...ids, model.id]); }
        render(); // render() må kalles FØR supaUpsertEvent for umiddelbar UI-oppdatering
        await supaUpsertEvent(model);
        closeDialog();
      };
      $('#btn-delete').onclick=async ()=>{
        state.events=state.events.filter(x=>x.id!==model.id); lsSet(KEY.EVENTS,state.events);
        const ids = getOrderForDate(model.date).filter(x=> x !== model.id); setOrderForDate(model.date, ids);
        render();
        await supaDeleteEvent(model);
        closeDialog();
      };

      $('#dialog').classList.remove('hidden'); $('#dialog').classList.add('flex');
    }

    function openViewDialog(model){
      const body = $('#dlg-body');
      $('#dlg-title').textContent = 'Vis hendelse';
      $('#btn-delete').classList.add('hidden'); $('#btn-save').classList.add('hidden');
      const row = (label, value) => `<div class="grid grid-cols-3 gap-3 items-start"><div class="text-sm font-medium text-slate-700 col-span-1">${label}</div><div class="text-sm col-span-2">${value||'–'}</div></div>`;
      const ageChips = (model.age||[]).map(a=>`<span class="rounded-full border px-2 py-0.5 text-xs mr-1">${escapeHTML(a)}</span>`).join('');
      const tema = (model.shooting?.tema||[]).length ? `<div class="mt-1 flex flex-wrap gap-1">${model.shooting.tema.map(t=>`<span class="rounded-full border px-2 py-0.5 text-[10px]">${escapeHTML(t)}</span>`).join('')}</div>` : '';
      body.innerHTML = `
        ${row('Tittel', escapeHTML(model.title))}
        ${row('Dato', dayjs(model.date).format('DD.MM.YYYY'))}
        ${row('Sted', escapeHTML(model.location||''))}
        ${row('Type', escapeHTML(model.type))}
        ${row('Modalitet', escapeHTML(model.modality))}
        ${row('Intensitet', escapeHTML(model.intensity))}
        ${row('Varighet', model.durationMin? escapeHTML(String(model.durationMin))+' min':'–')}
        ${row('Målgrupper', ageChips || '–')}
        ${row('Skyting', `${escapeHTML(model.shooting?.stilling||'–')}, ${model.shooting?.skudd||0} skudd ${tema}`)}
        ${model.type==='Konkurranse' ? row('Konkurranse-type', escapeHTML(model.raceSubtype||'')) : ''}
        ${row('Notater', `<div class="whitespace-pre-wrap">${escapeHTML(model.notes)}</div>`)}
        ${row('Roller', Object.entries(model.roles||{}).filter(([,v])=>v).map(([k,v])=>`<div><span class="font-medium">${escapeHTML(k)}:</span> ${escapeHTML(v)}</div>`).join('') || '–')}
      `;
      $('#dialog').classList.remove('hidden'); $('#dialog').classList.add('flex');
    }

    function openBankDialog(data = {}){
      const existing = state.bank.find(x => x.id === data.id);
      const isEdit = !!existing;
      const model = { id: uid(), name: '', type: 'Trening', modality: '', intensity: '', durationMin: 60, age: [], shooting: { stilling:'', skudd:0, tema:[] }, raceSubtype: '', notes: '', ...data };

      const body = $('#dlg-body');
      $('#dlg-title').textContent = isEdit ? 'Rediger bank-mal' : 'Ny bank-mal';
      $('#btn-delete').classList.toggle('hidden', !isEdit);
      $('#btn-save')?.classList.remove('hidden');

      const field=(label,inputHTML)=>`<div><label class='text-sm font-medium'>${label}</label>${inputHTML}</div>`;
      const ageChks = (state.ageGroups||[]).map(g=>`<label class='inline-flex items-center gap-2 rounded-xl border px-2 py-1'><input data-age='${g.id}' type='checkbox' ${model.age.includes(g.id)?'checked':''}/> <span class='text-sm'>${g.label}</span></label>`).join('');

      body.innerHTML = `
        ${field('Navn', `<input id='bk-name' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.name)}" placeholder='F.eks. I3 bakkedrag + styrke'/>`)}
        <div class='grid grid-cols-2 gap-3'>
          ${field('Type', select('bk-type', ['Trening','Skyting','Konkurranse','Samling','Restitusjon','Annet'], model.type))}
          ${field('Modalitet', select('bk-mod', MODALITETER, model.modality))}
        </div>
        <div class='grid grid-cols-2 gap-3'>
          ${field('Intensitet', select('bk-int', INTENS, model.intensity))}
          ${field('Varighet (min)', `<input id='bk-dur' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.durationMin||60}'/>`)}
        </div>
        <div>
          <label class='text-sm font-medium'>Målgruppe</label>
          <div class='mt-1 flex flex-wrap gap-2'>${ageChks}</div>
        </div>
        <div>
          <label class='text-sm font-medium'>Notater</label>
          <textarea id='bk-notes' rows='4' class='mt-1 w-full rounded-xl border px-3 py-2' placeholder='Beskrivelse, progresjon…'>${escapeHTML(model.notes||'')}</textarea>
        </div>
      `;
      $('#btn-save').onclick = async ()=>{
        Object.assign(model, {
          name: $('#bk-name').value.trim(), type: $('#bk-type').value, modality: $('#bk-mod').value,
          intensity: $('#bk-int').value, durationMin: parseInt($('#bk-dur').value) || 60,
          notes: $('#bk-notes').value, age: (state.ageGroups||[]).map(g => g.id).filter(id => $(`[data-age="${id}"]`).checked)
        });
        if(!model.name){ alert('Navn kan ikke være tomt.'); return; }
        const i = state.bank.findIndex(x => x.id === model.id);
        if (i >= 0) state.bank[i] = model; else state.bank.unshift(model);
        lsSet(KEY.BANK, state.bank);
        renderBank();
        await supaUpsertBankTemplate(model);
        closeDialog();
      };
      $('#btn-delete').onclick = async ()=>{
        if(!confirm('Slette denne bank-malen?')) return;
        state.bank = state.bank.filter(x => x.id !== model.id);
        lsSet(KEY.BANK, state.bank);
        renderBank();
        await supaDeleteBankTemplate(model.id);
        closeDialog();
      };
      $('#dialog').classList.remove('hidden'); $('#dialog').classList.add('flex');
    }

    function select(id, options, selected){
      return `<select id='${id}' class='mt-1 w-full rounded-xl border px-3 py-2'>${options.map(opt=>`<option ${opt===selected?'selected':''}>${opt}</option>`).join('')}</select>`;
    }
    
    // ---------- Admin UI-funksjoner ----------
    function renderWeeks(){
      const tbody = $('#tbl-weeks'); if(!tbody) return; tbody.innerHTML = '';
      const yearWeeks = {}; let d = dayjs(state.year+'-01-01').startOf('isoWeek');
      const end = dayjs(state.year+'-12-31');
      while(d.isBefore(end.add(1,'day'))){ yearWeeks[d.isoWeek()] = true; d = d.add(7,'day'); }

      Object.keys(yearWeeks).map(n=>+n).sort((a,b)=>a-b).forEach(wk=>{
        const { code = 'BAS', note = '' } = state.weeks[wk] || {};
        const tr = document.createElement('tr'); tr.className = 'border-t';
        tr.innerHTML = `
          <td class="p-2">${wk}</td>
          <td><select data-wk="${wk}" class="rounded-xl border px-2 py-1">${WEEKCODES.map(c=>`<option ${c===code?'selected':''}>${c}</option>`).join('')}</select></td>
          <td><input data-wkn="${wk}" class="w-full rounded-xl border px-2 py-1" value="${escapeHTML(note)}"/></td>`;
        tbody.appendChild(tr);
      });
      $$('select[data-wk], input[data-wkn]').forEach(el => {
        el.onchange = el.oninput = async () => {
          const wk = +el.dataset.wk || +el.dataset.wkn;
          state.weeks[wk] = state.weeks[wk] || { code: 'BAS', note: '' };
          if (el.tagName === 'SELECT') state.weeks[wk].code = el.value;
          else state.weeks[wk].note = el.value;
          lsSet(KEY.WEEKS, state.weeks);
          await supaUpsertWeek(state.year, wk, state.weeks[wk].code, state.weeks[wk].note);
        };
      });
    }

    function renderAgeEditor(){
      const holder = $('#age-editor'); if(!holder) return;
      holder.innerHTML = (state.ageGroups||[]).map((g,i)=>`
        <div class="grid grid-cols-[1fr_2fr_auto] gap-2 items-center">
          <input data-age-id="${i}" class="rounded-xl border px-3 py-1.5" value="${escapeHTML(g.id)}" placeholder="ID (f.eks. 13-14)">
          <input data-age-label="${i}" class="rounded-xl border px-3 py-1.5" value="${escapeHTML(g.label)}" placeholder="Label (f.eks. 13–14 år)">
          <button data-age-del="${i}" class="rounded-xl border bg-white px-3 py-1.5 text-red-700 border-red-300">Slett</button>
        </div>`).join('');
      holder.querySelectorAll('[data-age-del]').forEach(btn=>{
        btn.onclick = ()=>{
          state.ageGroups.splice(+btn.dataset.ageDel, 1);
          renderAgeEditor(); // Re-render for å oppdatere UI
        };
      });
    }

    function renderAdminEvents(){
      const tb = $('#admin-events'); if(!tb) return;
      const q = ($('#admin-q')?.value||'').toLowerCase().trim();
      const from = $('#admin-from')?.value, to = $('#admin-to')?.value;
      let rows = [...state.events];
      if(from) rows = rows.filter(e => e.date >= from);
      if(to)   rows = rows.filter(e => e.date <= to);
      if(q)    rows = rows.filter(e => [e.title,e.type,e.location,e.modality,e.intensity].some(x => (x||'').toLowerCase().includes(q)));
      rows.sort((a,b)=> a.date.localeCompare(b.date));
      tb.innerHTML = rows.map(e=>`
        <tr class="border-t">
          <td class="p-2 whitespace-nowrap">${dayjs(e.date).format('DD.MM.YYYY')}</td>
          <td class="p-2 max-w-[240px] truncate">${escapeHTML(e.title||'(uten tittel)')}</td>
          <td class="p-2">${escapeHTML(e.type||'')}</td>
          <td class="p-2 max-w-[180px] truncate">${escapeHTML(e.location||'')}</td>
          <td class="p-2">${escapeHTML(e.intensity||'')}</td>
          <td class="p-2 text-right"><button class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm" data-edit="${e.id}">Rediger</button></td>
        </tr>`).join('');
      tb.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick = ()=>{
          const ev = state.events.find(x=>x.id===btn.dataset.edit);
          if(ev) openDialog({...ev});
        };
      });
    }

    // ---------- Skyteresultater ----------
    async function supaLoadResults(limit = 1000){
      const { data, error } = await supabase.from(TBL.results).select('*').order('date', { ascending: false }).limit(limit);
      if (error) { alert('Kunne ikke hente skyteresultater.'); return; }
      state.resultsAll = (data || []).map(mapResultFromDb);
      const names = Array.from(new Set(state.resultsAll.map(r => r.athlete).filter(Boolean))).sort();
      $('#res-athlete-list').innerHTML = names.map(n=>`<option value="${escapeHTML(n)}"></option>`).join('');
      const exs = Array.from(new Set(state.resultsAll.map(r => r.exercise).filter(Boolean))).sort();
      $('#res-exercise-list').innerHTML = exs.map(n=>`<option value="${escapeHTML(n)}"></option>`).join('');
      applyResultsFilterAndSort();
      renderResults();
      renderResultsBests();
    }
    function applyResultsFilterAndSort(){
      const qName = ($('#res-filter-name')?.value || '').toLowerCase().trim();
      const qEx   = ($('#res-filter-ex')?.value   || '').toLowerCase().trim();
      const from  = $('#res-filter-from')?.value, to = $('#res-filter-to')?.value;
      const sort  = $('#res-sort')?.value || 'date_desc';
      const lim   = state.resultsLimit || 100;

      let rows = (state.resultsAll || []).filter(r => {
        const p = Number(r.pointsProne) || 0, s = Number(r.pointsStand) || 0;
        return !(p === 0 && s === 0);
      });
      if (qName) rows = rows.filter(r => (r.athlete||'').toLowerCase().includes(qName));
      if (qEx)   rows = rows.filter(r => (r.exercise||'').toLowerCase().includes(qEx));
      if (from)  rows = rows.filter(r => r.date >= from);
      if (to)    rows = rows.filter(r => r.date <= to);
      rows.sort((a,b)=>{
        switch (sort){
          case 'date_asc':   return a.date.localeCompare(b.date);
          case 'date_desc':  return b.date.localeCompare(a.date);
          case 'total_desc': return (b.pointsTotal||0) - (a.pointsTotal||0);
          case 'total_asc':  return (a.pointsTotal||0) - (b.pointsTotal||0);
          case 'prone_desc': return (b.pointsProne||0) - (a.pointsProne||0);
          case 'stand_desc': return (b.pointsStand||0) - (a.pointsStand||0);
          case 'name_asc':   return (a.athlete||'').localeCompare(b.athlete||'');
          default: return b.date.localeCompare(a.date);
        }
      });
      state.results = rows.slice(0, lim);
      $('#res-count').textContent = `${rows.length} treff`;
      return state.results;
    }

    function renderResults(){
      const dEl = $('#res-date'); if(dEl && !dEl.value) dEl.value = dayjs().format('YYYY-MM-DD');
      const p = parseInt($('#res-prone')?.value || '0', 10) || 0;
      const s = parseInt($('#res-stand')?.value || '0', 10) || 0;
      $('#res-total').value = String(p+s);
      $('#res-table').innerHTML = (state.results||[]).map(r=>`
        <tr class="border-t">
          <td class="p-2 whitespace-nowrap">${dayjs(r.date).format('DD.MM.YYYY')}</td>
          <td class="p-2">${escapeHTML(r.athlete)}</td>
          <td class="p-2">${escapeHTML(r.exercise)}</td>
          <td class="p-2 text-right">${r.pointsProne}</td>
          <td class="p-2 text-right">${r.pointsStand}</td>
          <td class="p-2 text-right font-medium">${r.pointsTotal}</td>
        </tr>`).join('');
    }

    // ENDRING: Generell funksjon for å lage Topp 5 lister
    function renderBestTop5ByField(elementId, dataList) {
        const ul = document.getElementById(elementId);
        if (!ul) return;
        ul.innerHTML = dataList.length
            ? dataList.map(x => `
                <li class="flex items-center justify-between">
                  <span class="truncate">${escapeHTML(x.athlete)}${x.exercise ? ' – ' + escapeHTML(x.exercise) : ''}</span>
                  <span class="tabular-nums font-semibold">${x.value}</span>
                </li>`).join('')
            : `<li class="text-slate-500">Ingen data.</li>`;
    }
    
    // ENDRING: Generell funksjon for å kalkulere Topp 5
    function computeTop5ByFieldUnique(field) {
        const bestByAthlete = new Map();
        for (const r of (state.resultsAll || [])) {
            const athlete = (r.athlete || '').trim();
            const value = Number(r[field] || 0);
            if (!athlete || value <= 0) continue;
            const current = bestByAthlete.get(athlete);
            if (!current || value > current.value) {
                bestByAthlete.set(athlete, { athlete, value, exercise: r.exercise || '', date: r.date });
            }
        }
        return Array.from(bestByAthlete.values()).sort((a, b) => b.value - a.value).slice(0, 5);
    }
    
    function renderResultsBests(){
      $('#res-best-meta').textContent = `${(state.resultsAll||[]).length} registreringer totalt`;
      // Topp 5 Total
      const top5total = computeTop5ByFieldUnique('pointsTotal');
      renderBestTop5ByField('res-best-top5', top5total);
      // Topp 5 Liggende
      const top5prone = computeTop5ByFieldUnique('pointsProne');
      renderBestTop5ByField('res-best-top5-prone', top5prone);
      // Topp 5 Stående
      const top5stand = computeTop5ByFieldUnique('pointsStand');
      renderBestTop5ByField('res-best-top5-stand', top5stand);
    }

    // ---------- Init og event listeners ----------
    function switchTab(name){
      $$('.tab-section').forEach(s=> s.classList.add('hidden'));
      $('#tab-'+name)?.classList.remove('hidden');
      $$('.tab-btn').forEach(b=>{
        const isActive = b.dataset.tab===name;
        b.classList.toggle('bg-slate-50', isActive);
        b.classList.toggle('border-blue-300', isActive);
      });
    }

    function bindUiHandlers(){
      $$('.tab-btn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));
      $('#toggle-list')?.addEventListener('click', ()=> $('#event-list')?.classList.toggle('hidden'));
      $('#quick-trening')?.addEventListener('click', ()=> openDialog({ type:'Trening' }));
      $('#quick-skyting')?.addEventListener('click', ()=> openDialog({ type:'Skyting', shooting:{stilling:'Liggende',skudd:30,tema:[]} }));
      $('#quick-konk')?.addEventListener('click', ()=> openDialog({ type:'Konkurranse' }));
      $('#bank-new')?.addEventListener('click', ()=> openBankDialog({}));
      $('#btn-ics')?.addEventListener('click', ()=>{/* ICS eksport logikk her */});
      $('#btn-seed-bank')?.addEventListener('click', ()=>{/* Seed logikk her */});
      $('#btn-export-xlsx')?.addEventListener('click', ()=>{/* Excel eksport logikk her */});
$$('#admin-search, #admin-q, #admin-from, #admin-to').forEach(el => el.addEventListener('input', renderAdminEvents));
      $('#age-add')?.addEventListener('click', ()=>{
        state.ageGroups.push({ id:'ny', label:'Ny gruppe' }); render();
      });
      $('#age-save')?.addEventListener('click', async ()=>{
        const newList = [];
        $('#age-editor').querySelectorAll('div').forEach((row, idx)=>{
          const id = $(`[data-age-id="${idx}"]`).value.trim();
          const label = $(`[data-age-label="${idx}"]`).value.trim();
          if(id && label) newList.push({ id, label });
        });
        if(newList.length===0){ alert('Legg inn minst én gruppe.'); return; }
        state.ageGroups = newList; lsSet(KEY.AGES, state.ageGroups);
        await supaSaveAgeGroups();
        render();
        alert('Årsklasser lagret.');
      });
      const onFilter = debounce(()=>{ applyResultsFilterAndSort(); renderResults(); }, 120);
      ['res-filter-name','res-filter-ex','res-filter-from','res-filter-to','res-sort'].forEach(id => $(`#${id}`)?.addEventListener('input', onFilter));
      $('#res-clear')?.addEventListener('click', ()=>{
        ['res-filter-name','res-filter-ex','res-filter-from','res-filter-to'].forEach(id=> $(`#${id}`).value='');
        $('#res-sort').value='date_desc';
        onFilter();
      });
      $('#res-refresh')?.addEventListener('click', ()=> supaLoadResults());
      $('#res-load-more')?.addEventListener('click', ()=>{
        state.resultsLimit = (state.resultsLimit||100) + 200; onFilter();
      });
      $('#res-save')?.addEventListener('click', async ()=>{
        const model = {
          id: uid(), athlete: $('#res-athlete').value.trim(), exercise: $('#res-ex').value.trim(),
          date: $('#res-date').value, pointsProne: parseInt($('#res-prone').value || '0'), pointsStand: parseInt($('#res-stand').value || '0')
        };
        if(!model.athlete || !model.date){ alert('Utøver og dato må fylles ut.'); return; }
        try {
          const saved = await supaInsertResult(model);
          state.resultsAll.unshift(saved);
          applyResultsFilterAndSort(); renderResults(); renderResultsBests();
          $('#res-athlete').value=''; $('#res-ex').value=''; $('#res-prone').value=''; $('#res-stand').value=''; renderResults();
        } catch(err){ console.error('Lagre resultat feilet', err); alert('Kunne ikke lagre resultat.'); }
      });
    }

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
    function closeDialog(){ $('#dialog').classList.add('hidden'); $('#dialog').classList.remove('flex'); }

    async function init(){
      bindDialogChrome();
      bindUiHandlers();
      setupSidebarToggle();
      $('#year-label').onclick = ()=>{ state.viewMode = state.viewMode === 'rolling' ? 'full' : 'rolling'; render(); };
      switchTab('calendar');
      await supaLoadAll(state.year);
      supaRealtimeInit();
      $('#year-prev').onclick = () => { state.year--; render(); supaLoadAll(state.year); };
      $('#year-next').onclick = () => { state.year++; render(); supaLoadAll(state.year); };
      $$('#q-bank, #f-age, #f-type').forEach(el => el.addEventListener('input', renderBank));
      $('#btn-new').onclick = () => openDialog({ date: dayjs().format('YYYY-MM-DD') });
      $('#btn-print').onclick = () => window.print();
      await supaLoadResults(1000);
    }

    window.addEventListener('DOMContentLoaded', init);

  </script>
</body>
</html>
