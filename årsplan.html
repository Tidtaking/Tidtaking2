<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lørenskog Skiskyting – Årsplan & Øktbank</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --brand:#18469a; --brand2:#dbe723; }
    html,body{height:100%}
    @media print{ .no-print{display:none!important} }
    #lss-tooltip{ position:fixed; z-index:1000; pointer-events:none; transform:translate(-50%,-100%); max-width: min(88vw, 22rem); }
    @media (max-width: 767px){
      header h1{ font-size:1.125rem }
      header .no-print button,
      header .no-print label{ padding: .4rem .6rem; border-radius: .75rem; }
      #dialog .dialog-card{ width:100%; max-width:none; height:92vh; border-radius:0; display:flex; flex-direction:column; }
      #dialog .dialog-body{ overflow:auto; -webkit-overflow-scrolling: touch; flex:1 1 auto; }
    }
    .card{ border:1px solid rgb(226 232 240); box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .daycell{ transition: background-color .15s ease; }
    @media print{
      aside, nav, .no-print { display:none!important; }
      body { background:white; }
    }
  </style>

  <!-- Dayjs + plugins + norsk locale -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/weekday.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/localizedFormat.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/nb.min.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- XLSX (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Header / toolbar -->
  <header class="no-print border-b bg-white">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-3">
      <h1 class="font-bold text-xl text-[color:var(--brand)]">
        Lørenskog Skiskyting – <span id="year-label"></span>
      </h1>
      <div class="flex items-center gap-2">
        <button id="year-prev" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">◀</button>
        <span id="event-year" class="min-w-[3ch] text-center"></span>
        <button id="year-next" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">▶</button>

        <button id="btn-new" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">Ny</button>
        <button id="btn-ics" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">Eksporter ICS</button>
        <button id="btn-export-xlsx" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">Eksporter Excel</button>
        <label class="rounded-lg border bg-white px-3 py-1.5 shadow-sm cursor-pointer">
          Import JSON <input id="file-import" type="file" class="hidden" accept=".json" />
        </label>

        <button id="btn-toggle-sidebar" class="rounded-lg border px-3 py-1.5 shadow-sm" aria-pressed="true">Skjul sidepanel</button>
        <button id="btn-print" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">Skriv ut</button>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <main class="mx-auto max-w-7xl p-4">
    <div id="page-grid" class="grid gap-4 lg:grid-cols-[minmax(0,1fr)_360px]">
      <!-- MAIN -->
      <section class="space-y-4">
        <!-- Kalender -->
        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>

        <!-- Liste (kan toggles) -->
        <div id="event-list" class="rounded-2xl border bg-white shadow-sm">
          <div class="p-3 flex items-center justify-between">
            <div class="font-semibold">Liste</div>
            <button id="toggle-list" class="rounded-lg border bg-white px-3 py-1.5 shadow-sm">Skjul/vis</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 text-left">
                <tr>
                  <th class="py-2 px-2">Dato</th>
                  <th class="py-2 px-2">Tittel</th>
                  <th class="py-2 px-2">Type</th>
                  <th class="py-2 px-2">Sted</th>
                  <th class="py-2 px-2">Modalitet</th>
                  <th class="py-2 px-2">Intensitet</th>
                  <th class="py-2 px-2">Skudd</th>
                  <th class="py-2 px-2 text-right">Handling</th>
                </tr>
              </thead>
              <tbody id="tbl-events"></tbody>
            </table>
          </div>
        </div>

        <!-- Øktbank -->
        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div class="mb-3 flex gap-2 items-center">
            <input id="q-bank" class="rounded-md border px-3 py-2" placeholder="Søk i øktbank…" />
            <select id="f-age" class="rounded-md border px-3 py-2"></select>
            <select id="f-type" class="rounded-md border px-3 py-2">
              <option value="">Alle typer</option>
              <option>Trening</option><option>Skyting</option><option>Konkurranse</option>
              <option>Samling</option><option>Restitusjon</option><option>Annet</option>
            </select>
            <button id="bank-new" class="rounded-md border bg-white px-3 py-2 shadow-sm">Ny bank-mal</button>
          </div>
          <div id="bank-cards" class="grid gap-3 md:grid-cols-2 xl:grid-cols-3"></div>
        </div>

        <!-- Ukeplan-koder -->
        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div class="font-semibold mb-2">Ukeplan</div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 text-left"><tr><th class="p-2">Uke</th><th class="p-2">Kode</th><th class="p-2">Notat</th></tr></thead>
              <tbody id="tbl-weeks"></tbody>
            </table>
          </div>
        </div>

        <!-- Admin-liste -->
        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div class="mb-3 flex gap-2">
            <input id="admin-q" class="rounded-md border px-3 py-2" placeholder="Søk…" />
            <input id="admin-from" type="date" class="rounded-md border px-3 py-2" />
            <input id="admin-to" type="date" class="rounded-md border px-3 py-2" />
            <button id="admin-search" class="rounded-md border bg-white px-3 py-2 shadow-sm">Filtrer</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100 text-left">
                <tr><th class="p-2">Dato</th><th class="p-2">Tittel</th><th class="p-2">Type</th><th class="p-2">Sted</th><th class="p-2">Intensitet</th><th class="p-2"></th></tr>
              </thead>
              <tbody id="admin-events"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SIDEBAR -->
      <aside id="sidebar" class="space-y-4">
        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div class="font-semibold mb-2">Forklaring</div>
          <div id="legend" class="space-y-1"></div>
        </div>

        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div class="font-semibold mb-2">Aldersgrupper</div>
          <div id="age-editor" class="space-y-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="age-add" class="rounded-md border bg-white px-3 py-2 shadow-sm">Legg til</button>
            <button id="age-save" class="rounded-md border bg-white px-3 py-2 shadow-sm">Lagre</button>
          </div>
        </div>

        <!-- Skytehistorikk (minimum) -->
        <div class="rounded-2xl border bg-white shadow-sm p-4">
          <div class="font-semibold mb-2">Skytehistorikk</div>
          <div class="mb-2 flex flex-wrap gap-2">
            <input id="shoot-q" class="rounded-md border px-2 py-1" placeholder="Søk utøver…" />
            <input id="shoot-from" type="date" class="rounded-md border px-2 py-1" />
            <input id="shoot-to" type="date" class="rounded-md border px-2 py-1" />
            <select id="shoot-highlight" class="rounded-md border px-2 py-1">
              <option value="all">Uthev alt</option>
              <option value="pb">PB</option>
              <option value="day">Dagens beste</option>
              <option value="club">Klubbrekord</option>
            </select>
          </div>
          <div class="mb-2 flex flex-wrap gap-2">
            <input id="shoot-file" type="file" accept=".xlsx,.xls" />
            <button id="shoot-add-date" class="rounded-md border bg-white px-2 py-1 shadow-sm">Ny dato</button>
            <button id="shoot-add-athlete" class="rounded-md border bg-white px-2 py-1 shadow-sm">Ny utøver</button>
            <button id="shoot-save" class="rounded-md border bg-white px-2 py-1 shadow-sm">Lagre til sky</button>
            <button id="shoot-export" class="rounded-md border bg-white px-2 py-1 shadow-sm">Eksporter Excel</button>
          </div>
          <div class="mb-2">
            <select id="shoot-chart-ath" class="rounded-md border px-2 py-1 w-full"></select>
          </div>
          <canvas id="shoot-chart" height="160"></canvas>

          <div class="mt-3 overflow-auto">
            <table id="shoot-table" class="min-w-full text-xs">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Tooltip -->
  <div id="lss-tooltip" class="hidden rounded-md border bg-white p-2 text-xs shadow-lg"></div>

  <!-- Dialog -->
  <div id="dialog" class="fixed inset-0 hidden items-start justify-center bg-black/40 p-3 z-50">
    <div class="dialog-card w-full max-w-3xl rounded-2xl border bg-white shadow-xl">
      <div class="flex items-center justify-between border-b p-3">
        <div id="dlg-title" class="font-semibold">Dialog</div>
        <button id="dlg-close" class="rounded-md border px-2 py-1 text-sm">×</button>
      </div>
      <div id="dlg-body" class="dialog-body p-3"></div>
      <div class="flex items-center justify-end gap-2 border-t p-3">
        <button id="btn-delete" class="hidden rounded-md border border-red-300 bg-red-50 px-3 py-1.5 text-red-700">Slett</button>
        <button id="btn-cancel" class="rounded-md border bg-white px-3 py-1.5">Avbryt</button>
        <button id="btn-save" class="rounded-md border bg-white px-3 py-1.5 shadow-sm">Lagre</button>
      </div>
    </div>
  </div>

  <script>
  // ---------- Dayjs ----------
  dayjs.extend(dayjs_plugin_isoWeek);
  dayjs.extend(dayjs_plugin_weekday);
  dayjs.extend(dayjs_plugin_localizedFormat);
  dayjs.locale('nb');

  // ---------- Utils ----------
  const $=(q,el=document)=>el.querySelector(q);
  const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));
  const uid=()=> (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2));
  const lsGet=(k,d)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):d;}catch{return d;} };
  const lsSet=(k,v)=>{ try{localStorage.setItem(k, JSON.stringify(v));}catch{} };
  function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function escapeHTML(str){
    return (str ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"
    }[m]));
  }

  // --- Sidebar toggle (med knappestil) ---
  function setSidebarButtonStyle(isVisible){
    const btn = document.getElementById('btn-toggle-sidebar');
    if(!btn) return;
    btn.classList.toggle('bg-blue-50', !isVisible);
    btn.classList.toggle('border-blue-300', !isVisible);
    btn.classList.toggle('text-[var(--brand)]', !isVisible);
    btn.setAttribute('aria-pressed', String(isVisible));
    btn.textContent = isVisible ? 'Skjul sidepanel' : 'Vis sidepanel';
  }
  function applySidebarLayout(visible){
    const grid = document.getElementById('page-grid');
    const aside = document.getElementById('sidebar');
    if(!grid || !aside) return;
    if(visible){
      aside.classList.remove('hidden');
      grid.classList.remove('lg:grid-cols-1');
      grid.classList.add('lg:grid-cols-[minmax(0,1fr)_360px]');
    }else{
      aside.classList.add('hidden');
      grid.classList.remove('lg:grid-cols-[minmax(0,1fr)_360px]');
      grid.classList.add('lg:grid-cols-1');
    }
    setSidebarButtonStyle(visible);
  }
  function setupSidebarToggle(){
    const btn = document.getElementById('btn-toggle-sidebar');
    if(!btn) return;
    const saved = localStorage.getItem('lss:sidebar:visible');
    const visible = saved === null ? true : (saved === 'true');
    applySidebarLayout(visible);
    btn.addEventListener('click', () => {
      const aside = document.getElementById('sidebar');
      const nowVisible = aside.classList.contains('hidden');
      applySidebarLayout(nowVisible);
      localStorage.setItem('lss:sidebar:visible', String(nowVisible));
    });
  }

  // ---------- Konstanter ----------
  const COLORS = { Trening:'#2563eb', Skyting:'#0ea5e9', Konkurranse:'#dc2626', Samling:'#a855f7', Annet:'#6b7280', Restitusjon:'#16a34a' };
  const MODALITETER = ['Ski skøyting','Ski klassisk','Rulleski skøyting','Rulleski klassisk','Løp','Sykkel','Styrke','Basistrening'];
  const INTENS = ['I1','I2','I3','I4','I5'];
  const WEEKCODES = ['BAS','OPP','KONK','RES','EKS'];

  const DEFAULT_AGE_GROUPS = [
    { id:'HL', label:'HL gruppe (15+)' },
    { id:'13-14', label:'13–14 år' },
    { id:'11-12', label:'11–12 år' },
    { id:'9-10', label:'9–10 år' },
    { id:'Skiskytterskolen', label:'Skiskytterskolen' }
  ];
  const AGE_MAP = { 'U12':'11-12', 'U14':'13-14', 'U16':'HL', 'JR':'HL' };

  const KEY = {
    EVENTS:   'lss:events:v1',
    BANK:     'lss:bank:v3',
    WEEKS:    'lss:weeks:v1',
    YEAR:     'lss:year:v1',
    DAYORDER: 'lss:dayorder:v2',
    AGES:     'lss:ages:v1',
    VIEW:     'lss:view:v1',
    SHOOT:    'lss:shoot:v1'
  };

  // ---------- Supabase ----------
  const SUPA_URL = "https://chzfewhbfkdtcizdxyzk.supabase.co";
  const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
  const supabase = window.supabase.createClient(SUPA_URL, SUPA_ANON);
  const TBL = { events:'events', bank:'bank_templates', weeks:'weeks', dayOrder:'day_order', settings:'settings', shoot:'shoot_history' };

  // ---------- State ----------
  let state = {
    year:      lsGet(KEY.YEAR, dayjs().year()),
    month:     dayjs().month() + 1,
    viewMode:  lsGet(KEY.VIEW, 'rolling'), // 'rolling' | 'full'
    events:    [],
    bank:      [],
    weeks:     {},
    dayOrder:  lsGet(KEY.DAYORDER, {}),
    ageGroups: lsGet(KEY.AGES, DEFAULT_AGE_GROUPS),

    // Skytehistorikk
    shoot: {
      athletes: [],   // [{name, birthYear}]
      dates: [],      // ['YYYY-MM-DD', ...]
      grid: {},       // key `${ai}|${di}|${gi}` -> { total, prone, stand, stand_hits }
      groups: []      // unike gruppenavn (økt/øvelse/variant) i Excel-kol A
    }
  };
    if (state.viewMode === 'year') state.viewMode = 'full';
    if (!['rolling','full'].includes(state.viewMode)) state.viewMode = 'rolling';

  const MOBILE_BREAKPOINT = 768;
  const isMobile = () => window.innerWidth < MOBILE_BREAKPOINT;

  // ---------- I/O ----------
  async function supaLoadAll(year = state.year){
    // Events
    const { data: ev } = await supabase.from(TBL.events).select('*').eq('year', year).order('date', { ascending: true });
    if(ev){ state.events = ev.map(mapEventFromDb); lsSet(KEY.EVENTS, state.events); }
    else { state.events = lsGet(KEY.EVENTS, state.events); }

    // Bank
    const { data: bk } = await supabase.from(TBL.bank).select('*').order('created_at', { ascending: false });
    if(bk){ state.bank = bk.map(mapBankFromDb); if(state.bank.length===0){ state.bank=getDefaultTemplates(); } lsSet(KEY.BANK, state.bank); }
    else { state.bank = lsGet(KEY.BANK, getDefaultTemplates()); }

    // Weeks
    const { data: wks } = await supabase.from(TBL.weeks).select('*').eq('year', year);
    if(wks){
      const dict={}; for(const r of wks){ dict[r.week] = { code: r.code || 'BAS', note: r.note || '' }; }
      state.weeks = dict;
    } else {
      state.weeks = lsGet(KEY.WEEKS, getDefaultWeeks(year));
    }

    // Age groups
    await supaLoadAgeGroups();

    // Day order
    await supaLoadDayOrderForYear(year);

    migrateAllAgesInState();
    render();
  }

  async function supaLoadAgeGroups(){
    const { data } = await supabase.from(TBL.settings).select('value').eq('key','age_groups').maybeSingle();
    if(data && Array.isArray(data.value)){ state.ageGroups = data.value; }
    else { state.ageGroups = DEFAULT_AGE_GROUPS; await supabase.from(TBL.settings).upsert({ key:'age_groups', value: state.ageGroups }); }
    lsSet(KEY.AGES, state.ageGroups);
  }
  async function supaSaveAgeGroups(){
    const { error } = await supabase.from(TBL.settings).upsert({ key:'age_groups', value: state.ageGroups });
    if(error){ console.warn('Lagre age_groups feilet', error); alert('Kunne ikke lagre grupper til skyen.'); }
  }

  async function notifyPerChange(eventId, change = 'upsert'){
    try {
      const { data, error } = await supabase.functions.invoke('notify-dispatch', {
        body: { mode: 'per_change', change, eventId }
      });
      if (error) throw error;
      console.log('[notify] OK', data);
    } catch (err) {
      console.error('[notify] FEIL', err);
    }
  }

  function replaceIdEverywhere(oldId, newId, dateISO){
    if (!oldId || !newId || oldId === newId) return;
    const i = state.events.findIndex(x => x.id === oldId);
    if (i >= 0) { state.events[i] = { ...state.events[i], id: newId }; }
    const key = dateISO || (state.events[i]?.date);
    if (key && state.dayOrder[key]) {
      state.dayOrder[key] = state.dayOrder[key].map(x => x === oldId ? newId : x);
    }
    lsSet(KEY.EVENTS, state.events);
    lsSet(KEY.DAYORDER, state.dayOrder);
    lsSet(KEY.VIEW, state.viewMode);
    render();
  }

  async function supaUpsertEvent(model){
    const row = mapEventToDb(model);
    try{
      const { data, error } = await supabase
        .from(TBL.events)
        .upsert(row, { onConflict: 'id' })
        .select('id, date')
        .single();

      if (error){
        console.warn('Upsert event feilet', error);
        alert('Kunne ikke lagre til skyen. Lagret lokalt.');
        return;
      }
      if (data && data.id && data.id !== model.id){
        replaceIdEverywhere(model.id, data.id, data.date || model.date);
        model.id = data.id;
      }
      await notifyPerChange(model.id);
    }catch(err){
      console.error('Upsert event exception:', err);
      alert('Uventet feil ved lagring (se konsoll).');
    }
  }

  async function findServerCandidates(ev){
    const title = (ev.title || '').trim();
    {
      const { data } = await supabase
        .from(TBL.events)
        .select('id, title, type, date, modality, location, intensity, duration_min, race_subtype, shooting, notes, updated_at, created_at')
        .eq('date', ev.date)
        .eq('title', title)
        .eq('type', ev.type || null)
        .eq('location', ev.location || null)
        .eq('modality', ev.modality || null)
        .eq('intensity', ev.intensity || null)
        .eq('duration_min', ev.durationMin ?? null)
        .limit(10);
      if (data && data.length) return data;
    }
    {
      const { data } = await supabase
        .from(TBL.events)
        .select('id, title, type, date, modality, location, updated_at, created_at')
        .eq('date', ev.date)
        .eq('title', title)
        .eq('type', ev.type || null)
        .order('updated_at', { ascending: false })
        .limit(10);
      if (data && data.length) return data;
    }
    if (title.length >= 3){
      const { data } = await supabase
        .from(TBL.events)
        .select('id, title, type, date, updated_at, created_at')
        .eq('date', ev.date)
        .ilike('title', `%${title}%`)
        .order('updated_at', { ascending: false })
        .limit(10);
      if (data && data.length) return data;
    }
    {
      const { data } = await supabase
        .from(TBL.events)
        .select('id, title, type, date, updated_at, created_at')
        .eq('date', ev.date)
        .order('created_at', { ascending: false })
        .limit(1);
      if (data && data.length) return data;
    }
    return [];
  }

  async function supaDeleteEvent(ev){
    try{
      let { data, error } = await supabase
        .from(TBL.events)
        .delete()
        .eq('id', ev.id)
        .select('id');

      if (error){ console.warn('Sletting feilet', error); alert('Kunne ikke slette i skyen.'); return; }
      if (data && data.length){ await verifyDeletion(ev); await notifyPerChange(null); return; }

      const candidates = await findServerCandidates(ev);
      if (!candidates.length){
        console.warn('Ingen kandidater funnet for sletting', ev);
        alert('Fant ingen match i skyen for sletting.');
        return;
      }
      const chosen = candidates.find(r => (r.title||'') === (ev.title||'') && (r.type||'') === (ev.type||'')) || candidates[0];

      const res2 = await supabase
        .from(TBL.events)
        .delete()
        .eq('id', chosen.id)
        .select('id');

      if (res2.error){ console.warn('Sletting via fallback feilet', res2.error); alert('Kunne ikke slette i skyen via fallback.'); return; }

      if (chosen.id !== ev.id){
        replaceIdEverywhere(ev.id, chosen.id, ev.date);
        console.log('Reparerte klient-ID → server-ID ved sletting:', ev.id, '→', chosen.id);
      }
      await verifyDeletion(ev);
      await notifyPerChange(null);
    }catch(err){
      console.error('Delete exception:', err);
      alert('Uventet feil ved sletting (se konsoll).');
    }
  }
  async function verifyDeletion(ev){
    const title = (ev.title || '').trim();
    const { data, error } = await supabase
      .from(TBL.events)
      .select('id, title, type, date, location, modality')
      .eq('date', ev.date)
      .eq('title', title)
      .eq('type', ev.type || null)
      .limit(5);

    if (error){ console.warn('Verifisering feilet', error); return; }
    if (data && data.length){
      console.warn('Advarsel: Det finnes fortsatt rader som matcher etter sletting:', data);
      alert('Obs: Det finnes fortsatt en (eller flere) rader i skyen med samme dato/tittel/type. Se konsollen for detaljer.');
    }
  }

  async function supaUpsertWeek(year, week, code, note){
    const { error } = await supabase.from(TBL.weeks).upsert({ year, week, code, note });
    if(error){ console.warn('Upsert week feilet', error); }
  }
  async function supaUpsertBankTemplate(t){
    const row = mapBankToDb(t);
    const { error } = await supabase.from(TBL.bank).upsert(row);
    if(error){ console.warn('Upsert bank feilet', error); }
  }
  async function supaDeleteBankTemplate(id){
    const { error } = await supabase.from(TBL.bank).delete().eq('id', id);
    if(error){ console.warn('Slett bank feilet', error); }
  }

  async function supaLoadDayOrderForYear(year){
    const from = `${year}-01-01`;
    const to   = `${year+1}-01-01`;
    const { data, error } = await supabase.from(TBL.dayOrder).select('*').gte('date', from).lt('date', to);
    if(error){ console.warn('Henting day_order feilet', error); return; }
    const map = {};
    for(const r of data||[]){ map[r.date] = Array.isArray(r.ids) ? r.ids : []; }
    state.dayOrder = { ...state.dayOrder, ...map };
    lsSet(KEY.DAYORDER, state.dayOrder);
  }
  async function supaUpsertDayOrder(dateISO, ids){
    const { error } = await supabase.from(TBL.dayOrder).upsert({ date: dateISO, ids });
    if(error){ console.warn('Upsert day_order feilet', error); }
  }

  function supaRealtimeInit(){
    supabase.channel('events-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: TBL.events }, payload => {
        if(payload.new?.year === state.year || payload.old?.year === state.year){ supaLoadAll(state.year); }
      }).subscribe();

    supabase.channel('weeks-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: TBL.weeks }, payload => {
        if((payload.new?.year||payload.old?.year) === state.year){ supaLoadAll(state.year); }
      }).subscribe();

    supabase.channel('bank-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: TBL.bank }, () => supaLoadAll(state.year))
      .subscribe();

    supabase.channel('dayorder-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: TBL.dayOrder }, payload => {
        const d = (payload.new?.date || payload.old?.date);
        if(!d) return;
        const y = dayjs(d).year();
        if(y !== state.year) return;
        if(payload.eventType === 'DELETE'){ delete state.dayOrder[d]; }
        else { state.dayOrder[d] = payload.new?.ids || []; }
        lsSet(KEY.DAYORDER, state.dayOrder);
        render();
      })
      .subscribe();

    supabase.channel('settings-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: TBL.settings }, payload => {
        if(payload.new?.key === 'age_groups'){
          state.ageGroups = payload.new?.value || DEFAULT_AGE_GROUPS;
          lsSet(KEY.AGES, state.ageGroups);
          render();
        }
      })
      .subscribe();

    supabase.channel('shoot-rt')
      .on('postgres_changes', { event: '*', schema: 'public', table: TBL.shoot }, ()=> shootLoadFromSupabase())
      .subscribe();
  }

  // ---------- Mapper ----------
  function mapEventToDb(e){
    return {
      id: e.id,
      date: e.date,
      year: Number(String(e.date).slice(0,4)),
      title: e.title || null,
      type: e.type || null,
      modality: e.modality || null,
      intensity: e.intensity || null,
      duration_min: e.durationMin ?? null,
      age: e.age || [],
      shooting: e.shooting || { stilling:'', skudd:0, tema:[] },
      race_subtype: e.raceSubtype || null,
      notes: e.notes || null,
      roles: e.roles || {},
      location: e.location || null
    };
  }
  function mapEventFromDb(r){
    const t = r.type ?? r.event_type ?? 'Trening';
    return {
      id: r.id,
      date: r.date,
      title: r.title || '',
      type: t,
      modality: r.modality || '',
      intensity: r.intensity || '',
      durationMin: r.duration_min ?? 60,
      age: r.age || [],
      shooting: r.shooting || { stilling:'', skudd:0, tema:[] },
      raceSubtype: r.race_subtype || '',
      notes: r.notes || '',
      roles: r.roles || {},
      location: r.location || ''
    };
  }
  function mapBankToDb(t){
    return {
      id: t.id,
      name: t.name,
      type: t.type,
      modality: t.modality,
      intensity: t.intensity,
      duration_min: t.durationMin ?? null,
      age: t.age || [],
      shooting: t.shooting || { stilling:'', skudd:0, tema:[] },
      race_subtype: t.raceSubtype || null,
      notes: t.notes || null
    };
  }
  function mapBankFromDb(r){
    return {
      id: r.id,
      name: r.name,
      type: r.type,
      modality: r.modality,
      intensity: r.intensity,
      durationMin: r.duration_min ?? null,
      age: r.age || [],
      shooting: r.shooting || { stilling:'', skudd:0, tema:[] },
      raceSubtype: r.race_subtype || null,
      notes: r.notes || null
    };
  }

  // ---------- Defaults / migrering ----------
  function getDefaultWeeks(year){
    const first=dayjs(year+'-01-01');
    const last=dayjs(year+'-12-31');
    const weeks={}; let d=first.startOf('isoWeek');
    while(d.isBefore(last.add(1,'day'))){
      const wk=d.isoWeek();
      if(!weeks[wk]) weeks[wk]={code:'BAS',note:''};
      d=d.add(7,'day');
    }
    return weeks;
  }
  function migrateAgeTagsInArray(arr){
    if(!Array.isArray(arr)) return [];
    return arr.map(a => AGE_MAP[a] || a);
  }
  function migrateAllAgesInState(){
    state.events = (state.events || []).map(e => ({ ...e, age: migrateAgeTagsInArray(e.age) }));
    state.bank   = (state.bank   || []).map(t => ({ ...t, age: migrateAgeTagsInArray(t.age) }));
  }

  // ---------- Tooltip ----------
  const tipEl = $('#lss-tooltip');
  function showTooltip(html, x, y){
    if(!tipEl) return;
    tipEl.innerHTML = html;
    tipEl.style.left = x+'px';
    tipEl.style.top = (y-12)+'px';
    tipEl.classList.remove('hidden');
  }
  function hideTooltip(){ if(tipEl) tipEl.classList.add('hidden'); }
  function attachTipHandlers(el, html){
    let pressTimer = null;
    let last = {x:0, y:0};
    const onEnter = (ev)=> showTooltip(html, ev.clientX, ev.clientY);
    const onMove  = (ev)=> showTooltip(html, ev.clientX, ev.clientY);
    const onLeave = ()=> hideTooltip();
    el.addEventListener('mouseenter', onEnter);
    el.addEventListener('mousemove', onMove);
    el.addEventListener('mouseleave', onLeave);
    const startPress = (ev)=>{
      const t = ev.touches?.[0]; if(!t) return;
      last = { x: t.clientX, y: t.clientY };
      clearTimeout(pressTimer);
      pressTimer = setTimeout(()=> showTooltip(html, last.x, last.y), 300);
    };
    const movePress = (ev)=>{
      const t = ev.touches?.[0]; if(!t) return;
      last = { x: t.clientX, y: t.clientY };
      if(!tipEl.classList.contains('hidden')) showTooltip(html, last.x, last.y);
    };
    const endPress = ()=>{ clearTimeout(pressTimer); setTimeout(hideTooltip, 1200); };
    el.addEventListener('touchstart', startPress, { passive:true });
    el.addEventListener('touchmove',  movePress,  { passive:true });
    el.addEventListener('touchend',   endPress,   { passive:true });
    el.addEventListener('touchcancel',endPress,   { passive:true });
  }
  function eventTooltipHTML(e){
    const esc = escapeHTML;
    const title = esc(e.title || e.type || '');
    const rolesList = Object.entries(e.roles||{}).filter(([,v])=> (v||'').trim().length).map(([k,v])=> `<div><span class="font-medium">${esc(k)}:</span> ${esc(v)}</div>`).join('');
    const ageChips = (e.age||[]).map(a=>`<span class="rounded-full border px-1.5 py-0.5 text-[10px] mr-1">${esc(a)}</span>`).join('');
    const race = e.type==='Konkurranse' && (e.raceSubtype||'').trim() ? `<div><span class="font-medium">Konkurranse:</span> ${esc(e.raceSubtype)}</div>` : '';
    const notes = (e.notes||'').trim() ? `<div class="mt-2 text-slate-600 whitespace-pre-wrap">${esc(e.notes)}</div>` : '';
    const tema = (e.shooting?.tema||[]).length ? `<div class="mt-1 flex flex-wrap gap-1">${e.shooting.tema.map(t=>`<span class="rounded-full border px-1.5 py-0.5 text-[10px]">${esc(t)}</span>`).join('')}</div>` : '';
    return `
      <div class="font-semibold mb-1">${title}</div>
      <div><span class="font-medium">Type:</span> ${esc(e.type||'–')}</div>
      <div><span class="font-medium">Sted:</span> ${esc(e.location||'–')}</div>
      <div><span class="font-medium">Modalitet:</span> ${esc(e.modality||'–')}</div>
      <div><span class="font-medium">Intensitet:</span> ${esc(e.intensity||'–')}</div>
      <div><span class="font-medium">Varighet:</span> ${e.durationMin? esc(String(e.durationMin))+' min' : '–'}</div>
      <div class="mt-1"><span class="font-medium">Aldersklasser:</span> ${ageChips||'–'}</div>
      <div class="mt-1"><span class="font-medium">Skyting:</span> ${esc(e.shooting?.stilling||'–')}, skudd: ${e.shooting?.skudd||0}</div>
      ${tema}
      ${race}
      ${rolesList? `<div class="mt-1">${rolesList}</div>`:''}
      ${notes}
    `;
  }

  // ---------- Day order ----------
  function getOrderForDate(dateISO){ return state.dayOrder[dateISO] || []; }
  function setOrderForDate(dateISO, ids){ state.dayOrder[dateISO] = ids; lsSet(KEY.DAYORDER, state.dayOrder); supaUpsertDayOrder(dateISO, ids); }
  function sortEventsByDayOrder(dateISO, events){
    const order = getOrderForDate(dateISO);
    const idx = new Map(order.map((id, i)=>[id, i]));
    return [...events].sort((a,b)=>{
      const ai = idx.has(a.id) ? idx.get(a.id) : Number.MAX_SAFE_INTEGER;
      const bi = idx.has(b.id) ? idx.get(b.id) : Number.MAX_SAFE_INTEGER;
      if (ai !== bi) return ai - bi;
      return (a.title||'').localeCompare(b.title||'');
    });
  }

  // ---------- Dagsvisning (DnD) ----------
  function previewCardHTML(e){
    const esc = escapeHTML;
    const dot = `<span class="inline-block h-2.5 w-2.5 rounded-full" style="background:${COLORS[e.type]||'#6b7280'}"></span>`;
    const title = esc(e.title || (e.type + (e.raceSubtype? ' – '+e.raceSubtype : '')));
    const meta = [
      e.type ? `<span class="inline-flex items-center gap-2">${dot}<span>${esc(e.type)}</span></span>` : '',
      e.location ? `<span>${esc(e.location)}</span>` : '',
      e.modality ? `<span>${esc(e.modality)}</span>` : '',
      e.intensity ? `<span>${esc(e.intensity)}</span>` : '',
      e.durationMin ? `<span>${String(e.durationMin)} min</span>` : ''
    ].filter(Boolean).join(' • ');
    const ages = (e.age||[]).length ? `<div class="mt-1 flex flex-wrap gap-1">${(e.age||[]).map(a=>`<span class="rounded-full border px-2 py-0.5 text-[11px]">${esc(a)}</span>`).join('')}</div>` : '';
    const notes = e.notes ? `<div class="mt-2 text-sm text-slate-700 whitespace-pre-wrap">${esc(e.notes)}</div>` : '';
    return `
      <div class="flex items-start justify-between gap-3">
        <div class="flex-1">
          <div class="text-base font-semibold flex items-center gap-2">
            <span class="cursor-grab select-none text-slate-400" title="Dra for å flytte">≡</span>
            ${title}
          </div>
          <div class="mt-1 text-xs text-slate-600 flex flex-wrap gap-2">${meta}</div>
          ${ages}
          ${notes}
        </div>
        <div class="shrink-0 flex gap-1">
          <button data-act="view" class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm min-w-[72px]">Vis</button>
          <button data-act="edit" class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm min-w-[72px]">Rediger</button>
          <button data-act="dup"  class="rounded-xl border bg-white px-2 py-1 text-xs shadow-sm min-w-[72px]">Dupliser</button>
          <button data-act="del"  class="rounded-xl border border-red-300 bg-red-50 px-2 py-1 text-xs text-red-700 shadow-sm min-w-[72px]">Slett</button>
        </div>
      </div>
    `;
  }
  function openDayView(dateISO, eventsForDay){
    const d = dayjs(dateISO);
    const items = sortEventsByDayOrder(dateISO, eventsForDay);
    const body = $('#dlg-body');
    $('#dlg-title').textContent = d.format('dddd D. MMMM YYYY');
    $('#btn-delete').classList.add('hidden');
    $('#btn-save').classList.remove('hidden');

    body.innerHTML = `
      <div class="space-y-3">
        <div id="dnd-list" class="space-y-3">
          ${items.map(e=> `<div class="rounded-2xl border bg-white shadow-sm p-4 dnd-item" draggable="true" data-id="${e.id}">${previewCardHTML(e)}</div>`).join('')}
        </div>
        <div class="pt-2">
          <button id="btn-new-on-day" class="rounded-xl border bg-white px-3 py-2 shadow-sm">Ny hendelse denne dagen</button>
        </div>
      </div>
    `;

    const list = $('#dnd-list');
    let dragEl = null;
    list.addEventListener('dragstart', (ev)=>{ const item = ev.target.closest('.dnd-item'); if(!item) return; dragEl = item; item.classList.add('opacity-60'); ev.dataTransfer.effectAllowed = 'move'; try { ev.dataTransfer.setData('text/plain', item.dataset.id || ''); } catch {} });
    list.addEventListener('dragover', (ev)=>{ ev.preventDefault(); const over = ev.target.closest('.dnd-item'); if(!over || over === dragEl) return; const rect = over.getBoundingClientRect(); const before = (ev.clientY - rect.top) < rect.height / 2; if (before) list.insertBefore(dragEl, over); else list.insertBefore(dragEl, over.nextSibling); });
    list.addEventListener('drop', ()=>{ const ids = Array.from(list.querySelectorAll('.dnd-item')).map(el => el.dataset.id).filter(Boolean); setOrderForDate(dateISO, ids); render(); });
    list.addEventListener('dragend', ()=>{ if(dragEl){ dragEl.classList.remove('opacity-60'); dragEl = null; } });

    list.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      const item = e.target.closest('.dnd-item'); const id = item?.dataset.id; const evObj = state.events.find(x=>x.id===id); if(!evObj) return;
      if(btn.dataset.act === 'view') return openViewDialog(evObj);
      if(btn.dataset.act === 'edit') return openDialog({...evObj});
      if(btn.dataset.act === 'dup'){ const copy = { ...evObj, id: uid(), title: (evObj.title||evObj.type)+' (kopi)' }; state.events.push(copy); lsSet(KEY.EVENTS, state.events); render(); await supaUpsertEvent(copy); const order = getOrderForDate(dateISO); setOrderForDate(dateISO, [...order, copy.id]); return; }
      if(btn.dataset.act === 'del'){ if(!confirm('Slette denne hendelsen?')) return; state.events = state.events.filter(x=> x.id !== evObj.id); lsSet(KEY.EVENTS, state.events); render(); await supaDeleteEvent(evObj); const ids = getOrderForDate(dateISO).filter(x=> x !== evObj.id); setOrderForDate(dateISO, ids); const remaining = state.events.filter(x=> dayjs(x.date).isSame(dateISO,'day')); return openDayView(dateISO, remaining); }
    });

    $('#btn-new-on-day')?.addEventListener('click', ()=> openDialog({ date: dateISO }));
    $('#dialog').classList.remove('hidden'); $('#dialog').classList.add('flex');
  }

  // ---------- Render ----------
  function render(){
    const systemYear  = dayjs().year();
    const systemMonth = dayjs().month() + 1;
    const crossesYear = (!isMobile() && state.viewMode === 'rolling' && state.year === systemYear && systemMonth !== 1);
    const yearLabelText = state.viewMode === 'rolling' ? (crossesYear ? `${state.year}–${state.year + 1}` : `${state.year}`) : `${state.year}`;
    $('#year-label').textContent = yearLabelText;
    $('#event-year').textContent = String(state.year);

    renderLegend();
    renderCalendar();
    renderList();
    renderBank();
    renderWeeks();
    renderAgeEditor();
    renderAdminEvents();

    const fAge = $('#f-age');
    if(fAge){
      fAge.innerHTML = `<option value="">Alle</option>` + (state.ageGroups||[]).map(g=>`<option value="${g.id}">${g.label}</option>`).join('');
    }

    lsSet(KEY.YEAR, state.year);
    lsSet(KEY.EVENTS, state.events);
    lsSet(KEY.BANK, state.bank);
    lsSet(KEY.WEEKS, state.weeks);
    lsSet(KEY.DAYORDER, state.dayOrder);
    lsSet(KEY.AGES, state.ageGroups);
    lsSet(KEY.VIEW, state.viewMode);
  }

  function renderLegend(){
    const el=$('#legend'); if(!el) return; el.innerHTML='';
    Object.entries(COLORS).forEach(([k,c])=>{
      const row=document.createElement('div');
      row.className='flex items-center justify-between';
      row.innerHTML=`<span class="flex items-center gap-2"><span class="inline-block h-2.5 w-2.5 rounded-full" style="background:${c}"></span>${k}</span>`;
      el.appendChild(row);
    });
  }

  function renderCalendar(){
    const grid = $('#calendar-grid');
    grid.innerHTML = '';

    const systemYear  = dayjs().year();
    const systemMonth = dayjs().month() + 1;

    if (isMobile()){
      grid.appendChild(renderMonth(state.year, state.month, { withNav:true }));
      return;
    }

    let months = [];
    let crossesYear = false;

    if (state.viewMode === 'full'){
      for (let m = 1; m <= 12; m++) months.push({ y: state.year, m });
    } else {
      if (state.year === systemYear){
        for (let m = systemMonth; m <= 12; m++) months.push({ y: state.year, m });
        for (let m = 1; m <  systemMonth; m++) months.push({ y: state.year + 1, m });
        crossesYear = (systemMonth !== 1);
      } else {
        for (let m = 1; m <= 12; m++) months.push({ y: state.year, m });
      }
    }

    const oldHeader = grid.previousElementSibling;
    if (oldHeader && oldHeader.dataset?.role === 'year-header') oldHeader.remove();

    const h = document.createElement('h2');
    h.dataset.role = 'year-header';
    h.className = 'text-xl font-bold text-center mb-4';
    const label = state.viewMode === 'rolling' ? (crossesYear ? `${state.year}–${state.year + 1}` : `${state.year}`) : `${state.year}`;
    h.textContent = label;
    grid.parentNode.insertBefore(h, grid);

    months.forEach(({ y, m }) => {
      const el = renderMonth(y, m);
      el.title = dayjs(`${y}-${String(m).padStart(2,'0')}-01`).format('MMMM YYYY');
      grid.appendChild(el);
    });
  }

  function renderMonth(year, month, opts = { withNav:false }){
    const wrap=document.createElement('div'); wrap.className='rounded-2xl border bg-white shadow-sm card';
    const header=document.createElement('div'); header.className='flex items-center justify-between border-b p-4';
    const title = dayjs(`${year}-${String(month).padStart(2,'0')}-01`).format('MMMM');
    if (opts.withNav){
      const left = document.createElement('button'); left.className = 'rounded-xl border bg-white px-3 py-1.5 shadow-sm'; left.textContent = '◀';
      const mid = document.createElement('div'); mid.className = 'text-lg font-semibold'; mid.textContent = `${title} ${year}`;
      const right = document.createElement('button'); right.className = 'rounded-xl border bg-white px-3 py-1.5 shadow-sm'; right.textContent = '▶';
      left.onclick = () => { let m = state.month - 1, y = state.year; if (m < 1){ m = 12; y--; } state.month = m; state.year = y; render(); };
      right.onclick = () => { let m = state.month + 1, y = state.year; if (m > 12){ m = 1; y++; } state.month = m; state.year = y; render(); };
      header.append(left, mid, right);
    } else {
      header.innerHTML=`<h3 class="text-lg font-semibold">${title}</h3>`;
    }

    const body=document.createElement('div'); body.className='p-2';
    const daysHeader=document.createElement('div'); daysHeader.className='grid grid-cols-7 gap-1 text-xs text-slate-500 px-1';
    'man tir ons tor fre lør søn'.split(' ').forEach(w=>{ const d=document.createElement('div'); d.className='px-1 py-1 text-center font-medium uppercase'; d.textContent=w; daysHeader.appendChild(d); });

    const cells=document.createElement('div'); cells.className='mt-1 grid grid-cols-7 gap-1';
    const first=dayjs(`${year}-${String(month).padStart(2,'0')}-01`).startOf('month');
    const leading=(first.day()+6)%7; const days=first.daysInMonth();
    for(let i=0;i<leading;i++) cells.appendChild(emptyCell());
    for(let d=1; d<=days; d++) cells.appendChild(dayCell(dayjs(`${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`)));
    const total=leading+days; const trail=(7-(total%7))%7; for(let i=0;i<trail;i++) cells.appendChild(emptyCell());

    body.appendChild(daysHeader); body.appendChild(cells); wrap.appendChild(header); wrap.appendChild(body); return wrap;
  }

  function emptyCell(){ const d = document.createElement('div'); d.className = 'min-h-[80px] rounded-xl border bg-white/70 p-1 opacity-50'; return d; }
  function dayCell(d){
    const key = d.format('YYYY-MM-DD');
    let evts = state.events.filter(e => dayjs(e.date).isSame(d, 'day'));
    evts = sortEventsByDayOrder(key, evts);

    const box = document.createElement('div');
    box.className = 'daycell relative min-h-[100px] rounded-xl border bg-white/70 p-1.5 hover:bg-blue-50 cursor-pointer';

    box.addEventListener('click', () => { hideTooltip(); if (evts.length > 0) openDayView(key, evts); else openDialog({ date: key }); });
    if(evts.length === 0){ const html = `<div class="font-semibold">${d.format('dddd D. MMMM')}</div>`; attachTipHandlers(box, html); }

    // Ukechip nederst på mandager
    if (d.day() === 1) {
      const wk = d.isoWeek();
      box.classList.add('pb-5');
      const chip = document.createElement('div');
      chip.className = 'absolute left-1 bottom-1 rounded-md bg-slate-200 text-[10px] px-1.5 py-0.5 shadow-sm';
      chip.textContent = `Uke ${wk}`;
      box.appendChild(chip);
    }

    const top = document.createElement('div'); top.className = 'flex items-center justify-between text-xs text-slate-600';
    const uniqueTypes = Array.from(new Set(evts.map(e => e.type))).slice(0,4);
    const dotsHTML = uniqueTypes.map(t => `<span class='inline-block h-2.5 w-2.5 rounded-full' style='background:${COLORS[t]||'#6b7280'}'></span>`).join('');
    top.innerHTML = `<span class="font-medium">${d.date()}</span><span class="flex gap-1">${dotsHTML}</span>`;

    const list = document.createElement('div'); list.className = 'mt-1 flex flex-col gap-0.5';
    evts.slice(0,3).forEach(e => {
      const row = document.createElement('div'); row.className = 'truncate text-xs flex items-center gap-1';
      const dot = document.createElement('span'); dot.className = 'inline-block h-2 w-2 rounded-full'; dot.style.background = COLORS[e.type] || '#6b7280';
      const txt = document.createElement('span'); txt.className = 'font-medium truncate'; txt.textContent = e.title || e.type;
      const tipHTML = eventTooltipHTML(e); attachTipHandlers(row, tipHTML);
      row.appendChild(dot); row.appendChild(txt); list.appendChild(row);
    });
    if(evts.length > 3){ const more = document.createElement('div'); more.className = 'text-[10px] text-slate-500'; more.textContent = `+${evts.length-3} flere…`; list.appendChild(more); }

    box.appendChild(top); box.appendChild(list); return box;
  }

  function renderList(){
    const tbody=$('#tbl-events'); if(!tbody) return; tbody.innerHTML='';
const yearEvents = state.events
  .filter(e => dayjs(e.date).year() === state.year)
  .sort((a,b)=>{
    const da = dayjs(a.date), db = dayjs(b.date);
    if (!da.isSame(db, 'day')) return da - db;
    const order = getOrderForDate(da.format('YYYY-MM-DD'));
    const ia = order.indexOf(a.id); const ib = order.indexOf(b.id);
    const A = ia === -1 ? Number.MAX_SAFE_INTEGER : ia;
    const B = ib === -1 ? Number.MAX_SAFE_INTEGER : ib;
    if (A !== B) return A - B;
    return (a.title||'').localeCompare(b.title||'');
  });


    yearEvents.forEach(e=>{
      const tr=document.createElement('tr'); tr.className='border-t';
      const safeTitle = e.title ? escapeHTML(e.title) : '<span class="opacity-50">(uten tittel)</span>';
      tr.innerHTML=`
        <td class='py-1 whitespace-nowrap'>${dayjs(e.date).format('DD.MM.YYYY')}</td>
        <td class='max-w-[260px] truncate'>${safeTitle}</td>
        <td><span class='inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs'><span class='inline-block h-2.5 w-2.5 rounded-full' style='background:${COLORS[e.type]||'#6b7280'}'></span>${escapeHTML(e.type||'')}</span></td>
        <td class='max-w-[160px] truncate'>${escapeHTML(e.location||'–')}</td>
        <td>${escapeHTML(e.modality||'–')}</td>
        <td>${escapeHTML(e.intensity||'–')}</td>
        <td>${(e.shooting&&e.shooting.skudd)||0}</td>
        <td class='text-right'>
          <div class="inline-flex gap-1">
            <button class='btn-view rounded-xl border bg-white px-2 py-1 text-xs shadow-sm min-w-[72px]'>Vis</button>
            <button class='btn-edit rounded-xl border bg-white px-2 py-1 text-xs shadow-sm min-w-[72px]'>Rediger</button>
          </div>
        </td>`;
      tr.querySelector('.btn-edit').addEventListener('click', ()=> openDialog({...e}));
      tr.querySelector('.btn-view').addEventListener('click', ()=> openViewDialog(e));
      const tipHTML = eventTooltipHTML(e); attachTipHandlers(tr, tipHTML);
      tbody.appendChild(tr);
    });
  }

  // ---------- Weeks (FIX for renderWeeks missing) ----------
  function renderWeeks(){
    const tb = $('#tbl-weeks'); if(!tb) return;
    tb.innerHTML = '';
    const weeks = state.weeks || {};
    const entries = Object.entries(weeks).sort((a,b)=> Number(a[0])-Number(b[0]));
    entries.forEach(([wk, val])=>{
      const tr = document.createElement('tr'); tr.className='border-t';
      tr.innerHTML = `
        <td class="p-2 w-16">Uke ${wk}</td>
        <td class="p-2">
          <select data-wk="${wk}" class="wk-code rounded-md border px-2 py-1">
            ${WEEKCODES.map(c=>`<option ${val.code===c?'selected':''}>${c}</option>`).join('')}
          </select>
        </td>
        <td class="p-2">
          <input data-wk="${wk}" class="wk-note rounded-md border px-2 py-1 w-full" value="${escapeHTML(val.note||'')}" placeholder="Notat for uke ${wk}"/>
        </td>
      `;
      tb.appendChild(tr);
    });

    // listeners
    $$('.wk-code').forEach(sel=>{
      sel.addEventListener('change', async (e)=>{
        const wk = Number(e.target.getAttribute('data-wk'));
        const code = e.target.value;
        const note = state.weeks[wk]?.note || '';
        state.weeks[wk] = { code, note };
        lsSet(KEY.WEEKS, state.weeks);
        await supaUpsertWeek(state.year, wk, code, note);
      });
    });
    $$('.wk-note').forEach(inp=>{
      inp.addEventListener('change', debounce(async (e)=>{
        const wk = Number(e.target.getAttribute('data-wk'));
        const note = e.target.value;
        const code = state.weeks[wk]?.code || 'BAS';
        state.weeks[wk] = { code, note };
        lsSet(KEY.WEEKS, state.weeks);
        await supaUpsertWeek(state.year, wk, code, note);
      }, 300));
    });
  }

  // ---------- Age editor ----------
  function renderAgeEditor(){
    const box = $('#age-editor'); if(!box) return; box.innerHTML='';
    (state.ageGroups||[]).forEach((g, i)=>{
      const row = document.createElement('div');
      row.className = 'flex gap-2';
      row.innerHTML = `
        <input data-i="${i}" data-k="id"     class="rounded-md border px-2 py-1 w-28" value="${escapeHTML(g.id)}" />
        <input data-i="${i}" data-k="label"  class="rounded-md border px-2 py-1 flex-1" value="${escapeHTML(g.label)}" />
        <button data-i="${i}" class="age-del rounded-md border px-2 py-1 bg-red-50 border-red-300 text-red-700">Slett</button>
      `;
      box.appendChild(row);
    });
  }
  function addAgeRow(){ state.ageGroups = [...(state.ageGroups||[]), { id:'NY', label:'Ny gruppe' }]; renderAgeEditor(); }
  function saveAgeRows(){
    const rows = $$('#age-editor [data-i]');
    const byIndex = {};
    rows.forEach(el=>{
      const i = Number(el.getAttribute('data-i'));
      const k = el.getAttribute('data-k');
      byIndex[i] = byIndex[i] || {};
      byIndex[i][k] = el.value.trim();
    });
    state.ageGroups = Object.values(byIndex).map(x=>({ id:x.id, label:x.label })).filter(x=>x.id && x.label);
    lsSet(KEY.AGES, state.ageGroups);
    supaSaveAgeGroups();
    render(); // refresh filters/cards
  }
  function deleteAgeRow(i){
    state.ageGroups.splice(i,1);
    renderAgeEditor();
    lsSet(KEY.AGES, state.ageGroups);
    supaSaveAgeGroups();
    render();
  }

  // ---------- Admin: list to edit ----------
  function renderAdminEvents(list = null){
    const tb = $('#admin-events'); if(!tb) return;
    tb.innerHTML = '';
    const src = Array.isArray(list) ? list : state.events.filter(e => dayjs(e.date).year() === state.year);
    src.forEach(e=>{
      const tr = document.createElement('tr'); tr.className='border-t';
      tr.innerHTML = `
        <td class="p-2 whitespace-nowrap">${dayjs(e.date).format('DD.MM.YYYY')}</td>
        <td class="p-2 truncate max-w-[220px]">${escapeHTML(e.title||'(uten tittel)')}</td>
        <td class="p-2">${escapeHTML(e.type||'')}</td>
        <td class="p-2 truncate max-w-[160px]">${escapeHTML(e.location||'')}</td>
        <td class="p-2">${escapeHTML(e.intensity||'')}</td>
        <td class="p-2 text-right pr-2">
          <button class="a-edit rounded-md border px-2 py-1 text-xs">Rediger</button>
        </td>
      `;
      tr.querySelector('.a-edit').addEventListener('click', ()=> openDialog({...e}));
      tb.appendChild(tr);
    });
  }
  async function adminFilter(){
    const q = ($('#admin-q').value||'').toLowerCase();
    const from = $('#admin-from').value;
    const to   = $('#admin-to').value;
    let list = state.events.filter(e => dayjs(e.date).year() === state.year);
    if (from) list = list.filter(e => dayjs(e.date).isSame(from) || dayjs(e.date).isAfter(from));
    if (to)   list = list.filter(e => dayjs(e.date).isSame(to) || dayjs(e.date).isBefore(to));
    if (q) list = list.filter(e=>{
      const hay = [e.title, e.type, e.location, e.modality, e.intensity, e.notes].join(' ').toLowerCase();
      return hay.includes(q);
    });
    renderAdminEvents(list);
  }

  // ---------- Bank ----------
  function renderBank(){
    const q=($('#q-bank').value||'').toLowerCase();
    const age=$('#f-age').value;
    const type=$('#f-type').value;
    const box=$('#bank-cards'); if(!box) return; box.innerHTML='';
    state.bank
      .filter(t=> (!q||t.name.toLowerCase().includes(q)) && (!age||(t.age||[]).includes(age)) && (!type||t.type===type))
      .forEach(t=> box.appendChild(bankCard(t)) );
  }
  function bankCard(t){
    const c=document.createElement('div'); 
    c.className='rounded-2xl border bg-white shadow-sm card';

    c.innerHTML=`
      <div class='border-b p-4 flex items-center justify-between'>
        <h4 class='text-base font-semibold text-[color:var(--brand)]'>
          <span class='inline-block h-2.5 w-2.5 rounded-full mr-2' style='background:${COLORS[t.type]||'#6b7280'}"></span>
          ${escapeHTML(t.name)}
        </h4>
        <div class='flex gap-1 text-xs'>
          ${(t.age||[]).map(a=>`<span class='rounded-full border px-2 py-0.5'>${escapeHTML(a)}</span>`).join('')}
        </div>
      </div>

      <div class='p-4 text-sm space-y-1'>
        <div><span class='font-medium'>Modalitet:</span> ${escapeHTML(t.modality||'–')}</div>
        <div><span class='font-medium'>Intensitet:</span> ${escapeHTML(t.intensity||'–')}</div>
        <div><span class='font-medium'>Varighet:</span> ${t.durationMin? escapeHTML(String(t.durationMin))+' min':'–'}</div>
        <div><span class='font-medium'>Skudd:</span> ${(t.shooting&&t.shooting.skudd)||0}</div>
        ${(t.shooting&&t.shooting.tema&&t.shooting.tema.length)
          ? `<div class='flex flex-wrap gap-1 mt-2'>
               ${t.shooting.tema.map(x=>`<span class='rounded-full border px-2 py-0.5 text-xs'>${escapeHTML(x)}</span>`).join('')}
             </div>` : ''}

        <div class='pt-2 flex flex-wrap gap-2'>
          <button class='btn-plan rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Planlegg denne</button>
          <button class='btn-edit rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Rediger</button>
          <button class='btn-dup  rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Dupliser</button>
          <button class='btn-del text-red-700 border-red-300 bg-red-50 rounded-xl border px-3 py-1.5 shadow-sm'>Slett</button>
        </div>
      </div>`;

    c.querySelector('.btn-plan').addEventListener('click', ()=> openDialog(fromTemplate(t)));
    c.querySelector('.btn-edit').addEventListener('click', ()=> openBankDialog({...t}));
    c.querySelector('.btn-dup').addEventListener('click', ()=>{
      const copy = { ...t, id: uid(), name: (t.name||'') + ' (kopi)' };
      openBankDialog(copy);
    });
    c.querySelector('.btn-del').addEventListener('click', async ()=>{
      if(!confirm('Slette denne bank-malen?')) return;
      state.bank = state.bank.filter(x=>x.id!==t.id);
      lsSet(KEY.BANK, state.bank);
      renderBank();
      await supaDeleteBankTemplate(t.id);
    });

    return c;
  }
  function fromTemplate(t){
    return {
      id:uid(),
      title:t.name, type:t.type,
      date:dayjs(`${state.year}-01-01`).format('YYYY-MM-DD'),
      modality:t.modality, intensity:t.intensity, durationMin:t.durationMin,
      age:t.age||[],
      shooting:t.shooting||{stilling:'',skudd:0,tema:[]},
      raceSubtype:t.raceSubtype, notes:t.notes||'', roles:{}, location:''
    };
  }

  // ---------- ICS & Excel exports ----------
  function exportICS(){
    const pad=n=>String(n).padStart(2,'0');
    const fmt=d=> `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
    const escIcs=s=> (s||'').replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/[,;]/g, m=> '\\'+m);
    const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//LSS Årsplan//NO'];

    state.events.forEach(e=>{
      const start=new Date(e.date+'T17:00:00');
      const end=new Date(start.getTime()+((e.durationMin||60)*60000));
      const title=e.title||(e.type+(e.raceSubtype?(' – '+e.raceSubtype):''));
      lines.push('BEGIN:VEVENT');
      lines.push('UID:'+e.id);
      lines.push('DTSTAMP:'+fmt(new Date()));
      lines.push('DTSTART:'+fmt(start));
      lines.push('DTEND:'+fmt(end));
      lines.push('SUMMARY:'+escIcs(title));
      if(e.location) lines.push('LOCATION:'+escIcs(e.location));
      if(e.notes)    lines.push('DESCRIPTION:'+escIcs(e.notes));
      lines.push('END:VEVENT');
    });

    lines.push('END:VCALENDAR');
    const blob=new Blob([lines.join('\n')],{type:'text/calendar'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='lss_arsplan.ics'; a.click();
    URL.revokeObjectURL(url);
  }

  async function fetchAllEventsFromSupabase(){
    const pageSize = 1000;
    let from = 0, to = pageSize - 1;
    let all = [];
    while(true){
      const { data, error } = await supabase
        .from(TBL.events)
        .select('*')
        .order('date', { ascending: true })
        .range(from, to);
      if(error) throw error;
      all = all.concat(data || []);
      if(!data || data.length < pageSize) break;
      from += pageSize; to += pageSize;
    }
    return all;
  }
  async function fetchAllFromSupabase(table){
    const pageSize = 1000;
    let from = 0, to = pageSize - 1;
    let all = [];
    while(true){
      const { data, error } = await supabase
        .from(table)
        .select('*')
        .order('created_at', { ascending: true })
        .range(from, to);
      if(error) throw error;
      all = all.concat(data || []);
      if(!data || data.length < pageSize) break;
      from += pageSize; to += pageSize;
    }
    return all;
  }
  function rowsForEventsExcel(rawRows){
    return (rawRows||[]).map(r=>{
      const d = dayjs(r.date);
      const shooting = r.shooting || {};
      const tema = Array.isArray(shooting.tema) ? shooting.tema.join(' | ') : '';
      const roles = r.roles
        ? Object.entries(r.roles)
            .filter(([,v])=>(v||'').trim().length)
            .map(([k,v])=>`${k}: ${v}`).join(' | ')
        : '';
      const age = Array.isArray(r.age) ? r.age.join(' | ') : '';
      return {
        ID: r.id || '',
        Dato: r.date || '',
        Ukedag: d.isValid()? d.format('dddd') : '',
        Ukenr: d.isValid()? (typeof d.isoWeek==='function' ? d.isoWeek() : '') : '',
        År: d.isValid()? d.year() : '',
        Tittel: r.title || '',
        Type: r.type || r.event_type || '',
        Konkurranse: r.race_subtype || '',
        Sted: r.location || '',
        Modalitet: r.modality || '',
        Intensitet: r.intensity || '',
        Varighet_min: (r.duration_min ?? ''),
        Skytestilling: shooting.stilling || '',
        Skudd: (shooting.skudd ?? ''),
        Tema: tema,
        Aldersklasser: age,
        Roller: roles,
        Notater: r.notes || '',
        Opprettet: r.created_at || '',
        Oppdatert: r.updated_at || ''
      };
    });
  }
  function rowsForBankExcel(rawRows){
    return (rawRows||[]).map(r=>{
      const shooting = r.shooting || {};
      const tema = Array.isArray(shooting.tema) ? shooting.tema.join(' | ') : '';
      const age = Array.isArray(r.age) ? r.age.join(' | ') : '';
      return {
        ID: r.id || '',
        Navn: r.name || '',
        Type: r.type || '',
        Modalitet: r.modality || '',
        Intensitet: r.intensity || '',
        Varighet_min: (r.duration_min ?? ''),
        Aldersklasser: age,
        Skytestilling: shooting.stilling || '',
        Skudd: (shooting.skudd ?? ''),
        Tema: tema,
        Konkurranse: r.race_subtype || '',
        Notater: r.notes || '',
        Opprettet: r.created_at || '',
        Oppdatert: r.updated_at || ''
      };
    });
  }
  function downloadXlsxMultiple(sheets){
    const wb = XLSX.utils.book_new();
    for(const {name, rows} of sheets){
      const ws = XLSX.utils.json_to_sheet(rows, { cellDates:false });
      const cols = Object.keys(rows[0] || {A:''}).map(k=>({wch: Math.min(50, Math.max(10, String(k).length+2))}));
      ws['!cols'] = cols;
      XLSX.utils.book_append_sheet(wb, ws, name.slice(0,31));
    }
    const stamp = dayjs().format('YYYYMMDD_HHmm');
    XLSX.writeFile(wb, `lss_arsplan_og_oktbank_${stamp}.xlsx`);
  }
  async function exportExcelAll(){
    try{
      let rawEvents = await fetchAllEventsFromSupabase();
      let rawBank   = await fetchAllFromSupabase(TBL.bank);

      if(!rawEvents || rawEvents.length===0) rawEvents = (state.events||[]).map(mapEventToDb);
      if(!rawBank   || rawBank.length===0)   rawBank   = (state.bank||[]).map(mapBankToDb);

      const rowsEvents = rowsForEventsExcel(rawEvents);
      const rowsBank   = rowsForBankExcel(rawBank);
      if(rowsEvents.length===0 && rowsBank.length===0){
        alert('Ingen data å eksportere.');
        return;
      }
      downloadXlsxMultiple([
        { name:'Årsplan', rows: rowsEvents.length? rowsEvents : [{Merk:'Tomt'}] },
        { name:'Øktbank', rows: rowsBank.length? rowsBank : [{Merk:'Tomt'}] }
      ]);
    }catch(err){
      console.error('Excel-eksport feilet (sky):', err);
      alert('Kunne ikke hente alt fra skyen. Eksporterer det som er lastet lokalt.');
      const rowsEvents = rowsForEventsExcel((state.events||[]).map(mapEventToDb));
      const rowsBank   = rowsForBankExcel((state.bank||[]).map(mapBankToDb));
      if(rowsEvents.length===0 && rowsBank.length===0){
        alert('Ingen data å eksportere.');
        return;
      }
      downloadXlsxMultiple([
        { name:'Årsplan', rows: rowsEvents.length? rowsEvents : [{Merk:'Tomt'}] },
        { name:'Øktbank', rows: rowsBank.length? rowsBank : [{Merk:'Tomt'}] }
      ]);
    }
  }

  // ---------- Dialog helpers ----------
  function select(id, options, selected){
    return `<select id='${id}' class='mt-1 w-full rounded-xl border px-3 py-2'>
      ${options.map(opt=>`<option ${opt===selected?'selected':''}>${opt}</option>`).join('')}
    </select>`;
  }
  function openDialog(data){
    const existing = state.events.find(x=>x.id===data.id);
    const isEdit = !!existing;

    const model=Object.assign(
      { id:uid(), title:'', type:'Trening', date:dayjs().format('YYYY-MM-DD'), modality:'', intensity:'', durationMin:60, age:[], shooting:{stilling:'',skudd:0,tema:[]}, notes:'', raceSubtype:'', roles:{}, location:'' },
      data
    );

    const body=$('#dlg-body'); body.innerHTML='';
    $('#dlg-title').textContent=isEdit?'Rediger hendelse':'Ny hendelse';
    $('#btn-delete').classList.toggle('hidden',!isEdit);
    $('#btn-save')?.classList.remove('hidden');
    $('#btn-save')?.removeAttribute('disabled');

    const field=(label,inputHTML)=>`<div><label class='text-sm font-medium'>${label}</label>${inputHTML}</div>`;
    const ageChks = (state.ageGroups||[]).map(g=>`<label class='inline-flex items-center gap-2 rounded-xl border px-2 py-1'><input data-age='${g.id}' type='checkbox' ${model.age.includes(g.id)?'checked':''}/> <span class='text-sm'>${g.label}</span></label>`).join('');

    body.innerHTML=`
      ${field('Tittel', `<input id='f-title' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.title)}" placeholder='F.eks. I3 drag + 30 skudd'/>`)}
      <div class='grid grid-cols-2 gap-3'>
        ${field('Type', select('f-type', ['Trening','Skyting','Konkurranse','Samling','Restitusjon','Annet'], model.type))}
        ${field('Dato', `<input id='f-date' type='date' class='mt-1 w-full rounded-xl border px-3 py-2' value='${dayjs(model.date).format('YYYY-MM-DD')}'/>`)}
      </div>
      ${field('Sted/plassering', `<input id='f-loc' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.location||'')}" placeholder='F.eks. Sørli'/>`)}
      <div class='grid grid-cols-2 gap-3'>
        ${field('Modalitet', select('f-mod', MODALITETER, model.modality))}
        ${field('Intensitet', select('f-int', INTENS, model.intensity))}
      </div>
      <div class='grid grid-cols-3 gap-3'>
        ${field('Varighet (min)', `<input id='f-dur' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.durationMin||60}'/>`)}
        ${field('Skytestilling', select('f-still', ['Liggende','Stående','Kombinert','Variert','Konk'], model.shooting.stilling||''))}
        ${field('Skudd', `<input id='f-skudd' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.shooting.skudd||0}'/>`)}
      </div>
      <div>
        <label class='text-sm font-medium'>Tema (skyting)</label>
        <div class='mt-1 flex flex-wrap gap-1' id='tema-tags'></div>
        <div class='mt-1 flex gap-2'>
          <input id='f-tema' class='w-full rounded-xl border px-3 py-2' placeholder='Skriv tema og Enter (f.eks. Overganger (inn/ut))'/>
          <button id='add-tema' class='rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Legg til</button>
        </div>
      </div>
      <div>
        <label class='text-sm font-medium'>Målgruppe</label>
        <div class='mt-1 flex flex-wrap gap-2'>${ageChks}</div>
      </div>
      <div>
        <label class='text-sm font-medium'>Roller</label>
        <div class='mt-1 grid grid-cols-2 gap-2'>
          ${['Hovedtrener','Assistent','Standplass','Lagleder/foreldre'].map(r=>`<div><div class='text-xs text-slate-600 mb-1'>${r}</div><input data-role='${r}' class='w-full rounded-xl border px-3 py-2' value='${escapeHTML(model.roles[r]||'')}' placeholder='Navn(e), komma-separert'/></div>`).join('')}
        </div>
      </div>
      <div>
        <label class='text-sm font-medium'>Notater</label>
        <textarea id='f-notes' rows='4' class='mt-1 w-full rounded-xl border px-3 py-2' placeholder='Detaljer, fokusområder, oppmøtested, utstyr…'>${escapeHTML(model.notes||'')}</textarea>
      </div>`;

    function refreshTema(){
      const holder = $('#tema-tags');
      holder.innerHTML = '';
      (model.shooting.tema || []).forEach((t, i) => {
        const b = document.createElement('span');
        b.className = 'inline-flex items-center gap-2 rounded-full border px-2 py-0.5 text-xs';
        b.textContent = t;
        const x = document.createElement('button');
        x.textContent = '×';
        x.className = 'ml-1';
        x.onclick = () => { model.shooting.tema.splice(i, 1); refreshTema(); };
        b.appendChild(x);
        holder.appendChild(b);
      });
    }
    refreshTema();
    $('#add-tema').onclick=()=>{ const v=$('#f-tema').value.trim(); if(!v) return; model.shooting.tema = Array.from(new Set([...(model.shooting.tema||[]), v])); $('#f-tema').value=''; refreshTema(); };

    $('#btn-save').onclick = async () => {
      const get = (id) => $('#'+id, body);
      const wasNew = state.events.findIndex(x => x.id === model.id) < 0;

      model.title       = get('f-title').value.trim();
      model.type        = get('f-type').value;
      model.date        = get('f-date').value;
      model.location    = get('f-loc').value.trim();
      model.modality    = get('f-mod').value;
      model.intensity   = get('f-int').value;
      model.durationMin = parseInt(get('f-dur').value) || 60;
      model.shooting    = { stilling: get('f-still').value, skudd: parseInt(get('f-skudd').value) || 0, tema: model.shooting.tema || [] };
      model.notes       = get('f-notes').value;
      model.raceSubtype = model.type === 'Konkurranse' ? (model.raceSubtype || '') : '';
      model.age         = (state.ageGroups||[]).map(g => g.id).filter(id => $('[data-age="'+id+'"]', body).checked);
      model.roles       = {}; ['Hovedtrener','Assistent','Standplass','Lagleder/foreldre'].forEach(r => model.roles[r] = $('[data-role="'+r+'"]', body).value);

      const i = state.events.findIndex(x => x.id === model.id);
      if (i >= 0) state.events[i] = model; else state.events.push(model);
      lsSet(KEY.EVENTS, state.events);
      render();
      await supaUpsertEvent(model);

      if (wasNew){ const ids = getOrderForDate(model.date); setOrderForDate(model.date, [...ids, model.id]); }

      closeDialog();
    };

    $('#btn-delete').onclick=async ()=>{
      state.events=state.events.filter(x=>x.id!==model.id); lsSet(KEY.EVENTS,state.events); render();
      await supaDeleteEvent(model);
      const ids = getOrderForDate(model.date).filter(x=> x !== model.id); setOrderForDate(model.date, ids);
      closeDialog();
    };

    $('#btn-cancel').onclick=closeDialog; $('#dlg-close').onclick=closeDialog;
    $('#dialog').classList.remove('hidden'); $('#dialog').classList.add('flex');
  }
  function openViewDialog(model){
    const body = $('#dlg-body');
    $('#dlg-title').textContent = 'Vis hendelse';
    $('#btn-delete').classList.add('hidden'); $('#btn-save').classList.add('hidden');
    const esc = escapeHTML;
    const row = (label, value) => `<div class="grid grid-cols-3 gap-3 items-start"><div class="text-sm font-medium text-slate-700 col-span-1">${label}</div><div class="text-sm col-span-2">${value||'–'}</div></div>`;
    const ageChips = (model.age||[]).map(a=>`<span class="rounded-full border px-2 py-0.5 text-xs mr-1">${esc(a)}</span>`).join('');
    const tema = (model.shooting?.tema||[]).length
      ? `<div class="mt-1 flex flex-wrap gap-1">${model.shooting.tema.map(t=>`<span class="rounded-full border px-2 py-0.5 text-[10px]">${esc(t)}</span>`).join('')}</div>`
      : '';

    body.innerHTML = `
      ${row('Tittel', esc(model.title))}
      ${row('Dato', dayjs(model.date).format('DD.MM.YYYY'))}
      ${row('Sted', esc(model.location||''))}
      ${row('Type', esc(model.type))}
      ${row('Modalitet', esc(model.modality))}
      ${row('Intensitet', esc(model.intensity))}
      ${row('Varighet', model.durationMin? esc(String(model.durationMin))+' min':'–')}
      ${row('Målgrupper', ageChips || '–')}
      ${row('Skyting', `${esc(model.shooting?.stilling||'–')}, ${model.shooting?.skudd||0} skudd ${tema}`)}
      ${model.type==='Konkurranse' ? row('Konkurranse-type', esc(model.raceSubtype||'')) : ''}
      ${row('Notater', esc(model.notes))}
      ${row('Roller', Object.entries(model.roles||{}).filter(([,v])=>v).map(([k,v])=>`<div><span class="font-medium">${esc(k)}:</span> ${esc(v)}</div>`).join('') || '–')}
    `;

    $('#btn-cancel').onclick=closeDialog; 
    $('#dlg-close').onclick=closeDialog;
    $('#dialog').classList.remove('hidden'); 
    $('#dialog').classList.add('flex');
  }
  function openBankDialog(data = {}){
    const existing = state.bank.find(x => x.id === data.id);
    const isEdit = !!existing;

    const model = Object.assign({
      id: uid(),
      name: '',
      type: 'Trening',
      modality: '',
      intensity: '',
      durationMin: 60,
      age: [],
      shooting: { stilling:'', skudd:0, tema:[] },
      raceSubtype: '',
      notes: ''
    }, data);

    const body = $('#dlg-body');
    $('#dlg-title').textContent = isEdit ? 'Rediger bank-mal' : 'Ny bank-mal';
    $('#btn-delete').classList.toggle('hidden', !isEdit);
    $('#btn-save')?.classList.remove('hidden');
    $('#btn-save')?.removeAttribute('disabled');

    const field=(label,inputHTML)=>`<div><label class='text-sm font-medium'>${label}</label>${inputHTML}</div>`;
    const ageChks = (state.ageGroups||[])
      .map(g=>`<label class='inline-flex items-center gap-2 rounded-xl border px-2 py-1'>
                 <input data-age='${g.id}' type='checkbox' ${model.age.includes(g.id)?'checked':''}/>
                 <span class='text-sm'>${g.label}</span>
               </label>`).join('');

    body.innerHTML = `
      ${field('Navn', `<input id='bk-name' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.name)}" placeholder='F.eks. I3 bakkedrag + styrke'/>`)}

      <div class='grid grid-cols-2 gap-3'>
        ${field('Type', select('bk-type', ['Trening','Skyting','Konkurranse','Samling','Restitusjon','Annet'], model.type))}
        ${field('Modalitet', select('bk-mod', MODALITETER, model.modality))}
      </div>

      <div class='grid grid-cols-2 gap-3'>
        ${field('Intensitet', select('bk-int', INTENS, model.intensity))}
        ${field('Varighet (min)', `<input id='bk-dur' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.durationMin||60}'/>`)}
      </div>

      <div id="bk-race-row" class="${model.type==='Konkurranse'?'':'hidden'}">
        ${field('Konkurranse-type', `<input id='bk-race' class='mt-1 w-full rounded-xl border px-3 py-2' value="${escapeHTML(model.raceSubtype||'')}" placeholder='Sprint, Fellesstart …'/>`)}
      </div>

      <div class='grid grid-cols-3 gap-3'>
        ${field('Skytestilling', select('bk-still', ['','Liggende','Stående','Kombinert','Variert','Konk'], model.shooting.stilling||''))}
        ${field('Skudd', `<input id='bk-skudd' type='number' class='mt-1 w-full rounded-xl border px-3 py-2' value='${model.shooting.skudd||0}'/>`)}
        <div></div>
      </div>

      <div>
        <label class='text-sm font-medium'>Tema (skyting)</label>
        <div class='mt-1 flex flex-wrap gap-1' id='bk-tema-tags'></div>
        <div class='mt-1 flex gap-2'>
          <input id='bk-tema' class='w-full rounded-xl border px-3 py-2' placeholder='Skriv tema og Enter (f.eks. Overganger (inn/ut))'/>
          <button id='bk-add-tema' class='rounded-xl border bg-white px-3 py-1.5 shadow-sm'>Legg til</button>
        </div>
      </div>

      <div>
        <label class='text-sm font-medium'>Målgruppe</label>
        <div class='mt-1 flex flex-wrap gap-2'>${ageChks}</div>
      </div>

      <div>
        <label class='text-sm font-medium'>Notater</label>
        <textarea id='bk-notes' rows='4' class='mt-1 w-full rounded-xl border px-3 py-2' placeholder='Beskrivelse, progresjon, variasjoner…'>${escapeHTML(model.notes||'')}</textarea>
      </div>
    `;

    function refreshTema(){
      const holder = $('#bk-tema-tags');
      holder.innerHTML = '';
      (model.shooting.tema || []).forEach((t, i) => {
        const b = document.createElement('span');
        b.className = 'inline-flex items-center gap-2 rounded-full border px-2 py-0.5 text-xs';
        b.textContent = t;
        const x = document.createElement('button');
        x.textContent = '×';
        x.className = 'ml-1';
        x.onclick = () => { model.shooting.tema.splice(i, 1); refreshTema(); };
        b.appendChild(x);
        holder.appendChild(b);
      });
    }
    refreshTema();

    $('#bk-add-tema').onclick = (e)=>{ e.preventDefault();
      const v=$('#bk-tema').value.trim(); if(!v) return;
      model.shooting.tema = Array.from(new Set([...(model.shooting.tema||[]), v]));
      $('#bk-tema').value=''; refreshTema();
    };

    $('#bk-type').addEventListener('change', (e)=>{
      const isKonk = e.target.value === 'Konkurranse';
      $('#bk-race-row').classList.toggle('hidden', !isKonk);
    });

    $('#btn-save').onclick = async ()=>{
      const get = (id) => $('#'+id, body);

      model.name        = get('bk-name').value.trim();
      model.type        = get('bk-type').value;
      model.modality    = get('bk-mod').value;
      model.intensity   = get('bk-int').value;
      model.durationMin = parseInt(get('bk-dur').value) || 60;
      model.raceSubtype = (model.type==='Konkurranse') ? (get('bk-race')?.value.trim() || '') : '';
      model.shooting    = {
        stilling: get('bk-still').value,
        skudd: parseInt(get('bk-skudd').value) || 0,
        tema: model.shooting.tema || []
      };
      model.notes       = get('bk-notes').value;
      model.age         = (state.ageGroups||[]).map(g => g.id).filter(id => $('[data-age="'+id+'"]', body).checked);

      if(!model.name){
        alert('Navn kan ikke være tomt.');
        return;
      }

      const i = state.bank.findIndex(x => x.id === model.id);
      if (i >= 0) state.bank[i] = model; else state.bank.unshift(model);
      lsSet(KEY.BANK, state.bank);
      renderBank();
      await supaUpsertBankTemplate(model);

      closeDialog();
    };

    $('#btn-delete').onclick = async ()=>{
      if(!confirm('Slette denne bank-malen?')) return;
      state.bank = state.bank.filter(x => x.id !== model.id);
      lsSet(KEY.BANK, state.bank);
      renderBank();
      await supaDeleteBankTemplate(model.id);
      closeDialog();
    };

    $('#btn-cancel').onclick = closeDialog;
    $('#dlg-close').onclick  = closeDialog;
    $('#dialog').classList.remove('hidden');
    $('#dialog').classList.add('flex');
  }
  function closeDialog(){ $('#dialog').classList.add('hidden'); $('#dialog').classList.remove('flex'); }

  // ---------- SKYTEHISTORIKK ----------
  // Parsing helpers (navn + år, og scoreformat)
  function parseAthleteCell(s){
    const t = (s||'').trim();
    if(!t) return { name:'', birthYear:null };
    const m = t.match(/^(.+?)(?:,\s*(\d{4}))?$/);
    return { name:(m? m[1].trim() : t), birthYear: m && m[2] ? +m[2] : null };
  }
  function parseScoreCell(s){
    const t=(s||'').toString().trim();
    if(!t) return { total:null, prone:null, stand:null, stand_hits:null };
    const m = t.match(/^(\d+)\s*\((\d+)\+(\d+)\)(?:\((\d+)\))?$/);
    if (!m) {
      const n = parseInt(t,10);
      if(Number.isFinite(n)) return { total:n, prone:null, stand:null, stand_hits:null };
      return { total:null, prone:null, stand:null, stand_hits:null };
    }
    return { total:+m[1], prone:+m[2], stand:+m[3], stand_hits: m[4]? +m[4] : null };
  }
  function formatScoreCell(v){
    const { total, prone, stand, stand_hits } = v || {};
    if(total==null && prone==null && stand==null) return '';
    const base = `${total ?? ''} (${prone ?? 0}+${stand ?? 0})`;
    return (stand_hits!=null) ? `${base}(${stand_hits})` : base;
  }

  // Import fra Excel (kol A kan inneholde gruppe-rader)
  async function shootImportFromExcel(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });

    // Anta: rad 2 = datoer, kol A = navn/grupper, blank rad = separator
    const headerRow = rows[1] || [];
    const datesRaw = headerRow.map((v, i)=> i===0 ? null : v).filter(v=>v);
    const dates = datesRaw.map(v=>{
      const d = dayjs(v);
      return d.isValid()? d.format('YYYY-MM-DD') : null;
    }).filter(Boolean);

    const athletes = [];      // alle utøverforekomster (kan dupliseres på tvers av grupper)
    const groups = [];        // navn på gruppe/øvelse
    const grid = {};          // `${ai}|${di}|${gi}` -> score

    let currentGroup = 'Uten gruppe';
    const groupSet = new Set();

    // Start lese fra rad 4 (0-indeks 3) – juster ved behov
    for(let r=3; r<rows.length; r++){
      const row = rows[r] || [];
      const aCell = (row[0] ?? '').toString().trim();

      // Tom rad = hopp
      if(aCell === '') continue;

      // Gruppeoverskrift hvis resten av raden er tom/ikke tall
      const isGroupHeader = row.slice(1).every(cell => (cell==='' || cell==null));
      if(isGroupHeader){
        currentGroup = aCell;
        groupSet.add(currentGroup);
        continue;
      }

      // Ellers: dette er en idrettsutøverlinje
      const a = parseAthleteCell(aCell);
      if(!a.name) continue;
      const ai = athletes.push(a) - 1;
      const gi = [...groupSet].indexOf(currentGroup);
      // hvis første gang
      if (gi === -1){
        groupSet.add(currentGroup);
      }
      const groupIndex = [...groupSet].indexOf(currentGroup);

      for(let c=1; c<=dates.length; c++){
        const raw = row[c];
        const sc = parseScoreCell(raw);
        if(sc.total!=null || sc.prone!=null || sc.stand!=null || sc.stand_hits!=null){
          const key = `${ai}|${c-1}|${groupIndex}`;
          grid[key] = sc;
        }
      }
    }

    state.shoot.athletes = athletes;
    state.shoot.dates = dates;
    state.shoot.groups = [...groupSet];
    state.shoot.grid = grid;
    lsSet(KEY.SHOOT, state.shoot);
    renderShootTable();
    populateChartAthletes();
    updateShootChart();
  }

  // Supabase (lagre/lese)
  // Supabase (lagre/lese) — robust mot 400 pga order=
async function shootLoadFromSupabase(){
  const { data, error } = await supabase
    .from(TBL.shoot)
    .select('*'); // <- ingen order i SQL

  if(error){ console.warn('[shoot] fetch error', error); return; }

  // Sorter stabilt i JS: group_label -> test_date -> athlete
  const rows = (data||[]).slice().sort((a,b)=>{
    const ga = (a.group_label || 'Uten gruppe').localeCompare(b.group_label || 'Uten gruppe', 'nb');
    if (ga) return ga;
    const da = (a.test_date || '').localeCompare(b.test_date || '');
    if (da) return da;
    return (a.athlete || '').localeCompare(b.athlete || '', 'nb');
  });

  // Normaliser til state
  const dates  = Array.from(new Set(rows.map(r => r.test_date))).filter(Boolean).sort();
  const groups = Array.from(new Set(rows.map(r => r.group_label || 'Uten gruppe')));

  const athletesList = [];
  const aIndex = new Map();
  rows.forEach(r=>{
    const key = r.athlete || '';
    if(!aIndex.has(key)){
      aIndex.set(key, athletesList.length);
      athletesList.push({ name: key, birthYear: r.birth_year ?? null });
    }
  });

  const gIndex = new Map(groups.map((g,i)=>[g,i]));
  const dIndex = new Map(dates.map((d,i)=>[d,i]));
  const grid = {};

  rows.forEach(r=>{
    const ai = aIndex.get(r.athlete || '');
    const di = dIndex.get(r.test_date);
    const gi = gIndex.get(r.group_label || 'Uten gruppe');
    if (ai==null || di==null || gi==null) return;
    const key = `${ai}|${di}|${gi}`;
    grid[key] = {
      total: r.total ?? null,
      prone: r.prone ?? null,
      stand: r.stand ?? null,
      stand_hits: r.stand_hits ?? null
    };
  });

  state.shoot.athletes = athletesList;
  state.shoot.dates    = dates;
  state.shoot.groups   = groups;
  state.shoot.grid     = grid;
  lsSet(KEY.SHOOT, state.shoot);

  renderShootTable();
  populateChartAthletes();
  updateShootChart();
}

  async function shootSaveToSupabase(){
    const rows = [];
    state.shoot.athletes.forEach((a, ai)=>{
      state.shoot.dates.forEach((dt, di)=>{
        state.shoot.groups.forEach((g, gi)=>{
          const key = `${ai}|${di}|${gi}`;
          const sc = state.shoot.grid[key];
          if(!sc) return;
          rows.push({
            athlete: (a.name||'').trim(),
            birth_year: a.birthYear ?? null,
            test_date: dt,
            group_label: g || 'Uten gruppe',
            total: sc.total ?? null,
            prone: sc.prone ?? null,
            stand: sc.stand ?? null,
            stand_hits: sc.stand_hits ?? null
          });
        });
      });
    });

    if(rows.length===0){
      alert('Ingen skyterader å lagre.');
      return;
    }

    // enkel synk: slett alt og legg inn på nytt
    const { error: delErr } = await supabase.from(TBL.shoot).delete().neq('athlete','__never__');
    if(delErr){ console.warn(delErr); alert('Kunne ikke rydde tabellen i skyen.'); return; }

    // batch insert i porsjoner
    const chunk = 500;
    for(let i=0;i<rows.length;i+=chunk){
      const slice = rows.slice(i, i+chunk);
      const { error } = await supabase.from(TBL.shoot).insert(slice);
      if(error){ console.warn(error); alert('Feil ved opplasting av skytehistorikk (se konsoll).'); return; }
    }
    alert('Skytehistorikk lagret i sky.');
  }

  // Utheving (PB / dagens beste / klubbrekord)
  function computeHighlights(){
    const pb = new Map();        // 'navn' -> max
    const dayBest = new Map();   // `dato|gruppe` -> max
    let clubRec = -Infinity;

    state.shoot.athletes.forEach((a, ai)=>{
      state.shoot.dates.forEach((dt, di)=>{
        state.shoot.groups.forEach((g, gi)=>{
          const sc = state.shoot.grid[`${ai}|${di}|${gi}`];
          if(!sc || sc.total==null) return;
          // PB
          pb.set(a.name, Math.max(pb.get(a.name)||-Infinity, sc.total));
          // Day best per group
          const dk = `${dt}|${g}`;
          dayBest.set(dk, Math.max(dayBest.get(dk)||-Infinity, sc.total));
          // Club record
          clubRec = Math.max(clubRec, sc.total);
        });
      });
    });
    return { pb, dayBest, clubRec };
  }

  function renderShootTable(){
    const tbl = $('#shoot-table'); if(!tbl) return;
    const thead = tbl.querySelector('thead'); const tbody = tbl.querySelector('tbody');
    thead.innerHTML = ''; tbody.innerHTML = '';

    const q = ($('#shoot-q').value||'').toLowerCase();
    const from = $('#shoot-from').value;
    const to   = $('#shoot-to').value;
    const highlightMode = $('#shoot-highlight')?.value || 'all';

    // filter dates by range
    const dateIdx = state.shoot.dates
      .map((d,i)=>({d,i}))
      .filter(({d})=>{
        if(from && dayjs(d).isBefore(from)) return false;
        if(to   && dayjs(d).isAfter(to)) return false;
        return true;
      });

    // header
    const trh = document.createElement('tr');
    trh.innerHTML = `<th class="sticky left-0 bg-slate-50 p-2 text-left">Utøver</th>${
      dateIdx.map(({d})=>`<th class="px-2 py-1 whitespace-nowrap">${dayjs(d).format('DD.MM')}</th>`).join('')
    }`;
    thead.appendChild(trh);

    const { pb, dayBest, clubRec } = computeHighlights();

    // tegn gruppe for gruppe
    state.shoot.groups.forEach((g, gi)=>{
      // gruppe-rad
      const gr = document.createElement('tr');
      gr.innerHTML = `<td class="bg-slate-100 font-semibold px-2 py-1 sticky left-0">🏷 ${escapeHTML(g||'Uten gruppe')}</td>${
        dateIdx.map(()=>`<td class="bg-slate-100"></td>`).join('')
      }`;
      tbody.appendChild(gr);

      // alle utøver-forekomster som har minst én verdi i gruppa (og matcher søk)
      state.shoot.athletes.forEach((a, ai)=>{
        if(q && !a.name.toLowerCase().includes(q)) return;

        // har vi data for denne (ai,gi)?
        const hasAny = dateIdx.some(({i:di}) => !!state.shoot.grid[`${ai}|${di}|${gi}`]);
        if(!hasAny) return;

        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const left = document.createElement('td');
        left.className = 'sticky left-0 bg-white px-2 py-1 whitespace-nowrap';
        left.textContent = `${a.name}${a.birthYear? `, ${a.birthYear}`:''}`;
        tr.appendChild(left);

        dateIdx.forEach(({i:di, d:ds})=>{
          const key = `${ai}|${di}|${gi}`;
          const v = state.shoot.grid[key] || { total:null, prone:null, stand:null, stand_hits:null };

          const td = document.createElement('td');
          td.className = 'px-1 py-0.5';

          // utheving
          if(v.total!=null){
            const isPB   = pb.get(a.name) === v.total;
            const isDay  = dayBest.get(`${ds}|${g||'Uten gruppe'}`) === v.total;
            const isClub = clubRec === v.total;

            const mode = (highlightMode || 'all');
            if(isPB   && (mode==='all' || mode==='pb'))   td.classList.add('sh-pb');
            if(isDay  && (mode==='all' || mode==='day'))  td.classList.add('sh-daybest');
            if(isClub && (mode==='all' || mode==='club')) td.classList.add('sh-clubrec');
          }

          // redigerbar input
          const inp = document.createElement('input');
          inp.className = 'w-28 max-w-[8.5rem] rounded-md border px-1 py-1 text-sm';
          inp.value = formatScoreCell(v);
          inp.placeholder = '391 (264+127)';

          inp.addEventListener('change', ()=>{
            const parsed = parseScoreCell(inp.value);
            // tom streng => fjern celle
            if((inp.value||'').trim()===''){
              delete state.shoot.grid[key];
            }else{
              state.shoot.grid[key] = parsed;
            }
            lsSet(KEY.SHOOT, state.shoot);
            // oppdater uthevinger/graf raskt
            renderShootTable();
            updateShootChart();
          });

          td.appendChild(inp);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    });
  }

  function populateChartAthletes(){
    const sel = $('#shoot-chart-ath'); if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = state.shoot.athletes
      .map((a, i)=>`<option value="${i}">${escapeHTML(a.name)}${a.birthYear?`, ${a.birthYear}`:''}</option>`)
      .join('');
    if(cur) sel.value = cur;
  }

  let shootChart;
  function bestPerDateForAthlete(ai){
    // finn beste total pr dato på tvers av grupper
    return state.shoot.dates.map((ds, di)=>{
      let best = null;
      state.shoot.groups.forEach((g, gi)=>{
        const v = state.shoot.grid[`${ai}|${di}|${gi}`];
        if(!v || v.total==null) return;
        best = (best==null) ? v.total : Math.max(best, v.total);
      });
      return best;
    });
  }
  function updateShootChart(){
    const ctx = document.getElementById('shoot-chart'); if(!ctx) return;
    const ai = parseInt($('#shoot-chart-ath').value || '0', 10) || 0;

    const labels = state.shoot.dates.map(ds => dayjs(ds).format('DD.MM'));
    const data = bestPerDateForAthlete(ai);

    if(shootChart){ shootChart.destroy(); }
    shootChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: (state.shoot.athletes[ai]?.name || 'Utøver') + ' – beste total pr dato',
          data,
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: true } },
        scales: {
          y: { beginAtZero: false, suggestedMin: 200, suggestedMax: 400 }
        }
      }
    });
  }

  // --- Skytehistorikk: add/eksport
  function shootAddDate(){
    const d = prompt('Ny testdato (YYYY-MM-DD):', dayjs().format('YYYY-MM-DD'));
    if(!d || !dayjs(d).isValid()) return;
    if(!state.shoot.dates.includes(d)){
      state.shoot.dates.push(d);
      state.shoot.dates.sort((a,b)=> dayjs(a)-dayjs(b));
      lsSet(KEY.SHOOT, state.shoot);
      renderShootTable();
      updateShootChart();
    }
  }
  function shootAddAthlete(){
    const name = (prompt('Navn (ev. ", 2010" for fødselsår):')||'').trim();
    if(!name) return;
    const a = parseAthleteCell(name);
    const ai = state.shoot.athletes.push(a) - 1;
    // ingen celler fylt – bare tegn tabellen
    lsSet(KEY.SHOOT, state.shoot);
    renderShootTable();
    populateChartAthletes();
    $('#shoot-chart-ath').value = String(ai);
    updateShootChart();
  }

  function shootExportExcel(){
    // én felles sheet med kolonner: Group, Athlete, BirthYear, Date, Total, Prone, Stand, StandHits
    const rows = [];
    state.shoot.athletes.forEach((a, ai)=>{
      state.shoot.dates.forEach((dt, di)=>{
        state.shoot.groups.forEach((g, gi)=>{
          const sc = state.shoot.grid[`${ai}|${di}|${gi}`];
          if(!sc) return;
          rows.push({
            Gruppe: g || 'Uten gruppe',
            Utøver: a.name || '',
            Fødselsår: a.birthYear ?? '',
            Dato: dt,
            Total: sc.total ?? '',
            Liggende: sc.prone ?? '',
            Stående: sc.stand ?? '',
            TreffStå: sc.stand_hits ?? ''
          });
        });
      });
    });
    if(rows.length===0){ alert('Ingen rader å eksportere.'); return; }

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Skytehistorikk');
    const stamp = dayjs().format('YYYYMMDD_HHmm');
    XLSX.writeFile(wb, `lss_skytehistorikk_${stamp}.xlsx`);
  }

  // ---------- Admin søk ----------
  async function adminFilter(){
    const q = ($('#admin-q').value||'').toLowerCase();
    const from = $('#admin-from').value;
    const to   = $('#admin-to').value;
    let list = state.events.filter(e => dayjs(e.date).year() === state.year);
    if (from) list = list.filter(e => dayjs(e.date).isSame(from) || dayjs(e.date).isAfter(from));
    if (to)   list = list.filter(e => dayjs(e.date).isSame(to) || dayjs(e.date).isBefore(to));
    if (q) list = list.filter(e=>{
      const hay = [e.title, e.type, e.location, e.modality, e.intensity, e.notes].join(' ').toLowerCase();
      return hay.includes(q);
    });
    renderAdminEvents(list);
  }

  // ---------- Default-økter ----------
  function getDefaultTemplates(){
    const base = [
      { id: uid(), name:'Rolig langkjøring', type:'Trening', modality:'Løp', intensity:'I1', durationMin:60, age:['11-12','13-14','HL'], shooting:{stilling:'',skudd:0,tema:[]}, notes:'Rolig pratetempo.' },
      { id: uid(), name:'Styrke helkropp', type:'Trening', modality:'Styrke', intensity:'I2', durationMin:45, age:['9-10','11-12','13-14','HL'], shooting:{stilling:'',skudd:0,tema:[]}, notes:'Kroppsvekt + stabilitet.' },
      { id: uid(), name:'Skyte­teknikk basis LIG', type:'Skyting', modality:'', intensity:'I1', durationMin:50, age:['9-10','11-12'], shooting:{stilling:'Liggende', skudd:60, tema:['Stilling: støtte/kontakt', 'Avtrekksrutine 5-pkt', 'Siktebilde ro']}, notes:'6×5 skudd serier med tørrtrening mellom.' },
      { id: uid(), name:'Overganger inn/ut (stå+ligg)', type:'Skyting', modality:'', intensity:'I2', durationMin:60, age:['11-12','13-14'], shooting:{stilling:'Variert', skudd:80, tema:['Inn på matte', 'Utplassering staver', 'Rytme ut']}, notes:'3 blokker à 4×5 skudd.' },
      { id: uid(), name:'I3 rulleski + stående presisjon', type:'Trening', modality:'Rulleski skøyting', intensity:'I3', durationMin:60, age:['13-14','HL'], shooting:{stilling:'Stående', skudd:40, tema:['Stabil kjerne','Pust/avtrekk under puls']}, notes:'4×5 min I3. 2×10 skudd stående mellom drag.' },
      { id: uid(), name:'Konk-simulering Sprint', type:'Konkurranse', modality:'Rulleski skøyting', intensity:'I4', durationMin:45, age:['HL'], shooting:{stilling:'Konk', skudd:20, tema:['Veksling ligg/stå','Skyteplan','Strafrunder']}, raceSubtype:'Sprint', notes:'Oppvarming 15 min. 2 skytinger m/strafrunde.' },
      { id: uid(), name:'Restitusjon lett', type:'Restitusjon', modality:'Sykkel', intensity:'I1', durationMin:40, age:['13-14','HL'], shooting:{stilling:'',skudd:0,tema:[]}, notes:'Veldig rolig trilling.' }
    ];
    return base;
  }

  // ---------- Hendelser: diverse helpers ----------
  function renderAdminEvents(list = null){
    const tb = $('#admin-events'); if(!tb) return;
    tb.innerHTML = '';
    const src = Array.isArray(list) ? list : state.events.filter(e => dayjs(e.date).year() === state.year);
    src.forEach(e=>{
      const tr = document.createElement('tr'); tr.className='border-t';
      tr.innerHTML = `
        <td class="p-2 whitespace-nowrap">${dayjs(e.date).format('DD.MM.YYYY')}</td>
        <td class="p-2 truncate max-w-[220px]">${escapeHTML(e.title||'(uten tittel)')}</td>
        <td class="p-2">${escapeHTML(e.type||'')}</td>
        <td class="p-2 truncate max-w-[160px]">${escapeHTML(e.location||'')}</td>
        <td class="p-2">${escapeHTML(e.intensity||'')}</td>
        <td class="p-2 text-right pr-2">
          <button class="a-edit rounded-md border px-2 py-1 text-xs">Rediger</button>
        </td>
      `;
      tr.querySelector('.a-edit').addEventListener('click', ()=> openDialog({...e}));
      tb.appendChild(tr);
    });
  }

  // ---------- Tabs / init ----------
  function switchTab(id){
    $$('.tab-section').forEach(s => s.classList.add('hidden'));
    $('#tab-'+id)?.classList.remove('hidden');
  }

  async function init(){
    setupSidebarToggle();

    // knapper i header
    $('#btn-new')?.addEventListener('click', ()=> openDialog({ date: dayjs().format('YYYY-MM-DD') }));
    $('#btn-print')?.addEventListener('click', ()=> window.print());
    $('#btn-export-xlsx')?.addEventListener('click', exportExcelAll);
    $('#file-import')?.addEventListener('change', async (e)=>{
      // (legacy import av json – behold)
      const file = e.target.files?.[0]; if(!file) return;
      const txt = await file.text();
      const obj = JSON.parse(txt);
      if(obj.events) state.events = obj.events;
      if(obj.bank)   state.bank = obj.bank;
      render();
    });

    // årsnavigasjon
    $('#year-prev')?.addEventListener('click', ()=>{ state.year--; render(); supaLoadAll(state.year); });
    $('#year-next')?.addEventListener('click', ()=>{ state.year++; render(); supaLoadAll(state.year); });

    // tabs
    $$('button.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = btn.getAttribute('data-tab');
        switchTab(t);
      });
    });

    // direktelenke til skytehistorikk
    $('#link-shoot')?.addEventListener('click', (e)=>{ e.preventDefault(); switchTab('shoot'); });

    // admin filter
    $('#admin-search')?.addEventListener('click', adminFilter);

    // bank søk/filtre
    $('#q-bank')?.addEventListener('input', debounce(renderBank, 120));
    $('#f-age')?.addEventListener('change', renderBank);
    $('#f-type')?.addEventListener('change', renderBank);
    $('#bank-new')?.addEventListener('click', ()=> openBankDialog({}));

    // weeks init
    if(!state.weeks || Object.keys(state.weeks).length===0){
      state.weeks = getDefaultWeeks(state.year);
    }

    // skytehistorikk – UI
    $('#shoot-file')?.addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      shootImportFromExcel(f);
      e.target.value = ''; // reset
    });
    $('#shoot-add-date')?.addEventListener('click', shootAddDate);
    $('#shoot-add-athlete')?.addEventListener('click', shootAddAthlete);
    $('#shoot-save')?.addEventListener('click', shootSaveToSupabase);
    $('#shoot-export')?.addEventListener('click', shootExportExcel);
    $('#shoot-q')?.addEventListener('input', debounce(()=>{ renderShootTable(); }, 120));
    $('#shoot-from')?.addEventListener('change', ()=>{ renderShootTable(); });
    $('#shoot-to')?.addEventListener('change', ()=>{ renderShootTable(); });
    $('#shoot-highlight')?.addEventListener('change', ()=>{ renderShootTable(); });

    $('#shoot-chart-ath')?.addEventListener('change', updateShootChart);

    // last fra supabase + realtime
    await supaLoadAll(state.year);
    await shootLoadFromSupabase();
    supaRealtimeInit();

    // lokal fallback for skytehistorikk
    const localShoot = lsGet(KEY.SHOOT, null);
    if(localShoot && (!state.shoot.athletes?.length)){
      state.shoot = localShoot;
    }

    // første render
    render();
    renderShootTable();
    populateChartAthletes();
    updateShootChart();

    // toolbar handling
    $('#toggle-list')?.addEventListener('click', ()=>{
      const el = $('#event-list'); if(!el) return;
      el.classList.toggle('hidden');
    });

    // eksport ICS
    $('#btn-ics')?.addEventListener('click', exportICS);

    // hurtig-knapper
    $('#quick-trening')?.addEventListener('click', ()=> openDialog({ type:'Trening', date: dayjs().format('YYYY-MM-DD') }));
    $('#quick-skyting')?.addEventListener('click', ()=> openDialog({ type:'Skyting', date: dayjs().format('YYYY-MM-DD') }));
    $('#quick-konk')?.addEventListener('click', ()=> openDialog({ type:'Konkurranse', date: dayjs().format('YYYY-MM-DD') }));

    // alder editor knapper
    $('#age-add')?.addEventListener('click', addAgeRow);
    $('#age-save')?.addEventListener('click', saveAgeRows);
    $('#age-editor')?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.age-del'); if(!btn) return;
      const i = Number(btn.getAttribute('data-i'));
      deleteAgeRow(i);
    });
  }

  // kick it
  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
