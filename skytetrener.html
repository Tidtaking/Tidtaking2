<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skiskyting ‚Äì Skyteanalyse Coach (kalibrert scoring)</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0c10; color:#e9eef2; }
    header { padding:20px; border-bottom:1px solid #1b1f2a;}
    h1 { margin:0; font-size:20px; letter-spacing:.3px;}
    main { display:grid; gap:var(--gap); grid-template-columns: 380px 1fr; padding:var(--gap);}
    @media (max-width: 900px){ main { grid-template-columns: 1fr; } }
    .card { background:#12141c; border:1px solid #1b1f2a; border-radius:12px; padding:16px; }
    .btn { background:#2a67ff; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.alt { background:#202636; }
    .btn.ghost { background:transparent; border:1px solid #2d3446; color:#cfd6df; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type=file] { display:none; }
    label.file { border:1px dashed #2d3446; border-radius:12px; padding:16px; display:block; text-align:center; cursor:pointer; color:#aeb8c7; }
    canvas { width:100%; background:#0b0c10; border-radius:12px; }
    .pill { background:#1b2335; color:#cfd6df; padding:6px 10px; border-radius:999px; font-size:12px; }
    .stat { display:grid; grid-template-columns: 1fr auto; gap:6px; padding:8px 0; border-bottom:1px dashed #1f2738; }
    .stat:last-child{ border-bottom:none; }
    .shots { display:flex; gap:6px; flex-wrap:wrap; }
    .shot { width:20px; height:20px; border-radius:50%; background:#2a67ff33; border:1px solid #2a67ff77; display:grid; place-items:center; font-size:10px; }
    .tips li { margin:6px 0; }
    .muted { color:#9aa6b2; }
    table { width:100%; border-collapse: collapse; }
    td,th { padding:6px 8px; border-bottom:1px solid #1f2738; text-align:left; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <h1>üèπ Skiskyting ‚Äì Skyteanalyse Coach (MVP + ringkalibrering & scoring)</h1>
  </header>

  <main>
    <!-- Venstre: kontrollpanel -->
    <section class="card">
      <h2 style="margin-top:0">1) Last opp blink</h2>
      <label class="file" id="dropzone">
        <input id="fileInput" type="file" accept="image/*" />
        Slipp bilde her eller klikk for √• velge
      </label>

      <div class="row" style="margin-top:10px">
        <button class="btn alt" id="rotateLeft">‚Ü∫ Roter</button>
        <button class="btn alt" id="resetView">‚§æ Nullstill visning</button>
        <span class="pill" id="zoomInfo">Zoom 100%</span>
      </div>

      <div style="height:16px"></div>
      <h2>2) Kalibrer</h2>
      <ol class="muted" style="margin-top:0">
        <li>Klikk senter av blinken.</li>
        <li>Klikk et punkt p√• en valgfri ring.</li>
        <li>Oppgi ringnummeret du klikket (f.eks. 10).</li>
      </ol>
      <div class="row" style="margin-bottom:6px">
        <button class="btn" id="centerMode">Sett sentrum</button>
        <button class="btn ghost" id="ringMode">Klikk p√• ring</button>
        <input id="ringNumber" type="number" min="1" max="20" placeholder="Ringnr (f.eks. 10)" style="width:140px;padding:10px;border-radius:10px;border:1px solid #2d3446;background:#0f1420;color:#e9eef2">
        <button class="btn alt" id="applyCalibration">Bruk ringnr</button>
      </div>
      <p class="muted" id="calibInfo">Ikke kalibrert.</p>

      <div class="row" style="margin-top:8px">
        <button class="btn ghost" id="shotMode">Marker skudd</button>
        <button class="btn ghost" id="undoShot">Angre siste</button>
        <button class="btn ghost" id="clearAll">Slett alt</button>
      </div>

      <div style="height:16px"></div>
      <h2>Analyse</h2>
      <div id="stats">
        <div class="stat"><div>Antall skudd</div><strong id="nShots">0</strong></div>
        <div class="stat"><div>Gruppesenter vs. senter (mm dx/dy)</div><strong id="centroid">(0,0)</strong></div>
        <div class="stat"><div>Ekstremspredning (mm)</div><strong id="extSpread">‚Äì</strong></div>
        <div class="stat"><div>Gj.snitt radius (mm)</div><strong id="avgRadius">‚Äì</strong></div>
        <div class="stat"><div>Horis./vert. std (mm)</div><strong id="stds">‚Äì</strong></div>
        <div class="stat"><div>Bias-retning</div><strong id="biasDir">‚Äì</strong></div>
        <div class="stat"><div>Totalscore (10-rings)</div><strong id="totalScore">‚Äì</strong></div>
        <div class="stat"><div>Biathlon 5/5 (‚â§10-ring)</div><strong id="biathlonHits">‚Äì</strong></div>
      </div>

      <div style="height:16px"></div>
      <h2>Skudd & score</h2>
      <table id="shotTable">
        <thead><tr><th>#</th><th>dx/dy (mm)</th><th>Radius (mm)</th><th>Ring</th><th>Poeng</th></tr></thead>
        <tbody></tbody>
      </table>

      <div style="height:16px"></div>
      <h2>Treningsr√•d</h2>
      <ul id="tips" class="tips"></ul>

      <div style="height:16px"></div>
      <h2>Lagre i Supabase (valgfritt)</h2>
      <div class="row">
        <input id="sessionName" placeholder="√òktnavn" style="flex:1;padding:10px;border-radius:10px;border:1px solid #2d3446;background:#0f1420;color:#e9eef2"/>
        <button class="btn" id="saveBtn">Lagre</button>
      </div>
      <p class="muted">Husk √• legge inn URL og anon key i koden.</p>
    </section>

    <!-- H√∏yre: lerret -->
    <section class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <div class="muted">Klikk for √• markere skudd. Scroll for √• zoome. Dra for √• panorere.</div>
        <div class="shots" id="shotsList"></div>
      </div>
      <canvas id="canvas" width="1400" height="1000"></canvas>
    </section>
  </main>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    // ---------- Konfig ----------
    const SUPABASE_URL = "YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ---------- State ----------
    const cvs = document.getElementById('canvas');
    const ctx = cvs.getContext('2d');
    let img = new Image();
    let imgLoaded = false;
    let rotation = 0;

    // world <-> screen
    let scale = 1;
    let offset = {x:0, y:0};
    let panning = false;
    let lastMouse = {x:0, y:0};

    // markering
    let shots = [];                 // {x,y}
    let center = null;              // {x,y}
    let ringPoint = null;           // {x,y} klikket p√• en ring
    let ringNumberVal = null;       // heltall (1..)
    let pxToMM = 0.25;              // fallback f√∏r kalibrering
    let ringStepMM = null;          // mm mellom ringene
    let ringsOverlayCount = 10;     // tegn 10 ringer som overlay

    let mode = 'shot';              // 'center' | 'ring' | 'shot'

    // ---------- UI ----------
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const rotateLeft = document.getElementById('rotateLeft');
    const resetView = document.getElementById('resetView');
    const zoomInfo = document.getElementById('zoomInfo');

    const centerModeBtn = document.getElementById('centerMode');
    const ringModeBtn = document.getElementById('ringMode');
    const ringNumberInput = document.getElementById('ringNumber');
    const applyCalibrationBtn = document.getElementById('applyCalibration');
    const calibInfo = document.getElementById('calibInfo');

    const shotModeBtn = document.getElementById('shotMode');
    const undoShotBtn = document.getElementById('undoShot');
    const clearAllBtn = document.getElementById('clearAll');
    const shotsList = document.getElementById('shotsList');

    const nShotsEl = document.getElementById('nShots');
    const centroidEl = document.getElementById('centroid');
    const extSpreadEl = document.getElementById('extSpread');
    const avgRadiusEl = document.getElementById('avgRadius');
    const stdsEl = document.getElementById('stds');
    const biasDirEl = document.getElementById('biasDir');
    const totalScoreEl = document.getElementById('totalScore');
    const biathlonHitsEl = document.getElementById('biathlonHits');
    const tipsEl = document.getElementById('tips');
    const shotTableBody = document.querySelector('#shotTable tbody');

    const saveBtn = document.getElementById('saveBtn');
    const sessionName = document.getElementById('sessionName');

    // ---------- Helpers ----------
    function draw(){
      ctx.clearRect(0,0,cvs.width,cvs.height);
      if(!imgLoaded){
        ctx.fillStyle = '#9aa6b2';
        ctx.textAlign='center';
        ctx.font='16px system-ui';
        ctx.fillText('Last opp et bilde for √• starte', cvs.width/2, cvs.height/2);
        return;
      }

      const iw = (rotation % 180 === 0) ? img.width : img.height;
      const ih = (rotation % 180 === 0) ? img.height : img.width;

      ctx.save();
      ctx.translate(offset.x, offset.y);
      ctx.scale(scale, scale);
      ctx.save();
      ctx.rotate(rotation * Math.PI/180);
      ctx.drawImage(img, 0, 0);
      ctx.restore();

      // Tegn i bildebasis
      ctx.save();
      ctx.rotate(rotation * Math.PI/180);

      // Overlay-ringer (kalibrert)
      if(center && ringStepMM){
        ctx.strokeStyle = '#48c77499';
        ctx.lineWidth = 1/scale;
        for(let r=1; r<=ringsOverlayCount; r++){
          const radPx = (r * ringStepMM) / pxToMM;
          ctx.beginPath(); ctx.arc(center.x, center.y, radPx, 0, Math.PI*2); ctx.stroke();
        }
      }

      // Center
      if(center){
        ctx.beginPath();
        ctx.arc(center.x, center.y, 8, 0, Math.PI*2);
        ctx.lineWidth = 2/scale;
        ctx.strokeStyle = '#2a67ff';
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(center.x-12, center.y); ctx.lineTo(center.x+12, center.y);
        ctx.moveTo(center.x, center.y-12); ctx.lineTo(center.x, center.y+12);
        ctx.stroke();
      }

      // Ring-klikk
      if(ringPoint){
        ctx.beginPath();
        ctx.arc(ringPoint.x, ringPoint.y, 6, 0, Math.PI*2);
        ctx.fillStyle = '#ffd166'; ctx.fill();
      }

      // Shots
      ctx.fillStyle = '#00d68fff';
      ctx.strokeStyle = '#002a24';
      shots.forEach((s,i)=>{
        ctx.beginPath(); ctx.arc(s.x, s.y, 6, 0, Math.PI*2); ctx.fill(); ctx.lineWidth = 2/scale; ctx.stroke();
        ctx.fillStyle = '#ffffff'; ctx.font = `${12/scale}px system-ui`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(i+1, s.x, s.y-14/scale);
        ctx.fillStyle = '#00d68fff';
      });

      // Gruppesentroid
      if(shots.length>0){
        const c = centroid(shots);
        ctx.beginPath(); ctx.arc(c.x, c.y, 5, 0, Math.PI*2); ctx.fillStyle = '#ffd166'; ctx.fill();
      }

      ctx.restore(); // slutt bildebasis
      ctx.restore();
    }

    function screenToImage(x,y){
      const ix = (x - offset.x)/scale;
      const iy = (y - offset.y)/scale;
      const r = -rotation * Math.PI/180;
      const rx = ix*Math.cos(r) - iy*Math.sin(r);
      const ry = ix*Math.sin(r) + iy*Math.cos(r);
      return {x:rx, y:ry};
    }

    function centroid(arr){ const n=arr.length; let sx=0, sy=0; arr.forEach(p=>{ sx+=p.x; sy+=p.y; }); return {x:sx/n, y:sy/n}; }
    function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

    function applyCalibration(){
      const rn = parseInt(ringNumberInput.value, 10);
      if(!center || !ringPoint || !rn || rn<=0){ calibInfo.textContent = 'Kalibrering mangler senter, ringpunkt eller ringnummer.'; return; }
      // ringStepMM = (avstand senter->ring) / ringnummer
      const dPx = dist(center, ringPoint);
      const dMM = dPx * pxToMM;
      ringStepMM = dMM / rn;
      calibInfo.textContent = `Kalibrert: ${ringStepMM.toFixed(2)} mm per ring (px‚Üímm=${pxToMM.toFixed(3)}).`;
      recompute();
      draw();
    }

    function scoreForRadiusMM(rad){
      if(!ringStepMM) return null;
      // Lavere radius => h√∏yere poeng. Poeng 10 p√• [0, <1*step), 9 p√• [1*step, <2*step) ...
      const ringIndex = Math.floor(rad / ringStepMM); // 0-bassert
      const score = Math.max(0, 10 - ringIndex);
      const ringNumber = ringIndex + 1; // menneskelig talt ring (1=en f√∏rste ringen fra sentrum)
      return { score, ringNumber };
    }

    function recompute(){
      const tbody = shotTableBody; tbody.innerHTML = '';
      nShotsEl.textContent = shots.length.toString();
      tipsEl.innerHTML = '';
      shotsList.innerHTML = '';

      if(shots.length===0){ centroidEl.textContent='(0,0)'; extSpreadEl.textContent='‚Äì'; avgRadiusEl.textContent='‚Äì'; stdsEl.textContent='‚Äì'; biasDirEl.textContent='‚Äì'; totalScoreEl.textContent='‚Äì'; biathlonHitsEl.textContent='‚Äì'; draw(); return; }

      const c = centroid(shots);
      let dx=0, dy=0;
      if(center){ dx = (c.x - center.x)*pxToMM; dy = (c.y - center.y)*pxToMM; }
      centroidEl.textContent = `${dx.toFixed(1)} / ${dy.toFixed(1)} mm`;

      // Ekstremspredning
      let maxd = 0;
      for(let i=0;i<shots.length;i++){
        for(let j=i+1;j<shots.length;j++){
          maxd = Math.max(maxd, dist(shots[i], shots[j]));
        }
      }
      extSpreadEl.textContent = (maxd*pxToMM).toFixed(1);

      // Radius/STD
      const ref = center || c;
      const radiiMM = shots.map(s => dist(s, ref)*pxToMM);
      const avgR = radiiMM.reduce((a,b)=>a+b,0)/radiiMM.length;
      avgRadiusEl.textContent = avgR.toFixed(1);

      const xs = shots.map(s=> (s.x - c.x)*pxToMM);
      const ys = shots.map(s=> (s.y - c.y)*pxToMM);
      const std = v => { const m=v.reduce((a,b)=>a+b,0)/v.length; return Math.sqrt(v.reduce((a,b)=>a+(b-m)*(b-m),0)/v.length); };
      const sx = std(xs), sy = std(ys);
      stdsEl.textContent = `${sx.toFixed(1)} / ${sy.toFixed(1)}`;

      let bias = '‚Äì';
      if(center){
        const ang = Math.atan2(dy, dx);
        const deg = ang*180/Math.PI;
        const dirs = ['h√∏yre','opph. h√∏yre','oppe','opph. venstre','venstre','nedv. venstre','nede','nedv. h√∏yre','h√∏yre'];
        const idx = Math.round(((deg+360)%360)/45);
        bias = `${dirs[idx]} (${Math.hypot(dx,dy).toFixed(1)} mm)`;
      }
      biasDirEl.textContent = bias;

      // Poengberegning + tabell
      let total = 0, biathlonHits = 0;
      shots.forEach((s,i)=>{
        const rmm = dist(s, center || c)*pxToMM;
        const scObj = scoreForRadiusMM(rmm);
        const score = scObj? scObj.score : null;
        const ringNum = scObj? scObj.ringNumber : '‚Äì';

        if(score!=null) total += score;
        if(ringStepMM && rmm <= ringStepMM) biathlonHits += 1; // "hit" hvis innenfor 10-ringen

        const dxs = center? ((s.x-center.x)*pxToMM) : ((s.x-c.x)*pxToMM);
        const dys = center? ((s.y-center.y)*pxToMM) : ((s.y-c.y)*pxToMM);

        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${dxs.toFixed(1)} / ${dys.toFixed(1)}</td><td>${rmm.toFixed(1)}</td><td>${ringNum}</td><td>${score==null?'‚Äì':score}</td>`;
        tbody.appendChild(tr);

        const div = document.createElement('div'); div.className='shot'; div.textContent=i+1; shotsList.appendChild(div);
      });
      totalScoreEl.textContent = ringStepMM ? `${total}` : '‚Äì';
      biathlonHitsEl.textContent = ringStepMM ? `${biathlonHits}/${shots.length}` : '‚Äì';

      // Tips
      buildTips({dx,dy,sx,sy,spread:maxd*pxToMM,avgR});
      draw();
    }

    function buildTips({dx,dy,sx,sy,spread,avgR}){
      const T = [];
      if(spread <= 35 && avgR <= 12){ T.push('God grupping! Fortsett med samme rytme. √òv serie-rutine (5 like skudd).'); }
      else if (spread <= 55){ T.push('Stabil grupping. Priorit√©r rent avtrekk og identisk kinnstilling.'); }
      else { T.push('Stor spredning: jobb med stillingsbygging og avtrekk (t√∏rrtrening 5√ó10 perfekte trykk).'); }

      if(Math.hypot(dx,dy) > 15){ T.push(`Systematisk avvik ${Math.hypot(dx,dy).toFixed(0)} mm: sjekk nullpunkt/sikte og kroppens naturlige retning f√∏r avtrekk.`); }
      if(sx > sy*1.25){ T.push('Horisontal spredning: typisk avtrekksbevegelse. √òv ‚Äúoverraskende‚Äù trykk + oppf√∏lging 1 s.'); }
      else if (sy > sx*1.25){ T.push('Vertikal spredning: jobb med pusterytme (utpust‚Äìkort pause‚Äìavtrekk) og jevnt skulderpress.'); }

      T.push('Oppgave: 5√ó5 skudd ‚Äì maks 1 klikk justering mellom seriene. Fokus p√• prosess.');
      T.push('Oppgave: T√∏rrtrening 10√ó ‚Äì lukk √∏yne 2 s ‚Üí √•pne ‚Üí trykk. Sjekk at siktet ikke ‚Äúdras‚Äù.');
      T.push('Oppgave: ‚ÄúPause-avtrekk‚Äù ‚Äì tell 1‚Äì2 etter utpust f√∏r trykk for √• unng√• krampehold.');
      tipsEl.innerHTML = T.map(t=>`<li>${t}</li>`).join('');
    }

    // ---------- Lytte p√• input ----------
    function loadFile(file){
      const reader = new FileReader();
      reader.onload = e => {
        img = new Image();
        img.onload = () => {
          imgLoaded = true;
          rotation = 0; scale = Math.min(cvs.width/img.width, cvs.height/img.height);
          offset.x = (cvs.width - img.width*scale)/2;
          offset.y = (cvs.height - img.height*scale)/2;
          // reset state
          shots = []; center = null; ringPoint=null; ringNumberVal=null; ringStepMM=null;
          pxToMM = 0.25; // fallback
          calibInfo.textContent = 'Ikke kalibrert.';
          updateZoomInfo();
          recompute();
        }
        img.src = e.target.result;
      }
      reader.readAsDataURL(file);
    }

    function updateZoomInfo(){ zoomInfo.textContent = `Zoom ${(scale*100).toFixed(0)}%`; }

    dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.borderColor='#2a67ff';});
    dropzone.addEventListener('dragleave', e=>{ dropzone.style.borderColor='#2d3446';});
    dropzone.addEventListener('drop', e=>{ e.preventDefault(); dropzone.style.borderColor='#2d3446'; const f=e.dataTransfer.files?.[0]; if(f) loadFile(f);});
    dropzone.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{ if(fileInput.files[0]) loadFile(fileInput.files[0]); });

    cvs.addEventListener('wheel', e=>{
      if(!imgLoaded) return;
      e.preventDefault();
      const mouse = {x:e.offsetX, y:e.offsetY};
      const delta = Math.sign(e.deltaY) * -0.1;
      const newScale = Math.min(5, Math.max(0.2, scale*(1+delta)));
      const ix = (mouse.x - offset.x)/scale;
      const iy = (mouse.y - offset.y)/scale;
      offset.x = mouse.x - ix*newScale;
      offset.y = mouse.y - iy*newScale;
      scale = newScale;
      updateZoomInfo();
      draw();
    });

    cvs.addEventListener('mousedown', e=>{
      if(!imgLoaded) return;
      if(e.button===1 || e.button===2){ panning=true; lastMouse={x:e.offsetX,y:e.offsetY}; return; }
      const p = screenToImage(e.offsetX, e.offsetY);
      if(mode==='center'){ center = p; }
      else if(mode==='ring'){ ringPoint = p; }
      else { shots.push(p); }
      recompute();
    });

    window.addEventListener('mousemove', e=>{
      if(panning){ const dx=e.offsetX-lastMouse.x, dy=e.offsetY-lastMouse.y; offset.x+=dx; offset.y+=dy; lastMouse={x:e.offsetX,y:e.offsetY}; draw(); }
    });
    window.addEventListener('mouseup', ()=> panning=false);
    window.addEventListener('contextmenu', e=> e.preventDefault());

    rotateLeft.addEventListener('click', ()=>{ rotation = (rotation-90+360)%360; draw(); });
    resetView.addEventListener('click', ()=>{ if(!imgLoaded) return; scale = Math.min(cvs.width/img.width, cvs.height/img.height); offset.x=(cvs.width-img.width*scale)/2; offset.y=(cvs.height-img.height*scale)/2; updateZoomInfo(); draw(); });

    centerModeBtn.addEventListener('click', ()=>{ mode='center'; centerModeBtn.classList.remove('ghost'); ringModeBtn.classList.add('ghost'); shotModeBtn.classList.add('ghost'); });
    ringModeBtn.addEventListener('click', ()=>{ mode='ring'; ringModeBtn.classList.remove('ghost'); centerModeBtn.classList.add('ghost'); shotModeBtn.classList.add('ghost'); });
    shotModeBtn.addEventListener('click', ()=>{ mode='shot'; shotModeBtn.classList.remove('ghost'); centerModeBtn.classList.add('ghost'); ringModeBtn.classList.add('ghost'); });

    applyCalibrationBtn.addEventListener('click', ()=>{
      ringNumberVal = parseInt(ringNumberInput.value,10);
      applyCalibration();
    });

    undoShotBtn.addEventListener('click', ()=>{ shots.pop(); recompute(); });
    clearAllBtn.addEventListener('click', ()=>{ shots=[]; center=null; ringPoint=null; ringNumberVal=null; ringStepMM=null; recompute(); });

    // ---------- Lagring i Supabase ----------
    const saveBtnEl = document.getElementById('saveBtn');
    async function saveToSupabase(){
      if(!supabase){ alert('Supabase er ikke konfigurert.'); return; }
      if(!imgLoaded){ alert('Last opp bilde f√∏rst.'); return; }
      const name = sessionName.value?.trim() || `√∏kt-${new Date().toISOString()}`;
      const dataURL = cvs.toDataURL('image/jpeg', 0.9);
      const blob = await (await fetch(dataURL)).blob();
      const path = `${Date.now()}-${name.replace(/\s+/g,'_')}.jpg`;
      const up = await supabase.storage.from('targets').upload(path, blob, {contentType:'image/jpeg', upsert:false});
      if(up.error){ alert('Feil ved opplasting: '+up.error.message); return; }
      const publicUrl = supabase.storage.from('targets').getPublicUrl(up.data.path).data.publicUrl;

      const c = shots.length? centroid(shots): null;
      const perShot = shots.map((s,i)=>{
        const rmm = center? dist(s, center)*pxToMM : dist(s, c)*pxToMM;
        const scObj = scoreForRadiusMM(rmm);
        return {
          idx: i+1,
          x: s.x, y: s.y,
          r_mm: rmm,
          score: scObj? scObj.score : null,
          ring: scObj? scObj.ringNumber : null
        };
      });

      const payload = {
        name,
        image_url: publicUrl,
        rotation,
        calib: { pxToMM, ringStepMM, ringsOverlayCount, center, ringPoint, ringNumberVal },
        shots,
        perShot,
        summary: {
          n: shots.length,
          totalScore: perShot.reduce((a,b)=>a+(b.score??0),0),
          biathlonHits: perShot.filter(s=> s.r_mm<= (ringStepMM||Infinity)).length
        }
      };
      const ins = await supabase.from('sessions').insert({ name, image_url: publicUrl, payload }).select().single();
      if(ins.error){ alert('Feil ved lagring: '+ins.error.message); return; }
      alert('Lagret! Session id: '+ins.data.id);
    }
    saveBtnEl.addEventListener('click', saveToSupabase);

    // init
    function initFit(){
      if(!imgLoaded) return;
      scale = Math.min(cvs.width/img.width, cvs.height/img.height);
      offset.x = (cvs.width - img.width*scale)/2;
      offset.y = (cvs.height - img.height*scale)/2;
      updateZoomInfo(); draw();
    }
    draw();
  </script>
</body>
</html>
