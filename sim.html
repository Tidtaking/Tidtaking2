<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulering av Skiskytterløp</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 20px;
      color: #333;
    }
    #controls {
      margin-bottom: 20px;
    }
    #controls input, #controls button {
      font-size: 18px;
      padding: 8px 12px;
      margin: 5px;
    }
    #canvasContainer {
      position: relative;
      margin: 0 auto;
      width: 800px;
      height: 300px;
      background: #fff;
      border: 2px solid #333;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    .shooting-zone {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      background: rgba(255,0,0,0.3);
    }
    #info {
      margin-top: 10px;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>
  <h1>Simulering av Skiskytterløp</h1>
  <div id="controls">
    <label for="snrInput">Startnummer (snr):</label>
    <input type="text" id="snrInput" placeholder="F.eks. 1">
    <button id="startSimBtn">Start Simulering</button>
  </div>
  <div id="canvasContainer">
    <canvas id="raceCanvas" width="800" height="300"></canvas>
    <!-- To shooting zones – plassert ved 33% og 66% av banen -->
    <div class="shooting-zone" style="left: 260px;"></div>
    <div class="shooting-zone" style="left: 520px;"></div>
  </div>
  <div id="info"></div>

  <!-- Last inn Supabase JS (bruk samme versjon som på de andre sidene) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Konfigurasjon av Supabase
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const canvas = document.getElementById("raceCanvas");
    const ctx = canvas.getContext("2d");
    const infoDiv = document.getElementById("info");

    // Konfigurasjon for simuleringen
    const trackStartX = 50;
    const trackEndX = 750;
    const trackY = canvas.height / 2;
    const trackLength = trackEndX - trackStartX;
    const simulationDuration = 10000; // simuleringen varer 10 sekunder (kan endres)

    // Variabler for animasjon
    let startTime = null;
    let animationFrameId = null;

    // Data for den valgte deltakeren
    let competitor = null; // objekt fra DB med felt: snr, name, finish, laps, shooting, etc.

    // Funksjon for å starte simuleringen
    async function startSimulation() {
      const snrInput = document.getElementById("snrInput").value.trim();
      if (!snrInput) {
        alert("Oppgi startnummer (snr) for deltakeren du vil følge.");
        return;
      }
      // Hent deltaker basert på snr
      const { data, error } = await supabaseClient
        .from("participants")
        .select("*")
        .eq("snr", snrInput)
        .single();
      if (error || !data) {
        alert("Fant ikke deltaker med snr: " + snrInput);
        return;
      }
      competitor = data;
      infoDiv.innerHTML = `<strong>${competitor.name}</strong> (snr: ${competitor.snr}) starter simuleringen...`;
      
      // For simulering: bruk finish tid (antatt i sekunder)
      // Hvis finish tid er null, bruk en standard tid (f.eks. 120 sek)
      const finishTimeSec = competitor.finish ? parseFloat(competitor.finish) : 120;
      
      // Vi simulerer at løpet tar simulationDuration (f.eks. 10 sekunder)
      // Men vi bruker finishTimeSec til å vise "virkelig" tid i infofeltet
      startTime = null;
      cancelAnimationFrame(animationFrameId);
      animateRace(finishTimeSec);
    }

    // Funksjon for å animere løpet
    function animateRace(finishTimeSec) {
      function drawFrame(timestamp) {
        if (!startTime) startTime = timestamp;
        const elapsed = timestamp - startTime;
        // Progresjon: 0 til 1
        const progress = Math.min(elapsed / simulationDuration, 1);
        // Beregn posisjon langs banen
        const posX = trackStartX + progress * trackLength;
        // Tegn bakgrunn og bane
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Tegn banen (en horisontal linje)
        ctx.beginPath();
        ctx.moveTo(trackStartX, trackY);
        ctx.lineTo(trackEndX, trackY);
        ctx.strokeStyle = "#333";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Tegn shooting soner (som røde, semi-transparente rektangler)
        ctx.fillStyle = "rgba(255,0,0,0.3)";
        ctx.fillRect(260, 0, 4, canvas.height);
        ctx.fillRect(520, 0, 4, canvas.height);

        // Tegn deltaker-ikon (en sirkel) på posX, med litt vertikal bevegelse for effekt
        const offsetY = 10 * Math.sin(progress * Math.PI * 2);
        ctx.beginPath();
        ctx.arc(posX, trackY + offsetY, 10, 0, 2 * Math.PI);
        ctx.fillStyle = "#007bff";
        ctx.fill();
        ctx.strokeStyle = "#0056b3";
        ctx.stroke();

        // Oppdater info med simulert tid (skal vise en "virkelig" tid basert på finishTimeSec)
        const simulatedTimeSec = progress * finishTimeSec;
        infoDiv.innerHTML = `<strong>${competitor.name}</strong> (snr: ${competitor.snr})<br>
                             Simulert tid: ${formatTime(simulatedTimeSec)}`;

        if (progress < 1) {
          animationFrameId = requestAnimationFrame(drawFrame);
        } else {
          infoDiv.innerHTML += "<br><em>Løpet er fullført!</em>";
        }
      }
      animationFrameId = requestAnimationFrame(drawFrame);
    }

    // Hjelpefunksjon for å formatere tid (sekunder) til mm:ss.x
    function formatTime(timeSec) {
      if (!timeSec || isNaN(timeSec)) return "";
      const totalSec = Math.floor(timeSec);
      const ms = Math.round((timeSec - totalSec) * 1000);
      const mm = Math.floor(totalSec / 60);
      const ss = totalSec % 60;
      return `${mm}:${ss.toString().padStart(2, "0")}.${Math.floor(ms / 100)}`;
    }

    document.getElementById("startSimBtn").addEventListener("click", startSimulation);
  </script>
</body>
</html>
