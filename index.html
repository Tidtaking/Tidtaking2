<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lørenskog Skiklubb – Tidtaking</title>

  <!-- For rask oppkobling til CDN/Supabase -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://chzfewhbfkdtcizdxyzk.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="https://chzfewhbfkdtcizdxyzk.supabase.co">

  <!-- Tailwind (CDN) -->
  <script>
    /* Beholdes for layout-klasser. Ingen spesial-config nødvendig for headerfarge. */
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: { extend: {} }
    };
  </script>
  <!-- FIX: riktig Tailwind-CDN URL (forrige brukte @3.4.10, som ikke lastes). -->
  <script src="https://cdn.tailwindcss.com?v=3.4.10"></script>

  <style>
    :root{
      --brand:#18469a;   /* Lørenskog blå, brukes ellers i UI */
      --brand2:#dbe723;  /* Lørenskog gul */
    }

    body{ background:#f5f7fb; color:#0f172a; }

    /* HEADER – lås nøyaktig blå og logostørrelse */
    .site-header{
      background:#18469a !important; /* identisk blå */
      color:#ffffff !important;
    }
    .site-header .logo-img{
      height:48px;           /* lås høyde */
      max-width:80px;        /* og maks bredde */
      width:auto;            /* behold proporsjoner */
      object-fit:contain;
      background:#ffffff;
      border-radius:8px;
      padding:4px;
    }
    .site-header .title{ line-height:1.1; }
    .site-header .subtitle{ opacity:.9; }

    /* Kort */
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:1rem;
      padding:1rem;
      box-shadow:0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    }
    @media (min-width:768px){
      .card{ padding:1.25rem; }
    }

    .subtle{ color:#475569 }
    .soft{ background:#f8fafc }

    /* Inputs/selects (uten Tailwind Forms-plugin) */
    input[type="text"],
    input[type="number"],
    input[type="time"],
    input[type="date"],
    input[type="file"],
    select {
      background:#ffffff;
      border:1px solid #e2e8f0;
      border-radius:0.75rem;
      padding:0.5rem 0.75rem;
      font-size:0.95rem;
      line-height:1.4;
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
      transition: box-shadow .15s, border-color .15s;
    }
    input[type="time"]{ padding-right:2.25rem; }
    input:focus, select:focus {
      outline:2px solid transparent;
      border-color:#93c5fd;
      box-shadow: 0 0 0 3px rgba(24,70,154,.18);
    }

    /* Tabeller */
    table{ width:100%; border-collapse:collapse; background:white; }
    th,td{ padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:14px; }
    thead th{
      background:#f1f5f9;
      font-weight:600; font-size:13px;
      position:sticky; top:0; z-index:1;
    }

    /* Knapper */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 12px; border-radius:9999px; font-size:14px; font-weight:600;
      border:1px solid #e2e8f0; cursor:pointer; transition: background .15s, transform .04s, box-shadow .15s;
      background:#fff;
    }
    .btn:hover{ background:#f1f5f9; }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ color:var(--brand); border-color:#cbd5e1; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
    .btn-purple{ background:#ede9fe; color:#6d28d9; border-color:#ddd6fe; }
    .btn-ghost{ background:transparent; }

    /* Status-piller */
    .status{ display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:600; letter-spacing:.2px }
    .status.wait{ background:#f3f4f6; color:#64748b; }
    .status.plan{ background:#dbeafe; color:#1d4ed8; }
    .status.run{ background:#dcfce7; color:#15803d; }
    .status.done{ background:#fee2e2; color:#b91c1c; }

    /* SKYTING: sort som standard, hvit ved treff (m/ sort kant) */
    .shooting .target{
      display:inline-grid; place-items:center;
      width:26px; height:26px; margin:2px;
      border-radius:50%; border:2px solid #0f172a;
      background:#000000; color:#000000; cursor:pointer; user-select:none
    }
    .shooting .target[data-hit="true"]{
      background:#ffffff; color:#ffffff; border-color:#0f172a;
    }

    /* Mobil: skjul noen kolonner */
    @media (max-width:760px){
      .col-laps, .col-finishdiff{ display:none }
      th.col-laps, th.col-finishdiff{ display:none }
    }

    /* Sticky actionbar på mobil */
    .sticky-actions{
      position:sticky; bottom:0; z-index:40; margin-top:12px;
      background:linear-gradient(180deg, rgba(245,247,251,0), rgba(245,247,251,0.85) 35%, rgba(245,247,251,1));
      padding-top:6px;
    }
    .sticky-actions .bar{
      display:flex; gap:8px; flex-wrap:wrap; padding:10px; border:1px solid #e2e8f0;
      background:#ffffff; border-radius:1rem; box-shadow:0 8px 24px rgba(15,23,42,.06);
    }

    dialog{ border:none; border-radius:1rem; padding:18px; background:#fff; color:#0f172a; box-shadow:0 12px 30px rgba(0,0,0,.18); }
    dialog::backdrop{ background:rgba(0,0,0,.45) }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  </script>
</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER (låst blå + logo-størrelse) -->
  <header class="site-header shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-4 px-4 py-3">
      <div class="flex items-center gap-3">
        <!-- Bruk gjerne en komprimert .webp-fil. width/height hindrer layout-jump -->
        <img
          src="Logo LSK Klubb farger JPG.jpeg"
          alt="Lørenskog Skiklubb"
          width="80" height="48"
          class="logo-img">
        <div>
          <h1 class="title text-xl font-bold">Lørenskog Skiklubb</h1>
          <p class="subtitle text-sm">Tidtaking for ski-konkurranser</p>
        </div>
      </div>
      <div id="liveClock" class="font-bold text-lg"></div>
    </div>
  </header>

  <main class="flex-1 max-w-6xl mx-auto w-full p-4 space-y-6">

    <!-- Toppkort -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold mb-3">Manuell registrering</h3>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm subtle">Startnummer</label>
            <input type="number" id="newStartNumber" placeholder="Startnr." />
          </div>
          <div>
            <label class="text-sm subtle">Navn</label>
            <input type="text" id="newParticipant" placeholder="Navn" />
          </div>
          <div>
            <label class="text-sm subtle">Klasse</label>
            <select id="newParticipantClass">
              <option value="">Velg klasse…</option>
              <option>G10 Nybeg og yngre</option>
              <option>K19</option>
              <option>J16</option>
              <option>K17</option>
              <option>M18</option>
              <option>M19</option>
              <option>K18</option>
              <option>G14</option>
              <option>G11-12 Nybeg</option>
              <option>J11</option>
              <option>G12</option>
              <option>G13</option>
              <option>J10 Nybeg og yngre</option>
              <option>J11-12 Nybeg</option>
              <option>G11</option>
              <option>J12</option>
              <option>J13</option>
              <option>J14</option>
              <option>J15</option>
              <option>G15</option>
              <option>G16</option>
              <option>M17</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnAddParticipant" class="btn btn-primary w-full">Lagre deltaker</button>
          </div>
        </div>

        <div class="mt-3 grid sm:grid-cols-3 gap-2 items-end">
          <div>
            <label class="text-sm subtle">CSV-import</label>
            <input type="file" id="csvImport" accept=".csv" />
          </div>
          <button id="btnImportCSV" class="btn btn-primary">Importer CSV</button>
          <button id="btnSaveCSV" class="btn">Lagre CSV</button>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-3">Oppsett</h3>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm subtle">Tilleggstid pr bom (sek)</label>
            <input type="number" id="penaltyTime" value="30" />
          </div>
          <div>
            <label class="text-sm subtle">Første starttid</label>
            <input type="time" id="firstStartTime" step="1" />
          </div>
          <div>
            <label class="text-sm subtle">Intervall (sek)</label>
            <input type="number" id="startInterval" value="30" />
          </div>
          <div class="flex items-end">
            <button id="btnAssignStartTimes" class="btn btn-primary w-full">Tildel starttider</button>
          </div>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnResetAll" class="btn btn-danger">Nullstill alt</button>
          <button id="btnStartMass" class="btn btn-primary">Fellesstart</button>
        </div>
      </div>
    </section>

    <!-- Operasjoner -->
    <section class="card hidden md:block">
      <h3 class="font-semibold mb-3">Operasjoner for markerte deltakere</h3>
      <div class="flex flex-wrap gap-2">
        <button class="btn btn-danger" id="btnDeleteSelected">Slett markerte</button>
        <button class="btn btn-primary" id="btnToggleSelected">Start/Stop markerte</button>
        <button class="btn btn-purple" id="btnSaveSelectedHistory">Lagre markerte til history</button>
      </div>
    </section>

    <!-- Resultater -->
    <section class="card">
      <h3 class="font-semibold mb-3">Resultater</h3>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Velg <input type="checkbox" id="masterSelect" /></th>
              <th>Plass</th>
              <th>Start</th>
              <th>#</th>
              <th>Navn</th>
              <th>Kl.</th>
              <th>Status</th>
              <th>Tid</th>
              <th>S1</th>
              <th>S2</th>
              <th>Bom</th>
              <th class="col-laps">Rundetider (Diff)</th>
              <th class="col-finishdiff">Mål (Diff)</th>
              <th>Handl.</th>
            </tr>
          </thead>
          <tbody id="results"></tbody>
        </table>
      </div>
    </section>

    <!-- Historikk -->
    <section id="historySection" class="card">
      <h3 class="font-semibold mb-3">Historikk – lagret vs. ikke lagret</h3>
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <label for="historyDate" class="text-sm subtle">Dato:</label>
        <input type="date" id="historyDate" />
        <button class="btn btn-primary" id="btnRefreshHistory">Oppdater historikk</button>
        <button class="btn" id="btnShowAllHistory" title="Vis all lagret historikk uansett dato">Vis all historikk</button>
        <small id="historySummary" class="subtle"></small>
      </div>

      <div class="overflow-x-auto">
        <table>
          <caption class="text-left font-semibold px-2 py-2">Lagret i history</caption>
          <thead>
            <tr>
              <th>Dato</th>
              <th>#</th>
              <th>Navn</th>
              <th>Kl.</th>
              <th>Status</th>
              <th>Tid</th>
            </tr>
          </thead>
          <tbody id="historySavedBody"></tbody>
        </table>
      </div>

      <div class="overflow-x-auto mt-4">
        <table>
          <caption class="text-left font-semibold px-2 py-2">Ikke lagret ennå (fra participants)</caption>
          <thead>
            <tr>
              <th>Velg</th>
              <th>#</th>
              <th>Navn</th>
              <th>Kl.</th>
              <th>Status</th>
              <th>Tid</th>
              <th>S1</th>
              <th>S2</th>
              <th>Bom</th>
              <th>Handl.</th>
            </tr>
          </thead>
          <tbody id="historyPendingBody"></tbody>
        </table>
      </div>

      <!-- Mobil sticky actions -->
      <div class="sticky-actions md:hidden mt-3">
        <div class="bar">
          <button class="btn btn-primary" id="btnToggleSelected__dup" title="Start/Stop markerte">Start/Stop</button>
          <button class="btn btn-purple" id="btnSaveSelectedHistory__dup" title="Lagre markerte til history">Lagre til history</button>
          <button class="btn btn-danger" id="btnDeleteSelected__dup" title="Slett markerte">Slett</button>
        </div>
      </div>
    </section>

  </main>

  <footer class="text-center text-sm text-gray-500 py-5">
    © 2025 Lørenskog Skiklubb – Tidtaking
  </footer>

  <!-- Dialog -->
  <dialog id="confirmDialog">
    <p id="confirmText">Er du sikker på at du vil nullstille alt?</p>
    <div class="mt-3 flex gap-2">
      <button class="btn" id="btnConfirmCancel">Avbryt</button>
      <button class="btn btn-danger" id="btnConfirmOk">OK</button>
    </div>
  </dialog>

  <!-- ====== APP LOGIKK ====== -->
  <script>
    // Global state
    window.participants = {};
    window.localTimers = {};
    window._didBackfillPenalties = false;
    window._historyShowAll = false;
    window.undoStack = {};
    const UNDO_MAX = 5;

    function pushUndo(snr, item){
      if (!window.undoStack[snr]) window.undoStack[snr] = [];
      window.undoStack[snr].push(item);
      if (window.undoStack[snr].length > UNDO_MAX) window.undoStack[snr].shift();
    }
    function hasUndo(snr){
      return Array.isArray(window.undoStack[snr]) && window.undoStack[snr].length > 0;
    }

    window.updateSelection = function(snr, isSelected) {
      if (window.participants[snr]) window.participants[snr].selected = isSelected;
    };
    window.selectAll = function(checked) {
      const boxes = document.querySelectorAll('.select-participant');
      boxes.forEach(cb => {
        cb.checked = checked;
        const snr = parseInt(cb.getAttribute('data-snr'));
        if (!isNaN(snr)) updateSelection(snr, checked);
      });
    };

    window.getShootingArray = function(p) {
      if (!p || !p.shooting) return [Array(5).fill(false), Array(5).fill(false)];
      if (Array.isArray(p.shooting)) return (p.shooting.length >= 2) ? p.shooting : [Array(5).fill(false), Array(5).fill(false)];
      if (typeof p.shooting === 'string') {
        try { const parsed = JSON.parse(p.shooting); return (Array.isArray(parsed) && parsed.length >= 2) ? parsed : [Array(5).fill(false), Array(5).fill(false)]; }
        catch { return [Array(5).fill(false), Array(5).fill(false)]; }
      }
      return [Array(5).fill(false), Array(5).fill(false)];
    };

    window.formatTime = function(sec){
      const sTot = Number(sec) || 0;
      const min = Math.floor(sTot/60);
      const s = (sTot % 60).toFixed(1);
      return min>0 ? `${min}m ${s}s` : `${s}s`;
    };
    window.formatClockTimeFull = function(ms){
      const d = new Date(ms);
      const h = d.getHours().toString().padStart(2,'0');
      const m = d.getMinutes().toString().padStart(2,'0');
      const s = d.getSeconds().toString().padStart(2,'0');
      return `${h}:${m}:${s}`;
    };

    window.customConfirm = function(message){
      return new Promise((resolve)=>{
        const dialog = document.getElementById('confirmDialog');
        document.getElementById('confirmText').textContent = message;
        dialog.showModal();
        document.getElementById('btnConfirmOk').onclick = function(){ dialog.close(); resolve(true); }
        document.getElementById('btnConfirmCancel').onclick = function(){ dialog.close(); resolve(false); }
      })
    };
    // L IM INN DENNE NYE FUNKSJONEN (f.eks. etter window.customConfirm)
    window.saveSelectedToHistory = async function() {
  // 1. Hent datoen fra datovelgeren
  const compDate = document.getElementById('historyDate')?.value || window.getTodayCompDate();
  if (!compDate) {
    alert('Vennligst velg en dato for historikken.');
    return;
  }

  // 2. Finn alle deltakere som er markert
  const selectedParticipants = [];
  for (const [snr, p] of Object.entries(window.participants)) {
    if (p.selected) {
      selectedParticipants.push(p);
    }
  }

  // 3. Sjekk om noen er valgt
  if (selectedParticipants.length === 0) {
    alert('Ingen deltakere er markert for lagring.');
    return;
  }

  // 4. Be om bekreftelse
  const confirmed = await window.customConfirm(
    `Vil du lagre ${selectedParticipants.length} markerte deltakere til historikken for datoen ${compDate}?`
  );
  if (!confirmed) return;

  console.log(`Lagrer ${selectedParticipants.length} deltakere til historikk...`);

  // 5. Klargjør data for Supabase
  const toInsert = selectedParticipants.map(p => {
    let shootingData = p.shooting;
    if (Array.isArray(p.shooting)) {
      shootingData = JSON.stringify(p.shooting);
    } else if (typeof p.shooting !== 'string') {
      shootingData = JSON.stringify(window.getShootingArray(p));
    }

    return {
      comp_date: compDate,
      snr: p.snr,
      name: p.name,
      class: p.class,
      status: p.status,
      finish: p.finish,
      rawFinish: p.rawFinish,
      laps: p.laps,
      shooting: shootingData
    };
  });

  // 6. Slett eksisterende rader for samme dato og snr (simulert upsert)
  const snrs = toInsert.map(r => r.snr).filter(v => v !== null && v !== undefined);
  if (snrs.length > 0) {
    const { error: delError } = await window.supabaseClient
      .from('history')
      .delete()
      .eq('comp_date', compDate)
      .in('snr', snrs);

    if (delError) {
      console.error('Feil ved sletting før lagring til historikk:', delError);
      alert(`En feil oppstod ved forberedelse til lagring: ${delError.message}`);
      return;
    }
  }

  // 7. Sett inn på nytt (ren INSERT)
  const { error } = await window.supabaseClient
    .from('history')
    .insert(toInsert);

  // 8. Håndter resultat
  if (error) {
    console.error('Feil ved lagring til historikk:', error);
    alert(`En feil oppstod: ${error.message}`);
  } else {
    console.log('Lagring til historikk vellykket!');
    alert(`${toInsert.length} deltakere ble lagret/oppdatert i historikken.`);

    selectedParticipants.forEach(p => {
      if (window.participants[p.snr]) window.participants[p.snr].selected = false;
    });
    window.selectAll(false);
    window.updateHistoryView();
    window.updateLocalDisplay();
  }
};


window.updateFinalTime = function(snr){
      let p = window.participants[snr];
      
      // VIKTIG: Ikke gjør noe med 'finish' hvis 'rawFinish' ikke har en gyldig verdi.
      if (p.rawFinish == null || isNaN(Number(p.rawFinish))) return; 

      const penaltyPerMiss = Number(document.getElementById('penaltyTime').value) || 0;
      const shootingArr = window.getShootingArray(p);
      const totalMisses = shootingArr.flat().filter(hit => hit === false).length;
      
      // Nå er 'p.rawFinish' garantert et tall, så den farlige '|| 0' er fjernet.
      p.finish = Number(p.rawFinish) + (totalMisses * penaltyPerMiss);
    };

    window.recomputeAndPersistAllFinished = async function(){
      const penaltyPerMiss = Number(document.getElementById('penaltyTime').value) || 0;
      for (const [snr,p] of Object.entries(window.participants)){
        if (p.status !== 'Fullført' && p.rawFinish == null) continue;
        const shootingArr = window.getShootingArray(p);
        const totalMisses = shootingArr.flat().filter(hit => hit === false).length;
        let raw = (p.rawFinish != null) ? Number(p.rawFinish) : (p.finish != null) ? Number(p.finish) : null;
        if (raw == null) continue;
        const newFinish = raw + totalMisses * penaltyPerMiss;
        const payload = { finish:newFinish };
        if (p.rawFinish == null) payload.rawFinish = raw;
        if (p.finish !== newFinish || (p.rawFinish == null)){
          const { error } = await window.supabaseClient.from('participants').update(payload).eq('snr', snr);
          if (error) console.error('Feil ved backfill av straff for snr', snr, error);
          else { p.finish = newFinish; if (p.rawFinish == null) p.rawFinish = raw; }
        }
      }
    };

    window.fetchParticipants = async function(){
      const { data, error } = await window.supabaseClient.from('participants').select('*');
      if (error){ console.error('Feil ved henting av deltakere:', error); return; }
      const old = window.participants; window.participants = {};
      data.forEach(record => {
        if (record.rawFinish != null) record.rawFinish = Number(record.rawFinish);
        if (record.finish    != null) record.finish    = Number(record.finish);
        record.laps = record.laps || [];
        record.shooting = (typeof record.shooting === 'string')
          ? window.getShootingArray(record)
          : (Array.isArray(record.shooting) ? record.shooting : [Array(5).fill(false), Array(5).fill(false)]);
        if (record.rawFinish != null){
          const penaltyPerMiss = Number(document.getElementById('penaltyTime').value) || 0;
          const totalMisses = record.shooting.flat().filter(h => h === false).length;
          record.finish = Number(record.rawFinish) + totalMisses * penaltyPerMiss;
        }
        record.selected = !!(old[record.snr] && old[record.snr].selected);
        if (window.localTimers[record.snr]) record.timer = window.localTimers[record.snr];
        window.participants[record.snr] = record;
        if (!window.undoStack[record.snr]) window.undoStack[record.snr] = [];
      })
    };

    window.updateTable = async function(){
      await window.fetchParticipants();
      await window.autoStart();
      if (!window._didBackfillPenalties){
        await window.recomputeAndPersistAllFinished();
        window._didBackfillPenalties = true;
      }
      window.updateLocalDisplay();
    };

   window.updateLocalDisplay = function(){
      // Kjører den lokale kalkuleringen av totaltid (raw + bom)
      Object.keys(window.participants).forEach(snr => {
        const p = window.participants[snr];
        if (p.status === 'Fullført' && p.rawFinish != null) window.updateFinalTime(snr);
      });

      // --- BEREGN BESTE RUNDETIDER PER KLASSE ---
      let maxLaps = 0; Object.values(window.participants).forEach(p => { if (p.laps.length > maxLaps) maxLaps = p.laps.length; });
      let bestLapTimesByClass = {};
      Object.values(window.participants).forEach(p => {
        const cls = p.class || 'Ukjent'; // Bruk 'Ukjent' hvis klasse mangler
        if (!bestLapTimesByClass[cls]) {
          bestLapTimesByClass[cls] = Array(maxLaps).fill(Infinity);
        }
        p.laps.forEach((lap, i) => {
          if (lap < bestLapTimesByClass[cls][i]) {
            bestLapTimesByClass[cls][i] = lap;
          }
        });
      });

      // --- BEREGN PLASSERING OG BESTE MÅLTID PER KLASSE ---
      let classPlacements = {};
      Object.entries(window.participants).forEach(([snr,p]) => {
        if (p.finish != null){
          const cls = p.class || 'Ukjent'; // Sørg for at 'Ukjent' brukes konsekvent
          if (!classPlacements[cls]) classPlacements[cls] = [];
          classPlacements[cls].push({ snr, finish:p.finish });
        }
      });

      let bestFinishByClass = {};
      for (const cls in classPlacements){
        // Sorter etter tid for å finne plassering OG beste tid
        classPlacements[cls].sort((a,b)=>a.finish-b.finish);
        classPlacements[cls].forEach((entry,i)=> entry.rank = i+1);
        // Lagre den beste tiden (den første i den sorterte listen)
        if (classPlacements[cls].length > 0) {
          bestFinishByClass[cls] = classPlacements[cls][0].finish;
        }
      }

      let rows = [];
      for (const [snr,p] of Object.entries(window.participants)){
        const p_class = p.class || 'Ukjent'; // Hent klassen til denne løperen
        const checkbox = `<input type="checkbox" class="select-participant" data-snr="${snr}" id="select-${snr}" name="select-participant" onchange="updateSelection(${snr}, this.checked)" ${p.selected ? 'checked' : ''}>`;
        
        // Finn plassering
        let placement = '-';
        if (p.finish != null && classPlacements[p_class]){
          const found = classPlacements[p_class].find(entry => entry.snr === snr);
          placement = found ? found.rank : '-';
        }
        
        // Formater tid (pågående eller total)
        let timeDisplay = '-';
        if (p.status === 'Planlagt'){
          let remainingSec = (Date.parse(p.start) - Date.now())/1000; if (remainingSec < 0) remainingSec = 0;
          timeDisplay = window.formatClockTimeFull(Date.parse(p.start)) + ` (${window.formatTime(remainingSec)} til start)`;
        } else if (p.timer){
          timeDisplay = window.formatTime((Date.now()-Date.parse(p.start))/1000);
        } else if (p.finish != null){
          timeDisplay = window.formatTime(p.finish);
        }

        // FIKS 1: Rundetid-diff (basert på klasse)
        const classBestLaps = bestLapTimesByClass[p_class] || [];
        const lapDiffs = p.laps.map((lap,i)=>{
          const best = classBestLaps[i];
          let diffStr = '–';
          if (best != null && best !== Infinity && lap > best) {
            diffStr = `+${(lap - best).toFixed(1)}s`;
          }
          return `${window.formatTime(lap)} (${diffStr})`;
        }).join('<br>');

        // FIKS 2: Måltid-diff (basert på klasse)
        const classBestFinish = bestFinishByClass[p_class];
        let finishDiff = '-';
        if (p.finish != null) {
          let diffStr = '–'; // Viser '–' for vinneren
          // Vis kun positive differanser
          if (classBestFinish != null && p.finish > classBestFinish && p.finish !== classBestFinish) {
            diffStr = `+${(p.finish - classBestFinish).toFixed(1)}s`;
          }
          finishDiff = `${window.formatTime(p.finish)} (${diffStr})`;
        }
        
        const statusTag = p.status==='Venter' ? 'status wait' : p.status==='Planlagt' ? 'status plan' : p.status==='I gang' ? 'status run' : 'status done';

        const startBtn = (p.status === 'Planlagt' || p.status === 'Venter') && !p.timer
          ? `<button class='btn btn-primary' data-action="start" data-snr="${snr}">Start</button>`
          : '-';

        const actionBtns = p.timer
          ? `<button class='btn btn-primary' data-action="lap" data-snr="${snr}">Rundetid</button>
             <button class='btn btn-primary' data-action="finish" data-snr="${snr}">Mål</button>
             ${hasUndo(snr) ? `<button class='btn' data-action="undo" data-snr="${snr}">Angre</button>` : ''}`
          : `${hasUndo(snr) ? `<button class='btn' data-action="undo" data-snr="${snr}">Angre</button>` : '-'}`;

        rows.push(`<tr>
          <td>${checkbox}</td>
          <td>${placement}</td>
          <td>${startBtn}</td>
          <td>${snr} <button class="btn btn-ghost p-1" data-action="edit-snr" data-snr="${snr}" title="Endre startnummer">✏️</button></td>
          <td>${p.name}</td>
          <td>${p.class || '-'} <button class="btn btn-ghost p-1" data-action="edit-class" data-snr="${snr}" title="Endre klasse">✏️</button></td>
          <td><span class='${statusTag}'>${p.status}</span></td>
          <td>${p.timer ? window.formatTime((Date.now()-Date.parse(p.start))/1000) : timeDisplay}</td>
->          <td class="shooting" data-snr="${snr}" data-shooting-idx="0">${window.renderShooting(snr,0)}</td>
          <td class="shooting" data-snr="${snr}" data-shooting-idx="1">${window.renderShooting(snr,1)}</td>
          <td>${window.getShootingArray(p).flat().filter(h => h === false).length}</td>
          <td class="col-laps">${lapDiffs || '-'}</td>
          <td class="col-finishdiff">${finishDiff}</td>
          <td>${actionBtns}</td>
        </tr>`);
      }
      document.getElementById('results').innerHTML = rows.join('');
    };

    window.updateLiveClock = function(){
      const now = new Date();
      document.getElementById('liveClock').innerText = now.toLocaleTimeString();
    };

    window.autoStart = async function(){
      const now = Date.now();
      for (const snr in window.participants){
        let p = window.participants[snr];
        if (p.status === 'Planlagt' && now >= Date.parse(p.start)){
          p.status = 'I gang';
          if (!window.localTimers[snr]) window.localTimers[snr] = setInterval(window.updateTable, 1000);
          const { error } = await window.supabaseClient.from('participants').update({ status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved autoStart for snr', snr, error);
        }
      }
    };

    window.startIndividual = async function(snr){
      let p = window.participants[snr];
      if (!p) return;

      const alreadyStarted = !!p.start;
      const hasLaps = Array.isArray(p.laps) && p.laps.length > 0;
      const hasFinish = p.rawFinish != null || p.finish != null;

      if (!alreadyStarted && !hasLaps && !hasFinish){
        p.start = new Date().toISOString();
        const { error } = await window.supabaseClient
          .from('participants')
          .update({ start: p.start })
          .eq('snr', snr);
        if (error) console.error('Feil ved lagring av start for snr', snr, error);
      }

      p.status = 'I gang';
      if (!window.localTimers[snr]) {
        window.localTimers[snr] = setInterval(window.updateTable, 1000);
      }

      const { error: err2 } = await window.supabaseClient
        .from('participants')
        .update({ status: p.status })
        .eq('snr', snr);
      if (err2) console.error('Feil ved oppdatering av status for snr', snr, err2);

      window.updateTable();
      if (window.updateHistoryView) window.updateHistoryView();
    };

    window.addParticipant = async function(){
      const snrStr = document.getElementById('newStartNumber').value; const snr = parseInt(snrStr);
      const name = document.getElementById('newParticipant').value; const cls = document.getElementById('newParticipantClass').value;
      if (!snrStr || !name || !cls){ alert('Fyll ut alle felt!'); return; }
      let { data: existing } = await window.supabaseClient.from('participants').select('*').eq('snr', snr);
      if (existing && existing.length > 0){ alert('Startnummer allerede brukt!'); return; }
      const newPart = { snr, name, class:cls, start:null, status:'Venter', laps:[], finish:null, rawFinish:null, shooting: JSON.stringify([Array(5).fill(false), Array(5).fill(false)]), selected:false };
      const { error } = await window.supabaseClient.from('participants').insert([newPart]);
      if (error) console.error('Feil ved lagring:', error);
      document.getElementById('newStartNumber').value = '';
      document.getElementById('newParticipant').value = '';
      setTimeout(window.updateTable, 500);
    };

    window.changeStartNumber = async function(oldSnr, newSnr) {
      if (isNaN(newSnr) || newSnr <= 0) { alert('Ugyldig nytt startnummer.'); return; }
      if (oldSnr === newSnr) return;

      if (window.participants[newSnr]) { alert(`Startnummer ${newSnr} er allerede i bruk.`); return; }
      let { data: existing } = await window.supabaseClient.from('participants').select('snr').eq('snr', newSnr);
      if (existing && existing.length > 0) { alert(`Startnummer ${newSnr} er allerede i bruk i databasen.`); return; }

      const p = window.participants[oldSnr]; if (!p) { console.error(`Fant ikke deltaker ${oldSnr} lokalt.`); return; }

      const timerToMove = window.localTimers[oldSnr];
      const undoToMove = window.undoStack[oldSnr];
      const selectedState = p.selected;

      const { timer, selected, ...dbData } = p;
      dbData.snr = newSnr;
      dbData.shooting = JSON.stringify(window.getShootingArray(dbData));

      const { error: insertError } = await window.supabaseClient.from('participants').insert([dbData]);
      if (insertError) { console.error('Feil ved innsetting (endre snr):', insertError); alert('Feil ved bytte av startnummer (insert).'); return; }
      const { error: deleteError } = await window.supabaseClient.from('participants').delete().eq('snr', oldSnr);
      if (deleteError) { console.error('Feil ved sletting (endre snr):', deleteError); alert('Kritisk feil: Klarte ikke slette det gamle startnummeret. Du har nå duplikater.'); }

      if (timerToMove) { window.localTimers[newSnr] = timerToMove; delete window.localTimers[oldSnr]; }
      if (undoToMove)  { window.undoStack[newSnr] = undoToMove; delete window.undoStack[oldSnr]; }
      await window.updateTable();
      if (window.participants[newSnr]) { window.participants[newSnr].selected = selectedState; }
      window.updateLocalDisplay();
    };

    // NEW: endre klasse for deltaker
    window.changeClassFor = async function(snr, newClass){
      const p = window.participants[snr];
      if (!p) return;
      const cls = (newClass || '').trim();
      if (!cls){ alert('Klasse kan ikke være tom.'); return; }
      // lagre i DB
      const { error } = await window.supabaseClient.from('participants').update({ class: cls }).eq('snr', snr);
      if (error){ console.error('Feil ved oppdatering av klasse for snr', snr, error); return; }
      // oppdater lokalt og rerender
      p.class = cls;
      window.updateLocalDisplay();
      if (window.updateHistoryView) window.updateHistoryView();
    };

    window.startMass = async function(){
      const nowISO = new Date().toISOString();
      for (const snr in window.participants){
        let p = window.participants[snr];
        const alreadyStarted = !!p.start;
        const hasLaps = Array.isArray(p.laps) && p.laps.length > 0;
        const hasFinish = p.rawFinish != null || p.finish != null;

        if (!alreadyStarted && !hasLaps && !hasFinish){
          p.start = nowISO; p.status = 'I gang';
          if (!window.localTimers[snr]) window.localTimers[snr] = setInterval(window.updateTable, 1000);
          const { error } = await window.supabaseClient.from('participants').update({ start:p.start, status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved startMass for snr', snr, error);
        } else if (p.status === 'Venter' || p.status === 'Planlagt'){
          p.status = 'I gang';
          if (!window.localTimers[snr]) window.localTimers[snr] = setInterval(window.updateTable, 1000);
          const { error } = await window.supabaseClient.from('participants').update({ status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved status-oppdatering i startMass for snr', snr, error);
        }
      }
      window.updateTable();
    };

    window.assignStartTimes = async function(){
      const firstTimeStr = document.getElementById('firstStartTime').value;
      const intervalSec = parseInt(document.getElementById('startInterval').value);
      if (!firstTimeStr || isNaN(intervalSec)){ alert('Skriv inn gyldig første starttid og intervall!'); return; }
      const today = new Date();
      const parts = firstTimeStr.split(':');
      today.setHours(parseInt(parts[0]), parseInt(parts[1]), parts[2] ? parseInt(parts[2]) : 0, 0);
      const firstStartMs = today.getTime();
      const keys = Object.keys(window.participants).sort((a,b)=>a-b);
      for (let index=0; index<keys.length; index++){
        const snr = keys[index]; let p = window.participants[snr];
        if (p.status === 'Venter'){
          p.start = new Date(firstStartMs + index * intervalSec * 1000).toISOString();
          p.status = 'Planlagt';
          const { error } = await window.supabaseClient.from('participants').update({ start:p.start, status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved oppdatering av starttid for snr', snr, error);
        }
      }
      window.updateTable();
    };

    window.recordLap = async function(snr){
      let p = window.participants[snr];
      if (p && p.start){
        pushUndo(snr, { type:'lap', prev:{ laps:[...p.laps] } });
        const lapTime = (Date.now() - Date.parse(p.start))/1000;
        p.laps.push(lapTime);
        const { error } = await window.supabaseClient.from('participants').update({ laps:p.laps }).eq('snr', snr);
        if (error) console.error('Feil ved recordLap for snr', snr, error);
        window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
      }
    };

    window.recordFinish = async function(snr){
      let p = window.participants[snr];
      if (p && p.start){
        pushUndo(snr, { type:'finish', prev:{ rawFinish: p.rawFinish ?? null, status: p.status, finish: p.finish ?? null, hadTimer: !!window.localTimers[snr] }});
        if (window.localTimers[snr]){ clearInterval(window.localTimers[snr]); delete window.localTimers[snr]; }
        let raw = (Date.now() - Date.parse(p.start))/1000;
        const lastLap = (Array.isArray(p.laps) && p.laps.length) ? p.laps[p.laps.length-1] : 0;
        if (raw < lastLap) raw = lastLap;
        p.rawFinish = raw; p.status = 'Fullført'; window.updateFinalTime(snr);
        const { error } = await window.supabaseClient.from('participants').update({ rawFinish:p.rawFinish, status:p.status, finish:p.finish }).eq('snr', snr);
        if (error) console.error('Feil ved recordFinish for snr', snr, error);
        window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
      }
    };

    window.undoLast = async function(snr){
      const stack = window.undoStack[snr];
      if (!stack || stack.length === 0) return;
      const last = stack.pop();
      const p = window.participants[snr];
      if (!p) return;

      if (last.type === 'lap'){
        p.laps = last.prev.laps || [];
        const { error } = await window.supabaseClient.from('participants').update({ laps:p.laps }).eq('snr', snr);
        if (error) console.error('Feil ved UNDO lap for snr', snr, error);
      } else if (last.type === 'finish'){
        p.rawFinish = last.prev.rawFinish;
        p.finish = last.prev.finish;
        p.status = last.prev.status || 'I gang';
        if (p.status === 'I gang' && !window.localTimers[snr]){ window.localTimers[snr] = setInterval(window.updateTable, 1000); }
        const payload = { rawFinish:p.rawFinish, finish:p.finish, status:p.status };
        const { error } = await window.supabaseClient.from('participants').update(payload).eq('snr', snr);
        if (error) console.error('Feil ved UNDO finish for snr', snr, error);
      }
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    };

    window.toggleTarget = async function(snr, shootIdx, idx){
      let p = window.participants[snr];
      let shootingArr = window.getShootingArray(p);
      shootingArr[shootIdx][idx] = !shootingArr[shootIdx][idx];
      p.shooting = JSON.stringify(shootingArr);
     const updatePayload = { shooting:p.shooting };

      // VIKTIG: Bytt '||' (eller) til '&&' (og).
      // Vi må ha BÅDE 'Fullført' status OG en gyldig 'rawFinish' for å regne ut ny tid.
      if (p.status === 'Fullført' && p.rawFinish != null){ 
        window.updateFinalTime(snr); // Denne vil nå kun regne ut hvis rawFinish er et tall
        updatePayload.finish = p.finish; // Lagre den nylig beregnede totaltiden
      }
      const { error } = await window.supabaseClient.from('participants').update(updatePayload).eq('snr', snr);
      }
    window.renderShooting = function(snr, shootIdx){
      let p = window.participants[snr];
      let shootingArr = window.getShootingArray(p);
      return shootingArr[shootIdx].map((hit,i)=>{
        const h = !!hit;
        return `<span class="target" data-hit="${h}" onclick="toggleTarget(${snr},${shootIdx},${i})">&#9679;</span>`;
      }).join('');
    };

    window.getTodayCompDate = function(){
      const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0'); const dd = String(now.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    function lc(x){return (x||'').toString().toLowerCase().trim();}

    window.renderPendingInteractive = function(pending, compDate){
      if (!pending || pending.length === 0) return `<tr><td colspan="10">Alle er lagret for ${compDate}.</td></tr>`;
      return pending.map(p => {
        const wp = window.participants[p.snr] || p;
        const selectedAttr = wp.selected ? 'checked' : '';
        let tid = '-';
        if (wp.status === 'Planlagt'){
          let remainingSec = (Date.parse(wp.start) - Date.now())/1000; if (remainingSec < 0) remainingSec = 0;
          tid = window.formatClockTimeFull(Date.parse(wp.start)) + ` (${window.formatTime(remainingSec)})`;
        } else if (wp.start && (wp.status === 'I gang')){
          tid = window.formatTime((Date.now() - Date.parse(wp.start))/1000);
        } else if (wp.finish != null){
          tid = window.formatTime(wp.finish);
        }
        const bom = window.getShootingArray(wp).flat().filter(h => h === false).length;

        const actions = wp.timer
          ? `<button class='btn btn-primary' data-action="lap" data-snr="${wp.snr}">Rundetid</button>
             <button class='btn btn-primary' data-action="finish" data-snr="${wp.snr}">Mål</button>
             ${hasUndo(wp.snr) ? `<button class='btn' data-action="undo" data-snr="${wp.snr}">Angre</button>` : ''}`
          : `${hasUndo(wp.snr) ? `<button class='btn' data-action="undo" data-snr="${wp.snr}">Angre</button>` : '-'}`;

        return `<tr>
          <td><input type='checkbox' class='select-participant' data-snr='${wp.snr}' onchange='updateSelection(${wp.snr}, this.checked)' ${selectedAttr}></td>
          <td>${wp.snr}</td>
          <td>${wp.name}</td>
          <td>${wp.class || '-'} <button class="btn btn-ghost p-1" data-action="edit-class" data-snr="${wp.snr}" title="Endre klasse">✏️</button></td>
          <td>${wp.status}</td>
          <td>${tid}</td>
          <td class='shooting'>${window.renderShooting(wp.snr,0)}</td>
          <td class='shooting'>${window.renderShooting(wp.snr,1)}</td>
          <td>${bom}</td>
          <td>${actions}</td>
        </tr>`;
      }).join('');
    };

    window.updateHistoryView = async function(dateStr){
      const compDate = dateStr || (document.getElementById('historyDate')?.value || window.getTodayCompDate());

      let hist, errH;
      if (window._historyShowAll){
        const resp = await window.supabaseClient.from('history').select('*').order('comp_date', { ascending:false });
        hist = resp.data; errH = resp.error;
      } else {
        const resp = await window.supabaseClient.from('history').select('*').eq('comp_date', compDate);
        hist = resp.data; errH = resp.error;
      }
      if (errH){ console.error('Feil ved henting av history:', errH); hist = []; }

      let { data: parts, error: errP } = await window.supabaseClient.from('participants').select('*');
      if (errP){ console.error('Feil ved henting av participants:', errP); parts = []; }

      const savedSnr = new Set((hist||[]).map(h => h.snr).filter(v => v !== null && v !== undefined));
      const savedNameClass = new Set((hist||[]).map(h => `name:${lc(h.name)}|class:${lc(h.class)}`));
      const pending = (parts||[]).filter(p => {
        const bySnr = (p.snr != null) && savedSnr.has(p.snr);
        const byNC  = savedNameClass.has(`name:${lc(p.name)}|class:${lc(p.class)}`);
        return !(bySnr || byNC);
      });

      const savedRows = (hist||[]).map(h => {
        const tid  = (h.finish != null) ? window.formatTime(h.finish) : '-';
        const snr  = (h.snr   != null) ? h.snr : '-';
        const dato = h.comp_date || '-';
        return `<tr><td>${dato}</td><td>${snr}</td><td>${h.name||''}</td><td>${h.class||''}</td><td>${h.status||''}</td><td>${tid}</td></tr>`;
      }).join('');
      const savedBody = document.getElementById('historySavedBody');
      if (savedBody) savedBody.innerHTML = savedRows || `<tr><td colspan="6">Ingen lagret${window._historyShowAll ? '' : ` for ${compDate}`}.</td></tr>`;

      const pendingBody = document.getElementById('historyPendingBody');
      if (pendingBody) pendingBody.innerHTML = window.renderPendingInteractive(pending, compDate);

      const summaryEl = document.getElementById('historySummary');
      if (summaryEl) summaryEl.textContent = `${(hist||[]).length} lagret${window._historyShowAll ? ' (alle datoer)' : ''} · ${pending.length} ikke lagret`;
    };

    // ---------- YTELSES-FIXER ----------
    // 1) Kun klokka hvert sekund (ingen nettverk)
    setInterval(window.updateLiveClock, 1000);

    // 2) Kun lokal DOM-oppdatering hvert sekund (til tider/labels)
    setInterval(window.updateLocalDisplay, 1000);

    // 3) Poll Supabase sjeldnere (5s) og bare når siden er synlig
    const POLL_MS = 5000;
    async function smartPoll(){
      if (document.hidden) return;
      await window.updateTable();
    }
    setInterval(smartPoll, POLL_MS);
    window.addEventListener('load', smartPoll);
    document.addEventListener('visibilitychange', ()=> { if (!document.hidden) smartPoll(); });

    // ---------- LYTTERE ----------
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const snr = btn.getAttribute('data-snr');
      if (!snr) return;

      if (action === 'edit-snr') {
        const oldSnr = parseInt(snr);
        const pName = window.participants[oldSnr]?.name || 'deltaker';
        const newSnrStr = prompt(`Endre startnummer for ${pName} (nå ${oldSnr}):`, oldSnr);
        if (newSnrStr) {
          const newSnr = parseInt(newSnrStr);
          await window.changeStartNumber(oldSnr, newSnr);
        }
        return;
      }

      if (action === 'edit-class') {
        const s = parseInt(snr);
        const curr = window.participants[s]?.class || '';
        const val = prompt(`Endre klasse for ${window.participants[s]?.name || 'deltaker'} (nå "${curr}"):",`, curr);
        if (val !== null) {
          await window.changeClassFor(s, val);
        }
        return;
      }

      if (action === 'start') { await window.startIndividual(snr); }
      if (action === 'lap')   { await window.recordLap(snr); }
      if (action === 'finish'){ await window.recordFinish(snr); }
      if (action === 'undo')  { await window.undoLast(snr); }
    });

    document.getElementById('btnAddParticipant').addEventListener('click', window.addParticipant);
    document.getElementById('btnAssignStartTimes').addEventListener('click', window.assignStartTimes);
    document.getElementById('btnResetAll').addEventListener('click', async function(){
      const confirmed = await window.customConfirm('Er du sikker på at du vil nullstille alt?'); if (!confirmed) return;
      for (const snr in window.participants){ if (window.localTimers[snr]){ clearInterval(window.localTimers[snr]); delete window.localTimers[snr]; } }
      window.participants = {};
      const { error } = await window.supabaseClient.from('participants').delete().neq('snr', 0);
      if (error) console.error('Feil ved nullstilling:', error);
      window.updateTable();
    });
    document.getElementById('btnSaveCSV').addEventListener('click', window.saveCSV);
    document.getElementById('btnStartMass').addEventListener('click', window.startMass);
    document.getElementById('btnImportCSV').addEventListener('click', window.importCSV);
    document.getElementById('btnSaveSelectedHistory').addEventListener('click', window.saveSelectedToHistory);
    const master = document.getElementById('masterSelect'); if (master){ master.addEventListener('change', (e)=> window.selectAll(e.target.checked)); }

    const dupMap = [
      ['btnToggleSelected__dup','btnToggleSelected'],
      ['btnSaveSelectedHistory__dup','btnSaveSelectedHistory'],
      ['btnDeleteSelected__dup','btnDeleteSelected']
    ];
    dupMap.forEach(([dup, orig])=>{
      const d = document.getElementById(dup); const o = document.getElementById(orig);
      if (d && o){ d.addEventListener('click', ()=> o.click()); }
    });

    (function(){
      const dateInput = document.getElementById('historyDate'); if (dateInput) { dateInput.value = window.getTodayCompDate(); }
      const btnRefr = document.getElementById('btnRefreshHistory');
      if (btnRefr){
        btnRefr.addEventListener('click', ()=> { window._historyShowAll = false; window.updateHistoryView(); });
      }
      const btnAll = document.getElementById('btnShowAllHistory');
      if (btnAll){
        btnAll.addEventListener('click', ()=> { window._historyShowAll = true; window.updateHistoryView(); });
      }
      if (dateInput || btnRefr || btnAll){ window.updateHistoryView(); }
    })();

    document.getElementById('btnDeleteSelected').addEventListener('click', async function(){
      const checkboxes = document.querySelectorAll('.select-participant'); let selected = [];
      checkboxes.forEach(cb => { if (cb.checked) selected.push(parseInt(cb.getAttribute('data-snr'))); });
      if (selected.length === 0){ alert('Ingen deltakere er markert.'); return; }
      const confirmed = await window.customConfirm('Er du sikker på at du vil slette de markerte deltakerne?'); if (!confirmed) return;
      for (let snr of selected){ const { error } = await window.supabaseClient.from('participants').delete().eq('snr', snr); if (error) console.error('Feil ved sletting av snr', snr, error); }
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    });

    document.getElementById('btnToggleSelected').addEventListener('click', async function(){
      const checkboxes = document.querySelectorAll('.select-participant'); let selected = [];
      checkboxes.forEach(cb => { if (cb.checked) selected.push(parseInt(cb.getAttribute('data-snr'))); });
      if (selected.length === 0){ alert('Ingen deltakere er markert.'); return; }
      for (let snr of selected){
        let p = window.participants[snr]; if (!p) continue;
        if (p.status === 'Venter' || p.status === 'Planlagt'){ await window.startIndividual(snr); }
        else if (p.status === 'I gang'){ await window.recordFinish(snr); }
      }
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    });
  </script>
</body>
</html>
