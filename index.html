<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lørenskog Skiklubb – Tidtaking</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand:#18469a;   /* Lørenskog blå */
      --brand2:#dbe723;  /* Lørenskog gul */
    }

    body{ background:#f5f7fb; color:#0f172a; }
    .card{ background:#fff; border:1px solid #e2e8f0; border-radius:1rem; padding:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
    .subtle{ color:#475569 }
    .soft{ background:#f8fafc }

    table{ width:100%; border-collapse:collapse; background:white; }
    th,td{ padding:10px 12px; border-bottom:1px solid #e2e8f0; text-align:left; font-size:14px; }
    thead th{ background:#f1f5f9; font-weight:600; font-size:13px; position:sticky; top:0; z-index:1; }

    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:8px 12px; border-radius:.75rem; font-size:14px; font-weight:600; border:1px solid #e2e8f0; cursor:pointer; transition: background .15s, transform .04s; }
    .btn:hover{ background:#f1f5f9; }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ background:#fff; color:var(--brand); border-color:#cbd5e1; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
    .btn-purple{ background:#ede9fe; color:#6d28d9; border-color:#ddd6fe; }
    .btn-ghost{ background:transparent; }

    .status{ display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px; font-weight:600; letter-spacing:.2px }
    .status.wait{ background:#f3f4f6; color:#64748b; }
    .status.plan{ background:#dbeafe; color:#1d4ed8; }
    .status.run{ background:#dcfce7; color:#15803d; }
    .status.done{ background:#fee2e2; color:#b91c1c; }

    /* SKYTING: sort som standard, hvit ved treff (m/ sort kant) */
    .shooting .target{
      display:inline-grid; place-items:center;
      width:26px; height:26px; margin:2px;
      border-radius:50%; border:2px solid #0f172a;
      background:#000000; color:#000000; cursor:pointer; user-select:none
    }
    .shooting .target[data-hit="true"]{
      background:#ffffff; color:#ffffff; border-color:#0f172a;
    }

    /* Mobil: skjul noen kolonner */
    @media (max-width:760px){
      .col-laps, .col-finishdiff{ display:none }
      th.col-laps, th.col-finishdiff{ display:none }
    }

    /* Sticky actionbar på mobil */
    .sticky-actions{
      position:sticky; bottom:0; z-index:40; margin-top:12px;
      background:linear-gradient(180deg, rgba(245,247,251,0), rgba(245,247,251,0.85) 35%, rgba(245,247,251,1));
      padding-top:6px;
    }
    .sticky-actions .bar{
      display:flex; gap:8px; flex-wrap:wrap; padding:10px; border:1px solid #e2e8f0;
      background:#ffffff; border-radius:1rem; box-shadow:0 8px 24px rgba(15,23,42,.06);
    }

    dialog{ border:none; border-radius:1rem; padding:18px; background:#fff; color:#0f172a; box-shadow:0 12px 30px rgba(0,0,0,.18); }
    dialog::backdrop{ background:rgba(0,0,0,.45) }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
  </script>
</head>
<body class="min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-[var(--brand)] text-white p-3 shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="Logo LSK Klubb farger JPG.jpeg" alt="Lørenskog Skiklubb" class="h-12 w-16 rounded bg-white p-1 object-contain">
        <div>
          <h1 class="text-xl font-bold leading-tight">Lørenskog Skiklubb</h1>
          <p class="text-sm opacity-90">Tidtaking for ski-konkurranser</p>
        </div>
      </div>
      <div id="liveClock" class="font-bold text-lg"></div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="flex-1 max-w-6xl mx-auto w-full p-4 space-y-6">

    <!-- Registrering + Oppsett -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card">
        <h3 class="font-semibold mb-3">Manuell registrering</h3>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm subtle">Startnummer</label>
            <input type="number" id="newStartNumber" class="w-full border rounded-lg px-3 py-2" placeholder="Startnr." />
          </div>
          <div>
            <label class="text-sm subtle">Navn</label>
            <input type="text" id="newParticipant" class="w-full border rounded-lg px-3 py-2" placeholder="Navn" />
          </div>
          <div>
            <label class="text-sm subtle">Klasse</label>
            <select id="newParticipantClass" class="w-full border rounded-lg px-3 py-2">
              <option value="">Velg klasse…</option>
              <option>G10 Nybeg og yngre</option>
              <option>K19</option>
              <option>J16</option>
              <option>K17</option>
              <option>M18</option>
              <option>M19</option>
              <option>K18</option>
              <option>G14</option>
              <option>G11-12 Nybeg</option>
              <option>J11</option>
              <option>G12</option>
              <option>G13</option>
              <option>J10 Nybeg og yngre</option>
              <option>J11-12 Nybeg</option>
              <option>G11</option>
              <option>J12</option>
              <option>J13</option>
              <option>J14</option>
              <option>J15</option>
              <option>G15</option>
              <option>G16</option>
              <option>M17</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnAddParticipant" class="btn btn-primary w-full">Lagre deltaker</button>
          </div>
        </div>

        <div class="mt-3 grid sm:grid-cols-[1fr_auto_auto] gap-2 items-end">
          <div>
            <label class="text-sm subtle">CSV-import</label>
            <input type="file" id="csvImport" accept=".csv" class="w-full border rounded-lg px-3 py-2" />
          </div>
          <button id="btnImportCSV" class="btn btn-primary">Importer CSV</button>
          <button id="btnSaveCSV" class="btn">Lagre CSV</button>
        </div>
      </div>

      <div class="card">
        <h3 class="font-semibold mb-3">Oppsett</h3>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm subtle">Tilleggstid pr bom (sek)</label>
            <input type="number" id="penaltyTime" value="30" class="w-full border rounded-lg px-3 py-2" />
          </div>
          <div>
            <label class="text-sm subtle">Første starttid</label>
            <input type="time" id="firstStartTime" step="1" class="w-full border rounded-lg px-3 py-2" />
          </div>
          <div>
            <label class="text-sm subtle">Intervall (sek)</label>
            <input type="number" id="startInterval" value="30" class="w-full border rounded-lg px-3 py-2" />
          </div>
          <div class="flex items-end">
            <button id="btnAssignStartTimes" class="btn btn-primary w-full">Tildel starttider</button>
          </div>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btnResetAll" class="btn btn-danger">Nullstill alt</button>
          <button id="btnStartMass" class="btn btn-primary">Fellesstart</button>
        </div>
      </div>
    </section>

    <!-- Operasjoner for markerte -->
    <section class="card">
      <h3 class="font-semibold mb-3">Operasjoner for markerte deltakere</h3>
      <div class="flex flex-wrap gap-2">
        <button class="btn btn-danger" id="btnDeleteSelected">Slett markerte</button>
        <button class="btn btn-primary" id="btnToggleSelected">Start/Stop markerte</button>
        <button class="btn btn-purple" id="btnSaveSelectedHistory">Lagre markerte til history</button>
      </div>
    </section>

    <!-- Resultater -->
    <section class="card">
      <h3 class="font-semibold mb-3">Resultater</h3>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th>Velg <input type="checkbox" id="masterSelect" /></th>
              <th>Plass</th>
              <th>Start</th>
              <th>#</th>
              <th>Navn</th>
              <th>Kl.</th>
              <th>Status</th>
              <th>Tid</th>
              <th>S1</th>
              <th>S2</th>
              <th>Bom</th>
              <th class="col-laps">Rundetider (Diff)</th>
              <th class="col-finishdiff">Mål (Diff)</th>
              <th>Handl.</th>
            </tr>
          </thead>
          <tbody id="results"></tbody>
        </table>
      </div>
    </section>

    <!-- Historikk -->
    <section id="historySection" class="card">
      <h3 class="font-semibold mb-3">Historikk – lagret vs. ikke lagret</h3>
      <div class="flex flex-wrap gap-2 items-center mb-2">
        <label for="historyDate" class="text-sm subtle">Dato:</label>
        <input type="date" id="historyDate" class="border rounded-lg px-3 py-2" />
        <button class="btn btn-primary" id="btnRefreshHistory">Oppdater historikk</button>
        <button class="btn" id="btnShowAllHistory" title="Vis all lagret historikk uansett dato">Vis all historikk</button>
        <small id="historySummary" class="subtle"></small>
      </div>

      <div class="overflow-x-auto">
        <table>
          <caption class="text-left font-semibold px-2 py-2">Lagret i history</caption>
          <thead>
            <tr>
              <th>Dato</th>
              <th>#</th>
              <th>Navn</th>
              <th>Kl.</th>
              <th>Status</th>
              <th>Tid</th>
            </tr>
          </thead>
          <tbody id="historySavedBody"></tbody>
        </table>
      </div>

      <div class="overflow-x-auto mt-4">
        <table>
          <caption class="text-left font-semibold px-2 py-2">Ikke lagret ennå (fra participants)</caption>
          <thead>
            <tr>
              <th>Velg</th>
              <th>#</th>
              <th>Navn</th>
              <th>Kl.</th>
              <th>Status</th>
              <th>Tid</th>
              <th>S1</th>
              <th>S2</th>
              <th>Bom</th>
              <th>Handl.</th>
            </tr>
          </thead>
          <tbody id="historyPendingBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Sticky (mobil) -->
    <div class="sticky-actions">
      <div class="bar">
        <button class="btn btn-primary" id="btnToggleSelected__dup" title="Start/Stop markerte">Start/Stop</button>
        <button class="btn btn-purple" id="btnSaveSelectedHistory__dup" title="Lagre markerte til history">Lagre til history</button>
        <button class="btn btn-danger" id="btnDeleteSelected__dup" title="Slett markerte">Slett</button>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer class="text-center text-sm text-gray-500 py-5">
    © 2025 Lørenskog Skiklubb – Tidtaking
  </footer>

  <!-- Bekreftelsesdialog -->
  <dialog id="confirmDialog">
    <p id="confirmText">Er du sikker på at du vil nullstille alt?</p>
    <div class="mt-3 flex gap-2">
      <button class="btn" id="btnConfirmCancel">Avbryt</button>
      <button class="btn btn-danger" id="btnConfirmOk">OK</button>
    </div>
  </dialog>

  <!-- ====== APP LOGIKK ====== -->
  <script>
    // Global state
    window.participants = {};
    window.localTimers = {};
    window._didBackfillPenalties = false;
    window._historyShowAll = false; // viser all historikk når true
    // UNDO-stack per deltaker
    window.undoStack = {}; // { [snr]: [ {type, prev:{...}} ] }
    const UNDO_MAX = 5;

    // Hjelper for undo
    function pushUndo(snr, item){
      if (!window.undoStack[snr]) window.undoStack[snr] = [];
      window.undoStack[snr].push(item);
      if (window.undoStack[snr].length > UNDO_MAX) window.undoStack[snr].shift();
    }
    function hasUndo(snr){
      return Array.isArray(window.undoStack[snr]) && window.undoStack[snr].length > 0;
    }

    // Markering
    window.updateSelection = function(snr, isSelected) {
      if (window.participants[snr]) window.participants[snr].selected = isSelected;
    };
    window.selectAll = function(checked) {
      const boxes = document.querySelectorAll('.select-participant');
      boxes.forEach(cb => {
        cb.checked = checked;
        const snr = parseInt(cb.getAttribute('data-snr'));
        if (!isNaN(snr)) updateSelection(snr, checked);
      });
    };

    // Helpers
    window.getShootingArray = function(p) {
      if (!p || !p.shooting) return [Array(5).fill(false), Array(5).fill(false)];
      if (Array.isArray(p.shooting)) return (p.shooting.length >= 2) ? p.shooting : [Array(5).fill(false), Array(5).fill(false)];
      if (typeof p.shooting === 'string') {
        try {
          const parsed = JSON.parse(p.shooting);
          return (Array.isArray(parsed) && parsed.length >= 2) ? parsed : [Array(5).fill(false), Array(5).fill(false)];
        } catch { return [Array(5).fill(false), Array(5).fill(false)]; }
      }
      return [Array(5).fill(false), Array(5).fill(false)];
    };

    window.formatTime = function(sec){
      const sTot = Number(sec) || 0;
      const min = Math.floor(sTot/60);
      const s = (sTot % 60).toFixed(1);
      return min>0 ? `${min}m ${s}s` : `${s}s`;
    };
    window.formatClockTimeFull = function(ms){
      const d = new Date(ms);
      const h = d.getHours().toString().padStart(2,'0');
      const m = d.getMinutes().toString().padStart(2,'0');
      const s = d.getSeconds().toString().padStart(2,'0');
      return `${h}:${m}:${s}`;
    };

    window.customConfirm = function(message){
      return new Promise((resolve)=>{
        const dialog = document.getElementById('confirmDialog');
        document.getElementById('confirmText').textContent = message;
        dialog.showModal();
        document.getElementById('btnConfirmOk').onclick = function(){ dialog.close(); resolve(true); }
        document.getElementById('btnConfirmCancel').onclick = function(){ dialog.close(); resolve(false); }
      })
    };

    // Beregning av sluttid
    window.updateFinalTime = function(snr){
      let p = window.participants[snr];
      const penaltyPerMiss = Number(document.getElementById('penaltyTime').value) || 0;
      const shootingArr = window.getShootingArray(p);
      const totalMisses = shootingArr.flat().filter(hit => hit === false).length;
      p.finish = Number(p.rawFinish || 0) + (totalMisses * penaltyPerMiss);
    };

    window.recomputeAndPersistAllFinished = async function(){
      const penaltyPerMiss = Number(document.getElementById('penaltyTime').value) || 0;
      for (const [snr,p] of Object.entries(window.participants)){
        if (p.status !== 'Fullført' && p.rawFinish == null) continue;
        const shootingArr = window.getShootingArray(p);
        const totalMisses = shootingArr.flat().filter(hit => hit === false).length;
        let raw = (p.rawFinish != null) ? Number(p.rawFinish) : (p.finish != null) ? Number(p.finish) : null;
        if (raw == null) continue;
        const newFinish = raw + totalMisses * penaltyPerMiss;
        const payload = { finish:newFinish };
        if (p.rawFinish == null) payload.rawFinish = raw;
        if (p.finish !== newFinish || (p.rawFinish == null)){
          const { error } = await window.supabaseClient.from('participants').update(payload).eq('snr', snr);
          if (error) console.error('Feil ved backfill av straff for snr', snr, error);
          else { p.finish = newFinish; if (p.rawFinish == null) p.rawFinish = raw; }
        }
      }
    };

    window.fetchParticipants = async function(){
      const { data, error } = await window.supabaseClient.from('participants').select('*');
      if (error){ console.error('Feil ved henting av deltakere:', error); return; }
      const old = window.participants; window.participants = {};
      data.forEach(record => {
        if (record.rawFinish != null) record.rawFinish = Number(record.rawFinish);
        if (record.finish    != null) record.finish    = Number(record.finish);
        record.laps = record.laps || [];
        record.shooting = (typeof record.shooting === 'string')
          ? window.getShootingArray(record)
          : (Array.isArray(record.shooting) ? record.shooting : [Array(5).fill(false), Array(5).fill(false)]);
        if (record.rawFinish != null){
          const penaltyPerMiss = Number(document.getElementById('penaltyTime').value) || 0;
          const totalMisses = record.shooting.flat().filter(h => h === false).length;
          record.finish = Number(record.rawFinish) + totalMisses * penaltyPerMiss;
        }
        // behold valg + ikke nullstill undo-stack
        record.selected = !!(old[record.snr] && old[record.snr].selected);
        if (window.localTimers[record.snr]) record.timer = window.localTimers[record.snr];
        window.participants[record.snr] = record;
        if (!window.undoStack[record.snr]) window.undoStack[record.snr] = [];
      })
    };

    window.updateTable = async function(){
      await window.fetchParticipants();
      await window.autoStart();
      if (!window._didBackfillPenalties){
        await window.recomputeAndPersistAllFinished();
        window._didBackfillPenalties = true;
      }
      window.updateLocalDisplay();
    };

    window.updateLocalDisplay = function(){
      Object.keys(window.participants).forEach(snr => {
        const p = window.participants[snr];
        if (p.status === 'Fullført' && p.rawFinish != null) window.updateFinalTime(snr);
      });
      let overallBestFinish = Infinity;
      Object.values(window.participants).forEach(p => { if (p.finish != null && p.finish < overallBestFinish) overallBestFinish = p.finish; });
      let maxLaps = 0; Object.values(window.participants).forEach(p => { if (p.laps.length > maxLaps) maxLaps = p.laps.length; });
      let bestLapTimes = Array(maxLaps).fill(Infinity);
      Object.values(window.participants).forEach(p => { p.laps.forEach((lap,i)=>{ if (lap < bestLapTimes[i]) bestLapTimes[i] = lap; })});
      let classPlacements = {};
      Object.entries(window.participants).forEach(([snr,p]) => {
        if (p.finish != null){
          if (!classPlacements[p.class]) classPlacements[p.class] = [];
          classPlacements[p.class].push({ snr, finish:p.finish });
        }
      });
      for (const cls in classPlacements){
        classPlacements[cls].sort((a,b)=>a.finish-b.finish);
        classPlacements[cls].forEach((entry,i)=> entry.rank = i+1);
      }

      let rows = [];
      for (const [snr,p] of Object.entries(window.participants)){
        const checkbox = `<input type="checkbox" class="select-participant" data-snr="${snr}" id="select-${snr}" name="select-participant" onchange="updateSelection(${snr}, this.checked)" ${p.selected ? 'checked' : ''}>`;
        let placement = '-';
        if (p.finish != null && classPlacements[p.class]){
          const found = classPlacements[p.class].find(entry => entry.snr === snr);
          placement = found ? found.rank : '-';
        }
        let timeDisplay = '-';
        if (p.status === 'Planlagt'){
          let remainingSec = (Date.parse(p.start) - Date.now())/1000; if (remainingSec < 0) remainingSec = 0;
          timeDisplay = window.formatClockTimeFull(Date.parse(p.start)) + ` (${window.formatTime(remainingSec)} til start)`;
        } else if (p.timer){
          timeDisplay = window.formatTime((Date.now()-Date.parse(p.start))/1000);
        } else if (p.finish != null){
          timeDisplay = window.formatTime(p.finish);
        }
        const lapDiffs = p.laps.map((lap,i)=>{ const diff=(lap - bestLapTimes[i]).toFixed(1); return `${window.formatTime(lap)} (+${diff}s)`; }).join('<br>');
        const finishDiff = p.finish != null ? `${window.formatTime(p.finish)} (+${(p.finish - overallBestFinish).toFixed(1)}s)` : '-';
        const statusTag = p.status==='Venter' ? 'status wait' : p.status==='Planlagt' ? 'status plan' : p.status==='I gang' ? 'status run' : 'status done';

        const startBtn = (p.status === 'Planlagt' || p.status === 'Venter') && !p.timer
          ? `<button class='btn btn-primary' data-action="start" data-snr="${snr}">Start</button>`
          : '-';

        const actionBtns = p.timer
          ? `<button class='btn btn-primary' data-action="lap" data-snr="${snr}">Rundetid</button>
             <button class='btn btn-primary' data-action="finish" data-snr="${snr}">Mål</button>
             ${hasUndo(snr) ? `<button class='btn' data-action="undo" data-snr="${snr}">Angre</button>` : ''}`
          : `${hasUndo(snr) ? `<button class='btn' data-action="undo" data-snr="${snr}">Angre</button>` : '-'}`;

        rows.push(`<tr>
          <td>${checkbox}</td>
          <td>${placement}</td>
          <td>${startBtn}</td>
          <td>${snr}</td>
          <td>${p.name}</td>
          <td>${p.class}</td>
          <td><span class='${statusTag}'>${p.status}</span></td>
          <td>${p.timer ? window.formatTime((Date.now()-Date.parse(p.start))/1000) : timeDisplay}</td>
          <td class="shooting">${window.renderShooting(snr,0)}</td>
          <td class="shooting">${window.renderShooting(snr,1)}</td>
          <td>${window.getShootingArray(p).flat().filter(h => h === false).length}</td>
          <td class="col-laps">${lapDiffs || '-'}</td>
          <td class="col-finishdiff">${finishDiff}</td>
          <td>${actionBtns}</td>
        </tr>`);
      }
      document.getElementById('results').innerHTML = rows.join('');
    };

    window.updateLiveClock = function(){
      const now = new Date();
      document.getElementById('liveClock').innerText = now.toLocaleTimeString();
    };

    window.autoStart = async function(){
      const now = Date.now();
      for (const snr in window.participants){
        let p = window.participants[snr];
        if (p.status === 'Planlagt' && now >= Date.parse(p.start)){
          p.status = 'I gang';
          if (!window.localTimers[snr]) window.localTimers[snr] = setInterval(window.updateTable, 1000);
          const { error } = await window.supabaseClient.from('participants').update({ status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved autoStart for snr', snr, error);
        }
      }
    };

    window.addParticipant = async function(){
      const snrStr = document.getElementById('newStartNumber').value; const snr = parseInt(snrStr);
      const name = document.getElementById('newParticipant').value; const cls = document.getElementById('newParticipantClass').value;
      if (!snrStr || !name || !cls){ alert('Fyll ut alle felt!'); return; }
      let { data: existing } = await window.supabaseClient.from('participants').select('*').eq('snr', snr);
      if (existing && existing.length > 0){ alert('Startnummer allerede brukt!'); return; }
      const newPart = { snr, name, class:cls, start:null, status:'Venter', laps:[], finish:null, rawFinish:null, shooting: JSON.stringify([Array(5).fill(false), Array(5).fill(false)]), selected:false };
      const { error } = await window.supabaseClient.from('participants').insert([newPart]);
      if (error) console.error('Feil ved lagring:', error);
      document.getElementById('newStartNumber').value = '';
      document.getElementById('newParticipant').value = '';
      setTimeout(window.updateTable, 500);
    };

    window.assignStartTimes = async function(){
      const firstTimeStr = document.getElementById('firstStartTime').value;
      const intervalSec = parseInt(document.getElementById('startInterval').value);
      if (!firstTimeStr || isNaN(intervalSec)){ alert('Skriv inn gyldig første starttid og intervall!'); return; }
      const today = new Date();
      const parts = firstTimeStr.split(':');
      today.setHours(parseInt(parts[0]), parseInt(parts[1]), parts[2] ? parseInt(parts[2]) : 0, 0);
      const firstStartMs = today.getTime();
      const keys = Object.keys(window.participants).sort((a,b)=>a-b);
      for (let index=0; index<keys.length; index++){
        const snr = keys[index]; let p = window.participants[snr];
        if (p.status === 'Venter'){
          p.start = new Date(firstStartMs + index * intervalSec * 1000).toISOString();
          p.status = 'Planlagt';
          const { error } = await window.supabaseClient.from('participants').update({ start:p.start, status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved oppdatering av starttid for snr', snr, error);
        }
      }
      window.updateTable();
    };

    window.startMass = async function(){
      const now = new Date().toISOString();
      for (const snr in window.participants){
        let p = window.participants[snr];
        if (!window.localTimers[snr] && (p.status === 'Venter' || p.status === 'Planlagt')){
          p.start = now; p.status = 'I gang';
          window.localTimers[snr] = setInterval(window.updateTable, 1000);
          const { error } = await window.supabaseClient.from('participants').update({ start:p.start, status:p.status }).eq('snr', snr);
          if (error) console.error('Feil ved startMass for snr', snr, error);
        }
      }
      window.updateTable();
    };

    window.startIndividual = async function(snr){
      let p = window.participants[snr];
      if (p && !window.localTimers[snr]){
        p.start = new Date().toISOString(); p.status = 'I gang';
        window.localTimers[snr] = setInterval(window.updateTable, 1000);
        const { error } = await window.supabaseClient.from('participants').update({ start:p.start, status:p.status }).eq('snr', snr);
        if (error) console.error('Feil ved startIndividual for snr', snr, error);
        window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
      }
    };

    window.recordLap = async function(snr){
      let p = window.participants[snr];
      if (p && p.start){
        // push undo før endring
        pushUndo(snr, { type:'lap', prev:{ laps:[...p.laps] } });

        const lapTime = (Date.now() - Date.parse(p.start))/1000;
        p.laps.push(lapTime);
        const { error } = await window.supabaseClient.from('participants').update({ laps:p.laps }).eq('snr', snr);
        if (error) console.error('Feil ved recordLap for snr', snr, error);
        window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
      }
    };

    window.recordFinish = async function(snr){
      let p = window.participants[snr];
      if (p && p.start){
        // push undo før endring (ta vare på forrige verdier)
        pushUndo(snr, { type:'finish', prev:{
          rawFinish: p.rawFinish ?? null,
          status: p.status,
          finish: p.finish ?? null,
          hadTimer: !!window.localTimers[snr]
        }});

        if (window.localTimers[snr]){ clearInterval(window.localTimers[snr]); delete window.localTimers[snr]; }
        p.rawFinish = (Date.now() - Date.parse(p.start))/1000;
        p.status = 'Fullført';
        window.updateFinalTime(snr);
        const { error } = await window.supabaseClient.from('participants').update({ rawFinish:p.rawFinish, status:p.status, finish:p.finish }).eq('snr', snr);
        if (error) console.error('Feil ved recordFinish for snr', snr, error);
        window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
      }
    };

    // UNDO – angre siste rundetid/mål
    window.undoLast = async function(snr){
      const stack = window.undoStack[snr];
      if (!stack || stack.length === 0) return;
      const last = stack.pop();
      const p = window.participants[snr];
      if (!p) return;

      if (last.type === 'lap'){
        p.laps = last.prev.laps || [];
        const { error } = await window.supabaseClient.from('participants').update({ laps:p.laps }).eq('snr', snr);
        if (error) console.error('Feil ved UNDO lap for snr', snr, error);
      } else if (last.type === 'finish'){
        // Reåpne hvis den var fullført
        p.rawFinish = last.prev.rawFinish;
        p.finish = last.prev.finish;
        p.status = last.prev.status || 'I gang';

        // Start timer igjen hvis vi er i gang
        if (p.status === 'I gang' && !window.localTimers[snr]){
          window.localTimers[snr] = setInterval(window.updateTable, 1000);
        }
        const payload = { rawFinish:p.rawFinish, finish:p.finish, status:p.status };
        const { error } = await window.supabaseClient.from('participants').update(payload).eq('snr', snr);
        if (error) console.error('Feil ved UNDO finish for snr', snr, error);
      }

      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    };

    // Lagrer finish når blink endres etter målgang (ikke inkludert i undo, men kan legges til senere)
    window.toggleTarget = async function(snr, shootIdx, idx){
      let p = window.participants[snr];
      let shootingArr = window.getShootingArray(p);
      shootingArr[shootIdx][idx] = !shootingArr[shootIdx][idx];
      p.shooting = JSON.stringify(shootingArr);
      const updatePayload = { shooting:p.shooting };
      if (p.status === 'Fullført' || p.rawFinish != null){
        window.updateFinalTime(snr); updatePayload.finish = p.finish;
      }
      const { error } = await window.supabaseClient.from('participants').update(updatePayload).eq('snr', snr);
      if (error) console.error('Feil ved toggleTarget for snr', snr, error);
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    };

    window.renderShooting = function(snr, shootIdx){
      let p = window.participants[snr];
      let shootingArr = window.getShootingArray(p);
      return shootingArr[shootIdx].map((hit,i)=>{
        const h = !!hit;
        return `<span class="target" data-hit="${h}" onclick="toggleTarget(${snr},${shootIdx},${i})">&#9679;</span>`;
      }).join('');
    };

    // Historikk
    window.getTodayCompDate = function(){
      const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0'); const dd = String(now.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };
    function lc(x){return (x||'').toString().toLowerCase().trim();}

    window.renderPendingInteractive = function(pending, compDate){
      if (!pending || pending.length === 0) return `<tr><td colspan="10">Alle er lagret for ${compDate}.</td></tr>`;
      return pending.map(p => {
        const wp = window.participants[p.snr] || p;
        const selectedAttr = wp.selected ? 'checked' : '';
        let tid = '-';
        if (wp.status === 'Planlagt'){
          let remainingSec = (Date.parse(wp.start) - Date.now())/1000; if (remainingSec < 0) remainingSec = 0;
          tid = window.formatClockTimeFull(Date.parse(wp.start)) + ` (${window.formatTime(remainingSec)})`;
        } else if (wp.start && (wp.status === 'I gang')){
          tid = window.formatTime((Date.now() - Date.parse(wp.start))/1000);
        } else if (wp.finish != null){
          tid = window.formatTime(wp.finish);
        }
        const bom = window.getShootingArray(wp).flat().filter(h => h === false).length;

        const actions = wp.timer
          ? `<button class='btn btn-primary' data-action="lap" data-snr="${wp.snr}">Rundetid</button>
             <button class='btn btn-primary' data-action="finish" data-snr="${wp.snr}">Mål</button>
             ${hasUndo(wp.snr) ? `<button class='btn' data-action="undo" data-snr="${wp.snr}">Angre</button>` : ''}`
          : `${hasUndo(wp.snr) ? `<button class='btn' data-action="undo" data-snr="${wp.snr}">Angre</button>` : '-'}`;

        return `<tr>
          <td><input type='checkbox' class='select-participant' data-snr='${wp.snr}' onchange='updateSelection(${wp.snr}, this.checked)' ${selectedAttr}></td>
          <td>${wp.snr}</td>
          <td>${wp.name}</td>
          <td>${wp.class}</td>
          <td>${wp.status}</td>
          <td>${tid}</td>
          <td class='shooting'>${window.renderShooting(wp.snr,0)}</td>
          <td class='shooting'>${window.renderShooting(wp.snr,1)}</td>
          <td>${bom}</td>
          <td>${actions}</td>
        </tr>`;
      }).join('');
    };

    // Støtter både valgt dato og "all historikk"
    window.updateHistoryView = async function(dateStr){
      const compDate = dateStr || (document.getElementById('historyDate')?.value || window.getTodayCompDate());

      // 1) Hent history – enten for valgt dato, eller alle datoer
      let hist, errH;
      if (window._historyShowAll){
        const resp = await window.supabaseClient.from('history').select('*').order('comp_date', { ascending:false });
        hist = resp.data; errH = resp.error;
      } else {
        const resp = await window.supabaseClient.from('history').select('*').eq('comp_date', compDate);
        hist = resp.data; errH = resp.error;
      }
      if (errH){ console.error('Feil ved henting av history:', errH); hist = []; }

      // 2) Hent participants
      let { data: parts, error: errP } = await window.supabaseClient.from('participants').select('*');
      if (errP){ console.error('Feil ved henting av participants:', errP); parts = []; }

      // 3) Matching for “ikke lagret ennå”
      const savedSnr = new Set((hist||[]).map(h => h.snr).filter(v => v !== null && v !== undefined));
      const savedNameClass = new Set((hist||[]).map(h => `name:${lc(h.name)}|class:${lc(h.class)}`));
      const pending = (parts||[]).filter(p => {
        const bySnr = (p.snr != null) && savedSnr.has(p.snr);
        const byNC  = savedNameClass.has(`name:${lc(p.name)}|class:${lc(p.class)}`);
        return !(bySnr || byNC);
      });

      // 4) Render lagret (med dato-kolonne)
const savedRows = (hist||[]).map(h => {
  const tid  = (h.finish != null) ? window.formatTime(h.finish) : '-';
  const snr  = (h.snr   != null) ? h.snr : '-';   // <-- fikset
  const dato = h.comp_date || '-';
  return `<tr><td>${dato}</td><td>${snr}</td><td>${h.name||''}</td><td>${h.class||''}</td><td>${h.status||''}</td><td>${tid}</td></tr>`;
}).join('');

      const savedBody = document.getElementById('historySavedBody');
      if (savedBody) savedBody.innerHTML = savedRows || `<tr><td colspan="6">Ingen lagret${window._historyShowAll ? '' : ` for ${compDate}`}.</td></tr>`;

      // 5) Render ikke-lagret (fra participants) – interaktiv
      const pendingBody = document.getElementById('historyPendingBody');
      if (pendingBody) pendingBody.innerHTML = window.renderPendingInteractive(pending, compDate);

      // 6) Oppsummering
      const summaryEl = document.getElementById('historySummary');
      if (summaryEl) summaryEl.textContent = `${(hist||[]).length} lagret${window._historyShowAll ? ' (alle datoer)' : ''} · ${pending.length} ikke lagret`;
    };

    // CSV-import
    window.importCSV = function(){
      const fileInput = document.getElementById('csvImport');
      if (!fileInput.files || fileInput.files.length === 0){ alert('Velg en CSV-fil å importere.'); return; }
      const file = fileInput.files[0]; const reader = new FileReader();
      reader.onload = async function(e){
        const text = e.target.result; const lines = text.split('\n').map(line=>line.trim()).filter(line=>line.length>0);
        let startIdx = 0; if (lines[0]?.toLowerCase().startsWith('snr')) startIdx = 1;
        let newParticipants = [];
        for (let i=startIdx;i<lines.length;i++){
          const parts = lines[i].split(','); if (parts.length < 3) continue;
          const snr = parseInt(parts[0].trim()); const name = parts[1].trim(); const cls = parts[2].trim();
          if (isNaN(snr) || !name || !cls) continue;
          newParticipants.push({ snr, name, class:cls, start:null, status:'Venter', laps:[], finish:null, rawFinish:null, shooting: JSON.stringify([Array(5).fill(false), Array(5).fill(false)]), selected:false });
        }
        if (newParticipants.length === 0){ alert('Ingen gyldige deltakere funnet i CSV-filen.'); return; }
        const { error } = await window.supabaseClient.from('participants').insert(newParticipants);
        if (error){ console.error('Feil ved CSV-import:', error); alert('Feil ved CSV-import – sjekk konsollen.'); }
        else { alert('CSV-import fullført!'); window.updateTable(); }
      };
      reader.readAsText(file);
    };

    // CSV-eksport
    window.saveCSV = async function(){
      const { data, error } = await window.supabaseClient.from('participants').select('*');
      if (error){ console.error('Feil ved CSV-export:', error); return; }
      if (!data || data.length === 0){ alert('Ingen data funnet for CSV-export!'); return; }
      const finishedData = data.filter(p => p.finish !== null && p.finish !== undefined).sort((a,b)=>a.finish-b.finish);
      let csv = 'Klasse,Plass,Startnummer,Navn,Tid,Bom\n';
      let groups = {};
      finishedData.forEach(p => { if (!groups[p.class]) groups[p.class] = []; groups[p.class].push(p); });
      for (const cls in groups){
        groups[cls].sort((a,b)=>a.finish-b.finish);
        const bestFinish = groups[cls][0].finish;
        groups[cls].forEach((p,i) => {
          const shooting = (typeof p.shooting === 'string') ? JSON.parse(p.shooting) : p.shooting || [[],[]];
          const bom = shooting.flat().filter(hit => hit === false).length;
          const diff = p.finish - bestFinish;
          csv += `${cls},${i+1},${p.snr},${p.name},${window.formatTime(p.finish)} (+${diff.toFixed(1)}s),${bom}\n`;
        })
      }
      const unfinishedData = data.filter(p => p.finish === null || p.finish === undefined).sort((a,b)=>a.snr-b.snr);
      unfinishedData.forEach(p => { const shooting = (typeof p.shooting === 'string') ? JSON.parse(p.shooting) : p.shooting || [[],[]]; const bom = shooting.flat().filter(hit => hit === false).length; csv += `-,${p.snr},${p.name},${p.class},-,${bom}\n`; });
      const link = document.createElement('a'); link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); link.download = 'resultater.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    };

    // Lagre markerte til history
    window.saveSelectedToHistory = async function(){
      const checkboxes = document.querySelectorAll('.select-participant');
      let selected = []; checkboxes.forEach(cb => { if (cb.checked) selected.push(parseInt(cb.getAttribute('data-snr'))); });
      if (selected.length === 0){ alert('Ingen deltakere er markert.'); return; }
      const now = new Date(); const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0'); const dd = String(now.getDate()).padStart(2,'0'); const compDate = `${yyyy}-${mm}-${dd}`;
      const rows = selected.map((snr)=>{
        const p = window.participants[snr]; if (!p) return null;
        const shootingArr = window.getShootingArray(p);
        return { comp_date:compDate, name:p.name, class:p.class, start:p.start ? p.start : null, status:p.status, laps:p.laps, finish:p.finish ?? null, rawFinish:p.rawFinish ?? null, shooting:shootingArr, penalty: Number(document.getElementById('penaltyTime').value) || null };
      }).filter(Boolean);
      const { error } = await window.supabaseClient.from('history').insert(rows);
      if (error){ console.error('Feil ved lagring til history:', error); alert('Feil ved lagring til history – sjekk konsollen.'); }
      else { alert(`Lagret ${rows.length} markerte til history for ${compDate}.`); if (window.updateHistoryView){ window.updateHistoryView(); } }
    };

    // Delegert knapphåndtering → fungerer på første klikk selv etter re-render
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const snr = btn.getAttribute('data-snr');
      if (!snr) return;

      if (action === 'start') { await window.startIndividual(snr); }
      if (action === 'lap')   { await window.recordLap(snr); }
      if (action === 'finish'){ await window.recordFinish(snr); }
      if (action === 'undo')  { await window.undoLast(snr); }
    });

    // Timere og init
    setInterval(()=>{ window.updateLiveClock(); window.updateTable(); }, 1000);

    // Event listeners
    document.getElementById('btnAddParticipant').addEventListener('click', window.addParticipant);
    document.getElementById('btnAssignStartTimes').addEventListener('click', window.assignStartTimes);
    document.getElementById('btnResetAll').addEventListener('click', async function(){
      const confirmed = await window.customConfirm('Er du sikker på at du vil nullstille alt?'); if (!confirmed) return;
      for (const snr in window.participants){ if (window.localTimers[snr]){ clearInterval(window.localTimers[snr]); delete window.localTimers[snr]; } }
      window.participants = {};
      const { error } = await window.supabaseClient.from('participants').delete().neq('snr', 0);
      if (error) console.error('Feil ved nullstilling:', error);
      window.updateTable();
    });
    document.getElementById('btnSaveCSV').addEventListener('click', window.saveCSV);
    document.getElementById('btnStartMass').addEventListener('click', window.startMass);
    document.getElementById('btnImportCSV').addEventListener('click', window.importCSV);
    document.getElementById('btnSaveSelectedHistory').addEventListener('click', window.saveSelectedToHistory);
    const master = document.getElementById('masterSelect'); if (master){ master.addEventListener('change', (e)=> window.selectAll(e.target.checked)); }

    // Dupliserte (sticky bar) knapper peker til samme logikk
    const dupMap = [
      ['btnToggleSelected__dup','btnToggleSelected'],
      ['btnSaveSelectedHistory__dup','btnSaveSelectedHistory'],
      ['btnDeleteSelected__dup','btnDeleteSelected']
    ];
    dupMap.forEach(([dup, orig])=>{
      const d = document.getElementById(dup); const o = document.getElementById(orig);
      if (d && o){ d.addEventListener('click', ()=> o.click()); }
    });

    // Historikk – initialiser & knapper
    (function(){
      const dateInput = document.getElementById('historyDate'); if (dateInput) { dateInput.value = window.getTodayCompDate(); }
      const btnRefr = document.getElementById('btnRefreshHistory');
      if (btnRefr){
        btnRefr.addEventListener('click', ()=> {
          window._historyShowAll = false;
          window.updateHistoryView();
        });
      }
      const btnAll = document.getElementById('btnShowAllHistory');
      if (btnAll){
        btnAll.addEventListener('click', ()=> {
          window._historyShowAll = true;
          window.updateHistoryView();
        });
      }
      if (dateInput || btnRefr || btnAll){ window.updateHistoryView(); }
    })();

    // Når straffetid endres → reberegn og persister
    document.getElementById('penaltyTime').addEventListener('change', async function(){
      for (const [snr,p] of Object.entries(window.participants)){
        if (p.rawFinish != null){
          window.updateFinalTime(snr);
          const { error } = await window.supabaseClient.from('participants').update({ finish:p.finish }).eq('snr', snr);
          if (error) console.error('Feil ved oppdatering av finish etter straffe-endring for snr', snr, error);
        }
      }
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    });

    // Markerte deltakere (start/stop/slett)
    document.getElementById('btnDeleteSelected').addEventListener('click', async function(){
      const checkboxes = document.querySelectorAll('.select-participant'); let selected = [];
      checkboxes.forEach(cb => { if (cb.checked) selected.push(parseInt(cb.getAttribute('data-snr'))); });
      if (selected.length === 0){ alert('Ingen deltakere er markert.'); return; }
      const confirmed = await window.customConfirm('Er du sikker på at du vil slette de markerte deltakerne?'); if (!confirmed) return;
      for (let snr of selected){ const { error } = await window.supabaseClient.from('participants').delete().eq('snr', snr); if (error) console.error('Feil ved sletting av snr', snr, error); }
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    });

    document.getElementById('btnToggleSelected').addEventListener('click', async function(){
      const checkboxes = document.querySelectorAll('.select-participant'); let selected = [];
      checkboxes.forEach(cb => { if (cb.checked) selected.push(parseInt(cb.getAttribute('data-snr'))); });
      if (selected.length === 0){ alert('Ingen deltakere er markert.'); return; }
      for (let snr of selected){
        let p = window.participants[snr]; if (!p) continue;
        if (p.status === 'Venter' || p.status === 'Planlagt'){ await window.startIndividual(snr); }
        else if (p.status === 'I gang'){ await window.recordFinish(snr); }
      }
      window.updateTable(); if (window.updateHistoryView) window.updateHistoryView();
    });
  </script>
</body>
</html>
