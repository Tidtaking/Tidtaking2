<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LHK ‚Äì Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f2f2f2; padding: 1rem; text-align: center; }
    .logo { max-width: 150px; margin: 1rem auto; }
    select, input, button {
      font-size: 1rem; padding: 0.5rem; margin: 0.3rem; border-radius: 5px;
    }
    .score, .klokke { font-size: 2rem; margin: 1rem; }
    .section {
      margin-top: 2rem;
      background: #fff;
      padding: 1rem;
      border-radius: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
    }
    th {
      background: #0057b8;
      color: white;
    }
    button.delete {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.delete:hover {
      background: #c0392b;
    }
  </style>
</head>
<body>
  <img src="logo-lhk.jpg" alt="LHK-logo" class="logo" />
  <h1>LHK Admin</h1>

  <div class="section">
    <h3>Opprett ny kamp</h3>
    <input type="text" id="hjemmelag" placeholder="Hjemmelag" />
    <input type="text" id="bortelag" placeholder="Bortelag" />
    <button onclick="opprettKamp()">‚ûï Opprett kamp</button>
  </div>

  <div class="section">
    <h3>Velg aktiv kamp</h3>
    <select id="kampSelect" onchange="velgKamp()"></select>
    <div class="score">LHK: <span id="hjemmescore">0</span> ‚Äì Bortelag: <span id="bortescore">0</span></div>
  </div>

  <div class="section">
    <h3>Registrer m√•l</h3>
    <input type="text" id="spiller" placeholder="Spillernavn (valgfritt)" />
    <button onclick="registrerMaal('hjemme')">+ LHK</button>
    <button onclick="registrerMaal('borte')">+ Bortelag</button>
  </div>

  <div class="section">
    <h3>Kampklokke og omgang</h3>
    <div>üïí Omgang: <span id="omgangVisning">1</span></div>
    <div class="klokke">‚è±Ô∏è <span id="klokkeVisning">--:--</span></div>
    <label>
      Lengde (min): <input type="number" id="omgangLengde" value="20" style="width: 60px" />
    </label>
    <div>
      <button onclick="startPauseKamp()">‚ñ∂Ô∏è Start / Pause</button>
      <button onclick="nyOmgang()">üîÅ Ny omgang</button>
      <button onclick="nullstillTid()">üõë Nullstill tid</button>
    </div>
  </div>

  <div class="section">
    <h3>Utvisninger</h3>
    <div>
      <button onclick="registrerUtvisning('hjemme')">üö® LHK</button>
      <button onclick="registrerUtvisning('borte')">üö® Bortelag</button>
    </div>
    <table>
      <thead>
        <tr><th>Lag</th><th>Start</th><th>Gjenst√•ende</th><th></th></tr>
      </thead>
      <tbody id="utvisningListe"></tbody>
    </table>
  </div>
  <div class="section">
    <h3>M√•llogg</h3>
    <table>
      <thead>
        <tr><th>Tid</th><th>Lag</th><th>Spiller</th><th></th></tr>
      </thead>
      <tbody id="maalListe"></tbody>
    </table>
  </div>

  <script>
    const client = supabase.createClient(
      "https://chzfewhbfkdtcizdxyzk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA"
    );

    let aktivKampId = null;
    let klokkeInterval = null;
    let kampData = null;

    async function opprettKamp() {
      const hjemmelag = document.getElementById("hjemmelag").value.trim();
      const bortelag = document.getElementById("bortelag").value.trim();
      if (!hjemmelag || !bortelag) return alert("Fyll inn begge lag");
      const { data, error } = await client.from("kamp").insert({ hjemmelag, bortelag }).select().single();
      if (error) return alert("Feil: " + error.message);
      aktivKampId = data.id;
      document.getElementById("hjemmelag").value = "";
      document.getElementById("bortelag").value = "";
      await lastKamper();
    }

    async function lastKamper() {
      const { data } = await client.from("kamp").select("*").order("opprettet", { ascending: false });
      const select = document.getElementById("kampSelect");
      select.innerHTML = "";
      (data || []).forEach(k => {
        const option = document.createElement("option");
        option.value = k.id;
        option.text = `${k.hjemmelag} vs ${k.bortelag}`;
        select.appendChild(option);
      });
      if (data.length) {
        aktivKampId = data[0].id;
        select.value = aktivKampId;
        hentKampData();
        hentMaallogg();
        hentUtvisninger();
      }
    }

    async function velgKamp() {
      aktivKampId = document.getElementById("kampSelect").value;
      hentKampData();
      hentMaallogg();
      hentUtvisninger();
    }

    async function hentKampData() {
      const { data } = await client.from("kamp").select("*").eq("id", aktivKampId).single();
      if (!data) return;
      kampData = data;
      document.getElementById("hjemmescore").textContent = data.hjemmescore;
      document.getElementById("bortescore").textContent = data.bortescore;
      document.getElementById("omgangVisning").textContent = data.omgang;
      document.getElementById("omgangLengde").value = data.omgang_lengde / 60;
      visKlokke(data.start_tid, data.omgang_lengde, data.er_paused, data.tid_brukt);
    }

    function visKlokke(startTidStr, omgangLengde, erPaused, tidBrukt) {
      if (klokkeInterval) clearInterval(klokkeInterval);
      const visning = document.getElementById("klokkeVisning");
      function oppdater() {
        const n√• = new Date();
        const startTid = new Date(startTidStr);
        let brukt = tidBrukt;
        if (!erPaused) {
          brukt += Math.floor((n√•.getTime() - startTid.getTime()) / 1000);
        }
        let gjenst√•ende = Math.max(0, omgangLengde - brukt);
        const min = Math.floor(gjenst√•ende / 60).toString().padStart(2, "0");
        const sek = (gjenst√•ende % 60).toString().padStart(2, "0");
        visning.textContent = `${min}:${sek}`;
      }
      oppdater();
      if (!kampData.er_paused) klokkeInterval = setInterval(oppdater, 1000);
    }

    async function startPauseKamp() {
      const { data } = await client.from("kamp").select("*").eq("id", aktivKampId).single();
      if (!data) return;
      const n√• = new Date();
      let nyTidBrukt = data.tid_brukt;
      if (!data.er_paused) {
        nyTidBrukt += Math.floor((n√•.getTime() - new Date(data.start_tid).getTime()) / 1000);
      }
      await client.from("kamp").update({
        er_paused: !data.er_paused,
        tid_brukt: nyTidBrukt,
        start_tid: data.er_paused ? new Date().toISOString() : data.start_tid,
        omgang_lengde: parseInt(document.getElementById("omgangLengde").value) * 60
      }).eq("id", aktivKampId);
      hentKampData();
    }

    async function nullstillTid() {
      await client.from("kamp").update({
        er_paused: true,
        tid_brukt: 0,
        start_tid: new Date().toISOString()
      }).eq("id", aktivKampId);
      hentKampData();
    }

    async function nyOmgang() {
      const { data } = await client.from("kamp").select("*").eq("id", aktivKampId).single();
      const omgang = (data?.omgang || 1) + 1;
      const n√• = new Date().toISOString();
      const lengde = parseInt(document.getElementById("omgangLengde").value) * 60;
      await client.from("kamp").update({
        omgang,
        start_tid: n√•,
        er_paused: false,
        tid_brukt: 0,
        omgang_lengde: lengde
      }).eq("id", aktivKampId);
      hentKampData();
    }

    async function registrerMaal(lag) {
      const spiller = document.getElementById("spiller").value.trim() || "Ukjent";
      await client.from("maal").insert({ kamp_id: aktivKampId, spiller, lag });
      const felt = lag === "hjemme" ? "hjemmescore" : "bortescore";
      const { data } = await client.from("kamp").select(felt).eq("id", aktivKampId).single();
      await client.from("kamp").update({ [felt]: (data[felt] || 0) + 1 }).eq("id", aktivKampId);
      document.getElementById("spiller").value = "";
      hentKampData();
      hentMaallogg();
    }

    async function hentMaallogg() {
      const { data } = await client.from("maal").select("*").eq("kamp_id", aktivKampId).order("tidspunkt");
      const tbody = document.getElementById("maalListe");
      tbody.innerHTML = "";
      (data || []).forEach(m => {
        const tidspunkt = new Date(m.tidspunkt).toLocaleTimeString("no-NO", { hour: "2-digit", minute: "2-digit" });
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${tidspunkt}</td><td>${m.lag === "hjemme" ? "LHK" : "Bortelag"}</td><td>${m.spiller}</td>
          <td><button class="delete" onclick="slettMaal('${m.id}', '${m.lag}')">Slett</button></td>`;
        tbody.appendChild(tr);
      });
    }

    async function slettMaal(id, lag) {
      if (!confirm("Slette m√•l?")) return;
      await client.from("maal").delete().eq("id", id);
      const felt = lag === "hjemme" ? "hjemmescore" : "bortescore";
      const { data } = await client.from("kamp").select(felt).eq("id", aktivKampId).single();
      const nyScore = Math.max(0, (data[felt] || 1) - 1);
      await client.from("kamp").update({ [felt]: nyScore }).eq("id", aktivKampId);
      hentKampData();
      hentMaallogg();
    }

    async function registrerUtvisning(lag) {
      const n√• = new Date().toISOString();
      await client.from("utvisning").insert({
        kamp_id: aktivKampId,
        lag,
        start_tid: n√•
      });
      hentUtvisninger();
    }

    async function hentUtvisninger() {
      const { data } = await client.from("utvisning").select("*").eq("kamp_id", aktivKampId).order("start_tid");
      const tbody = document.getElementById("utvisningListe");
      tbody.innerHTML = "";

      const kampStart = new Date(kampData.start_tid);
      const bruktTotal = kampData.er_paused
        ? kampData.tid_brukt
        : kampData.tid_brukt + Math.floor((Date.now() - kampStart.getTime()) / 1000);

      (data || []).forEach(u => {
        const utvStart = new Date(u.start_tid);
        const sekSidenStart = bruktTotal - Math.floor((utvStart.getTime() - kampStart.getTime()) / 1000);
        const gjenst√•ende = 120 - sekSidenStart;
        if (gjenst√•ende <= 0) return;

        const min = Math.floor(gjenst√•ende / 60).toString().padStart(2, "0");
        const sek = (gjenst√•ende % 60).toString().padStart(2, "0");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.lag === "hjemme" ? "LHK" : "Bortelag"}</td>
          <td>${new Date(u.start_tid).toLocaleTimeString("no-NO", { hour: "2-digit", minute: "2-digit" })}</td>
          <td>${min}:${sek}</td>
          <td><button class="delete" onclick="slettUtvisning('${u.id}')">Slett</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function slettUtvisning(id) {
      if (!confirm("Slette denne utvisningen?")) return;
      await client.from("utvisning").delete().eq("id", id);
      hentUtvisninger();
    }

    setInterval(hentUtvisninger, 1000);
    lastKamper();
  </script>
</body>
</html>
