<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Skuddplassering Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 10px; }
        #goalCanvas { border: 2px solid #444; background: linear-gradient(to top, #ddd, #fff); margin-top: 10px; }
        .player-button, .clear-button { padding: 8px; margin: 4px; cursor: pointer; }
        .selected { background-color: #4caf50; color: white; }
        .edit-input { margin: 2px; width: 100px; }
    </style>
</head>
<body>
    <h2>Registrer Skuddplassering</h2>

    <div id="players"></div>
    <button class="clear-button" onclick="deleteAllShots()">Slett alle skudd</button>
    <canvas id="goalCanvas" width="300" height="200"></canvas>

    <h3>Endre spillere</h3>
    <div id="editPlayers"></div>
    <h3>Legg til ny spiller</h3>
    <div>
        <input id="newDraktnr" class="edit-input" placeholder="Draktnr">
        <input id="newNavn" class="edit-input" placeholder="Navn">
        <button onclick="addNewPlayer()">Legg til</button>
    </div>

    <script>
    window.onload = function () {
        function getColorForPlayer(playerId) {
            if (!playerColors[playerId]) {
                playerColors[playerId] = '#' + Math.floor(Math.random() * 16777215).toString(16);
            }
            return playerColors[playerId];
        }

        function drawShot(x, y, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fill();
        }

        function drawGoal() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#fff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Tegn netting
    ctx.strokeStyle = '#ccc';
    ctx.lineWidth = 0.5;
    const gridSize = 20;
    for (let x = 0; x <= canvas.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    for (let y = 0; y <= canvas.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }

    // Tegn stolper
    const postWidth = 10;
    ctx.fillStyle = '#000';
    for (let i = 0; i < canvas.height / 20; i++) {
        if (i % 2 === 0) {
            ctx.fillRect(0, i * 20, postWidth, 20); // venstre stolpe
            ctx.fillRect(canvas.width - postWidth, i * 20, postWidth, 20); // høyre stolpe
        }
    }

    // Tverrligger
    for (let i = 0; i < canvas.width / 20; i++) {
        if (i % 2 === 0) {
            ctx.fillRect(i * 20, 0, 20, postWidth);
        }
    }

    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, canvas.width, canvas.height);
}

    function loadPlayers() {
            supabaseClient.from('spiller').select('*').then(({ data, error }) => {
                if (error) { alert(error.message); return; }
                const playerDiv = document.getElementById('players');
                const editDiv = document.getElementById('editPlayers');
                playerDiv.innerHTML = '';
                editDiv.innerHTML = '';

                data.forEach(player => {
                    const btn = document.createElement('button');
                    btn.textContent = `${player.draktnummer || '?'} - ${player.navn || 'Ukjent'}`;
                    btn.className = 'player-button';
                    btn.onclick = () => selectPlayer(player, btn);
                    playerDiv.appendChild(btn);

                    const nrInput = document.createElement('input');
                    nrInput.value = player.draktnummer || '';
                    nrInput.className = 'edit-input';
                    nrInput.placeholder = 'Draktnr';

                    const nameInput = document.createElement('input');
                    nameInput.value = player.navn || '';
                    nameInput.className = 'edit-input';
                    nameInput.placeholder = 'Navn';

                    const saveBtn = document.createElement('button');
                    saveBtn.textContent = 'Lagre';
                    saveBtn.onclick = async () => {
                        const { error } = await supabaseClient.from('spiller').update({
                            draktnummer: nrInput.value,
                            navn: nameInput.value
                        }).eq('id', player.id);
                        if (error) alert('Feil ved lagring: ' + error.message);
                        else loadPlayers();
                    };

                    const wrapper = document.createElement('div');
                    wrapper.appendChild(nrInput);
                    wrapper.appendChild(nameInput);
                    wrapper.appendChild(saveBtn);
                    editDiv.appendChild(wrapper);
                });
            });
        }

        window.addNewPlayer = async function () {
            const draktnr = document.getElementById('newDraktnr').value;
            const navn = document.getElementById('newNavn').value;
            if (!draktnr || !navn) {
                alert('Begge felt må fylles ut');
                return;
            }
            const { error } = await supabaseClient.from('spiller').insert([{ draktnummer: draktnr, navn }]);
            if (error) alert('Feil ved lagring: ' + error.message);
            else {
                document.getElementById('newDraktnr').value = '';
                document.getElementById('newNavn').value = '';
                loadPlayers();
            }
        }

        async function loadShots() {
            const { data, error } = await supabaseClient.from('skuddplassering').select('*');
            if (error) { console.error(error); return; }
            drawGoal();
            data.forEach(shot => {
                const color = getColorForPlayer(shot.spiller_id);
                drawShot(shot.x_pos, shot.y_pos, color);
            });
        }

        function selectPlayer(player, btn) {
            document.querySelectorAll('.player-button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedPlayer = player;
        }

        canvas.addEventListener('click', function(event) {
            if (!selectedPlayer) {
                alert('Velg en spiller først!');
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const color = getColorForPlayer(selectedPlayer.id);

            drawShot(x, y, color);

            supabaseClient.from('skuddplassering').insert([{
                spiller_id: selectedPlayer.id,
                x_pos: x,
                y_pos: y,
                timestamp: new Date()
            }]).then(({ error }) => {
                if (error) alert('Feil ved lagring: ' + error.message);
            });
        });

        window.deleteAllShots = async function () {
            if (!confirm("Er du sikker på at du vil slette alle skudd?")) return;
            const { error } = await supabaseClient.from('skuddplassering').delete().neq('id', 0);
            if (error) {
                alert("Feil ved sletting: " + error.message);
            } else {
                drawGoal();
            }
        }

        loadPlayers();
        loadShots();
    };
    </script>
</body>
</html>
