<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Registrering av Skyteresultat - Mobilforbedret (favoritter + offline-robust)</title>
  <style>
    :root{
      --bg:#ffffff;--fg:#111;--muted:#6b7280;--border:#e5e7eb;--primary:#0ea5e9;--primary-fg:#fff;--success:#22c55e;--disabled:#9ca3af;
      --radius:14px; --pad:12px; --tap:48px; --gap:10px; --target:60px;
      --row-hover:#eef2ff; --row-active:#e6efff;
      --sticky-bg:#f8fafc;
      --star:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";margin:0; padding:0; color:var(--fg); background:var(--bg)}

    header{position:sticky; top:0; z-index:30; background:var(--bg); border-bottom:1px solid var(--border)}
    .wrap{max-width:1000px; margin:0 auto; padding:12px clamp(10px, 3vw, 20px);}
    h1{font-size:clamp(20px, 4vw, 28px); margin:4px 0 8px}

    .toolbar{display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap}
    .toolbar input[type="text"]{flex:1 1 220px; min-width:140px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:16px}
    .toolbar .toggle{display:flex; align-items:center; gap:6px; font-size:14px}
    .toolbar .toggle input{accent-color:var(--primary)}
    .toolbar .chip{border:1px solid var(--border); padding:8px 10px; border-radius:999px; font-size:14px; cursor:pointer; user-select:none}
    .toolbar .chip[aria-pressed="true"]{background:var(--primary); color:#fff; border-color:transparent}

    .table-container{overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; border-top:1px solid var(--border); border-bottom:1px solid var(--border); border-radius:12px}
    table{border-collapse:separate; border-spacing:0; width:100%; min-width:1020px}

    thead th{position:sticky; top:0; background:var(--sticky-bg); text-align:center; font-weight:600; font-size:14px; border-bottom:1px solid var(--border); padding:10px; z-index:20}
    tbody td{border-bottom:1px solid var(--border); padding:10px; text-align:center; font-size:16px; background:#fff}
    tbody tr:nth-child(odd) td{background:#fcfcfd}

    tbody tr{transition: background-color .12s ease}
    tbody tr:hover, tbody tr:focus-within{ background-color: var(--row-hover); }
    tbody tr:active{ background-color: var(--row-active); }
    tbody tr.fav td{box-shadow: inset 3px 0 0 0 var(--star)}

    .shootingCell{white-space:nowrap; min-width:calc(var(--target)*5 + 16px)}
    .targets{display:inline-flex; align-items:center; gap:6px}
    .target{width:var(--target); height:var(--target); border-radius:50%; display:inline-grid; place-content:center; user-select:none; cursor:pointer; border:2px solid #000; touch-action:manipulation; transition: transform 0.15s ease, box-shadow 0.15s ease;}
    .target[data-hit="true"]{background:#fff; color:#000; animation:pop 0.2s ease;}
    .target[data-hit="false"]{background:#000; color:#fff;}
    .target:active{transform:scale(0.92)}

    @keyframes pop{0%{transform:scale(1); box-shadow:0 0 0 rgba(0,0,0,0)}50%{transform:scale(1.2); box-shadow:0 0 8px rgba(0,0,0,0.4)}100%{transform:scale(1); box-shadow:0 0 0 rgba(0,0,0,0)}}

    .skive-input{width:70px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:16px; text-align:center}
    .btn{appearance:none; border:0; border-radius:12px; padding:12px 14px; font-size:16px; line-height:1; cursor:pointer; min-height:var(--tap)}
    .btn-primary{background:var(--primary); color:var(--primary-fg)}
    .btn-success{background:var(--success); color:#fff}
    .btn-ghost{background:#f3f4f6}
    .btn[disabled]{background:#e5e7eb; color:#6b7280; cursor:not-allowed}

    .fav-btn{display:inline-grid; place-items:center; min-width:44px; padding:10px 12px; border-radius:999px; border:1px solid var(--border); background:#fff}
    .fav-btn[aria-pressed="true"]{background:#fff3; color:var(--star); border-color:var(--star)}
    .fav-btn .star{font-size:18px; line-height:1}

    @media (max-width: 640px){
      :root{--target:56px}
      thead th{font-size:12px; padding:8px}
      tbody td{font-size:15px; padding:8px}
      .skive-input{width:64px}
      tbody{scroll-snap-type:y proximity}
      tbody tr{scroll-snap-align:start}
    }

    /* Høyre kolonne (Fokus) sticky */
    th.sticky-right, td.sticky-right{position:sticky; right:0; z-index:18; background:var(--sticky-bg)}

    @media (prefers-reduced-motion: reduce){ .target{transition:none} .target:active{transform:none} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Registrering av skyteresultat</h1>
      <div class="toolbar">
        <input id="filter" type="text" placeholder="Søk på navn eller startnr..." aria-label="Filtrer deltakere">
        <label class="toggle"><input id="onlyRunning" type="checkbox"> Kun "I gang"</label>
        <label class="toggle"><input id="onlyFavs" type="checkbox"> Kun favoritter</label>
        <button id="toggleCompact" class="chip" aria-pressed="false" title="Skjul S2 for smalere visning">Kompakt</button>
        <span id="netBadge" style="margin-left:auto;font-size:13px;color:var(--muted)">Kobler til...</span>
        <span id="syncBadge" style="font-size:13px;color:var(--muted);display:none">Synkroniserer...</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="table-container">
      <table id="shootingTable" aria-live="polite">
        <thead>
          <tr>
            <th>&#9733;</th> <!-- stjerne først -->
            <th>Startnr</th>
            <th>Navn</th>
            <th>Status</th>
            <th>Skive</th>
            <th>Skyting S1</th>
            <th>Send S1</th>
            <th>Skytetid S1</th>
            <th class="colS2">Skyting S2</th>
            <th class="colS2">Send S2</th>
            <th class="colS2">Skytetid S2</th>
            <th class="sticky-right">Fokus</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <dialog id="focusSheet">
    <div class="sheet" style="padding:16px">
      <div class="header" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="display:flex; align-items:center; gap:8px">
          <button class="fav-btn" id="fsFavBtn" aria-pressed="false" title="Merk som favoritt"><span class="star" id="fsStar">&#9734;</span></button>
          <div>
            <div class="id" id="fsId" style="font-weight:700"></div>
            <div class="meta" style="display:flex;gap:10px;color:var(--muted);font-size:14px">
              <span id="fsStatus"></span><span>•</span><span>Skive <span id="fsSkive"></span></span>
            </div>
          </div>
        </div>
        <button class="btn" id="fsClose">Lukk</button>
      </div>

      <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <label for="fsSkiveInput" class="sub" style="color:var(--muted);font-size:13px">Skive</label>
        <input id="fsSkiveInput" class="skive-input" inputmode="numeric" pattern="[0-9]*" placeholder="Skive">
        <button class="btn btn-ghost" id="fsCopyLink">Kopier lenke</button>
      </div>

      <h3>S1</h3>
      <div id="fsS1" class="targets"></div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-success" id="fsSendS1" data-snr data-round="0">Send S1</button>
        <button class="btn btn-primary" id="fsTimeS1" data-snr data-round="0">Start skytetid S1</button>
      </div>

      <h3>S2</h3>
      <div id="fsS2" class="targets"></div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-success" id="fsSendS2" data-snr data-round="1">Send S2</button>
        <button class="btn btn-primary" id="fsTimeS2" data-snr data-round="1">Start skytetid S2</button>
      </div>
    </div>
  </dialog>

<script>
// ---------------- Supabase setup ----------------
const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

// ---------------- Local state ----------------
/** @type {Record<string, any>} */
const participants = {};
let lastRenderKey = "";
let compact = false; // hide S2 cols on demand

// Favourites (persist locally per enhet/nettleser)
let favorites = new Set(JSON.parse(localStorage.getItem("favorites")||"[]"));
function saveFavorites(){ localStorage.setItem("favorites", JSON.stringify(Array.from(favorites))); }
function toggleFavorite(snr){
  snr = Number(snr);
  if(favorites.has(snr)) favorites.delete(snr); else favorites.add(snr);
  saveFavorites();
  // Tving render for å reflektere filter og visuell stjerne umiddelbart
  lastRenderKey = ""; render();
  if(focusedSnr===snr) updateFocusFav();
}

// --- Offline/queue state ---
const QUEUE_KEY = "pendingOps_v1";
let pendingOps = [];
try { pendingOps = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]"); } catch (e) { pendingOps = []; }
function saveQueue(){ localStorage.setItem(QUEUE_KEY, JSON.stringify(pendingOps)); }
function queueSize(){ return pendingOps.length; }
function setSyncBadge(){
  var el = document.getElementById("syncBadge");
  if(!el) return;
  var n = queueSize();
  if(n>0){ el.style.display="inline"; el.textContent = "Synkroniserer ("+n+")..."; }
  else { el.style.display="none"; }
}
async function execOp(op){
  if(op.type==="update"){
    var table = op.table, values = op.values, match = op.match;
    var resp = await sb.from(table).update(values).match(match);
    if(resp.error) throw resp.error; return true;
  }
}
var processing=false;
async function processQueue(){
  if(processing) return; processing=true;
  try{
    if(!navigator.onLine) return;
    setSyncBadge();
    var backoff=800;
    while(pendingOps.length){
      try{ await execOp(pendingOps[0]); pendingOps.shift(); saveQueue(); setSyncBadge(); }
      catch(e){ console.warn("Queue op failed, retrying later", e); await new Promise(function(r){ setTimeout(r, backoff); }); backoff = Math.min(backoff*1.8, 8000); if(!navigator.onLine) break; }
    }
  } finally { processing=false; setSyncBadge(); }
}
function enqueueUpdate(table, values, match){
  pendingOps.push({type:"update", table:table, values:values, match:match});
  saveQueue(); setSyncBadge(); processQueue();
}
// Nettverksstatus badge
var netBadge = function(){
  var el = document.getElementById("netBadge");
  if(!el) return;
  if(navigator.onLine){
    el.textContent = "\u25CF Online";
    el.style.color = "#16a34a";
    processQueue();
  } else {
    el.textContent = "\u25CF Offline - lagrer lokalt";
    el.style.color = "#ef4444";
  }
};
window.addEventListener("online", netBadge);
window.addEventListener("offline", netBadge);
setTimeout(netBadge,0);
setTimeout(setSyncBadge,0);

// ---------------- Utils for shooting arrays ----------------
function ensureShootingFormat(arr){
  if(!Array.isArray(arr) || arr.length!==2) return [Array(5).fill(false), Array(5).fill(false)];
  return arr.map(function(r){ return (Array.isArray(r) && r.length===5) ? r : Array(5).fill(false); });
}
function parseShooting(rec){
  var val = rec.shooting; var arr;
  if(typeof val === "string"){ try{ arr = JSON.parse(val); }catch(e){ arr=null; } }
  else if(Array.isArray(val)){ arr = val; }
  if(!arr) arr = [Array(5).fill(false), Array(5).fill(false)];
  return ensureShootingFormat(arr);
}
function mergeDbRecord(dbRec){
  const snr = dbRec.snr;
  if(!participants[snr]){
    participants[snr] = {
      ...dbRec,
      shootingLocal: parseShooting(dbRec),
      s1sent: !!dbRec.s1sent,
      s2sent: !!dbRec.s2sent,
      skive: dbRec.skive || "",
      status: dbRec.status || "",
      shootingTimeStart1: dbRec.shootingTimeStart1 || null,
      shootingTimeStart2: dbRec.shootingTimeStart2 || null,
    };
  } else {
    const p = participants[snr];
    p.status = dbRec.status || p.status;
    p.s1sent = p.s1sent || !!dbRec.s1sent;
    p.s2sent = p.s2sent || !!dbRec.s2sent;
    if(!p.skive) p.skive = dbRec.skive || "";
    if(dbRec.shooting) p.shootingLocal = parseShooting(dbRec);
    if(dbRec.shootingtime1) p.shootingtime1 = dbRec.shootingtime1;
    if(dbRec.shootingtime2) p.shootingtime2 = dbRec.shootingtime2;
  }
}
async function fetchAll(){
  const { data, error } = await sb.from("participants").select("*");
  if(error){ console.error("Feil ved henting:", error); return []; }
  return data;
}

// ---------------- Key used to minimize re-render ----------------
function computeRenderKey(list){
  const onlyFavs = document.getElementById("onlyFavs").checked;
  const onlyRunning = document.getElementById("onlyRunning").checked;
  const q = document.getElementById("filter").value.trim().toLowerCase();
  const base = JSON.stringify(list.map(function(p){
    return {snr:p.snr, s1:p.s1sent, s2:p.s2sent, sk:p.skive, st:p.status, t1:p.shootingtime1, t2:p.shootingtime2, sh:p.shooting};
  }));
  const favs = Array.from(favorites).join(",");
  return base + "|c:" + String(compact) + "|f:" + favs + "|favOnly:" + String(onlyFavs) + "|runOnly:" + String(onlyRunning) + "|q:" + q;
}

// ---------------- Rendering ----------------
function renderShootingSpans(p, shootIdx){
  const arr = (p.shootingLocal && p.shootingLocal[shootIdx]) ? p.shootingLocal[shootIdx] : Array(5).fill(false);
  var html = '<div class="targets" role="group" aria-label="Skyting S' + (shootIdx+1) + '">';
  for(var i=0;i<5;i++){
    var hit = !!arr[i];
    html += '<div class="target" role="button" aria-pressed="' + hit + '" tabindex="0" data-action="toggle" data-snr="' + p.snr + '" data-round="' + shootIdx + '" data-idx="' + i + '" data-hit="' + hit + '"></div>';
  }
  html += "</div>";
  return html;
}

function sortParticipants(list){
  return list.sort(function(a,b){
    // Favoritter først (tving snr til Number)
    var af = favorites.has(Number(a.snr)) ? 1 : 0;
    var bf = favorites.has(Number(b.snr)) ? 1 : 0;
    if(af !== bf) return bf - af;
    if(a.status === "I gang" && b.status !== "I gang") return -1;
    if(a.status !== "I gang" && b.status === "I gang") return 1;
    const aDone = (a.s1sent && a.s2sent) ? 1 : 0;
    const bDone = (b.s1sent && b.s2sent) ? 1 : 0;
    if(aDone !== bDone) return aDone - bDone;
    return (Number(a.snr)||0) - (Number(b.snr)||0);
  });
}

function applyFilters(list){
  const q = document.getElementById("filter").value.trim().toLowerCase();
  const onlyRunning = document.getElementById("onlyRunning").checked;
  const onlyFavs = document.getElementById("onlyFavs").checked;
  return list.filter(function(p){
    const matchQ = !q || (String(p.snr).includes(q) || (p.name||"").toLowerCase().includes(q));
    const matchRun = !onlyRunning || p.status === "I gang";
    const matchFav = !onlyFavs || favorites.has(Number(p.snr));
    return matchQ && matchRun && matchFav;
  });
}

function render(){
  const tbody = document.getElementById("tbody");
  const list = sortParticipants(Object.values(participants));
  const filtered = applyFilters(list);
  const newKey = computeRenderKey(filtered);
  if(newKey === lastRenderKey){ return; }
  lastRenderKey = newKey;

  var rowsHtml = "";
  filtered.forEach(function(pp){
    // sørg for Number-snr for favorittlogikk
    const p = {...pp, snr: Number(pp.snr)};
    const s1 = renderShootingSpans(p,0);
    const s2 = renderShootingSpans(p,1);

    var s1Btn = p.s1sent
      ? '<button class="btn btn-ghost" data-action="undo-send" data-snr="'+p.snr+'" data-round="0">Angre S1</button>'
      : '<button class="btn btn-success" data-action="send" data-snr="'+p.snr+'" data-round="0">Send S1</button>';

    var t1Btn = "";
    if(p.shootingtime1){
      t1Btn = '<button class="btn btn-ghost" data-action="undo-time" data-snr="'+p.snr+'" data-round="0">Angre tid S1</button>';
    } else if(!p.shootingTimeStart1){
      t1Btn = '<button class="btn btn-primary" data-action="time" data-snr="'+p.snr+'" data-round="0">Start skytetid S1</button>';
    } else {
      t1Btn = '<button class="btn btn-primary" data-action="time" data-snr="'+p.snr+'" data-round="0">Registrer tid S1</button>';
    }

    var s2Btn = p.s2sent
      ? '<button class="btn btn-ghost" data-action="undo-send" data-snr="'+p.snr+'" data-round="1">Angre S2</button>'
      : '<button class="btn btn-success" data-action="send" data-snr="'+p.snr+'" data-round="1">Send S2</button>';

    var t2Btn = "";
    if(p.shootingtime2){
      t2Btn = '<button class="btn btn-ghost" data-action="undo-time" data-snr="'+p.snr+'" data-round="1">Angre tid S2</button>';
    } else if(!p.shootingTimeStart2){
      t2Btn = '<button class="btn btn-primary" data-action="time" data-snr="'+p.snr+'" data-round="1">Start skytetid S2</button>';
    } else {
      t2Btn = '<button class="btn btn-primary" data-action="time" data-snr="'+p.snr+'" data-round="1">Registrer tid S2</button>';
    }

    const isFav = favorites.has(Number(p.snr));
    const favBtn = '<button class="fav-btn" title="Favoritt" data-action="fav" data-snr="'+p.snr+'" aria-pressed="'+isFav+'"><span class="star">'+(isFav? "&#9733;":"&#9734;")+'</span></button>';
    const focusBtn = '<button class="btn sticky-right" data-action="focus" data-snr="'+p.snr+'">Åpne</button>';

    rowsHtml += '<tr data-snr="'+p.snr+'" id="snr-'+p.snr+'" class="'+(isFav? "fav": "")+'">'+
      '<td>'+favBtn+'</td>'+                 // ★ først
      '<td>'+(p.snr ?? "")+'</td>'+         // startnr
      '<td style="text-align:left">'+(p.name ?? "")+'</td>'+
      '<td>'+(p.status ?? "")+'</td>'+
      '<td><input class="skive-input" inputmode="numeric" pattern="[0-9]*" placeholder="Skive" value="'+(p.skive ?? "")+'" data-action="skive" data-snr="'+p.snr+'" aria-label="Skive for '+(p.name ?? ("startnr "+p.snr))+'"></td>'+
      '<td class="shootingCell">'+s1+'</td>'+
      '<td>'+s1Btn+'</td>'+
      '<td>'+t1Btn+'</td>'+
      '<td class="shootingCell colS2">'+s2+'</td>'+
      '<td class="colS2">'+s2Btn+'</td>'+
      '<td class="colS2">'+t2Btn+'</td>'+
      '<td class="sticky-right">'+focusBtn+'</td>'+
    '</tr>';
  });
  tbody.innerHTML = rowsHtml;

  document.querySelectorAll(".colS2").forEach(function(el){
    el.style.display = compact ? "none" : "";
  });

  enableUndoButtons(); // no-op (beholder for struktur)
}

// ---------------- Events ----------------
const table = document.getElementById("shootingTable");
table.addEventListener("click", async (e)=>{
  const el = e.target.closest("[data-action]");
  if(!el) return;
  const action = el.dataset.action; const snr = Number(el.dataset.snr); const round = Number(el.dataset.round);
  if(action === "toggle"){
    const idx = Number(el.dataset.idx); const p = participants[snr];
    const arr = p?.shootingLocal || (p.shootingLocal=[Array(5).fill(false),Array(5).fill(false)]);
    arr[round][idx] = !arr[round][idx];
    el.setAttribute("data-hit", String(arr[round][idx]));
    if(navigator.vibrate) navigator.vibrate(10);
  }
  if(action === "send"){ await sendShootingResult(snr, round); }
  if(action === "time"){ await registerShootingTime(snr, round, el); }
  if(action === "focus"){ openFocusSheet(snr); }
  if(action === "fav"){ toggleFavorite(snr); }
  if(action === "undo-send"){ await undoSend(snr, round); }
  if(action === "undo-time"){ await undoTime(snr, round); }
});
table.addEventListener("keydown", (e)=>{
  const el = e.target.closest(".target");
  if(!el) return;
  if(e.key===" "|| e.key==="Enter"){ e.preventDefault(); el.click(); }
});

// Skive debounce
let skiveTimer;
table.addEventListener("input", (e)=>{
  const el = e.target; if(!(el instanceof HTMLInputElement)) return;
  if(el.dataset.action !== "skive") return;
  const snr = Number(el.dataset.snr); const p = participants[snr];
  p.skive = el.value.trim();
  clearTimeout(skiveTimer);
  skiveTimer = setTimeout(()=>{ saveSkive(snr, p.skive); }, 450);
});

async function saveSkive(snr, skive){ enqueueUpdate("participants", { skive: skive }, { snr: snr }); }
async function sendShootingResult(snr, shootIdx){
  const p = participants[snr]; if(!p) return;
  const updateData = { skive: p.skive ?? "", shooting: JSON.stringify(p.shootingLocal) };
  if(shootIdx===0){ updateData.s1sent = true; p.s1sent = true; } else { updateData.s2sent = true; p.s2sent = true; }
  enqueueUpdate("participants", updateData, { snr: snr });
  lastRenderKey = ""; render();
}
async function registerShootingTime(snr, shootIdx, btnEl){
  const p = participants[snr]; if(!p) return;
  if(shootIdx===0){
    if(!p.shootingTimeStart1){ p.shootingTimeStart1 = Date.now(); btnEl.textContent = "Registrer tid S1"; }
    else {
      const secs = (Date.now() - p.shootingTimeStart1) / 1000;
      p.shootingtime1 = secs; enqueueUpdate("participants", { shootingtime1: secs }, { snr: snr }); lastRenderKey = ""; render();
    }
  } else {
    if(!p.shootingTimeStart2){ p.shootingTimeStart2 = Date.now(); btnEl.textContent = "Registrer tid S2"; }
    else {
      const secs = (Date.now() - p.shootingTimeStart2) / 1000;
      p.shootingtime2 = secs; enqueueUpdate("participants", { shootingtime2: secs }, { snr: snr }); lastRenderKey = ""; render();
    }
  }
}
async function undoSend(snr, round){
  const col = round===0? "s1sent":"s2sent";
  const p = participants[snr]; if(!p) return;
  p[col] = false; var o={}; o[col]=false; enqueueUpdate("participants", o, {snr:snr}); lastRenderKey = ""; render();
}
async function undoTime(snr, round){
  const col = round===0? "shootingtime1":"shootingtime2";
  const p = participants[snr]; if(!p) return;
  delete p[col]; var o={}; o[col]=null; enqueueUpdate("participants", o, {snr:snr}); lastRenderKey = ""; render();
}
function enableUndoButtons(){ /* no-op */ }

// ---------------- Focus Sheet ----------------
const focusSheet = document.getElementById("focusSheet");
const fsId = document.getElementById("fsId");
const fsStatus = document.getElementById("fsStatus");
const fsSkive = document.getElementById("fsSkive");
const fsSkiveInput = document.getElementById("fsSkiveInput");
const fsS1 = document.getElementById("fsS1");
const fsS2 = document.getElementById("fsS2");
const fsSendS1 = document.getElementById("fsSendS1");
const fsSendS2 = document.getElementById("fsSendS2");
const fsTimeS1 = document.getElementById("fsTimeS1");
const fsTimeS2 = document.getElementById("fsTimeS2");
const fsClose = document.getElementById("fsClose");
const fsCopyLink = document.getElementById("fsCopyLink");
const fsFavBtn = document.getElementById("fsFavBtn");
const fsStar = document.getElementById("fsStar");
let focusedSnr = null;

function renderTargetsInline(p, shootIdx, container){
  container.innerHTML = "";
  const arr = p.shootingLocal?.[shootIdx] || Array(5).fill(false);
  arr.forEach((hit, i)=>{
    const d = document.createElement("div");
    d.className = "target"; d.setAttribute("role", "button"); d.setAttribute("tabindex", "0");
    d.dataset.action = "toggle-focus"; d.dataset.snr = String(p.snr); d.dataset.round = String(shootIdx); d.dataset.idx = String(i); d.dataset.hit = String(!!hit);
    d.addEventListener("click", ()=>{
      const a = participants[p.snr].shootingLocal[shootIdx]; a[i] = !a[i]; d.dataset.hit = String(a[i]); if(navigator.vibrate) navigator.vibrate(10);
    });
    let t;
    d.addEventListener("pointerdown", ()=>{ t=setTimeout(()=>{ participants[p.snr].shootingLocal[shootIdx] = Array(5).fill(false); renderTargetsInline(participants[p.snr], shootIdx, container); }, 450); });
    d.addEventListener("pointerup", ()=>clearTimeout(t)); d.addEventListener("pointerleave", ()=>clearTimeout(t));
    let last=0; d.addEventListener("click", (e)=>{ const now = Date.now(); if(now-last<300){ participants[p.snr].shootingLocal[shootIdx] = Array(5).fill(true); renderTargetsInline(participants[p.snr], shootIdx, container);} last=now; }, {capture:true});
    container.appendChild(d);
  });
}
function updateFocusFav(){
  const isFav = favorites.has(Number(focusedSnr));
  fsFavBtn.setAttribute("aria-pressed", String(isFav));
  fsStar.innerHTML = isFav ? "&#9733;" : "&#9734;";
}
function openFocusSheet(snr){
  focusedSnr = Number(snr);
  const p = participants[focusedSnr]; if(!p) return;
  fsSendS1.dataset.snr = fsSendS2.dataset.snr = fsTimeS1.dataset.snr = fsTimeS2.dataset.snr = String(focusedSnr);
  fsId.textContent = (p.name ?? "") + " (Startnr " + p.snr + ")";
  fsStatus.textContent = p.status ?? "";
  fsSkive.textContent = p.skive ?? "";
  fsSkiveInput.value = p.skive ?? "";
  renderTargetsInline(p,0,fsS1);
  renderTargetsInline(p,1,fsS2);
  fsSendS1.disabled = false; fsSendS1.textContent = p.s1sent ? "Angre S1" : "Send S1";
  fsSendS2.disabled = false; fsSendS2.textContent = p.s2sent ? "Angre S2" : "Send S2";
  fsTimeS1.textContent = p.shootingtime1 ? "Angre tid S1" : (p.shootingTimeStart1 ? "Registrer tid S1" : "Start skytetid S1");
  fsTimeS1.disabled = false;
  fsTimeS2.textContent = p.shootingtime2 ? "Angre tid S2" : (p.shootingTimeStart2 ? "Registrer tid S2" : "Start skytetid S2");
  fsTimeS2.disabled = false;
  updateFocusFav();
  focusSheet.showModal();
  history.replaceState(null, "", "#snr-" + focusedSnr);
}
fsFavBtn.addEventListener("click", ()=>{ if(focusedSnr!=null){ toggleFavorite(focusedSnr); } });
fsClose.addEventListener("click", ()=>{ focusSheet.close(); });
fsCopyLink.addEventListener("click", async ()=>{
  const url = location.origin + location.pathname + "#snr-" + focusedSnr;
  try{ await navigator.clipboard.writeText(url); alert("Lenke kopiert."); }catch(e){ prompt("Kopier lenken:", url); }
});
fsSkiveInput.addEventListener("input", ()=>{
  if(focusedSnr==null) return; const p = participants[focusedSnr]; p.skive = fsSkiveInput.value.trim(); fsSkive.textContent = p.skive; debounce(function(){ saveSkive(focusedSnr, p.skive); }, 400)();
});
fsSendS1.addEventListener("click", ()=>{ if(focusedSnr==null) return; const p=participants[focusedSnr]; if(p.s1sent) undoSend(focusedSnr,0); else sendShootingResult(focusedSnr,0); });
fsSendS2.addEventListener("click", ()=>{ if(focusedSnr==null) return; const p=participants[focusedSnr]; if(p.s2sent) undoSend(focusedSnr,1); else sendShootingResult(focusedSnr,1); });
fsTimeS1.addEventListener("click", (e)=>{ if(focusedSnr==null) return; const p=participants[focusedSnr]; if(p.shootingtime1) undoTime(focusedSnr,0); else registerShootingTime(focusedSnr,0, e.currentTarget); });
fsTimeS2.addEventListener("click", (e)=>{ if(focusedSnr==null) return; const p=participants[focusedSnr]; if(p.shootingtime2) undoTime(focusedSnr,1); else registerShootingTime(focusedSnr,1, e.currentTarget); });

// ---------------- Live updates ----------------
async function refreshFromDb(){
  const data = await fetchAll();
  const present = {};
  data.forEach(function(rec){ mergeDbRecord(rec); present[rec.snr]=true; });
  Object.keys(participants).forEach(function(snr){ if(!present[snr]) delete participants[snr]; });
  lastRenderKey = ""; render();
}
async function init(){
  await refreshFromDb();
  try{
    sb.channel("participants_changes")
      .on("postgres_changes", { event: "*", schema: "public", table: "participants" }, (payload) => {
        const rec = payload.new || payload.old;
        if(rec){ mergeDbRecord(rec); lastRenderKey = ""; render(); if(focusedSnr && rec.snr===focusedSnr){ openFocusSheet(focusedSnr); } }
      })
      .subscribe();
  }catch(err){
    console.warn("Realtime ikke aktivert, bruker polling.", err);
    setInterval(refreshFromDb, 2000);
  }
  if(window.innerWidth >= 900){ setInterval(refreshFromDb, 4000); }
  netBadge(); setSyncBadge(); processQueue();
}

// ---------------- UI filter listeners (fix for mobil) ----------------
function setupUiFilterListeners(){
  const filterEl = document.getElementById('filter');
  const onlyFavsEl = document.getElementById('onlyFavs');
  const onlyRunningEl = document.getElementById('onlyRunning');
  const toggleCompactEl = document.getElementById('toggleCompact');

  const triggerRender = () => { lastRenderKey = ""; render(); };

  // Live-søk m/ debounce
  filterEl.addEventListener('input', debounce(triggerRender, 120));

  // Filter-checkboxer
  onlyFavsEl.addEventListener('change', triggerRender);
  onlyRunningEl.addEventListener('change', triggerRender);

  // Kompakt visning (skjuler S2-kolonner)
  toggleCompactEl.addEventListener('click', (e) => {
    compact = !compact;
    e.currentTarget.setAttribute('aria-pressed', String(compact));
    triggerRender();
  });
}

// ---------------- Small utils ----------------
function debounce(fn, ms){ let t; return function(){ const args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null, args); }, ms); } }

// Start app
document.addEventListener("DOMContentLoaded", () => {
  init();
  setupUiFilterListeners();
});
</script>
</body>
</html>
