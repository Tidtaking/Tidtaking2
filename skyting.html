<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Registrering av Skyteresultat — Mobilforbedret (med favoritter)</title>
  <style>
    :root{
      --bg:#ffffff;--fg:#111;--muted:#6b7280;--border:#e5e7eb;--primary:#0ea5e9;--primary-fg:#fff;--success:#22c55e;--disabled:#9ca3af;
      --radius:14px; --pad:12px; --tap:48px; --gap:10px; --target:60px;
      --row-hover:#eef2ff; --row-active:#e6efff;
      --sticky-bg:#f8fafc;
      --star:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";margin:0; padding:0; color:var(--fg); background:var(--bg)}

    header{position:sticky; top:0; z-index:30; background:var(--bg); border-bottom:1px solid var(--border)}
    .wrap{max-width:1000px; margin:0 auto; padding:12px clamp(10px, 3vw, 20px);}    
    h1{font-size:clamp(20px, 4vw, 28px); margin:4px 0 8px}

    .toolbar{display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap}
    .toolbar input[type="text"]{flex:1 1 220px; min-width:140px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:16px}
    .toolbar .toggle{display:flex; align-items:center; gap:6px; font-size:14px}
    .toolbar .toggle input{accent-color:var(--primary)}
    .toolbar .chip{border:1px solid var(--border); padding:8px 10px; border-radius:999px; font-size:14px; cursor:pointer; user-select:none}
    .toolbar .chip[aria-pressed="true"]{background:var(--primary); color:#fff; border-color:transparent}

    .table-container{overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; border-top:1px solid var(--border); border-bottom:1px solid var(--border); border-radius:12px}
    table{border-collapse:separate; border-spacing:0; width:100%; min-width:1020px}

    thead th{position:sticky; top:0; background:var(--sticky-bg); text-align:center; font-weight:600; font-size:14px; border-bottom:1px solid var(--border); padding:10px; z-index:20}
    tbody td{border-bottom:1px solid var(--border); padding:10px; text-align:center; font-size:16px; background:#fff}
    tbody tr:nth-child(odd) td{background:#fcfcfd}

    tbody tr{transition: background-color .12s ease}
    tbody tr:hover, tbody tr:focus-within{ background-color: var(--row-hover); }
    tbody tr:active{ background-color: var(--row-active); }
    tbody tr.fav td{box-shadow: inset 3px 0 0 0 var(--star)}

    .shootingCell{white-space:nowrap; min-width:calc(var(--target)*5 + 16px)}
    .targets{display:inline-flex; align-items:center; gap:6px}
    .target{width:var(--target); height:var(--target); border-radius:50%; display:inline-grid; place-content:center; user-select:none; cursor:pointer; border:2px solid #000; touch-action:manipulation; transition: transform 0.15s ease, box-shadow 0.15s ease;}
    .target[data-hit="true"]{background:#fff; color:#000; animation:pop 0.2s ease;}
    .target[data-hit="false"]{background:#000; color:#fff;}
    .target:active{transform:scale(0.92)}

    @keyframes pop{0%{transform:scale(1); box-shadow:0 0 0 rgba(0,0,0,0)}50%{transform:scale(1.2); box-shadow:0 0 8px rgba(0,0,0,0.4)}100%{transform:scale(1); box-shadow:0 0 0 rgba(0,0,0,0)}}

    .skive-input{width:70px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; font-size:16px; text-align:center}
    .btn{appearance:none; border:0; border-radius:12px; padding:12px 14px; font-size:16px; line-height:1; cursor:pointer; min-height:var(--tap)}
    .btn-primary{background:var(--primary); color:var(--primary-fg)}
    .btn-success{background:var(--success); color:#fff}
    .btn-ghost{background:#f3f4f6}
    .btn[disabled]{background:#e5e7eb; color:#6b7280; cursor:not-allowed}

    .fav-btn{display:inline-grid; place-items:center; min-width:44px; padding:10px 12px; border-radius:999px; border:1px solid var(--border); background:#fff}
    .fav-btn[aria-pressed="true"]{background:#fff3; color:var(--star); border-color:var(--star)}
    .fav-btn .star{font-size:18px; line-height:1}

    @media (max-width: 640px){
      :root{--target:56px}
      thead th{font-size:12px; padding:8px}
      tbody td{font-size:15px; padding:8px}
      .skive-input{width:64px}
      tbody{scroll-snap-type:y proximity}
      tbody tr{scroll-snap-align:start}
    }

    /* Kun høyre kolonne (Fokus) sticky */
    th.sticky-right, td.sticky-right{position:sticky; right:0; z-index:18; background:var(--sticky-bg)}

    @media (prefers-reduced-motion: reduce){ .target{transition:none} .target:active{transform:none} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Registrering av skyteresultat</h1>
      <div class="toolbar">
        <input id="filter" type="text" placeholder="Søk på navn eller startnr…" aria-label="Filtrer deltakere">
        <label class="toggle"><input id="onlyRunning" type="checkbox"> Kun "I gang"</label>
        <label class="toggle"><input id="onlyFavs" type="checkbox"> Kun favoritter</label>
        <button id="toggleCompact" class="chip" aria-pressed="false" title="Skjul S2 for smalere visning">Kompakt</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="table-container">
      <table id="shootingTable" aria-live="polite">
        <thead>
          <tr>
            <th>Startnr</th>
            <th>Navn</th>
            <th>Status</th>
            <th>Skive</th>
            <th>Skyting S1</th>
            <th>Send S1</th>
            <th>Skytetid S1</th>
            <th class="colS2">Skyting S2</th>
            <th class="colS2">Send S2</th>
            <th class="colS2">Skytetid S2</th>
            <th>★</th>
            <th class="sticky-right">Fokus</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </main>

  <!-- Focus sheet for single-participant full-screen controls -->
  <dialog id="focusSheet">
    <div class="sheet" style="padding:16px">
      <div class="header" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div style="display:flex; align-items:center; gap:8px">
          <button class="fav-btn" id="fsFavBtn" aria-pressed="false" title="Merk som favoritt"><span class="star" id="fsStar">☆</span></button>
          <div>
            <div class="id" id="fsId" style="font-weight:700"></div>
            <div class="meta" style="display:flex;gap:10px;color:var(--muted);font-size:14px">
              <span id="fsStatus"></span><span>•</span><span>Skive <span id="fsSkive"></span></span>
            </div>
          </div>
        </div>
        <button class="btn" id="fsClose">Lukk</button>
      </div>

      <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <label for="fsSkiveInput" class="sub" style="color:var(--muted);font-size:13px">Skive</label>
        <input id="fsSkiveInput" class="skive-input" inputmode="numeric" pattern="[0-9]*" placeholder="Skive">
        <button class="btn btn-ghost" id="fsCopyLink">Kopier lenke</button>
      </div>

      <h3>S1</h3>
      <div id="fsS1" class="targets"></div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-success" id="fsSendS1" data-snr data-round="0">Send S1</button>
        <button class="btn btn-primary" id="fsTimeS1" data-snr data-round="0">Start skytetid S1</button>
      </div>

      <h3>S2</h3>
      <div id="fsS2" class="targets"></div>
      <div class="actions" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button class="btn btn-success" id="fsSendS2" data-snr data-round="1">Send S2</button>
        <button class="btn btn-primary" id="fsTimeS2" data-snr data-round="1">Start skytetid S2</button>
      </div>
    </div>
  </dialog>

<script>
// ---------------- Supabase setup ----------------
const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

// ---------------- Local state ----------------
/** @type {Record<string, any>} */
const participants = {};
let lastRenderKey = "";
let compact = false; // hide S2 cols on demand

// Favourites (persist locally per enhet/nettleser)
let favorites = new Set(JSON.parse(localStorage.getItem('favorites')||'[]'));
function saveFavorites(){ localStorage.setItem('favorites', JSON.stringify([...favorites])); }
function toggleFavorite(snr){ snr = Number(snr); if(favorites.has(snr)) favorites.delete(snr); else favorites.add(snr); saveFavorites(); render(); if(focusedSnr===snr) updateFocusFav(); }

function ensureShootingFormat(arr){
  if(!Array.isArray(arr) || arr.length!==2) return [Array(5).fill(false), Array(5).fill(false)];
  return arr.map(r => (Array.isArray(r) && r.length===5) ? r : Array(5).fill(false));
}

function parseShooting(rec){
  let val = rec.shooting; let arr;
  if(typeof val === 'string'){ try{ arr = JSON.parse(val); }catch{ arr=null; } }
  else if(Array.isArray(val)){ arr = val; }
  if(!arr) arr = [Array(5).fill(false), Array(5).fill(false)];
  return ensureShootingFormat(arr);
}

function mergeDbRecord(dbRec){
  const snr = dbRec.snr;
  if(!participants[snr]){
    participants[snr] = {
      ...dbRec,
      shootingLocal: parseShooting(dbRec),
      s1sent: !!dbRec.s1sent,
      s2sent: !!dbRec.s2sent,
      skive: dbRec.skive || "",
      status: dbRec.status || "",
      shootingTimeStart1: dbRec.shootingTimeStart1 || null,
      shootingTimeStart2: dbRec.shootingTimeStart2 || null,
    };
  } else {
    const p = participants[snr];
    p.status = dbRec.status || p.status;
    p.s1sent = p.s1sent || !!dbRec.s1sent;
    p.s2sent = p.s2sent || !!dbRec.s2sent;
    if(!p.skive) p.skive = dbRec.skive || "";
    if(dbRec.shooting) p.shootingLocal = parseShooting(dbRec);
    if(dbRec.shootingtime1) p.shootingtime1 = dbRec.shootingtime1;
    if(dbRec.shootingtime2) p.shootingtime2 = dbRec.shootingtime2;
  }
}

async function fetchAll(){
  const { data, error } = await sb.from('participants').select('*');
  if(error){ console.error('Feil ved henting:', error); return []; }
  return data;
}

function computeRenderKey(list){
  const onlyFavs = document.getElementById('onlyFavs').checked;
  return JSON.stringify(list.map(p=>({snr:p.snr, s1:p.s1sent, s2:p.s2sent, sk:p.skive, st:p.status, t1:p.shootingtime1, t2:p.shootingtime2, sh:p.shooting}))) + `|c:${compact}|f:${[...favorites].join(',')}|favOnly:${onlyFavs}`;
}

async function refreshFromDb(){
  const data = await fetchAll();
  const present = {};
  data.forEach(rec=>{ mergeDbRecord(rec); present[rec.snr]=true; });
  Object.keys(participants).forEach(snr=>{ if(!present[snr]) delete participants[snr]; });
  render();
}

// ---------------- Rendering ----------------
function renderShootingSpans(p, shootIdx){
  const arr = p.shootingLocal?.[shootIdx] || Array(5).fill(false);
  return `<div class="targets" role="group" aria-label="Skyting S${shootIdx+1}">`+
    arr.map((hit, i)=>`<div class="target" role="button" aria-pressed="${hit}" tabindex="0" data-action="toggle" data-snr="${p.snr}" data-round="${shootIdx}" data-idx="${i}" data-hit="${hit}"></div>`).join('')+
  `</div>`;
}

function sortParticipants(list){
  return list.sort((a,b)=>{
    // Favoritter først
    const af = favorites.has(a.snr) ? 1 : 0; const bf = favorites.has(b.snr) ? 1 : 0;
    if(af !== bf) return bf - af;
    if(a.status === 'I gang' && b.status !== 'I gang') return -1;
    if(a.status !== 'I gang' && b.status === 'I gang') return 1;
    const aDone = (a.s1sent && a.s2sent) ? 1 : 0;
    const bDone = (b.s1sent && b.s2sent) ? 1 : 0;
    if(aDone !== bDone) return aDone - bDone;
    return (a.snr||0) - (b.snr||0);
  });
}

function applyFilters(list){
  const q = document.getElementById('filter').value.trim().toLowerCase();
  const onlyRunning = document.getElementById('onlyRunning').checked;
  const onlyFavs = document.getElementById('onlyFavs').checked;
  return list.filter(p=>{
    const matchQ = !q || (String(p.snr).includes(q) || (p.name||'').toLowerCase().includes(q));
    const matchRun = !onlyRunning || p.status === 'I gang';
    const matchFav = !onlyFavs || favorites.has(p.snr);
    return matchQ && matchRun && matchFav;
  });
}

function render(){
  const tbody = document.getElementById('tbody');
  const list = sortParticipants(Object.values(participants));
  const filtered = applyFilters(list);
  const newKey = computeRenderKey(filtered);
  if(newKey === lastRenderKey){ return; }
  lastRenderKey = newKey;

  tbody.innerHTML = filtered.map(p=>{
    const s1 = renderShootingSpans(p,0);
    const s2 = renderShootingSpans(p,1);
    const s1Btn = p.s1sent ? `<button class="btn btn-ghost" disabled data-snr="${p.snr}" data-round="0">Sendt</button>` : `<button class="btn btn-success" data-action="send" data-snr="${p.snr}" data-round="0">Send S1</button>`;
    const s2Btn = p.s2sent ? `<button class="btn btn-ghost" disabled data-snr="${p.snr}" data-round="1">Sendt</button>` : `<button class="btn btn-success" data-action="send" data-snr="${p.snr}" data-round="1">Send S2</button>`;

    let t1Btn = '';
    if(p.shootingtime1){ t1Btn = `<button class=\"btn btn-ghost\" disabled data-snr=\"${p.snr}\" data-round=\"0\">Tid registrert</button>`; }
    else if(!p.shootingTimeStart1){ t1Btn = `<button class=\"btn btn-primary\" data-action=\"time\" data-snr=\"${p.snr}\" data-round=\"0\">Start skytetid S1</button>`; }
    else { t1Btn = `<button class=\"btn btn-primary\" data-action=\"time\" data-snr=\"${p.snr}\" data-round=\"0\">Registrer tid S1</button>`; }

    let t2Btn = '';
    if(p.shootingtime2){ t2Btn = `<button class=\"btn btn-ghost\" disabled data-snr=\"${p.snr}\" data-round=\"1\">Tid registrert</button>`; }
    else if(!p.shootingTimeStart2){ t2Btn = `<button class=\"btn btn-primary\" data-action=\"time\" data-snr=\"${p.snr}\" data-round=\"1\">Start skytetid S2</button>`; }
    else { t2Btn = `<button class=\"btn btn-primary\" data-action=\"time\" data-snr=\"${p.snr}\" data-round=\"1\">Registrer tid S2</button>`; }

    const focusBtn = `<button class="btn sticky-right" data-action="focus" data-snr="${p.snr}">Åpne</button>`;
    const isFav = favorites.has(p.snr);
    const favBtn = `<button class="fav-btn" title="Favoritt" data-action="fav" data-snr="${p.snr}" aria-pressed="${isFav}"><span class="star">${isFav? '★':'☆'}</span></button>`;

    return `<tr data-snr="${p.snr}" id="snr-${p.snr}" class="${isFav? 'fav':''}">
      <td>${p.snr ?? ''}</td>
      <td style="text-align:left">${p.name ?? ''}</td>
      <td>${p.status ?? ''}</td>
      <td>
        <input class="skive-input" inputmode="numeric" pattern="[0-9]*" placeholder="Skive" value="${p.skive ?? ''}" data-action="skive" data-snr="${p.snr}" aria-label="Skive for ${p.name ?? ('startnr '+p.snr)}">
      </td>
      <td class="shootingCell">${s1}</td>
      <td>${s1Btn}</td>
      <td>${t1Btn}</td>
      <td class="shootingCell colS2">${s2}</td>
      <td class="colS2">${s2Btn}</td>
      <td class="colS2">${t2Btn}</td>
      <td>${favBtn}</td>
      <td class="sticky-right">${focusBtn}</td>
    </tr>`;
  }).join('');

  // Toggle visibility of S2 columns in compact mode
  document.querySelectorAll('.colS2').forEach(el=>{
    el.style.display = compact ? 'none' : '';
  });

  // Etter at DOM er tegnet: aktiver long-press for å angre
  enableUndoButtons();
}

// ---------------- Event delegation (mobile-friendly) ----------------
const table = document.getElementById('shootingTable');

table.addEventListener('click', async (e)=>{
  const el = e.target.closest('[data-action]');
  if(!el) return;
  const action = el.dataset.action; const snr = +el.dataset.snr; const round = +el.dataset.round;
  if(action === 'toggle'){
    const idx = +el.dataset.idx; const p = participants[snr];
    const arr = p?.shootingLocal || (p.shootingLocal=[Array(5).fill(false),Array(5).fill(false)]);
    arr[round][idx] = !arr[round][idx];
    el.setAttribute('data-hit', String(arr[round][idx]));
    if(navigator.vibrate) navigator.vibrate(10);
  }
  if(action === 'send'){
    await sendShootingResult(snr, round);
  }
  if(action === 'time'){
    await registerShootingTime(snr, round, el);
  }
  if(action === 'focus'){
    openFocusSheet(snr);
  }
  if(action === 'fav'){
    toggleFavorite(snr);
  }
});

// Keyboard support for targets
 table.addEventListener('keydown', (e)=>{
  const el = e.target.closest('.target');
  if(!el) return;
  if(e.key===' '|| e.key==='Enter'){
    e.preventDefault();
    el.click();
  }
});

// Update skive on change (debounced)
let skiveTimer;
table.addEventListener('input', (e)=>{
  const el = e.target; if(!(el instanceof HTMLInputElement)) return;
  if(el.dataset.action !== 'skive') return;
  const snr = +el.dataset.snr; const p = participants[snr];
  p.skive = el.value.trim();
  clearTimeout(skiveTimer);
  skiveTimer = setTimeout(()=>{ saveSkive(snr, p.skive); }, 450);
});

async function saveSkive(snr, skive){
  const { error } = await sb.from('participants').update({ skive }).eq('snr', snr);
  if(error){ console.error('Feil ved lagring av skive', snr, error); }
}

async function sendShootingResult(snr, shootIdx){
  const p = participants[snr]; if(!p) return;
  const updateData = { skive: p.skive ?? '', shooting: JSON.stringify(p.shootingLocal) };
  if(shootIdx===0){ updateData.s1sent = true; p.s1sent = true; } else { updateData.s2sent = true; p.s2sent = true; }
  const { error } = await sb.from('participants').update(updateData).eq('snr', snr);
  if(error){ console.error('Feil ved sending av skyteresultat', snr, error); }
  await refreshFromDb();
}

async function registerShootingTime(snr, shootIdx, btnEl){
  const p = participants[snr]; if(!p) return;
  if(shootIdx===0){
    if(!p.shootingTimeStart1){ p.shootingTimeStart1 = Date.now(); btnEl.textContent = 'Registrer tid S1'; }
    else {
      const secs = (Date.now() - p.shootingTimeStart1) / 1000;
      const { error } = await sb.from('participants').update({ shootingtime1: secs }).eq('snr', snr);
      if(error){ console.error('Feil lagring shootingtime1', snr, error); alert('Feil ved lagring av tid – sjekk konsollen.'); }
      else { p.shootingtime1 = secs; btnEl.textContent='Tid registrert'; btnEl.disabled=true; btnEl.classList.remove('btn-primary'); btnEl.classList.add('btn-ghost'); enableUndoButtons(); }
    }
  } else {
    if(!p.shootingTimeStart2){ p.shootingTimeStart2 = Date.now(); btnEl.textContent = 'Registrer tid S2'; }
    else {
      const secs = (Date.now() - p.shootingTimeStart2) / 1000;
      const { error } = await sb.from('participants').update({ shootingtime2: secs }).eq('snr', snr);
      if(error){ console.error('Feil lagring shootingtime2', snr, error); alert('Feil ved lagring av tid – sjekk konsollen.'); }
      else { p.shootingtime2 = secs; btnEl.textContent='Tid registrert'; btnEl.disabled=true; btnEl.classList.remove('btn-primary'); btnEl.classList.add('btn-ghost'); enableUndoButtons(); }
    }
  }
}

// ---------------- Filters & compact toggle ----------------
['filter','onlyRunning','onlyFavs'].forEach(id=> document.getElementById(id).addEventListener('input', ()=> render()));
document.getElementById('toggleCompact').addEventListener('click', (e)=>{
  compact = !compact;
  e.currentTarget.setAttribute('aria-pressed', String(compact));
  render();
});

// ---------------- Long press (angre) helpers ----------------
let longPressTimer;
function addLongPress(el, callback){
  el.addEventListener('pointerdown', ()=>{ longPressTimer = setTimeout(()=>{ callback(); }, 800); });
  ['pointerup','pointerleave','pointercancel'].forEach(ev=> el.addEventListener(ev, ()=> clearTimeout(longPressTimer)));
}

async function undoSend(snr, round){
  if(!confirm('Angre registrert skyting?')) return;
  const col = round==0? 's1sent':'s2sent';
  const {error} = await sb.from('participants').update({[col]:false}).eq('snr', snr);
  if(error) console.error('Feil ved angre send', error); else refreshFromDb();
}

async function undoTime(snr, round){
  if(!confirm('Angre registrert skytetid?')) return;
  const col = round==0? 'shootingtime1':'shootingtime2';
  const {error} = await sb.from('participants').update({[col]:null}).eq('snr', snr);
  if(error) console.error('Feil ved angre tid', error); else refreshFromDb();
}

function enableUndoButtons(){
  // deaktiverte knapper i tabellen
  document.querySelectorAll('table button[disabled]').forEach(btn=>{
    const snr = btn.dataset.snr; const round = btn.dataset.round;
    if(!snr || round===undefined) return;
    if(btn.textContent.includes('Sendt')) addLongPress(btn, ()=> undoSend(snr, round));
    if(btn.textContent.includes('Tid registrert')) addLongPress(btn, ()=> undoTime(snr, round));
  });
  // deaktiverte knapper i fokus-skjema
  [fsSendS1, fsSendS2, fsTimeS1, fsTimeS2].forEach(btn=>{
    if(!btn.disabled) return;
    const snr = btn.dataset.snr; const round = btn.dataset.round;
    if(btn.textContent.includes('Sendt')) addLongPress(btn, ()=> undoSend(snr, round));
    if(btn.textContent.includes('Tid registrert')) addLongPress(btn, ()=> undoTime(snr, round));
  });
}

// ---------------- Focus Sheet logic ----------------
const focusSheet = document.getElementById('focusSheet');
const fsId = document.getElementById('fsId');
const fsStatus = document.getElementById('fsStatus');
const fsSkive = document.getElementById('fsSkive');
const fsSkiveInput = document.getElementById('fsSkiveInput');
const fsS1 = document.getElementById('fsS1');
const fsS2 = document.getElementById('fsS2');
const fsSendS1 = document.getElementById('fsSendS1');
const fsSendS2 = document.getElementById('fsSendS2');
const fsTimeS1 = document.getElementById('fsTimeS1');
const fsTimeS2 = document.getElementById('fsTimeS2');
const fsClose = document.getElementById('fsClose');
const fsCopyLink = document.getElementById('fsCopyLink');
const fsFavBtn = document.getElementById('fsFavBtn');
const fsStar = document.getElementById('fsStar');
let focusedSnr = null;

function renderTargetsInline(p, shootIdx, container){
  container.innerHTML = '';
  const arr = p.shootingLocal?.[shootIdx] || Array(5).fill(false);
  arr.forEach((hit, i)=>{
    const d = document.createElement('div');
    d.className = 'target'; d.setAttribute('role', 'button'); d.setAttribute('tabindex', '0');
    d.dataset.action = 'toggle-focus'; d.dataset.snr = p.snr; d.dataset.round = shootIdx; d.dataset.idx = i; d.dataset.hit = hit;
    d.addEventListener('click', ()=>{ const arr = participants[p.snr].shootingLocal[shootIdx]; arr[i] = !arr[i]; d.dataset.hit = String(arr[i]); if(navigator.vibrate) navigator.vibrate(10); });
    // Long press to clear round
    let t; d.addEventListener('pointerdown', ()=>{ t=setTimeout(()=>{ participants[p.snr].shootingLocal[shootIdx] = Array(5).fill(false); renderTargetsInline(participants[p.snr], shootIdx, container); }, 450); });
    d.addEventListener('pointerup', ()=>clearTimeout(t)); d.addEventListener('pointerleave', ()=>clearTimeout(t));
    // Double click to set all true
    let last=0; d.addEventListener('click', (e)=>{ const now = Date.now(); if(now-last<300){ participants[p.snr].shootingLocal[shootIdx] = Array(5).fill(true); renderTargetsInline(participants[p.snr], shootIdx, container);} last=now; }, {capture:true});
    container.appendChild(d);
  });
}

function updateFocusFav(){
  const isFav = favorites.has(focusedSnr);
  fsFavBtn.setAttribute('aria-pressed', String(isFav));
  fsStar.textContent = isFav ? '★' : '☆';
}

function openFocusSheet(snr){
  focusedSnr = snr;
  const p = participants[snr]; if(!p) return;
  fsSendS1.dataset.snr = fsSendS2.dataset.snr = fsTimeS1.dataset.snr = fsTimeS2.dataset.snr = String(snr);
  fsId.textContent = `${p.name ?? ''} (Startnr ${p.snr})`;
  fsStatus.textContent = p.status ?? '';
  fsSkive.textContent = p.skive ?? '';
  fsSkiveInput.value = p.skive ?? '';
  renderTargetsInline(p,0,fsS1);
  renderTargetsInline(p,1,fsS2);

  fsSendS1.disabled = !!p.s1sent; fsSendS1.textContent = p.s1sent ? 'Sendt' : 'Send S1';
  fsSendS2.disabled = !!p.s2sent; fsSendS2.textContent = p.s2sent ? 'Sendt' : 'Send S2';
  fsTimeS1.textContent = p.shootingtime1 ? 'Tid registrert' : (p.shootingTimeStart1 ? 'Registrer tid S1' : 'Start skytetid S1');
  fsTimeS1.disabled = !!p.shootingtime1;
  fsTimeS2.textContent = p.shootingtime2 ? 'Tid registrert' : (p.shootingTimeStart2 ? 'Registrer tid S2' : 'Start skytetid S2');
  fsTimeS2.disabled = !!p.shootingtime2;

  updateFocusFav();

  focusSheet.showModal();
  // enable long-press on disabled buttons inside sheet
  enableUndoButtons();
  // update URL hash for quick link
  history.replaceState(null, '', `#snr-${snr}`);
}

fsFavBtn.addEventListener('click', ()=>{ if(focusedSnr!=null){ toggleFavorite(focusedSnr); } });

fsClose.addEventListener('click', ()=>{ focusSheet.close(); });
fsCopyLink.addEventListener('click', async ()=>{
  const url = location.origin + location.pathname + `#snr-${focusedSnr}`;
  try{ await navigator.clipboard.writeText(url); alert('Lenke kopiert.'); }catch{ prompt('Kopier lenken:', url); }
});

fsSkiveInput.addEventListener('input', ()=>{
  if(focusedSnr==null) return; const p = participants[focusedSnr]; p.skive = fsSkiveInput.value.trim(); fsSkive.textContent = p.skive; debounce(()=>saveSkive(focusedSnr, p.skive), 400)();
});

fsSendS1.addEventListener('click', ()=> sendShootingResult(focusedSnr, 0));
fsSendS2.addEventListener('click', ()=> sendShootingResult(focusedSnr, 1));
fsTimeS1.addEventListener('click', (e)=> registerShootingTime(focusedSnr, 0, e.currentTarget));
fsTimeS2.addEventListener('click', (e)=> registerShootingTime(focusedSnr, 1, e.currentTarget));

// Jump to focused row if hash present
window.addEventListener('load', ()=>{
  const id = location.hash.replace('#','');
  if(id){ const row = document.getElementById(id); if(row){ row.scrollIntoView({behavior:'smooth', block:'start'}); const snr = +id.replace('snr-',''); if(snr) openFocusSheet(snr); } }
});

// ---------------- Live updates ----------------
async function init(){
  await refreshFromDb();
  try{
    sb.channel('participants_changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, (payload) => {
        const rec = payload.new || payload.old; if(rec){ mergeDbRecord(rec); render(); if(focusedSnr && rec.snr===focusedSnr){ openFocusSheet(focusedSnr); } }
      })
      .subscribe();
  }catch(err){ console.warn('Realtime ikke aktivert, bruker polling.', err); setInterval(refreshFromDb, 2000); }
  if(window.innerWidth >= 900){ setInterval(refreshFromDb, 4000); }
}

document.addEventListener('DOMContentLoaded', init);

// ---------------- Small utils ----------------
function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); } }
</script>
</body>
</html>
