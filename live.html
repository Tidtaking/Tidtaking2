<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konkurransestatus – LSK Ski</title>
  <meta name="theme-color" content="#1E57B7">
  <style>
    :root{
      --lsk-blue:   #1E57B7;
      --lsk-red:    #D01616;
      --lsk-yellow: #E3EB2C;
      --lsk-white:  #ffffff;
      --ink:        #0f172a;
      --muted:      #64748b;
      --table-border:#e2e8f0;
      --row-alt:    #f8fafc;
      --success:    #16a34a;
      --warning:    #ea580c;
      --neutral:    #475569;
      --shoot-bg:   #3a3a3a;
    }

    * { box-sizing: border-box; }
    html,body{ margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--ink); }

    /* Header: rød/blå bånd, hvitt midtbånd (logo kun i hvitt felt) */
    header{
      background:
        linear-gradient(180deg, var(--lsk-red) 0 48px, transparent 48px),
        linear-gradient(0deg, var(--lsk-blue) 0 48px, transparent 48px);
      background-position: top, bottom;
      background-repeat: no-repeat;
    }
    .band{
      background: var(--lsk-white);
      border-top: 6px solid var(--lsk-yellow);
      border-bottom: 6px solid var(--lsk-yellow);
    }
    .bar{
      max-width: 1100px; margin: 0 auto; padding: 12px 16px;
      display:flex; align-items:center; gap:16px;
    }
    .logo{ width:72px; height:72px; object-fit: contain; background:transparent; }
    .titles h1{ margin:0; font-size: clamp(20px, 3.5vw, 28px); font-weight: 800; letter-spacing:.2px; }
    .titles p{ margin:2px 0 0 0; font-size:14px; color:#111827; font-weight:600; }

    #liveClock{
      font-weight:700; letter-spacing:.5px;
      padding:6px 10px; border-radius:10px; background: var(--lsk-blue); color: var(--lsk-white);
      box-shadow: 0 2px 4px rgba(0,0,0,.06);
    }

    main{ max-width:1100px; margin: 16px auto 40px; padding: 0 12px; }

    /* Kontrolllinje */
    .controls{
      display:flex; flex-wrap:wrap; align-items:center; gap:10px;
      background:#fff; border:1px solid var(--table-border); border-radius:12px; padding:10px 12px;
      box-shadow: 0 2px 10px rgba(2,8,23,.05);
      margin-bottom:10px;
    }
    .controls label{ font-size:12px; color:var(--muted); margin-right:4px; }
    .controls select{
      padding:6px 8px; border:1px solid var(--table-border); border-radius:10px; background:#fff; font-size:14px;
    }
    .controls button{
      padding:6px 10px; border:1px solid var(--table-border); border-radius:10px; background:#f8fafc; cursor:pointer;
    }
    .counters{
      margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-size:13px;
    }
    .badge{
      padding:4px 8px; border-radius:999px; background:#eef2ff; border:1px solid var(--table-border);
    }
    .badge.green{ background:#ecfdf5; border-color:#d1fae5; }
    .badge.orange{ background:#fff7ed; border-color:#ffedd5; }

    .legend{ font-size:12px; color: var(--muted); margin: 10px 2px; }

    /* Kort rundt tabellen – ingen horisontal scroll */
    .table-card{
      background: var(--lsk-white);
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(2,8,23,.06);
      border: 1px solid var(--table-border);
      overflow: hidden;
    }

    /* Tabell – automatisk bredde */
    table{ border-collapse: collapse; width: 100%; }
    thead th{
      position: sticky; top:0; z-index:2;
      background: linear-gradient(180deg, #ffffff, #f3f6fb);
      border-bottom: 1px solid var(--table-border);
      color:#0b1220; font-weight:800; font-size:13px; text-transform: uppercase; letter-spacing:.5px;
      padding:10px 8px; text-align:center;
      white-space: nowrap;
    }
    tbody td{
      border-top: 1px solid var(--table-border);
      padding:10px 8px; text-align:center; font-size:14px;
    }
    tbody tr:nth-child(odd){ background: var(--row-alt); }
    tbody tr:hover{ background:#eef2ff; }
    td:nth-child(3){ text-align:left; } /* Navn */

    /* Status chips */
    .chip{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:white; }
    .chip.running{ background: var(--warning); }
    .chip.done{ background: var(--success); }
    .chip.wait{ background: var(--neutral); }

    /* Skyte-kolonner: robust oppsett med indre flex-wrapper */
    th.shooting,
    td.shooting{
      background: var(--shoot-bg);
      color:#fff;
      white-space: nowrap;
    }
    td.shooting{ padding-top:8px; padding-bottom:8px; }
    .targets{
      display: inline-flex;           /* funker i td på alle browsere */
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 4px;
      flex-wrap: nowrap;              /* aldri linjeskift */
      vertical-align: middle;
    }
    .target{
      display: inline-block;
      width: clamp(20px, 5vw, 40px);
      height: clamp(20px, 5vw, 40px);
      line-height: clamp(20px, 5vw, 40px);  /* vertikal sentrering */
      font-size: clamp(14px, 4vw, 28px);
      border-radius: 50%;
      background: transparent;
      text-align: center;
      vertical-align: middle;
    }

    /* Markér fullført */
    tr.done-row td:first-child{ border-left:6px solid var(--success); }

    @media (max-width: 700px){
      thead th, tbody td{ font-size:12px; padding:8px 6px; }
      .titles h1{ font-size: 22px; }
      .controls{ gap:8px; }
      th.shooting{ font-size:11px; padding:6px 4px; }
      .target{
        width: clamp(18px, 5vw, 36px);
        height: clamp(18px, 5vw, 36px);
        line-height: clamp(18px, 5vw, 36px);
        font-size: clamp(12px, 3.2vw, 24px);
      }
    }
    @media (max-width: 480px){
      thead th, tbody td{ font-size:11px; }
      th.shooting{ font-size:10px; }
      .target{
        width: clamp(16px, 5.2vw, 30px);
        height: clamp(16px, 5.2vw, 30px);
        line-height: clamp(16px, 5.2vw, 30px);
        font-size: clamp(11px, 3vw, 20px);
      }
    }

    .empty, .error, .loading{ padding:22px; text-align:center; color: var(--muted); }
  </style>

  <!-- Supabase SDK v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase ===
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // === Hjelpere ===
    const $ = (sel) => document.querySelector(sel);

    function formatTime(sec){
      if (sec == null || isNaN(sec)) return "-";
      const sign = sec < 0 ? "-" : "";
      sec = Math.abs(sec);
      const m = Math.floor(sec / 60);
      const s = (sec % 60).toFixed(1).padStart(4, "0");
      return m > 0 ? `${sign}${m}m ${s}s` : `${sign}${s}s`;
    }
    function getShootingArray(p){
      if (Array.isArray(p.shooting)) return p.shooting;
      try { return JSON.parse(p.shooting); }
      catch { return [Array(5).fill(false), Array(5).fill(false)]; }
    }
    function chip(status){
      if (status === "I gang") return `<span class="chip running">I gang</span>`;
      if (status === "Fullført") return `<span class="chip done">Fullført</span>`;
      return `<span class="chip wait">${status ?? "Venter"}</span>`;
    }

    // Wrap blinkene i en .targets-container (robust i tabellceller)
    function renderTargets(arr){
      const dots = (arr||[]).map(hit =>
        `<span class="target" style="color:${hit ? 'white' : 'black'};">&#9679;</span>`
      ).join(""); // ingen mellomrom => ingen ekstra tekstnoder
      return `<div class="targets">${dots}</div>`;
    }

    function updateLiveClock(){
      const el = $("#liveClock");
      if (el) el.textContent = new Date().toLocaleTimeString();
    }
    setInterval(updateLiveClock, 1000);

    // === Henting + rangering ===
    async function fetchParticipants(){
      const { data, error } = await supabaseClient
        .from("participants")
        .select("snr,name,class,status,start,finish,laps,shooting");
      if (error) throw error;
      return data || [];
    }

    function buildRankMap(rows){
      const byClass = {};
      rows.forEach(p=>{
        if (p.finish != null){
          (byClass[p.class] ||= []).push({ snr: p.snr, finish: p.finish });
        }
      });
      const rank = {};
      Object.keys(byClass).forEach(cls=>{
        byClass[cls].sort((a,b)=>a.finish-b.finish).forEach((r,i)=>{ rank[r.snr]=i+1; });
      });
      return rank;
    }

    function sortRows(rows, rankMap){
      return rows.slice().sort((a,b)=>{
        if (a.status === "I gang" && b.status !== "I gang") return -1;
        if (a.status !== "I gang" && b.status === "I gang") return 1;
        if (a.status === "Fullført" && b.status !== "Fullført") return 1;
        if (a.status !== "Fullført" && b.status === "Fullført") return -1;
        if (a.status === "Fullført" && b.status === "Fullført"){
          return (rankMap[a.snr]||9999) - (rankMap[b.snr]||9999);
        }
        return a.snr - b.snr;
      });
    }

    // ====== Filtre & tellere ======
    const filters = { class: "", status: "" };

    function populateClassFilter(rows){
      const sel = $("#classFilter");
      if (!sel) return;
      const classes = Array.from(new Set(rows.map(r=>r.class).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'no'));
      const current = sel.value;
      sel.innerHTML = `<option value="">Alle klasser</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join("");
      sel.value = current && classes.includes(current) ? current : "";
      filters.class = sel.value;
    }

    function applyFilters(rows){
      return rows.filter(r=>{
        const okClass = !filters.class || r.class === filters.class;
        const okStatus = !filters.status || r.status === filters.status;
        return okClass && okStatus;
      });
    }

    function updateCounters(rows){
      const total = rows.length;
      const running = rows.filter(r=>r.status==="I gang").length;
      const done = rows.filter(r=>r.status==="Fullført").length;
      $("#countTotal").textContent = total;
      $("#countRunning").textContent = running;
      $("#countDone").textContent = done;
    }

    // ====== Rendering ======
    function renderTable(allRows){
      updateCounters(allRows);
      populateClassFilter(allRows);

      // For "Måltid": sluttid + diff mot beste totalt
      const finishedAll = allRows.filter(p => p.finish != null);
      const overallBestFinish = finishedAll.length
        ? Math.min(...finishedAll.map(p => p.finish))
        : null;

      const rankMap = buildRankMap(allRows);
      const filtered = applyFilters(allRows);
      const sorted = sortRows(filtered, rankMap);

      if (!sorted.length){
        $("#statusTable").innerHTML = `<div class="empty">Ingen deltakere for gjeldende filter.</div>`;
        return;
      }

      let html = `
      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>Plass</th>
              <th>Startnr</th>
              <th>Navn</th>
              <th>Klasse</th>
              <th>Status</th>
              <th>Tid</th>
              <th>Rundetid</th>
              <th class="shooting">S1</th>
              <th class="shooting">S2</th>
              <th>Måltid</th>
            </tr>
          </thead>
          <tbody>`;

      for (const p of sorted){
        const rank = (p.status === "Fullført" && rankMap[p.snr]) ? rankMap[p.snr] : "-";

        let tidDisplay = "-";
        if (p.status === "I gang" && p.start){
          const elapsedSec = (Date.now() - Date.parse(p.start)) / 1000;
          tidDisplay = formatTime(elapsedSec);
        } else if (p.finish != null){
          tidDisplay = formatTime(p.finish);
        }

        // laps kan være array eller JSON-string
        let lapsArr = [];
        try {
          if (Array.isArray(p.laps)) lapsArr = p.laps;
          else if (typeof p.laps === "string") {
            const parsed = JSON.parse(p.laps);
            lapsArr = Array.isArray(parsed) ? (parsed.flat?.() || parsed) : [];
          }
        } catch(_) {}
        const lapsDisplay = lapsArr.length ? lapsArr.map(l=>formatTime(l)).join("<br>") : "-";

        const shooting = getShootingArray(p);
        const s1 = renderTargets(shooting[0]);
        const s2 = renderTargets(shooting[1]);

        const maltid = (p.finish != null)
          ? (overallBestFinish != null
              ? `${formatTime(p.finish)} (+${(p.finish - overallBestFinish).toFixed(1)}s)`
              : formatTime(p.finish))
          : "-";
        const doneRow = p.status === "Fullført" ? "done-row" : "";

        html += `
          <tr class="${doneRow}">
            <td>${rank}</td>
            <td>${p.snr}</td>
            <td>${p.name ?? ""}</td>
            <td>${p.class ?? ""}</td>
            <td>${chip(p.status)}</td>
            <td>${tidDisplay}</td>
            <td>${lapsDisplay}</td>
            <td class="shooting">${s1}</td>
            <td class="shooting">${s2}</td>
            <td>${maltid}</td>
          </tr>`;
      }

      html += `</tbody></table></div>`;
      $("#statusTable").innerHTML = html;
    }

    // === Realtime + fallback polling ===
    let pollTimer;
    let cacheRows = [];

    async function refresh(){
      try{
        $("#statusTable").innerHTML ||= `<div class="loading">Laster...</div>`;
        const data = await fetchParticipants();
        cacheRows = data;
        renderTable(cacheRows);
      }catch(err){
        console.error(err);
        $("#statusTable").innerHTML = `<div class="error">Kunne ikke hente data: ${err.message}</div>`;
      }
    }

    function startRealtime(){
      try{
        supabaseClient
          .channel('public:participants')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, () => refresh())
          .subscribe();
      }catch(e){
        console.warn("Realtime ikke tilgjengelig, bruker polling:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateLiveClock();
      refresh();
      startRealtime();
      pollTimer = setInterval(refresh, 10000);

      // Koble filtre
      $("#classFilter").addEventListener("change", (e)=>{ filters.class = e.target.value; renderTable(cacheRows); });
      $("#statusFilter").addEventListener("change", (e)=>{ filters.status = e.target.value; renderTable(cacheRows); });
      $("#clearFilters").addEventListener("click", ()=>{
        filters.class = ""; filters.status = "";
        $("#classFilter").value = ""; $("#statusFilter").value = "";
        renderTable(cacheRows);
      });
    });
  </script>
</head>
<body>
  <header>
    <div class="band">
      <div class="bar">
        <img class="logo" src="./Logo LSK Klubb farger JPG.jpeg" alt="LSK-logo" />
        <div class="titles">
          <h1>Konkurransestatus – Ski</h1>
          <p>Lørenskog Skiklubb • 1919</p>
        </div>
        <div style="flex:1"></div>
        <div id="liveClock">--:--:--</div>
      </div>
    </div>
  </header>

  <main>
    <div class="controls">
      <div style="display:flex; align-items:center; gap:6px;">
        <label for="classFilter">Klasse</label>
        <select id="classFilter">
          <option value="">Alle klasser</option>
        </select>
      </div>
      <div style="display:flex; align-items:center; gap:6px;">
        <label for="statusFilter">Status</label>
        <select id="statusFilter">
          <option value="">Alle</option>
          <option value="I gang">I gang</option>
          <option value="Venter">Venter</option>
          <option value="Fullført">Fullført</option>
        </select>
      </div>
      <button id="clearFilters" title="Nullstill filtre">Nullstill</button>

      <div class="counters">
        <span class="badge">Totalt: <strong id="countTotal">0</strong></span>
        <span class="badge orange">I gang: <strong id="countRunning">0</strong></span>
        <span class="badge green">Fullført: <strong id="countDone">0</strong></span>
      </div>
    </div>

    <div class="legend">
      <strong>Forklaring blink:</strong> hvit ● = treff, svart ● = bom.
    </div>

    <div id="statusTable" class="loading">Laster...</div>
  </main>
</body>
</html>
