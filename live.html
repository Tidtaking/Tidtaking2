<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konkurransestatus – LSK Ski</title>
  <meta name="theme-color" content="#1E57B7">
  <style>
    :root{
      /* LSK-palett (justert litt for kontrast) */
      --lsk-blue:   #1E57B7;
      --lsk-red:    #D01616;
      --lsk-yellow: #E3EB2C;
      --lsk-white:  #ffffff;
      --ink:        #0f172a;
      --muted:      #64748b;
      --table-border:#e2e8f0;
      --row-alt:    #f8fafc;
      --success:    #16a34a;
      --warning:    #ea580c;
      --neutral:    #475569;
      --shoot-bg:   #3a3a3a;
    }

    * { box-sizing: border-box; }
    html,body{ margin:0; padding:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--ink); }

    /* Header med logo og LSK-striper */
    header{
      border-bottom: 6px solid var(--lsk-yellow);
      background:
        linear-gradient(180deg, var(--lsk-red) 0 33%, var(--lsk-white) 33% 66%, var(--lsk-blue) 66% 100%);
    }
    .bar{
      max-width: 1100px; margin: 0 auto; padding: 16px 16px 22px 16px;
      display:flex; align-items:center; gap:16px;
    }
    .logo{ width:72px; height:72px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,.15)); background:transparent; }
    .titles{ color:#0b1220; text-shadow: 0 1px 0 rgba(255,255,255,.35); }
    .titles h1{ margin:0; font-size: clamp(20px, 3.5vw, 28px); font-weight: 800; letter-spacing:.2px; }
    .titles p{ margin:2px 0 0 0; font-size:14px; color:#111827; font-weight:600; }

    main{ max-width:1100px; margin: 18px auto; padding: 0 12px 40px; }

    /* Info-row */
    .info{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    #liveClock{
      font-weight:700; letter-spacing:.5px;
      padding:6px 10px; border-radius:10px; background: var(--lsk-blue); color: var(--lsk-white);
      box-shadow: 0 2px 4px rgba(0,0,0,.06);
    }
    .legend{ font-size:12px; color: var(--muted); }

    /* Table wrapper with shadow and sticky header */
    .table-wrap{
      background: var(--lsk-white);
      border:1px solid var(--table-border);
      border-radius:14px;
      overflow:hidden;
      box-shadow: 0 6px 20px rgba(2,8,23,.06);
    }
    table{
      border-collapse: collapse; width:100%;
    }
    thead th{
      position: sticky; top:0; z-index:2;
      background: linear-gradient(180deg, #ffffff, #f3f6fb);
      border-bottom: 1px solid var(--table-border);
      color:#0b1220; font-weight:800; font-size:13px; text-transform: uppercase; letter-spacing:.5px;
      padding:10px 8px; text-align:center;
    }
    tbody td{
      border-top: 1px solid var(--table-border);
      padding:10px 8px; text-align:center; font-size:14px;
    }
    tbody tr:nth-child(odd){ background: var(--row-alt); }
    tbody tr:hover{ background:#eef2ff; }

    /* Status chips */
    .chip{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; color:white;
    }
    .chip.running{ background: var(--warning); }
    .chip.done{ background: var(--success); }
    .chip.wait{ background: var(--neutral); }

    /* Skytedeler */
    th.shooting, td.shooting{ background: var(--shoot-bg); color: #fff; }
    td.shooting{ white-space: nowrap; }
    .target{
      display:inline-block; width:56px; height:56px; line-height:56px;
      margin:2px; border-radius:50%;
      background: transparent; /* beholder mørk cellebakgrunn */
      font-size:40px; vertical-align:middle;
    }

    /* “Fullført”-rad får grønn venstrekant */
    tr.done-row td:first-child{ border-left:6px solid var(--success); }

    /* Liten skjerm */
    @media (max-width: 700px){
      thead th, tbody td{ font-size:12px; padding:8px 6px; }
      .target{ width:40px; height:40px; line-height:40px; font-size:28px; }
      .titles h1{ font-size: 22px; }
    }

    /* Loader & tom-tilstand */
    .empty, .error, .loading{
      padding:22px; text-align:center; color: var(--muted);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase ===
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // === Hjelpere ===
    const $ = (sel) => document.querySelector(sel);

    function formatTime(sec){
      if (sec == null || isNaN(sec)) return "-";
      const sign = sec < 0 ? "-" : "";
      sec = Math.abs(sec);
      const m = Math.floor(sec / 60);
      const s = (sec % 60).toFixed(1).padStart(4, "0");
      return m > 0 ? `${sign}${m}m ${s}s` : `${sign}${s}s`;
    }
    function getShootingArray(p){
      if (Array.isArray(p.shooting)) return p.shooting;
      try { return JSON.parse(p.shooting); }
      catch { return [Array(5).fill(false), Array(5).fill(false)]; }
    }

    function chip(status){
      if (status === "I gang") return `<span class="chip running">I gang</span>`;
      if (status === "Fullført") return `<span class="chip done">Fullført</span>`;
      return `<span class="chip wait">${status ?? "Venter"}</span>`;
    }

    function renderTargets(arr){
      // Hvit ● = treff, sort ● = bom (på mørk bakgrunn)
      return arr.map(hit => `<span class="target" style="color:${hit ? 'white' : 'black'};">&#9679;</span>`).join("");
    }

    function updateLiveClock(){
      const el = $("#liveClock");
      if (el) el.textContent = new Date().toLocaleTimeString();
    }
    setInterval(updateLiveClock, 1000);

    // === Henting + rangering ===
    async function fetchParticipants(){
      const { data, error } = await supabaseClient
        .from("participants")
        .select("snr,name,class,status,start,finish,laps,shooting");

      if (error) throw error;
      return data || [];
    }

    function buildRankMap(rows){
      const byClass = {};
      rows.forEach(p=>{
        if (p.finish != null){
          (byClass[p.class] ||= []).push({ snr: p.snr, finish: p.finish });
        }
      });
      const rank = {};
      Object.keys(byClass).forEach(cls=>{
        byClass[cls].sort((a,b)=>a.finish-b.finish).forEach((r,i)=>{ rank[r.snr]=i+1; });
      });
      return rank;
    }

    function sortRows(rows, rankMap){
      return rows.slice().sort((a,b)=>{
        // I gang først
        if (a.status === "I gang" && b.status !== "I gang") return -1;
        if (a.status !== "I gang" && b.status === "I gang") return 1;
        // Fullført sist (men internt på rank)
        if (a.status === "Fullført" && b.status !== "Fullført") return 1;
        if (a.status !== "Fullført" && b.status === "Fullført") return -1;
        if (a.status === "Fullført" && b.status === "Fullført"){
          return (rankMap[a.snr]||9999) - (rankMap[b.snr]||9999);
        }
        // Ellers stigende startnummer
        return a.snr - b.snr;
      });
    }

    function renderTable(rows){
      if (!rows.length){
        $("#statusTable").innerHTML = `<div class="empty">Ingen deltakere funnet i databasen.</div>`;
        return;
      }

      const rankMap = buildRankMap(rows);
      const sorted = sortRows(rows, rankMap);

      let html = `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Plass</th>
              <th>Startnr</th>
              <th>Navn</th>
              <th>Klasse</th>
              <th>Status</th>
              <th>Tid</th>
              <th>Rundetid</th>
              <th class="shooting">S1</th>
              <th class="shooting">S2</th>
              <th>Måltid</th>
            </tr>
          </thead>
          <tbody>`;

      for (const p of sorted){
        const rank = (p.status === "Fullført" && rankMap[p.snr]) ? rankMap[p.snr] : "-";
        let tidDisplay = "-";
        if (p.status === "I gang" && p.start){
          const elapsedSec = (Date.now() - Date.parse(p.start)) / 1000;
          tidDisplay = formatTime(elapsedSec);
        } else if (p.finish != null){
          tidDisplay = formatTime(p.finish);
        }
        const laps = Array.isArray(p.laps) ? p.laps : (p.laps ? JSON.parse(p.laps).flat?.() || [] : []);
        const lapsDisplay = laps.length ? laps.map(l=>formatTime(l)).join("<br>") : "-";

        const shooting = getShootingArray(p);
        const s1 = renderTargets(shooting[0] || []);
        const s2 = renderTargets(shooting[1] || []);

        const måltid = (p.finish != null) ? formatTime(p.finish) : "-";

        const doneRow = p.status === "Fullført" ? "done-row" : "";

        html += `
          <tr class="${doneRow}">
            <td>${rank}</td>
            <td>${p.snr}</td>
            <td style="text-align:left">${p.name ?? ""}</td>
            <td>${p.class ?? ""}</td>
            <td>${chip(p.status)}</td>
            <td>${tidDisplay}</td>
            <td>${lapsDisplay}</td>
            <td class="shooting">${s1}</td>
            <td class="shooting">${s2}</td>
            <td>${måltid}</td>
          </tr>`;
      }

      html += `</tbody></table></div>`;
      $("#statusTable").innerHTML = html;
    }

    // === Realtime + fallback polling ===
    let pollTimer;

    async function refresh(){
      try{
        $("#statusTable").innerHTML ||= `<div class="loading">Laster...</div>`;
        const data = await fetchParticipants();
        renderTable(data);
      }catch(err){
        console.error(err);
        $("#statusTable").innerHTML = `<div class="error">Kunne ikke hente data: ${err.message}</div>`;
      }
    }

    function startRealtime(){
      try{
        const channel = supabaseClient
          .channel('public:participants')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'participants' }, payload => {
            // Når noe endres, hent alt på nytt (enkelt og robust for denne visningen)
            refresh();
          })
          .subscribe((status) => {
            // no-op; status: SUBSCRIBED, CHANNEL_ERROR, etc.
          });
      }catch(e){
        console.warn("Realtime ikke tilgjengelig, bruker polling:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateLiveClock();
      refresh();
      startRealtime();
      // Fallback: jevnlig polling (roligere enn 1s)
      pollTimer = setInterval(refresh, 10000);
    });
  </script>
</head>
<body>
  <header>
    <div class="bar">
      <img class="logo" src="./Logo LSK Klubb farger JPG.jpeg" alt="LSK-logo" />
      <div class="titles">
        <h1>Konkurransestatus – Ski</h1>
        <p>Lørenskog Skiklubb • 1919</p>
      </div>
      <div style="flex:1"></div>
      <div id="liveClock">--:--:--</div>
    </div>
  </header>

  <main>
    <div class="info">
      <div class="legend">
        <strong>Forklaring blink:</strong> hvit ● = treff, svart ● = bom.
      </div>
    </div>

    <div id="statusTable" class="loading">Laster...</div>
  </main>
</body>
</html>
