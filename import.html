<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Import CSV Deltakere</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f9f9f9; }
    h1 { font-size: 32px; margin-bottom: 20px; color: #333; }
    .instructions { background: #e9e9e9; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto; font-size: 18px; }
    label { font-size: 18px; margin-top: 10px; display: block; }
    input, button { font-size: 18px; padding: 8px; margin: 10px; max-width: 300px; }
    @media (max-width: 480px) {
      h1 { font-size: 28px; }
      .instructions { font-size: 16px; }
      input, button { font-size: 16px; }
    }
  </style>
</head>
<body>
  <h1>Import CSV Deltakere</h1>
  <div class="instructions">
    <p><strong>CSV-format:</strong></p>
    <p>Filen skal ha header: <strong>name;class</strong> (med semikolon)</p>
    <p><strong>Eksempel:</strong><br>
        Ola Nordmann;G10<br>
        Kari Hansen;G14<br>
        Per Olsen;G10</p>
    <p>Koden vil finne høyeste 'snr' i databasen og tildele nye, unike 'snr' fortløpende, sortert etter klasse.</p>
  </div>
  
  <label for="competitionInput">Konkurranse:</</label>
  <input type="text" id="competitionInput" placeholder="F.eks. Klubbløp-2025">
  <br>
  <label for="dateInput">Dato:</label>
  <input type="date" id="dateInput">
  <br>
  <input type="file" id="csvImport" accept=".csv">
  <br>
  <button id="btnImportCSV">Importer CSV</button>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Konfigurer Supabase
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    console.log("Supabase-klient opprettet:", supabaseClient);

    /**
     * Henter det høyeste 'snr' (startnummeret) som er i bruk i HELE databasen.
     * Returnerer 0 hvis tabellen er tom eller en feil oppstår.
     */
    async function fetchHighestSnr() {
      const { data, error } = await supabaseClient
        .from("participants")
        .select("snr")
        .order("snr", { ascending: false }) // Sorter synkende
        .limit(1); // Bare hent den øverste (høyeste)

      if (error) {
        console.error("Feil ved henting av høyeste snr:", error);
        return 0;
      }
      
      if (data && data.length > 0) {
        const highestSnr = parseInt(data[0].snr, 10);
        return isNaN(highestSnr) ? 0 : highestSnr;
      }
      
      return 0; // Tabellen er tom
    }

    /**
     * Leser CSV-filen, tildeler globalt unike startnumre sortert etter klasse,
     * og importerer data til Supabase.
     */
    async function parseCSVAndImport(file) {
      const competitionVal = document.getElementById("competitionInput").value.trim();
      const dateVal = document.getElementById("dateInput").value.trim();
      if (!competitionVal || !dateVal) {
        alert("Fyll ut konkurranse og dato før import!");
        return;
      }

      // 1. HENT HØYESTE EKSISTERENDE SNR
      const highestExistingSnr = await fetchHighestSnr();
      let nextSnr = highestExistingSnr + 1; // Start tildeling fra neste nummer
      console.log(`Høyeste snr i DB: ${highestExistingSnr}. Starter tildeling fra: ${nextSnr}`);

      const reader = new FileReader();
      reader.onload = async function(e) {
        const text = e.target.result;
        const lines = text.split("\n").map(line => line.trim()).filter(line => line.length > 0);
        if (lines.length < 2) {
          alert("CSV-filen mangler data eller har ikke riktig header.");
          return;
        }
        
        const headers = lines[0].split(";").map(h => h.trim().replace(/"/g, "").toLowerCase());
        let rows = [];
        
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(";").map(val => val.trim().replace(/"/g, ""));
          let row = {};
          headers.forEach((header, index) => {
            if (["name", "class"].includes(header)) {
              row[header] = values[index];
            }
          });
          if (row.name && row.class) {
            rows.push(row);
          }
        }
        
        if (rows.length === 0) {
          alert("Ingen gyldige deltakere funnet i CSV-filen.");
          return;
        }

        // --- NY LOGIKK FOR UNIKT OG GRUPPERT SNR ---

        // 2. Sorter radene etter klasse.
        rows.sort((a, b) => a.class.localeCompare(b.class));

        let newParticipants = [];

        // 3. Gå gjennom de sorterte radene og tildel UNIKE, fortløpende numre
        for (const row of rows) {
          const { name, class: cls } = row;

          // 4. Hent det neste globale startnummeret
          const snrToAssign = nextSnr;

          // 5. Øk telleren for NESTE deltaker
          nextSnr++;

          // 6. Bygg det nye deltakerobjektet
          newParticipants.push({
            snr: snrToAssign, // Her settes det unike, fortløpende nummeret
            name,
            class: cls,
            competition: competitionVal,
            comp_date: dateVal,
            status: "Venter",
            start: null,
            laps: [],
            finish: null,
            rawFinish: null,
            shooting: JSON.stringify([Array(5).fill(false), Array(5).fill(false)])
          });
        }
        // --- SLUTT PÅ NY LOGIKK ---

        console.log("Nye deltakere som skal importeres (unikt/gruppert snr):", newParticipants);

        // 7. Sett dem inn i DB
        const { error } = await supabaseClient.from("participants").insert(newParticipants);
        if (error) {
          console.error("Feil ved CSV-import:", error);
          alert("CSV-import feilet – sjekk konsollen for detaljer. (Sannsynligvis 409-feil)");
        } else {
          alert(`CSV-import fullført! ${newParticipants.length} deltakere ble lagt til.`);
        }
      };
      reader.readAsText(file);
    }
    
    document.getElementById("btnImportCSV").addEventListener("click", function() {
      const fileInput = document.getElementById("csvImport");
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Velg en CSV-fil å importere.");
        return;
      }
      parseCSVAndImport(fileInput.files[0]);
    });
  </script>
</body>
</html>
