<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lørenskog Skiklubb – Import</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://chzfewhbfkdtcizdxyzk.supabase.co" crossorigin>
  <link rel="dns-prefetch" href="https://chzfewhbfkdtcizdxyzk.supabase.co">

  <script src="https://cdn.tailwindcss.com@3.4.10"></script>

  <style>
    :root{
      --brand:#18469a;    /* Lørenskog blå */
      --brand2:#dbe723;   /* Lørenskog gul */
    }

    body{ background:#f5f7fb; color:#0f172a; }

    /* HEADER */
    .site-header{
      background:#18469a !important; 
      color:#ffffff !important;
    }
    .site-header .logo-img{
      height:48px; max-width:80px; width:auto;
      object-fit:contain; background:#ffffff;
      border-radius:8px; padding:4px;
    }
    .site-header .title{ line-height:1.1; }
    .site-header .subtitle{ opacity:.9; }

    /* Kort */
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:1rem;
      padding:1rem;
      box-shadow:0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    }
    @media (min-width:768px){
      .card{ padding:1.25rem; }
    }

    .subtle{ color:#475569 }
    .soft{ background:#f8fafc; border: 1px solid #e2e8f0; } /* Lagt til border */

    /* Inputs/selects */
    input[type="text"],
    input[type="number"],
    input[type="time"],
    input[type="date"],
    input[type="file"],
    select {
      width: 100%; /* Gjør input-felt responsive */
      background:#ffffff;
      border:1px solid #e2e8f0;
      border-radius:0.75rem;
      padding:0.5rem 0.75rem;
      font-size:0.95rem;
      line-height:1.4;
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.02);
      transition: box-shadow .15s, border-color .15s;
    }
    input:focus, select:focus {
      outline:2px solid transparent;
      border-color:#93c5fd;
      box-shadow: 0 0 0 3px rgba(24,70,154,.18);
    }
    /* Stil for fil-input */
    input[type="file"] { 
        padding: 0; 
        font-size: 14px;
    }
    input[type="file"]::file-selector-button {
        font-weight: 600;
        color: var(--brand);
        padding: 0.5rem 0.75rem;
        border: none;
        border-right: 1px solid #e2e8f0;
        background-color: #f8fafc;
        cursor: pointer;
        margin-right: 10px;
    }

    /* Knapper */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 12px; border-radius:9999px; font-size:14px; font-weight:600;
      border:1px solid #e2e8f0; cursor:pointer; transition: background .15s, transform .04s, box-shadow .15s;
      background:#fff;
    }
    .btn:hover{ background:#f1f5f9; }
    .btn:active{ transform:translateY(1px); }
    .btn-primary{ color:var(--brand); border-color:#cbd5e1; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="site-header shadow-md sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex items-center justify-between gap-4 px-4 py-3">
      <div class="flex items-center gap-3">
        <img
          src="lsk_logo.jpg"
          alt="Lørenskog Skiklubb"
          width="80" height="48"
          class="logo-img">
        <div>
          <h1 class="title text-xl font-bold">Lørenskog Skiklubb</h1>
          <p class="subtitle text-sm">Import av deltakere</p>
        </div>
      </div>
      </div>
  </header>

  <main class="flex-1 max-w-6xl mx-auto w-full p-4">

    <section class="card max-w-2xl mx-auto">
      
      <h3 class="font-semibold text-lg mb-4">Importer deltakere fra CSV</h3>
      
      <div class="soft p-3 rounded-lg mb-4">
        <p class="font-medium">Instruksjoner:</p>
        <ul class="list-disc list-inside text-sm subtle mt-1 space-y-1">
            <li>Filen må være en `.csv`-fil.</li>
            <li>Første rad (header) må være: <strong>name;class</strong></li>
            <li>Data må være separert med semikolon (`;`).</li>
            <li>Systemet tildeler unike startnumre automatisk.</li>
            <li>Importen sorteres etter **eldste klasse først**.</li>
        </ul>
      </div>

      <div class="space-y-4">
        <div>
          <label for="competitionInput" class="block text-sm subtle mb-1">Konkurranse:</label>
          <input type="text" id="competitionInput" placeholder="F.eks. Klubbløp-2025">
        </div>
        
        <div>
          <label for="dateInput" class="block text-sm subtle mb-1">Dato:</label>
          <input type="date" id="dateInput">
        </div>

        <div>
            <label for="csvImport" class="block text-sm subtle mb-1">Velg CSV-fil:</label>
            <input type="file" id="csvImport" accept=".csv">
        </div>
        
        <div class="pt-2">
          <button id="btnImportCSV" class="btn btn-primary w-full md:w-auto">Start Import</button>
        </div>
      </div>

    </section>

  </main>

  <footer class="text-center text-sm text-gray-500 py-5">
    © 2025 Lørenskog Skiklubb – Tidtaking
  </footer>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    // Konfigurer Supabase
    const supabaseUrl = "https://chzfewhbfkdtcizdxyzk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // Sett dato til i dag som standard
    document.getElementById("dateInput").value = new Date().toISOString().split('T')[0];

    /**
     * Henter det høyeste 'snr' (startnummeret) som er i bruk i HELE databasen.
     */
    async function fetchHighestSnr() {
      const { data, error } = await supabaseClient
        .from("participants")
        .select("snr")
        .order("snr", { ascending: false })
        .limit(1); 

      if (error) {
        console.error("Feil ved henting av høyeste snr:", error);
        return 0;
      }
      
      if (data && data.length > 0) {
        const highestSnr = parseInt(data[0].snr, 10);
        return isNaN(highestSnr) ? 0 : highestSnr;
      }
      
      return 0; // Tabellen er tom
    }

    /**
     * NY HJELPEFUNKSJON:
     * Henter ut alderen (tallet) fra en klassestreng, f.eks. "G16" -> 16
     */
    function getClassAge(className) {
        if (!className) return 0;
        const match = className.match(/\d+/); // Finner første tallrekke
        return match ? parseInt(match[0], 10) : 0;
    }

    /**
     * Leser CSV-filen, tildeler globalt unike startnumre sortert etter klasse,
     * og importerer data til Supabase.
     */
    async function parseCSVAndImport(file) {
      const competitionVal = document.getElementById("competitionInput").value.trim();
      const dateVal = document.getElementById("dateInput").value.trim();
      if (!competitionVal || !dateVal) {
        alert("Fyll ut konkurranse og dato før import!");
        return;
      }

      const highestExistingSnr = await fetchHighestSnr();
      let nextSnr = highestExistingSnr + 1;
      console.log(`Høyeste snr i DB: ${highestExistingSnr}. Starter tildeling fra: ${nextSnr}`);

      const reader = new FileReader();
      reader.onload = async function(e) {
        const text = e.target.result;
        const lines = text.split("\n").map(line => line.trim()).filter(line => line.length > 0);
        if (lines.length < 2) {
          alert("CSV-filen mangler data eller har ikke riktig header.");
          return;
        }
        
        const headers = lines[0].split(";").map(h => h.trim().replace(/"/g, "").toLowerCase());
        let rows = [];
        
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(";").map(val => val.trim().replace(/"/g, ""));
          let row = {};
          headers.forEach((header, index) => {
            if (["name", "class"].includes(header)) {
              row[header] = values[index];
            }
          });
          if (row.name && row.class) {
            rows.push(row);
          }
        }
        
        if (rows.length === 0) {
          alert("Ingen gyldige deltakere funnet i CSV-filen.");
          return;
        }

        // --- OPPDATERT SORTERINGSLOGIKK ---
        // Sorterer etter "eldste klasse først" (høyest tall)
        rows.sort((a, b) => {
            const ageA = getClassAge(a.class);
            const ageB = getClassAge(b.class);

            // Sorter eldst (høyest tall) først
            if (ageA !== ageB) {
                return ageB - ageA; // Sorter synkende
            }
            
            // Hvis lik alder (f.eks. G10 vs J10), sorter alfabetisk på klasse
            return a.class.localeCompare(b.class);
        });
        // --- SLUTT PÅ NY LOGIKK ---

        let newParticipants = [];

        // Gå gjennom de sorterte radene og tildel UNIKE, fortløpende numre
        for (const row of rows) {
          const { name, class: cls } = row;
          const snrToAssign = nextSnr;
          nextSnr++; // Øk telleren for NESTE deltaker

          newParticipants.push({
            snr: snrToAssign,
            name,
            class: cls,
            competition: competitionVal,
            comp_date: dateVal,
            status: "Venter",
            start: null,
            laps: [],
            finish: null,
            rawFinish: null,
            shooting: JSON.stringify([Array(5).fill(false), Array(5).fill(false)])
          });
        }

        console.log("Nye deltakere som skal importeres (sortert):", newParticipants);

        // Sett dem inn i DB
        const { error } = await supabaseClient.from("participants").insert(newParticipants);
        if (error) {
          console.error("Feil ved CSV-import:", error);
          alert("CSV-import feilet – sjekk konsollen for detaljer. (Sannsynligvis 409-feil pga. duplikat snr hvis du kjører to ganger)");
        } else {
          alert(`CSV-import fullført! ${newParticipants.length} deltakere ble lagt til.`);
          // Send brukeren tilbake til startsiden
          window.location.href = 'index.html'; 
        }
      };
      reader.readAsText(file);
    }
    
    document.getElementById("btnImportCSV").addEventListener("click", function() {
      const fileInput = document.getElementById("csvImport");
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Velg en CSV-fil å importere.");
        return;
      }
      parseCSVAndImport(fileInput.files[0]);
    });
  </script>
</body>
</html>
