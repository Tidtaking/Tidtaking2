<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anbud – Postnummerkart</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; padding:0 }
    #map { width:100%; height:100vh }
    #controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:8px; border-radius:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; font-size:14px;
    }
    #controls label { display:flex; align-items:center; margin-bottom:4px }
    #controls input { margin-right:6px }
    #controls span.count { margin-left:auto; font-weight:bold }
  </style>
</head>
<body>
  <div id="controls">
    <label>
      <input type="checkbox" id="toggleAktuelle" checked/>
      Abo utenfor anbud
      <span id="countAktuelle" class="count">0</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAbo" checked/>
      abo_treff_anbud
      <span id="countAbo" class="count">0</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAnbud" checked/>
      anbudet
      <span id="countAnbud" class="count">0</span>
    </label>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // 1) Init kart
    const map = L.map('map').setView([60,10],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors', maxZoom:18
    }).addTo(map);

    // 2) EPSG:3035 → WGS84
    proj4.defs("EPSG:3035","+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs");
    function coords3035tilLatLng(c){
      const [x,y] = c;
      const [lon,lat] = proj4("EPSG:3035","WGS84",[x,y]);
      return L.latLng(lat,lon);
    }

    // 3) Les CSV-rader med 'postnummer'
    function lesCSVRows(sti){
      return new Promise((res,rej)=>{
        Papa.parse(sti,{download:true,header:true,skipEmptyLines:true,
          complete(r){
            const rows = r.data.filter(row=>row.postnummer);
            rows.length ? res(rows) : rej(`Ingen rader i ${sti}`);
          },
          error(e){ rej(e); }
        });
      });
    }

    // 4) Last inn tre CSV-er og to GeoJSON-filer
    Promise.all([
      lesCSVRows('aktuelle_postnummer.csv'),
      lesCSVRows('abo_treff_anbud.csv'),
      lesCSVRows('anbud_postnummer.csv'),
      fetch('postnummer_part01.geojson').then(r=>r.json()),
      fetch('filtrert_anbud.geojson').then(r=>r.json())
    ])
    .then(([rowsAkt, rowsAbo, rowsAnb, geoBase, geoAnb])=>{
      // Normaliser til fire-sifret postnummer
      const norm = rows => Array.from(new Set(
        rows.map(r=>r.postnummer.trim().padStart(4,'0'))
      ));
      const normAkt = norm(rowsAkt);
      const normAbo = norm(rowsAbo);
      const normAnb = norm(rowsAnb);

      // 5) Filtrer features
      // Blått lag fra begge JSON-filer
      const baseMatch = geoBase.features.filter(f=> normAkt.includes(f.properties.postnummer.trim()));
      const anbMatch  = geoAnb.features.filter(f=>  normAkt.includes(f.properties.postnummer.trim()));
      const aktMap = {};
      baseMatch.forEach(f=> aktMap[f.properties.postnummer] = f);
      anbMatch.forEach(f=>  aktMap[f.properties.postnummer] = f);
      const fAktuelle = Object.values(aktMap);

      // Grønt lag mot filtrert_anbud.geojson
      const fAbo = geoAnb.features.filter(f=> normAbo.includes(f.properties.postnummer.trim()));

      // Rødt lag mot filtrert_anbud.geojson
      const fAnbud = geoAnb.features.filter(f=> normAnb.includes(f.properties.postnummer.trim()));

      // 6) Oppdater tellere
      document.getElementById('countAktuelle').innerText = fAktuelle.length;
      document.getElementById('countAbo').innerText       = fAbo.length;
      document.getElementById('countAnbud').innerText     = fAnbud.length;

      // 7) Bygg FeatureCollections
      const collAkt = {type:'FeatureCollection',features:fAktuelle};
      const collAbo = {type:'FeatureCollection',features:fAbo};
      const collAnb = {type:'FeatureCollection',features:fAnbud};

      // 8) Opprett lag
      const layerAkt = L.geoJSON(collAkt,{
        coordsToLatLng:coords3035tilLatLng,
        style:()=>({color:'#333',weight:1,fillOpacity:0.5,fillColor:'#3388ff'})
      });
      const layerAbo = L.geoJSON(collAbo,{
        coordsToLatLng:coords3035tilLatLng,
        style:()=>({color:'#333',weight:1,fillOpacity:0.5,fillColor:'#33cc33'})
      });
      const layerAnb = L.geoJSON(collAnb,{
        coordsToLatLng:coords3035tilLatLng,
        style:()=>({color:'#333',weight:1,fillOpacity:0.5,fillColor:'#ff3333'})
      });

      // 9) Popups
      [layerAkt,layerAbo,layerAnb].forEach(layer=>
        layer.eachLayer(l=>
          l.bindPopup(`<strong>${l.feature.properties.postnummer}</strong>`)
        )
      );

      // 10) Toggle & zoom
      function oppdater(){
        document.getElementById('toggleAktuelle').checked
          ? map.addLayer(layerAkt) : map.removeLayer(layerAkt);
        document.getElementById('toggleAbo').checked
          ? map.addLayer(layerAbo) : map.removeLayer(layerAbo);
        document.getElementById('toggleAnbud').checked
          ? map.addLayer(layerAnb) : map.removeLayer(layerAnb);

        const visible = [layerAkt,layerAbo,layerAnb]
          .flatMap(l=> map.hasLayer(l) ? l.getLayers() : []);
        if(visible.length){
          const fg = L.featureGroup(visible);
          map.fitBounds(fg.getBounds().pad(0.05));
        }
      }
      ['toggleAktuelle','toggleAbo','toggleAnbud']
        .forEach(id=> document.getElementById(id).addEventListener('change', oppdater));

      // Initial
      oppdater();
    })
    .catch(err=>console.error('Feil ved innlasting/behandling:', err));
  </script>
</body>
</html>
