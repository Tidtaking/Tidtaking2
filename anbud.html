<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anbud – Postnummerkart</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Papa Parse for å lese CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // 1) Initialiser Leaflet-kartet
    const map = L.map('map').setView([60.0, 10.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 18,
    }).addTo(map);

    // 2) Les CSV med ønskede postnummer (kolonne heter "Postnummer")
    Papa.parse('aktuelle_postnummer.csv', {
      download: true,
      header: true,
      dynamicTyping: false,
      complete: function (csvResult) {
        // Bruk row.Postnummer (stor P) i stedet for row.postnummer
        const ønskedePN = csvResult.data
          .map((row) => (row.Postnummer ? String(row.Postnummer).trim() : null))
          .filter((p) => p);

        if (ønskedePN.length === 0) {
          console.error('Ingen gyldige postnummer funnet i CSV-filen.');
          return;
        }

        // 3) Hent den filtrerte GeoJSON-fila
        fetch('filtrert_postnummer.geojson')
          .then((res) => {
            if (!res.ok) throw new Error('Feil ved lasting av GeoJSON: ' + res.status);
            return res.json();
          })
          .then((rawData) => {
            // Forvent at rawData er en FeatureCollection
            if (!rawData || rawData.type !== 'FeatureCollection' || !rawData.features) {
              console.error('Uventet GeoJSON-struktur. Forventet FeatureCollection med "features".');
              return;
            }

            // Filtrer én gang til som garanti
            const filtrerteFeatures = rawData.features.filter((feat) => {
              // 'properties.postnummer' i GeoJSON er fortsatt liten p
              const pn = String((feat.properties && feat.properties.postnummer) || '').trim();
              return ønskedePN.includes(pn);
            });

            console.log(`Fant ${filtrerteFeatures.length} polygoner som matcher CSV-listen.`);

            if (filtrerteFeatures.length === 0) {
              console.warn('Ingen matchende polygoner i GeoJSON for de angitte postnumrene.');
            }

            const litenGeoJSON = {
              type: 'FeatureCollection',
              features: filtrerteFeatures,
            };

            // 4) Tegn polygonene i kartet
            const geojsonLayer = L.geoJSON(litenGeoJSON, {
              style: (feature) => ({
                color: '#333333',
                weight: 1,
                fillOpacity: 0.5,
                fillColor: '#3388ff',
              }),
              onEachFeature: (feature, layer) => {
                const props = feature.properties || {};
                layer.bindPopup(
                  `<strong>Postnummer:</strong> ${props.postnummer || '–'}<br>` +
                  (props.navn ? `<strong>Navn:</strong> ${props.navn}` : '')
                );
              }
            }).addTo(map);

            if (litenGeoJSON.features.length > 0) {
              map.fitBounds(geojsonLayer.getBounds().pad(0.2));
            }
          })
          .catch((err) => {
            console.error('Feil ved henting av GeoJSON:', err);
          });
      },
      error: (err) => {
        console.error('Kunne ikke lese CSV-filen:', err);
      },
    });
  </script>
</body>
</html>
