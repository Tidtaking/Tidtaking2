<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anbud – Postnummerkart</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-XQoYMqMTK8LvdlDXvxdM2LB5DZX++0Vr4X0mzxtgFMo="
    crossorigin=""
  />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-gZOGXcIBjDoOKrlgCNL0Mi733Vl+2GYJ0gVS0E8pCgM="
    crossorigin=""
  ></script>

  <!-- Papa Parse for å lese CSV -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
    integrity="sha512-g2ma2t7t1PdLv7hy8UmgMZpeeR8vbgyoPmNfToOVtuzUoIi1kvJraMIB+OlOSv54rz0hgyhdN3tMclz8880R4Q=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>

  <script>
    // 1) Initialiser Leaflet-kartet
    const map = L.map('map').setView([60.0, 10.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:
        '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 18,
    }).addTo(map);

    // 2) Les CSV med ønskede postnummer (samme repo, relativ sti)
    Papa.parse('aktuelle_postnummer.csv', {
      download: true,
      header: true,
      dynamicTyping: false,
      complete: function (csvResult) {
        const ønskedePN = csvResult.data
          .map((row) => (row.postnummer ? String(row.postnummer).trim() : null))
          .filter((p) => p);

        if (ønskedePN.length === 0) {
          console.error('Ingen gyldige postnummer funnet i CSV-filen.');
          return;
        }

        // 3) Hent den filtrerte GeoJSON-fila som ligger i samme mappe
        fetch('filtrert_postnummer.geojson')
          .then((res) => {
            if (!res.ok) throw new Error('Feil ved lasting av GeoJSON: ' + res.status);
            return res.json();
          })
          .then((rawData) => {
            // Her forutsetter vi at rawData er en FeatureCollection direkte under rot:
            // {
            //   "type": "FeatureCollection",
            //   "features": [ … ]
            // }
            if (!rawData || rawData.type !== 'FeatureCollection' || !rawData.features) {
              console.error('Uventet GeoJSON-struktur. Forventet FeatureCollection med "features".');
              return;
            }

            // Filtrer funksjonelt en gang til (valgfritt, men trygghets‐sjekk)
            const filtrerteFeatures = rawData.features.filter((feat) => {
              const pn = String((feat.properties && feat.properties.postnummer) || '').trim();
              return ønskedePN.includes(pn);
            });

            if (filtrerteFeatures.length === 0) {
              console.warn('Ingen matchende features i GeoJSON for de postnumrene som stod i CSV.');
            }

            const litenGeoJSON = {
              type: 'FeatureCollection',
              features: filtrerteFeatures,
            };

            // Legg til GeoJSON-laget på kartet
            const geojsonLayer = L.geoJSON(litenGeoJSON, {
              style: function (feature) {
                return {
                  color: '#333333',
                  weight: 1,
                  fillOpacity: 0.5,
                  fillColor: '#3388ff',
                };
              },
              onEachFeature: function (feature, layer) {
                const props = feature.properties || {};
                layer.bindPopup(
                  `<strong>Postnummer:</strong> ${props.postnummer || '–'}<br>` +
                    (props.navn ? `<strong>Navn:</strong> ${props.navn}` : '')
                );
              },
            }).addTo(map);

            if (litenGeoJSON.features.length > 0) {
              map.fitBounds(geojsonLayer.getBounds().pad(0.2));
            }
          })
          .catch((err) => {
            console.error(err);
          });
      },
      error: function (err) {
        console.error('Kunne ikke lese CSV-filen:', err);
      },
    });
  </script>
</body>
</html>
