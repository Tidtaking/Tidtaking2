<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anbud – Postnummerkart</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; padding:0 }
    #map { width:100%; height:100vh }
    #controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:8px; border-radius:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; font-size:14px;
    }
    #controls label { display:flex; align-items:center; margin-bottom:4px }
    #controls input[type=text] { flex:1; margin-right:6px; padding:4px; }
    #controls button { padding:4px 8px; }
    #controls span.count { margin-left:auto; font-weight:bold }
  </style>
</head>
<body>
  <div id="controls">
    <label>
      <input type="checkbox" id="toggleAktuelle" checked/>
      Abo utenfor anbud(blått)
      <span id="countAktuelle" class="count">0</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAbo" checked/>
      abo_treff_anbud(grønt)
      <span id="countAbo" class="count">0</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAnbud" checked/>
      anbudet(rødt)
      <span id="countAnbud" class="count">0</span>
    </label>
    <label>
      <input type="checkbox" id="toggleBrukt" checked/>
      abo_bruktidag_anbud (gult)
      <span id="countBrukt" class="count">0</span>
    </label>
    <div style="margin-top:8px; display:flex;">
      <input type="text" id="searchInput" placeholder="Søk poststed eller nr" />
      <button id="searchBtn">Søk</button>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // 1) Init kart
    const map = L.map('map').setView([60,10],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors', maxZoom:18
    }).addTo(map);

    // 2) EPSG:3035 → WGS84
    proj4.defs("EPSG:3035","+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs");
    function coords3035tilLatLng(c){
      const [x,y] = c;
      const [lon,lat] = proj4("EPSG:3035","WGS84",[x,y]);
      return L.latLng(lat,lon);
    }

    // 3) Les CSV-rader med 'postnummer'
    function lesCSVRows(sti){
      return new Promise((res,rej)=>{
        Papa.parse(sti,{download:true,header:true,skipEmptyLines:true,
          complete(r){
            const rows = r.data.filter(row=>row.postnummer);
            rows.length ? res(rows) : rej(`Ingen rader i ${sti}`);
          },
          error(e){ rej(e); }
        });
      });
    }

    Promise.all([
      lesCSVRows('aktuelle_postnummer.csv'),
      lesCSVRows('abo_treff_anbud.csv'),
      lesCSVRows('anbud_postnummer.csv'),
      // Håndter manglende eller tom CSV uten å avbryte
      lesCSVRows('abo_bruktidag_anbud.csv').catch(e => {
        console.warn('Ingen rader i abo_bruktidag_anbud.csv, fortsetter med tomt sett');
        return [];
      }),
      fetch('postnummer_part01.geojson').then(r=>r.json()),
      fetch('postnummer_part02.geojson').then(r=>r.json()),
      fetch('postnummer_part03.geojson').then(r=>r.json()),
      fetch('filtrert_anbud.geojson').then(r=>r.json())
    ])
    .then(([rowsAkt, rowsAbo, rowsAnb, rowsBrukt, geoBase1, geoBase2, geoBase3, geoAnb])=>{
      // Kombiner base geo
      const alleBaseFeatures = [...geoBase1.features, ...geoBase2.features, ...geoBase3.features];
      const geoBase = { type: 'FeatureCollection', features: alleBaseFeatures };

      // Normaliser postnummer
      const norm = rows=> Array.from(new Set(rows.map(r=>r.postnummer.trim().padStart(4,'0'))));
      const normAkt = norm(rowsAkt);
      const normAbo = norm(rowsAbo);
      const normAnb = norm(rowsAnb);
      const normBrukt = norm(rowsBrukt);

      // Filtrer
      const baseMatch = geoBase.features.filter(f=> normAkt.includes(f.properties.postnummer.trim()));
      const anbMatch  = geoAnb.features.filter(f=> normAkt.includes(f.properties.postnummer.trim()));
      const aktMap = {};
      baseMatch.forEach(f=> aktMap[f.properties.postnummer] = f);
      anbMatch.forEach(f=> aktMap[f.properties.postnummer] = f);
      const fAktuelle = Object.values(aktMap);

      const fAbo = geoAnb.features.filter(f=> normAbo.includes(f.properties.postnummer.trim()));
      const fAnbud = geoAnb.features.filter(f=> normAnb.includes(f.properties.postnummer.trim()));
      const fBrukt = geoAnb.features.filter(f=> normBrukt.includes(f.properties.postnummer.trim()));

      // Oppdater tellere
      document.getElementById('countAktuelle').innerText = fAktuelle.length;
      document.getElementById('countAbo').innerText       = fAbo.length;
      document.getElementById('countAnbud').innerText     = fAnbud.length;
      document.getElementById('countBrukt').innerText     = fBrukt.length;

      // FeatureCollections
      const collAkt = { type:'FeatureCollection', features: fAktuelle };
      const collAbo = { type:'FeatureCollection', features: fAbo };
      const collAnb = { type:'FeatureCollection', features: fAnbud };
      const collBrukt = { type:'FeatureCollection', features: fBrukt };

      // Lag lag
      const layerAkt = L.geoJSON(collAkt, { coordsToLatLng: coords3035tilLatLng, style:()=>({ color:'#333', weight:1, fillOpacity:0.5, fillColor:'#3388ff' }) });
      const layerAbo = L.geoJSON(collAbo, { coordsToLatLng: coords3035tilLatLng, style:()=>({ color:'#333', weight:1, fillOpacity:0.5, fillColor:'#33cc33' }) });
      const layerAnb = L.geoJSON(collAnb, { coordsToLatLng: coords3035tilLatLng, style:()=>({ color:'#333', weight:1, fillOpacity:0.5, fillColor:'#ff3333' }) });
      const layerBrukt = L.geoJSON(collBrukt, { coordsToLatLng: coords3035tilLatLng, style:()=>({ color:'#333', weight:1, fillOpacity:0.5, fillColor:'#ffff00' }) });

      // Popups
      [layerAkt, layerAbo, layerAnb, layerBrukt].forEach(layer =>
        layer.eachLayer(l => l.bindPopup(`<strong>${l.feature.properties.postnummer}</strong><br>${l.feature.properties.poststed||''}`))
      );

      // Toggle & zoom
      function oppdater(){
        document.getElementById('toggleAktuelle').checked ? map.addLayer(layerAkt) : map.removeLayer(layerAkt);
        document.getElementById('toggleAbo').checked      ? map.addLayer(layerAbo) : map.removeLayer(layerAbo);
        document.getElementById('toggleAnbud').checked    ? map.addLayer(layerAnb) : map.removeLayer(layerAnb);
        document.getElementById('toggleBrukt').checked    ? map.addLayer(layerBrukt) : map.removeLayer(layerBrukt);

        const visible = [layerAkt, layerAbo, layerAnb, layerBrukt]
          .flatMap(l=> map.hasLayer(l) ? l.getLayers() : []);
        if(visible.length){
          const fg = L.featureGroup(visible);
          map.fitBounds(fg.getBounds().pad(0.05));
        }
      }
      ['toggleAktuelle','toggleAbo','toggleAnbud','toggleBrukt']
        .forEach(id=> document.getElementById(id).addEventListener('change', oppdater));

      // Initial visning
      oppdater();

      // Søkefunksjon
      const searchFeatures = [...collAkt.features, ...collAbo.features, ...collAnb.features, ...collBrukt.features];
      function searchMap(){
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if(!q) return;
        const matches = searchFeatures.filter(f =>
          f.properties.postnummer.toLowerCase() === q ||
          (f.properties.poststed && f.properties.poststed.toLowerCase().includes(q))
        );
        if(!matches.length){ alert('Ingen resultater for "'+q+'"'); return; }
        const gruppe = L.geoJSON({ type:'FeatureCollection', features: matches }, { coordsToLatLng: coords3035tilLatLng });
        map.fitBounds(gruppe.getBounds().pad(0.05));
        gruppe.eachLayer(l => l.openPopup());
      }
      document.getElementById('searchBtn').addEventListener('click', searchMap);
      document.getElementById('searchInput').addEventListener('keyup', e=>{ if(e.key=== 'Enter') searchMap(); });
    })
    .catch(err=> console.error('Feil ved innlasting/behandling:', err));
  </script>
</body>
</html>
