<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anbud – Postnummerkart</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; padding:0; }
    #map { width:100%; height:100vh; }
    #controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:10px; border-radius:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; font-size:14px; line-height:1.4;
      width:320px;
    }
    /* Striped bakgrunn for filterrader */
    #controls label {
      display:flex; align-items:center; margin-bottom:10px;
      padding:4px; border-radius:4px;
    }
    #controls label:nth-of-type(odd) { background-color: rgba(0,0,0,0.03); }
    #controls .label-content { display:flex; justify-content:space-between; align-items:center; width:100%; margin-left:6px; }
    #controls .label-text { font-weight:500; flex:1; }
    #controls .counts { display:flex; flex-direction:column; align-items:flex-end; min-width:90px; }
    #controls .counts .count { font-weight:bold; color:#0077cc; }
    #controls .counts .count + .count { margin-top:4px; }
    #controls input[type='text'] { flex:1; margin-right:6px; padding:4px; }
    #controls button { padding:4px 8px; margin-left:4px; }
    #search-summary { margin-top:12px; }
    /* Tabell-styling for søkeresultater */
    #search-summary table { width:100%; border-collapse:collapse; font-size:13px; margin-top:4px; }
    #search-summary th, #search-summary td { border:1px solid #ddd; padding:6px; text-align:left; }
    #search-summary th { background-color:#f4f4f4; font-weight:600; }
    #search-summary tr:nth-child(odd) td { background-color:rgba(0,0,0,0.02); }
  </style>
</head>
<body>
  <div id="controls">
    <!-- Filtervisning -->
    <label>
      <input type="checkbox" id="toggleAktuelle" checked />
      <div class="label-content">
        <span class="label-text">Abo utenfor anbud</span>
        <div class="counts">
          <span id="postCountAktuelle" class="count">0 postnumre</span>
          <span id="sumCountAktuelle" class="count">0 antall</span>
        </div>
      </div>
    </label>
    <label>
      <input type="checkbox" id="toggleAbo" checked />
      <div class="label-content">
        <span class="label-text">abo_treff_anbud</span>
        <div class="counts">
          <span id="postCountAbo" class="count">0 postnumre</span>
          <span id="sumCountAbo" class="count">0 antall</span>
        </div>
      </div>
    </label>
    <label>
      <input type="checkbox" id="toggleAnbud" checked />
      <div class="label-content">
        <span class="label-text">anbudet</span>
        <div class="counts">
          <span id="postCountAnbud" class="count">0 postnumre</span>
          <span id="sumCountAnbud" class="count">0 antall</span>
        </div>
      </div>
    </label>
    <label>
      <input type="checkbox" id="toggleBrukt" checked />
      <div class="label-content">
        <span class="label-text">abo_bruktidag_anbud</span>
        <div class="counts">
          <span id="postCountBrukt" class="count">0 postnumre</span>
          <span id="sumCountBrukt" class="count">0 antall</span>
        </div>
      </div>
    </label>
    <!-- Søk og eksport -->
    <div style="margin-top:8px; display:flex; align-items:center;">
      <input type="text" id="searchInput" placeholder="Søk poststed, nr eller avis" />
      <button id="searchBtn">Søk</button>
      <button id="exportBtn" disabled>Eksporter CSV</button>
    </div>
    <div id="search-summary"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([60,10],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'© OpenStreetMap contributors', maxZoom:18
    }).addTo(map);

    proj4.defs('EPSG:3035', '+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs');
    function coords3035tilLatLng(c){
      const [x,y] = c;
      const [lon,lat] = proj4('EPSG:3035','WGS84',[x,y]);
      return L.latLng(lat,lon);
    }

    async function lesCSVRows(url){
      try {
        const res = await fetch(url);
        if(!res.ok) throw new Error(`${url}: HTTP ${res.status}`);
        const text = await res.text();
        return Papa.parse(text,{header:true,skipEmptyLines:true,delimiter:';'}).data;
      } catch(e) {
        console.warn('Kunne ikke lese',url,e);
        return [];
      }
    }

    function group(rows){
      const m = {};
      rows.forEach(r=>{
        const p = r.postnummer?.trim().padStart(4,'0');
        if(!p) return;
        const num = r.antall ? Number(r.antall) : 0;
        if(!m[p]) m[p] = {count:0, avis:new Set()};
        m[p].count += num;
        if(r.avis) m[p].avis.add(r.avis.toLowerCase());
      });
      return m;
    }

    let lastMatches = [];
    const filterKeys = {
      Aktuelle:'Abo utenfor anbud',
      Abo:'abo_treff_anbud',
      Anbud:'anbudet',
      Brukt:'abo_bruktidag_anbud'
    };

    Promise.all([
      lesCSVRows('aktuelle_postnummer.csv'),
      lesCSVRows('abo_treff_anbud.csv'),
      lesCSVRows('anbud_postnummer.csv'),
      lesCSVRows('abo_bruktidag_anbud.csv'),
      fetch('postnummer_part01.geojson').then(r=>r.json()),
      fetch('postnummer_part02.geojson').then(r=>r.json()),
      fetch('postnummer_part03.geojson').then(r=>r.json()),
      fetch('filtrert_anbud.geojson').then(r=>r.json())
    ]).then(([aRows,bRows,cRows,dRows,g1,g2,g3,geoAnb])=>{
      const dA = group(aRows), dB = group(bRows), dC = group(cRows), dD = group(dRows);
      const nA = Object.keys(dA), nB = Object.keys(dB), nC = Object.keys(dC), nD = Object.keys(dD);
      const base = [...g1.features,...g2.features,...g3.features];
      const geoBase = {type:'FeatureCollection',features:base};
      const fA = Array.from(new Set([
        ...geoBase.features.filter(f=>nA.includes(f.properties.postnummer.trim())),
        ...geoAnb.features.filter(f=>nA.includes(f.properties.postnummer.trim()))
      ]));
      const fB = geoAnb.features.filter(f=>nB.includes(f.properties.postnummer.trim()));
      const fC = geoAnb.features.filter(f=>nC.includes(f.properties.postnummer.trim()));
      const fD = geoAnb.features.filter(f=>nD.includes(f.properties.postnummer.trim()));

      function enrich(arr,mapData){
        arr.forEach(f=>{
          const p = f.properties.postnummer.trim();
          const info = mapData[p] || {count:0, avis:new Set()};
          f.properties.antall = info.count;
          f.properties.avis = Array.from(info.avis).join(', ');
        });
      }
      enrich(fA,dA); enrich(fB,dB); enrich(fC,dC); enrich(fD,dD);

      ['Aktuelle','Abo','Anbud','Brukt'].forEach((k,i)=>{
        const arr = [fA,fB,fC,fD][i];
        document.getElementById('postCount'+k).innerText = `${arr.length} postnumre`;
        const sum = arr.reduce((s,f)=>s+f.properties.antall,0);
        document.getElementById('sumCount'+k).innerText = `${sum} antall`;
      });

      const layers = {
        Aktuelle: L.geoJSON(fA,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#3388ff',fillOpacity:0.5,weight:1})}),
        Abo:      L.geoJSON(fB,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#33cc33',fillOpacity:0.5,weight:1})}),
        Anbud:    L.geoJSON(fC,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#ff3333',fillOpacity:0.5,weight:1})}),
        Brukt:    L.geoJSON(fD,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#ffff00',fillOpacity:0.5,weight:1})})
      };
      Object.values(layers).forEach(layer => layer.eachLayer(l=>{
        const p = l.feature.properties;
        l.bindPopup(`<strong>${p.postnummer}</strong><br>Antall: ${p.antall}<br>Avis: ${p.avis}`);
      }));

      function oppdaterLag(){
        Object.entries(layers).forEach(([k,lyr])=>{
          document.getElementById('toggle'+k).checked ? map.addLayer(lyr) : map.removeLayer(lyr);
        });
        const vis = Object.values(layers).flatMap(l=>map.hasLayer(l)?l.getLayers():[]);
        if(vis.length) map.fitBounds(L.featureGroup(vis).getBounds().pad(0.05));
      }
      ['Aktuelle','Abo','Anbud','Brukt'].forEach(k=>document.getElementById('toggle'+k).addEventListener('change',oppdaterLag));
      oppdaterLag();

      const searchBtn = document.getElementById('searchBtn');
      const exportBtn = document.getElementById('exportBtn');
      const csvMaps = {Aktuelle:dA,Abo:dB,Anbud:dC,Brukt:dD};

      function searchMap(){
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if(!q) return;
        Object.values(layers).forEach(l=>map.removeLayer(l));
        const matched = new Set();
        Object.entries(csvMaps).forEach(([k,mapData])=>{
          Object.entries(mapData).forEach(([p,info])=>{
            if(p.toLowerCase()===q || Array.from(info.avis).some(a=>a.includes(q)))
              matched.add(p);
          });
        });
        const matches = [...fA,...fB,...fC,...fD].filter(f=>matched.has(f.properties.postnummer.trim()));
        if(!matches.length){
          document.getElementById('search-summary').innerHTML = '';
          exportBtn.disabled = true;
          return alert(`Ingen treff for "${q}"`);
        }

        let html = '<table><thead><tr><th>Filter</th><th>Postnumre</th><th>Totalt antall</th></tr></thead><tbody>';
        Object.entries(csvMaps).forEach(([key,mapData])=>{
          const keys = Object.keys(mapData).filter(p=>matched.has(p));
          const postCount = keys.length;
          const sumCount = keys.reduce((s,p)=>s+mapData[p].count,0);
          html += `<tr><td>${filterKeys[key]}</td><td>${postCount}</td><td>${sumCount}</td></tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('search-summary').innerHTML = html;

        // Rettet eksport: sjekk filter i prioritert rekkefølge
        lastMatches = matches.map(f=>{
          const p = f.properties.postnummer;
          let filt = null;
          if(nA.includes(p)) filt = 'Aktuelle';
          else if(nB.includes(p)) filt = 'Abo';
          else if(nC.includes(p)) filt = 'Anbud';
          else if(nD.includes(p)) filt = 'Brukt';
          return {
            filter: filterKeys[filt] || '',
            postnummer: p,
            antall: f.properties.antall,
            avis: f.properties.avis
          };
        });
        exportBtn.disabled = false;

        const grp = L.geoJSON(matches,{
          coordsToLatLng:coords3035tilLatLng,
          style:()=>({color:'#555',fillOpacity:0.3,weight:2})
        }).addTo(map);
        grp.eachLayer(l=>{
          const p = l.feature.properties;
          l.bindPopup(`<strong>${p.postnummer}</strong><br>Antall: ${p.antall}<br>Avis: ${p.avis}`);
          l.openPopup();
        });
        map.fitBounds(grp.getBounds().pad(0.05));
      }

      searchBtn.addEventListener('click',searchMap);
      document.getElementById('searchInput').addEventListener('keyup', e=>e.key==='Enter' && searchMap());

      exportBtn.addEventListener('click',()=>{
        if(!lastMatches.length) return;
        const csv = Papa.unparse(lastMatches);
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'sokeresultater.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

    });
  </script>
</body>
</html>
