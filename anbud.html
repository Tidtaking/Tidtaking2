<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anbud – Postnummerkart</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4js for reprojisering fra EPSG:3035 til WGS84 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

  <!-- Papa Parse for å lese CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // ============================================================
    // Definer EPSG:3035 (ETRS89/LAEA Europe) → WGS84
    // EPSG:3035: +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs
    // ============================================================
    proj4.defs("EPSG:3035", "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs");
    // “WGS84” er forhåndsdefinert i Proj4js.

    // Funksjon som tar [x, y] i EPSG:3035 og returnerer L.latLng(lat, lon)
    function coords3035tilLatLng(coords) {
      // coords = [x, y]
      const [x, y] = coords;
      const [lon, lat] = proj4("EPSG:3035", "WGS84", [x, y]);
      return L.latLng(lat, lon);
    }

    // ============================================================
    // Initialiser Leaflet-kartet
    // ============================================================
    const map = L.map('map').setView([60.0, 10.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 18,
    }).addTo(map);

    // ============================================================
    // Les CSV med ønskede postnummer (kolonne = "Postnummer")
    // ============================================================
    Papa.parse('aktuelle_postnummer.csv', {
      download: true,
      header: true,
      dynamicTyping: false,
      complete: function (csvResult) {
        // Bruk “row.Postnummer” siden headeren heter akkurat det
        const ønskedePN = csvResult.data
          .map(row => (row.Postnummer ? String(row.Postnummer).trim() : null))
          .filter(p => p);

        if (ønskedePN.length === 0) {
          console.error('Ingen gyldige postnummer funnet i CSV-filen.');
          return;
        }

        // ==========================================================
        // Hent den filtrerte GeoJSON-fila (EPSG:3035)
        // ==========================================================
        fetch('filtrert_postnummer.geojson')
          .then(res => {
            if (!res.ok) throw new Error('Feil ved lasting av GeoJSON: ' + res.status);
            return res.json();
          })
          .then(rawData => {
            // Forvent at rawData har struktur:
            // {
            //   "type": "FeatureCollection",
            //   "features": [ … ]
            // }
            if (!rawData || rawData.type !== 'FeatureCollection' || !rawData.features) {
              console.error('Uventet GeoJSON-struktur. Forventet FeatureCollection.');
              return;
            }

            // ========================================================
            // Filtrer én gang til for sikkerhet (bruker properties.postnummer små bokstaver)
            // ========================================================
            const filtrerteFeatures = rawData.features.filter(feat => {
              const pn = String((feat.properties && feat.properties.postnummer) || '').trim();
              return ønskedePN.includes(pn);
            });

            console.log(`Fant ${filtrerteFeatures.length} polygoner som matcher CSV-listen.`);

            if (filtrerteFeatures.length === 0) {
              console.warn('Ingen matchende polygoner i GeoJSON for de angitte postnumrene.');
            }

            // Bygg ny, liten GeoJSON‐struktur
            const litenGeoJSON = {
              type: 'FeatureCollection',
              features: filtrerteFeatures,
            };

            // ========================================================
            // Tegn polygonene i kartet, med reprojisering __med__ coordsToLatLng
            // ========================================================
            const geojsonLayer = L.geoJSON(litenGeoJSON, {
              coordsToLatLng: coords3035tilLatLng,
              style: feature => ({
                color: '#333333',
                weight: 1,
                fillOpacity: 0.5,
                fillColor: '#3388ff',
              }),
              onEachFeature: (feature, layer) => {
                const props = feature.properties || {};
                layer.bindPopup(
                  `<strong>Postnummer:</strong> ${props.postnummer || '–'}<br>` +
                  (props.navn ? `<strong>Navn:</strong> ${props.navn}` : '')
                );
              }
            }).addTo(map);

            // Zoom slik at alle polygoner vises
            if (litenGeoJSON.features.length > 0) {
              map.fitBounds(geojsonLayer.getBounds().pad(0.2));
            }
          })
          .catch(err => {
            console.error('Feil ved henting av GeoJSON:', err);
          });
      },
      error: err => {
        console.error('Kunne ikke lese CSV-filen:', err);
      }
    });
  </script>
</body>
</html>
