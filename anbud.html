<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anbud – Postnummerkart</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; padding:0; }
    #map { width:100%; height:100vh; }
    #controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:10px; border-radius:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; font-size:14px; line-height:1.4;
    }
    #controls label { display:flex; align-items:center; margin-bottom:6px; }
    #controls .label-text { margin-left:6px; }
    #controls span.count { margin-left:auto; font-weight:bold; color:#0077cc; }
    #controls input[type='text'] { flex:1; margin-right:6px; padding:4px; }
    #controls button { padding:4px 8px; }
    #search-summary { margin-top:8px; font-weight:bold; }
  </style>
</head>
<body>
  <div id="controls">
    <label>
      <input type="checkbox" id="toggleAktuelle" checked/>
      <span class="label-text">Abo utenfor anbud</span>
      <span id="postCountAktuelle" class="count">0</span>
      <span class="label-text">postnumre</span>
      <span id="sumCountAktuelle" class="count">0</span>
      <span class="label-text">antall (blått)</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAbo" checked/>
      <span class="label-text">abo_treff_anbud</span>
      <span id="postCountAbo" class="count">0</span>
      <span class="label-text">postnumre</span>
      <span id="sumCountAbo" class="count">0</span>
      <span class="label-text">antall (grønt)</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAnbud" checked/>
      <span class="label-text">anbudet</span>
      <span id="postCountAnbud" class="count">0</span>
      <span class="label-text">postnumre</span>
      <span id="sumCountAnbud" class="count">0</span>
      <span class="label-text">antall (rødt)</span>
    </label>
    <label>
      <input type="checkbox" id="toggleBrukt" checked/>
      <span class="label-text">abo_bruktidag_anbud</span>
      <span id="postCountBrukt" class="count">0</span>
      <span class="label-text">postnumre</span>
      <span id="sumCountBrukt" class="count">0</span>
      <span class="label-text">antall (gult)</span>
    </label>
    <div style="margin-top:8px; display:flex;">
      <input type="text" id="searchInput" placeholder="Søk poststed, nr eller avis" />
      <button id="searchBtn">Søk</button>
    </div>
    <div id="search-summary"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Init map
    const map = L.map('map').setView([60,10],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap contributors', maxZoom:18 }).addTo(map);

    // Projection
    proj4.defs('EPSG:3035','+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs');
    function coords3035tilLatLng(c){
      const [x,y] = c;
      const [lon,lat] = proj4('EPSG:3035','WGS84',[x,y]);
      return L.latLng(lat,lon);
    }

    // Parse CSV
    async function lesCSVRows(url){
      try {
        const res = await fetch(url);
        if(!res.ok) throw new Error(`${url}: HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true, delimiter:';' });
        return parsed.data;
      } catch(e) {
        console.warn('Kunne ikke lese',url,e);
        return [];
      }
    }

    // Group by postnummer
    function group(rows){
      const m = {};
      rows.forEach(r => {
        const p = r.postnummer?.trim().padStart(4,'0');
        if(!p) return;
        const num = r.antall ? Number(r.antall) : 0;
        if(!m[p]) m[p] = { count:0, avis:new Set() };
        m[p].count += num;
        if(r.avis) m[p].avis.add(r.avis);
      });
      return m;
    }

    // Load all data
    Promise.all([
      lesCSVRows('aktuelle_postnummer.csv'),
      lesCSVRows('abo_treff_anbud.csv'),
      lesCSVRows('anbud_postnummer.csv'),
      lesCSVRows('abo_bruktidag_anbud.csv'),
      fetch('postnummer_part01.geojson').then(r=>r.json()),
      fetch('postnummer_part02.geojson').then(r=>r.json()),
      fetch('postnummer_part03.geojson').then(r=>r.json()),
      fetch('filtrert_anbud.geojson').then(r=>r.json())
    ]).then(([aRows,bRows,cRows,dRows, g1,g2,g3,geoAnb])=>{
      // Process CSV
      const dA = group(aRows), dB = group(bRows), dC = group(cRows), dD = group(dRows);
      const nA = Object.keys(dA), nB = Object.keys(dB), nC = Object.keys(dC), nD = Object.keys(dD);

      // Base geo
      const base = [...g1.features, ...g2.features, ...g3.features];
      const geoBase = { type:'FeatureCollection', features: base };

      // Filter per layer
      const fA = Array.from(new Set([
        ...geoBase.features.filter(f=>nA.includes(f.properties.postnummer.trim())),
        ...geoAnb.features.filter(f=>nA.includes(f.properties.postnummer.trim()))
      ]));
      const fB =          geoAnb.features.filter(f=>nB.includes(f.properties.postnummer.trim()));
      const fC =          geoAnb.features.filter(f=>nC.includes(f.properties.postnummer.trim()));
      const fD =          geoAnb.features.filter(f=>nD.includes(f.properties.postnummer.trim()));

      // Enrich
      function enrich(arr, mapData){
        arr.forEach(f => {
          const p = f.properties.postnummer.trim();
          const info = mapData[p] || {count:0, avis:new Set()};
          f.properties.antall = info.count;
          f.properties.avis   = Array.from(info.avis).join(', ');
        });
      }
      enrich(fA,dA); enrich(fB,dB); enrich(fC,dC); enrich(fD,dD);

      // Update counts
      function upd(id, arr){
        document.getElementById('postCount'+id).innerText = arr.length;
        document.getElementById('sumCount'+id).innerText  = arr.reduce((s,f)=>s+f.properties.antall,0);
      }
      upd('Aktuelle',fA); upd('Abo',fB); upd('Anbud',fC); upd('Brukt',fD);

      // Create layers
      const layers = {
        Aktuelle: L.geoJSON(fA, { coordsToLatLng:coords3035tilLatLng, style:()=>({color:'#3388ff',fillOpacity:0.5,weight:1})}),
        Abo     : L.geoJSON(fB, { coordsToLatLng:coords3035tilLatLng, style:()=>({color:'#33cc33',fillOpacity:0.5,weight:1})}),
        Anbud   : L.geoJSON(fC, { coordsToLatLng:coords3035tilLatLng, style:()=>({color:'#ff3333',fillOpacity:0.5,weight:1})}),
        Brukt   : L.geoJSON(fD, { coordsToLatLng:coords3035tilLatLng, style:()=>({color:'#ffff00',fillOpacity:0.5,weight:1})})
      };
      Object.values(layers).forEach(layer=>
        layer.eachLayer(l=>{
          const p=l.feature.properties;
          l.bindPopup(`<strong>${p.postnummer}</strong><br>Antall: ${p.antall}<br>Avis: ${p.avis}`);
        })
      );

      // Toggle layers
      function updLayers(){
        Object.entries(layers).forEach(([k,lyr])=>{
          document.getElementById('toggle'+k).checked ? map.addLayer(lyr) : map.removeLayer(lyr);
        });
        const vis = Object.values(layers).flatMap(l=> map.hasLayer(l) ? l.getLayers():[]);
        if(vis.length) map.fitBounds(L.featureGroup(vis).getBounds().pad(0.05));
      }
      ['Aktuelle','Abo','Anbud','Brukt'].forEach(k=>
        document.getElementById('toggle'+k).addEventListener('change',updLayers)
      );
      updLayers();

      // Search-only matches
      const allF = [...fA,...fB,...fC,...fD];
      function searchMap(){
        const q=document.getElementById('searchInput').value.trim().toLowerCase();
        if(!q) return;
        updLayers();
        const matches = allF.filter(f=>{
          const p=f.properties.postnummer.toLowerCase();
          const sted=(f.properties.poststed||'').toLowerCase();
          const avis=(f.properties.avis||'').toLowerCase();
          return p===q || sted.includes(q) || avis.includes(q);
        });
        const postCount = matches.length;
        const sumCount  = matches.reduce((s,f)=>s+f.properties.antall,0);
        document.getElementById('search-summary').innerText = `Viser ${postCount} postnumre, totalt ${sumCount}`;
        if(!matches.length) return alert(`Ingen treff for "${q}"`);
        const grp = L.geoJSON(matches, { coordsToLatLng:coords3035tilLatLng, style:()=>({color:'#555',fillOpacity:0.3,weight:2}) })
                     .addTo(map);
        grp.eachLayer(l=>l.openPopup());
        map.fitBounds(grp.getBounds().pad(0.05));
      }
      document.getElementById('searchBtn').addEventListener('click',searchMap);
      document.getElementById('searchInput').addEventListener('keyup', e=> e.key==='Enter' && searchMap());
    });
  </script>
</body>
</html>
