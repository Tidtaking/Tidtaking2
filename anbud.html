<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anbud – Postnummerkart</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4js for reprojisering fra EPSG:3035 til WGS84 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>

  <!-- Papa Parse for å lese CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // ------------------------------------------------------------
    // 1) Initialiser Leaflet-kartet
    // ------------------------------------------------------------
    const map = L.map('map').setView([60.0, 10.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 18,
    }).addTo(map);

    // ------------------------------------------------------------
    // EPSG:3035 → WGS84-definisjon
    // ------------------------------------------------------------
    proj4.defs("EPSG:3035", "+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs");
    function coords3035tilLatLng(coords) {
      const [x, y] = coords;
      const [lon, lat] = proj4("EPSG:3035", "WGS84", [x, y]);
      return L.latLng(lat, lon);
    }

    // ------------------------------------------------------------
    // 2) Hent CSV med Papa Parse
    // ------------------------------------------------------------
    Papa.parse('aktuelle_postnummer.csv', {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function (csvResult) {
        console.log('csvResult.data:', csvResult.data);

        // Sjekk om data finnes i det hele tatt
        if (!Array.isArray(csvResult.data) || csvResult.data.length === 0) {
          console.error('Fant ingen rader i CSV ("/aktuelle_postnummer.csv" returnerte tomt eller 404).');
          return;
        }

        // Sjekk om feltet "Postnummer" eksisterer i første rad
        const firstRow = csvResult.data[0];
        if (!Object.prototype.hasOwnProperty.call(firstRow, 'Postnummer')) {
          console.error('CSV mangler kolonnen "Postnummer". Feltnavnene i CSV er:', Object.keys(firstRow));
          return;
        }

        // Bygg liste over postnummer-strenger
        const ønskedePN = csvResult.data
          .map(row => (row.Postnummer ? String(row.Postnummer).trim() : null))
          .filter(p => p);

        console.log('Ønskede postnummer:', ønskedePN);

        if (ønskedePN.length === 0) {
          console.error('Ingen gyldige postnummer funnet i CSV-dataene.');
          return;
        }

        // ------------------------------------------------------------
        // 3) Hent filtrert GeoJSON (EPSG:3035)
        // ------------------------------------------------------------
        fetch('filtrert_postnummer.geojson')
          .then(res => {
            if (!res.ok) throw new Error('Feil ved lasting av GeoJSON: ' + res.status);
            return res.json();
          })
          .then(rawData => {
            if (!rawData || rawData.type !== 'FeatureCollection' || !rawData.features) {
              console.error('Uventet GeoJSON-struktur. Forventet FeatureCollection med "features".');
              return;
            }

            // Filtrer én gang til for sikkerhet
            const filtrerteFeatures = rawData.features.filter(feat => {
              const pn = String((feat.properties && feat.properties.postnummer) || '').trim();
              return ønskedePN.includes(pn);
            });

            console.log(`Fant ${filtrerteFeatures.length} polygoner som matcher CSV-listen.`);

            const litenGeoJSON = {
              type: 'FeatureCollection',
              features: filtrerteFeatures,
            };

            // ------------------------------------------------------------
            // 4) Tegn polygonene i kartet med reprojisering
            // ------------------------------------------------------------
            const geojsonLayer = L.geoJSON(litenGeoJSON, {
              coordsToLatLng: coords3035tilLatLng,
              style: feature => ({
                color: '#333333',
                weight: 1,
                fillOpacity: 0.5,
                fillColor: '#3388ff',
              }),
              onEachFeature: (feature, layer) => {
                const props = feature.properties || {};
                layer.bindPopup(
                  `<strong>Postnummer:</strong> ${props.postnummer || '–'}<br>` +
                  (props.navn ? `<strong>Navn:</strong> ${props.navn}` : '')
                );
              }
            }).addTo(map);

            if (litenGeoJSON.features.length > 0) {
              map.fitBounds(geojsonLayer.getBounds().pad(0.2));
            }
          })
          .catch(err => {
            console.error('Feil ved henting av GeoJSON:', err);
          });
      },
      error: err => {
        console.error('Kunne ikke lese CSV-filen:', err);
      }
    });
  </script>
</body>
</html>
