<script>
  let kanSokeNavn = false;
  const riktigPassord = "hemmelig123";

  const searchBtn = document.getElementById('searchBtn');
  const exportBtn = document.getElementById('exportBtn');
  const heatmapBtn = document.getElementById('toggleHeatmapBtn');
  const frekvCheckboxes = Array.from(document.querySelectorAll('.frekvCheckbox'));

  const map = L.map('map').setView([60,10],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Â© OpenStreetMap contributors', maxZoom:18
  }).addTo(map);

  proj4.defs('EPSG:3035', '+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs');
  function coords3035tilLatLng(c){
    const [x,y] = c;
    const [lon,lat] = proj4('EPSG:3035','WGS84',[x,y]);
    return L.latLng(lat,lon);
  }

  async function lesCSVRows(url){
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error(`${url}: HTTP ${res.status}`);
      const text = await res.text();
      return Papa.parse(text, {header:true, skipEmptyLines:true, delimiter: ','}).data;
    } catch(e) {
      console.warn('Kunne ikke lese', url, e);
      return [];
    }
  }

  async function lesAvisnavn(url) {
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error(`${url}: HTTP ${res.status}`);
      const text = await res.text();
      const data = Papa.parse(text, {header:true, skipEmptyLines:true}).data;
      const map = {};
      data.forEach(r => {
        if(r.ID && r.avis){
          map[r.ID.trim()] = r.avis.trim();
        }
      });
      return map;
    } catch(e) {
      console.warn('Kunne ikke lese avisnavn', e);
      return {};
    }
  }

  const harFrekvens = {
    Anbud: false,
    Brukt: false,
    Innenfor: true,
    Utenfor: true
  };

  function group(rows, label = '') {
    const m = {};
    rows.forEach((r,i) => {
      const keyMap = {};
      Object.entries(r).forEach(([k,v])=>{
        keyMap[k.trim().toLowerCase()] = v;
      });
      const pRaw = keyMap['postnummer'] ?? '';
      const p = pRaw.toString().trim().padStart(4,'0');
      if(!p) {
        console.warn(`[${label}] Rad ${i} har ugyldig postnummer`, r);
        return;
      }
      let num = 1;
      if('antall' in keyMap){
        const n = Number(keyMap['antall']);
        num = isNaN(n) ? 1 : n;
      } else if ('frekvens' in keyMap){
        const n = Number(keyMap['frekvens']);
        num = isNaN(n) ? 1 : n;
      }
      const avisRaw = keyMap['avis'] ?? '';
      const frekvensRaw = keyMap['frekvens'] ?? '';

      if(!m[p]) m[p] = {count:0, avis:new Map()};
      m[p].count += num;

      if(avisRaw){
        const avisLower = avisRaw.toString().toLowerCase();
        if(!m[p].avis.has(avisLower)){
          m[p].avis.set(avisLower, {count:0, frekvenser: new Set()});
        }
        const current = m[p].avis.get(avisLower);
        current.count += num;
        if(frekvensRaw) {
          current.frekvenser.add(frekvensRaw.toString());
        }
      }
    });
    return m;
  }

  let dC, dD, dInnenfor, dUtenfor;
  let fC, fD, fInnenfor, fUtenfor;
  let avisNavnMap;
  const layers = {};
  let searchLayer = null;
  let heatLayer = null;
  let showingHeatmap = false;
  let lastMatches = [];

  const filterColors = {
    Anbud: '#ff3333',
    Brukt: '#ffff00',
    Innenfor: '#663399',
    Utenfor: '#ff9900'
  };

  const filterKeys = {
    Anbud: 'anbudet',
    Brukt: 'abo_bruktidag_anbud',
    Innenfor: 'Innenfor anbud',
    Utenfor: 'Utenfor anbud'
  };

  function hentValgteFrekvenser(){
    return frekvCheckboxes.filter(cb=>cb.checked).map(cb=>cb.value);
  }

  function frekvensMatcher(frekvensSet, valgte){
    for(const v of valgte){
      if(frekvensSet.has(v)) return true;
    }
    return false;
  }

  function enrich(arr,mapData, valgteFrekvenser, harFrekv){
    arr.forEach(f=>{
      const p = f.properties.postnummer.trim().padStart(4,'0');
      const info = mapData[p] || {count:0, avis:new Map()};
      let totalCount = 0;
      const avisStrings = [];
      for(const [avisId, avisData] of info.avis.entries()){
        if(!harFrekv || frekvensMatcher(avisData.frekvenser, valgteFrekvenser)){
          totalCount += avisData.count;
          if(kanSokeNavn){
            avisStrings.push(`${avisNavnMap[avisId] || avisId}: ${avisData.count}`);
          } else {
            avisStrings.push(`${avisId}: ${avisData.count}`);
          }
        }
      }
      f.properties.antall = totalCount;
      f.properties.avis = avisStrings.join(', ');
    });
  }

  function enrichAll(valgteFrekvenser){
    enrich(fC,dC,valgteFrekvenser, harFrekvens.Anbud);
    enrich(fD,dD,valgteFrekvenser, harFrekvens.Brukt);
    enrich(fInnenfor,dInnenfor,valgteFrekvenser, harFrekvens.Innenfor);
    enrich(fUtenfor,dUtenfor,valgteFrekvenser, harFrekvens.Utenfor);
    Object.values(layers).forEach(layer => layer.eachLayer(l=>{
      const p = l.feature.properties;
      l.setPopupContent(`
        <strong>Postnummer: ${p.postnummer}</strong><br>
        Totalt antall: ${p.antall}<br>
        Detaljer pr avis: ${p.avis || 'Ingen'}
      `);
    }));
  }

  function oppdaterFilterTellinger(valgteFrekvenser){
    ['Anbud','Brukt','Innenfor','Utenfor'].forEach((k,i)=>{
      const mapData = [dC,dD,dInnenfor,dUtenfor][i];
      if(!mapData) return;
      const postnummerer = Object.keys(mapData).filter(p=>{
        const avisMap = mapData[p].avis;
        if(!harFrekvens[k]) return true; // teller alt uten frekvens
        for(const [avisId, avisData] of avisMap.entries()){
          if(frekvensMatcher(avisData.frekvenser, valgteFrekvenser)){
            return true;
          }
        }
        return false;
      });
      const antallSum = postnummerer.reduce((s,p) => {
        const avisMap = mapData[p].avis;
        let sum = 0;
        for(const [avisId, avisData] of avisMap.entries()){
          if(!harFrekvens[k] || frekvensMatcher(avisData.frekvenser, valgteFrekvenser)){
            sum += avisData.count;
          }
        }
        return s+sum;
      }, 0);
      document.getElementById('postCount'+k).innerHTML = `<span class="color-box" style="background:${filterColors[k]}"></span> ${postnummerer.length.toLocaleString()} postnumre`;
      document.getElementById('sumCount'+k).innerHTML = `<span class="color-box" style="background:${filterColors[k]}"></span> ${antallSum.toLocaleString()} antall`;
    });
  }

  Promise.all([
    lesCSVRows('anbud_postnummer.csv'),
    lesCSVRows('abo_bruktidag_anbud.csv'),
    lesCSVRows('innenforanbud.csv'),
    lesCSVRows('utenforanbud.csv'),
    lesAvisnavn('avisid.csv'),
    fetch('postnummer_part01.geojson').then(r=>r.json()),
    fetch('postnummer_part02.geojson').then(r=>r.json()),
    fetch('postnummer_part03.geojson').then(r=>r.json()),
    fetch('filtrert_anbud.geojson').then(r=>r.json())
  ]).then(([cRows,dRows,eRows,fRows, avisMap, g1,g2,g3,geoAnb])=>{
    dC = group(cRows, 'Anbud');
    dD = group(dRows, 'Brukt');
    dInnenfor = group(eRows, 'Innenfor');
    dUtenfor = group(fRows, 'Utenfor');
    avisNavnMap = avisMap;

    const nC = Object.keys(dC).map(p => p.padStart(4,'0'));
    const nD = Object.keys(dD).map(p => p.padStart(4,'0'));
    const nInnenfor = Object.keys(dInnenfor).map(p => p.padStart(4,'0'));
    const nUtenfor = Object.keys(dUtenfor).map(p => p.padStart(4,'0'));

    const base = [...g1.features,...g2.features,...g3.features];
    const geoBase = {type:'FeatureCollection',features:base};

    fC = geoAnb.features.filter(f=>nC.includes(f.properties.postnummer.trim().padStart(4,'0')));
    fD = geoAnb.features.filter(f=>nD.includes(f.properties.postnummer.trim().padStart(4,'0')));
    fInnenfor = geoAnb.features.filter(f=>nInnenfor.includes(f.properties.postnummer.trim().padStart(4,'0')));
    fUtenfor = geoBase.features.filter(f=>nUtenfor.includes(f.properties.postnummer.trim().padStart(4,'0')));

    enrichAll(hentValgteFrekvenser());
    oppdaterFilterTellinger(hentValgteFrekvenser());

    layers.Anbud    = L.geoJSON(fC,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:filterColors.Anbud,fillOpacity:0.5,weight:1})});
    layers.Brukt    = L.geoJSON(fD,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:filterColors.Brukt,fillOpacity:0.5,weight:1})});
    layers.Innenfor = L.geoJSON(fInnenfor,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:filterColors.Innenfor,fillOpacity:0.5,weight:1})});
    layers.Utenfor  = L.geoJSON(fUtenfor,{coordsToLatLng:coords3035tilLatLng,style:()=>({color:filterColors.Utenfor,fillOpacity:0.5,weight:1})});

    Object.values(layers).forEach(layer => layer.eachLayer(l=>{
      const p = l.feature.properties;
      l.bindPopup(`
        <strong>Postnummer: ${p.postnummer}</strong><br>
        Totalt antall: ${p.antall}<br>
        Detaljer pr avis: ${p.avis || 'Ingen'}
      `);
    }));

    function oppdaterLag(){
      Object.entries(layers).forEach(([k,lyr])=>{
        document.getElementById('toggle'+k).checked ? map.addLayer(lyr) : map.removeLayer(lyr);
      });
      const vis = Object.values(layers).flatMap(l=>map.hasLayer(l)?l.getLayers():[]);
      if(vis.length) map.fitBounds(L.featureGroup(vis).getBounds().pad(0.05));
    }
    ['Anbud','Brukt','Innenfor','Utenfor'].forEach(k=>
      document.getElementById('toggle'+k).addEventListener('change', oppdaterLag)
    );
    oppdaterLag();

    frekvCheckboxes.forEach(cb => cb.addEventListener('change', () => {
      const valgte = hentValgteFrekvenser();
      enrichAll(valgte);
      oppdaterFilterTellinger(valgte);
      oppdaterLag();
    }));

    searchBtn.addEventListener('click', searchMap);
    document.getElementById('searchInput').addEventListener('keyup', e=>e.key==='Enter' && searchMap());

    exportBtn.addEventListener('click', () => {
      if(!lastMatches.length) return;
      const csv = Papa.unparse(lastMatches);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'sokeresultater.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  });

  function getPolygonCentroid(feature){
    const geom = feature.geometry;
    if(geom.type === 'Polygon'){
      const coords = geom.coordinates[0];
      let latSum = 0, lngSum = 0;
      coords.forEach(([x,y])=>{
        const [lon, lat] = proj4('EPSG:3035','WGS84',[x,y]);
        latSum += lat;
        lngSum += lon;
      });
      const len = coords.length;
      return [latSum/len, lngSum/len];
    }
    return [0,0];
  }

  function searchMap(){
    const qRawInput = document.getElementById('searchInput').value.trim();
    const qRaw = qRawInput.toLowerCase();
    if(!qRaw) return;
    Object.values(layers).forEach(l=>map.removeLayer(l));
    if(searchLayer){
      map.removeLayer(searchLayer);
      searchLayer = null;
    }
    if(heatLayer){
      map.removeLayer(heatLayer);
      heatLayer = null;
      showingHeatmap = false;
      heatmapBtn.innerText = 'Vis heatmap';
      heatmapBtn.disabled = true;
    }

    const matchedPostnr = new Set();
    const erPostnummer = /^\d{4}$/.test(qRawInput);
    const qPostnummer = erPostnummer ? qRawInput.padStart(4,'0') : null;
    const avisSok = erPostnummer ? [] : qRaw.split(',').map(s => s.trim()).filter(Boolean);
    const valgteFrekvenser = hentValgteFrekvenser();

    function avisMatcher(avisMap) {
      if(erPostnummer) return false;
      if(!kanSokeNavn) {
        return avisSok.some(sokStr => {
          return Array.from(avisMap.keys()).some(avisId => avisId === sokStr);
        });
      }
      return avisSok.some(sokStr => {
        return Array.from(avisMap.keys()).some(avisId => {
          const navn = avisNavnMap[avisId] ? avisNavnMap[avisId].toLowerCase() : avisId.toLowerCase();
          return avisId === sokStr || navn.includes(sokStr);
        });
      });
    }

    Object.entries({ Anbud:dC, Brukt:dD, Innenfor:dInnenfor, Utenfor:dUtenfor }).forEach(([filterKey,mapData])=>{
      Object.entries(mapData).forEach(([pRaw,info])=>{
        const p = pRaw.padStart(4,'0');
        if(erPostnummer){
          if(p === qPostnummer){
            if(checkFrekvensOverlap(info, valgteFrekvenser, filterKey)){
              matchedPostnr.add(p);
            }
          } else if(Array.from(info.avis.keys()).some(a => a.includes(qRaw))){
            if(checkFrekvensOverlap(info, valgteFrekvenser, filterKey)){
              matchedPostnr.add(p);
            }
          }
        } else {
          if(avisMatcher(info.avis)){
            if(checkFrekvensOverlap(info, valgteFrekvenser, filterKey)){
              matchedPostnr.add(p);
            }
          }
        }
      });
    });

    function checkFrekvensOverlap(info, valgteFrekvenser, filterKey){
      if(!harFrekvens[filterKey]) return true;
      for(const avisData of info.avis.values()){
        if(frekvensMatcher(avisData.frekvenser, valgteFrekvenser)){
          return true;
        }
      }
      return false;
    }

    const allFeatures = [...fC,...fD,...fInnenfor,...fUtenfor];
    const matches = allFeatures.filter(f =>
      matchedPostnr.has(f.properties.postnummer.trim().padStart(4,'0'))
    );

    if(!matches.length){
      document.getElementById('search-summary').innerHTML = '';
      exportBtn.disabled = true;
      heatmapBtn.disabled = true;
      alert(`Ingen treff for "${qRawInput}"`);
      return;
    }

    let totalSum = 0;
    let html = '<table><thead><tr><th>Filter</th><th>Farge</th><th>Postnumre</th><th>Antall for sÃ¸k</th></tr></thead><tbody>';
    Object.entries({ Anbud:dC, Brukt:dD, Innenfor:dInnenfor, Utenfor:dUtenfor }).forEach(([filterKey,mapData])=>{
      const keys = Object.keys(mapData).filter(p=>matchedPostnr.has(p));
      let sumCount = 0;
      if(!harFrekvens[filterKey]){
        sumCount = keys.reduce((s,p) => s + (mapData[p]?.count || 0), 0);
      } else {
        keys.forEach(p=>{
          const avisMap = mapData[p]?.avis;
          if(avisMap){
            for(const [avisId, avisData] of avisMap.entries()){
              const navn = avisNavnMap[avisId] || avisId;
              if(avisSok.some(sokStr => avisId === sokStr || navn.toLowerCase().includes(sokStr))){
                if(frekvensMatcher(avisData.frekvenser, valgteFrekvenser)){
                  sumCount += avisData.count;
                }
              }
            }
          }
        });
      }
      totalSum += sumCount;
      const color = filterColors[filterKey] || '#000';
      html += `<tr>
        <td>${filterKeys[filterKey]}</td>
        <td><span class="color-box" style="background:${color};"></span></td>
        <td>${keys.length.toLocaleString()}</td>
        <td>${sumCount.toLocaleString()}</td>
      </tr>`;
    });
    html += `<tr style="font-weight:bold; background:#eef;">
      <td colspan="3">Totalt</td>
      <td>${totalSum.toLocaleString()}</td>
    </tr>`;
    html += '</tbody></table>';
    document.getElementById('search-summary').innerHTML = html;

    lastMatches = matches.map(f=>{
      const p = f.properties.postnummer.trim().padStart(4,'0');
      let filt = null;
      if(dC && Object.keys(dC).includes(p)) filt = 'Anbud';
      else if(dD && Object.keys(dD).includes(p)) filt = 'Brukt';
      else if(dInnenfor && Object.keys(dInnenfor).includes(p)) filt = 'Innenfor';
      else if(dUtenfor && Object.keys(dUtenfor).includes(p)) filt = 'Utenfor';
      return {
        filter: filterKeys[filt] || '',
        postnummer: p,
        antall: f.properties.antall,
        avis: f.properties.avis
      };
    });
    exportBtn.disabled = false;

    const heatPointsRaw = matches.map(f => {
      const [lat, lng] = getPolygonCentroid(f);
      return [lat, lng, f.properties.antall || 1];
    });
    const maxAntall = Math.max(...heatPointsRaw.map(p => p[2]));
    const heatPoints = heatPointsRaw.map(p => [p[0], p[1], p[2] / maxAntall]);

    heatmapBtn.disabled = false;
    showingHeatmap = false;
    heatmapBtn.innerText = 'Vis heatmap';

    heatmapBtn.onclick = () => {
      if(showingHeatmap){
        if(heatLayer){
          map.removeLayer(heatLayer);
          heatLayer = null;
        }
        if(searchLayer){
          map.addLayer(searchLayer);
        }
        heatmapBtn.innerText = 'Vis polygon';
        showingHeatmap = false;
      } else {
        if(searchLayer){
          map.removeLayer(searchLayer);
        }
        heatLayer = L.heatLayer(heatPoints, {
          radius: 25,
          blur: 15,
          maxZoom: 17,
          gradient: {
            0.0: 'rgba(255,0,0,0.6)',
            0.2: 'rgba(255,0,0,0.4)',
            0.4: 'rgba(255,0,0,0.3)',
            0.6: 'rgba(255,0,0,0.2)',
            1.0: 'rgba(255,0,0,0.05)'
          }
        }).addTo(map);
        heatmapBtn.innerText = 'Vis polygon';
        showingHeatmap = true;
      }
    };

    searchLayer = L.geoJSON(matches,{
      coordsToLatLng: coords3035tilLatLng,
      style: ()=>({color:'#555', fillOpacity:0.3, weight:2})
    }).addTo(map);

    searchLayer.eachLayer(l=>{
      const p = l.feature.properties;
      l.bindPopup(`
        <strong>Postnummer: ${p.postnummer}</strong><br>
        Totalt antall: ${p.antall}<br>
        Detaljer pr avis: ${p.avis || 'Ingen'}
      `);
      l.openPopup();
    });

    map.fitBounds(searchLayer.getBounds().pad(0.05));
  }
</script>
