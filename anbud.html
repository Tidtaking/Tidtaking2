<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Anbud – Postnummerkart</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { height:100%; margin:0; padding:0 }
    #map { width:100%; height:100vh }
    #controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:10px; border-radius:4px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      font-family:sans-serif; font-size:14px;
      line-height:1.4;
    }
    #controls label { display:flex; align-items:center; margin-bottom:6px }
    #controls .label-text { margin-left:6px }
    #controls span.count { margin-left:auto; font-weight:bold; color:#0077cc }
    #controls input[type=text] { flex:1; margin-right:6px; padding:4px }
    #controls button { padding:4px 8px }
  </style>
</head>
<body>
  <div id="controls">
    <label>
      <input type="checkbox" id="toggleAktuelle" checked />
      <span class="label-text">Abo utenfor anbud</span>
      <span id="countAktuelle" class="count">0</span>
      <span class="label-text">antall (blått)</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAbo" checked />
      <span class="label-text">abo_treff_anbud</span>
      <span id="countAbo" class="count">0</span>
      <span class="label-text">antall (grønt)</span>
    </label>
    <label>
      <input type="checkbox" id="toggleAnbud" checked />
      <span class="label-text">anbudet</span>
      <span id="countAnbud" class="count">0</span>
      <span class="label-text">antall (rødt)</span>
    </label>
    <label>
      <input type="checkbox" id="toggleBrukt" checked />
      <span class="label-text">abo_bruktidag_anbud</span>
      <span id="countBrukt" class="count">0</span>
      <span class="label-text">antall (gult)</span>
    </label>
    <div style="margin-top:8px; display:flex">
      <input type="text" id="searchInput" placeholder="Søk poststed eller nr" />
      <button id="searchBtn">Søk</button>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Init kart
    const map = L.map('map').setView([60,10],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap contributors', maxZoom:18 }).addTo(map);

    // EPSG:3035 → WGS84
    proj4.defs('EPSG:3035','+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs');
    function coords3035tilLatLng(c){ const [x,y]=c; const [lon,lat]=proj4('EPSG:3035','WGS84',[x,y]); return L.latLng(lat,lon); }

    // Les CSV og grupper på postnummer
    async function lesCSVRows(sti){
      try{
        const res=await fetch(sti); if(!res.ok) throw new Error(`${sti}: HTTP ${res.status}`);
        const text=await res.text(); const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
        return parsed.data;
      }catch(e){ console.warn('Kunne ikke lese',sti,e); return []; }
    }

    function group(rows){
      const map={};
      rows.forEach(r=>{
        const p=r.postnummer?.trim().padStart(4,'0'); if(!p) return;
        const num=Number(r.antall)||1;
        if(!map[p]) map[p]={count:0, avis:new Set()};
        map[p].count+=num;
        if(r.avis) map[p].avis.add(r.avis);
      });
      return map;
    }

    Promise.all([
      lesCSVRows('aktuelle_postnummer.csv'),
      lesCSVRows('abo_treff_anbud.csv'),
      lesCSVRows('anbud_postnummer.csv'),
      lesCSVRows('abo_bruktidag_anbud.csv'),
      fetch('postnummer_part01.geojson').then(r=>r.json()),
      fetch('postnummer_part02.geojson').then(r=>r.json()),
      fetch('postnummer_part03.geojson').then(r=>r.json()),
      fetch('filtrert_anbud.geojson').then(r=>r.json())
    ]).then(([rAkt,rAbo,rAnb,rBrukt,g1,g2,g3,gAnb])=>{
      // Grupper CSV-data
      const dAkt=group(rAkt), dAbo=group(rAbo), dAnb=group(rAnb), dBrukt=group(rBrukt);
      const normAkt=Object.keys(dAkt), normAbo=Object.keys(dAbo), normAnb=Object.keys(dAnb), normBrukt=Object.keys(dBrukt);

      // Kombiner geo
      const allBase=[...g1.features,...g2.features,...g3.features];
      const geoBase={type:'FeatureCollection',features:allBase};

      // Filtrer features
      const fAktuelle=Array.from(new Set([
        ...geoBase.features.filter(f=>normAkt.includes(f.properties.postnummer.trim())),
        ...gAnb.features.filter(f=>normAkt.includes(f.properties.postnummer.trim()))
      ]));
      const fAboArr = gAnb.features.filter(f=>normAbo.includes(f.properties.postnummer.trim()));
      const fAnbArr = gAnb.features.filter(f=>normAnb.includes(f.properties.postnummer.trim()));
      const fBruktArr=gAnb.features.filter(f=>normBrukt.includes(f.properties.postnummer.trim()));

      // Legg på egenskaper
      function enrich(features,data){
        features.forEach(f=>{
          const p=f.properties.postnummer.trim();
          const info=data[p]||{count:0,avis:new Set()};
          f.properties.antall=info.count;
          f.properties.avis=Array.from(info.avis).join(', ');
        });
      }
      enrich(fAktuelle,dAkt); enrich(fAboArr,dAbo); enrich(fAnbArr,dAnb); enrich(fBruktArr,dBrukt);

      // Oppdater tellere
      function updateCount(id,arr){
        const sum = arr.reduce((s,f) => s + f.properties.antall, 0);
        document.getElementById('count'+id).innerText = `${sum}`;
      }
      updateCount('Aktuelle',fAktuelle);
      updateCount('Abo',fAboArr);
      updateCount('Anbud',fAnbArr);
      updateCount('Brukt',fBruktArr);

      // Lag lag og popups
      const layers={
        Aktuelle:L.geoJSON({type:'FeatureCollection',features:fAktuelle},{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#3388ff',fillOpacity:0.5,weight:1})}),
        Abo     :L.geoJSON({type:'FeatureCollection',features:fAboArr},{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#33cc33',fillOpacity:0.5,weight:1})}),
        Anbud   :L.geoJSON({type:'FeatureCollection',features:fAnbArr},{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#ff3333',fillOpacity:0.5,weight:1})}),
        Brukt   :L.geoJSON({type:'FeatureCollection',features:fBruktArr},{coordsToLatLng:coords3035tilLatLng,style:()=>({color:'#ffff00',fillOpacity:0.5,weight:1})})
      };
      Object.values(layers).forEach(layer=>layer.eachLayer(l=>{
        const p=l.feature.properties;
        l.bindPopup(`<strong>${p.postnummer}</strong><br>Antall: ${p.antall}<br>Avis: ${p.avis}`);
      }));

      // Toggle & zoom
      function oppdater(){
        Object.entries(layers).forEach(([k,lyr])=>{
          document.getElementById('toggle'+k).checked?map.addLayer(lyr):map.removeLayer(lyr);
        });
        const vis=Object.values(layers).flatMap(l=>map.hasLayer(l)?l.getLayers():[]);
        if(vis.length) map.fitBounds(L.featureGroup(vis).getBounds().pad(0.05));
      }
      ['Aktuelle','Abo','Anbud','Brukt'].forEach(k=>document.getElementById('toggle'+k).addEventListener('change',oppdater));
      oppdater();

      // Søkefunksjon
      const allF=[...fAktuelle,...fAboArr,...fAnbArr,...fBruktArr];
      function searchMap(){ const q=document.getElementById('searchInput').value.trim().toLowerCase(); if(!q) return;
        const m=allF.filter(f=>f.properties.postnummer.toLowerCase()===q||(f.properties.poststed||'').toLowerCase().includes(q));
        if(!m.length) return alert(`Ingen treff for "${q}"`);
        const grp=L.geoJSON({type:'FeatureCollection',features:m},{coordsToLatLng:coords3035tilLatLng});
        map.fitBounds(grp.getBounds().pad(0.05));grp.eachLayer(l=>l.openPopup());
      }
      document.getElementById('searchBtn').addEventListener('click',searchMap);
      document.getElementById('searchInput').addEventListener('keyup',e=>e.key==='Enter'&&searchMap());
    });
  </script>
</body>
</html>
