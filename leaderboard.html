<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Leaderboard</title>
  <!-- Prod-klar Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/gh/tailwindlabs/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet" />
  <style>[x-cloak]{display:none}</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <header class="w-full max-w-3xl mb-6 text-center">
    <h1 class="text-3xl font-bold">Live Leaderboard</h1>
    <p class="text-sm text-gray-600">Oppdatert i sanntid fra Supabase</p>
  </header>

  <main class="w-full max-w-3xl space-y-6">
    <!-- Leaderboard -->
    <section class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold mb-2">Topp 10 Samlet</h2>
      <table id="leaderboardTable" class="w-full text-center text-sm">
        <thead class="bg-green-600 text-white">
          <tr>
            <th class="px-4 py-2">Plass</th>
            <th class="px-4 py-2">Navn</th>
            <th class="px-4 py-2">Netto</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody"><tr><td colspan="3" class="py-4">Laster...</td></tr></tbody>
      </table>
      <p class="text-xs text-gray-500 mt-2">Klikk på et navn for spillerstatistikk</p>
    </section>

    <!-- Stats per bane -->
    <section class="bg-white rounded-lg shadow p-4">
      <h2 class="text-xl font-semibold mb-2">Stats per bane</h2>
      <div id="coursesStats" class="space-y-2">
        <p>Laster...</p>
      </div>
    </section>

    <!-- Holer visning -->
    <section id="holesSection" class="bg-white rounded-lg shadow p-4 hidden">
      <h2 id="holesTitle" class="text-xl font-semibold mb-2">Hulldetaljer</h2>
      <table id="holesTable" class="w-full text-center text-sm">
        <thead>
          <tr id="holesHeader"><!-- Dynamisk --></tr>
        </thead>
        <tbody id="holesBody"></tbody>
      </table>
      <button id="closeHoles" class="mt-4 btn-secondary">Lukk</button>
    </section>

    <!-- Spiller statistikk -->
    <section id="playerSection" class="bg-white rounded-lg shadow p-4 hidden">
      <h2 id="playerTitle" class="text-xl font-semibold mb-2">Spillerstatistikk</h2>
      <div id="playerStats" class="space-y-4"></div>
      <button id="closePlayer" class="mt-4 btn-secondary">Lukk</button>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    // Supabase-klient
    const supabase = window.supabase.createClient(
      "https://chzfewhbfkdtcizdxyzk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNoemZld2hiZmtkdGNpemR4eXprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2NDE1ODgsImV4cCI6MjA1ODIxNzU4OH0.RKgK8b1PHl9ZbFj57u_rD34e53Zlk3sGPHUru9KmuqA"
    );

    // Globale datastrukturer
    let courseMap = {};
    let playerMap = {};

    // Hent data og beregn statistikk
    async function loadData() {
      const { data, error } = await supabase
        .from('rounds')
        .select('payload')
        .order('inserted_at', { ascending: false })
        .limit(100);
      if (error) return;

      const leaderboardScores = {};
      courseMap = {};
      playerMap = {};

      data.forEach(r => {
        const { course, players } = r.payload;
        const courseName = course.name;
        if (!courseMap[courseName]) {
          courseMap[courseName] = {
            holes: course.holes,
            playerStats: {},
            count: 0,
            totalNet: 0
          };
        }
        players.forEach(p => {
          const gross = p.strokes.reduce((sum, v) => sum + (Number(v) || 0), 0);
          const net = gross - p.index;
          // Leaderboard
          if (!leaderboardScores[p.name] || net < leaderboardScores[p.name]) {
            leaderboardScores[p.name] = net;
          }
          // Course stats
          const cs = courseMap[courseName];
          cs.count++;
          cs.totalNet += net;
          if (!cs.playerStats[p.name]) {
            cs.playerStats[p.name] = { holeTotals: Array(18).fill(0), holeCounts: Array(18).fill(0) };
          }
          p.strokes.forEach((s, i) => {
            if (s != null) {
              cs.playerStats[p.name].holeTotals[i] += s;
              cs.playerStats[p.name].holeCounts[i]++;
            }
          });
          // Player stats
          if (!playerMap[p.name]) {
            playerMap[p.name] = { rounds: 0, totalNet: 0, courseCounts: {}, holeTotals: Array(18).fill(0), holeCounts: Array(18).fill(0) };
          }
          const pm = playerMap[p.name];
          pm.rounds++;
          pm.totalNet += net;
          pm.courseCounts[courseName] = (pm.courseCounts[courseName] || 0) + 1;
          p.strokes.forEach((s, i) => {
            if (s != null) {
              pm.holeTotals[i] += s;
              pm.holeCounts[i]++;
            }
          });
        });
      });

      renderLeaderboard(leaderboardScores);
      renderCourseStats();
    }

    // Vis leaderboard
    function renderLeaderboard(scores) {
      const sorted = Object.entries(scores).sort((a, b) => a[1] - b[1]).slice(0, 10);
      const rows = sorted.map(([name, net], idx) => `
        <tr class="border-t hover:bg-gray-50 cursor-pointer" data-player="${name}">
          <td class="px-4 py-2">${idx + 1}</td>
          <td class="px-4 py-2 text-left">${name}</td>
          <td class="px-4 py-2">${net}</td>
        </tr>`
      ).join('');
      const tbody = document.getElementById('leaderboardBody');
      tbody.innerHTML = rows;
      tbody.querySelectorAll('[data-player]').forEach(tr => {
        tr.onclick = () => showPlayer(tr.dataset.player);
      });
    }

    // Vis stats per bane
    function renderCourseStats() {
      const container = document.getElementById('coursesStats');
      container.innerHTML = '';
      Object.entries(courseMap).forEach(([name, cs]) => {
        const avgNet = (cs.totalNet / cs.count).toFixed(1);
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center';
        div.innerHTML = `
          <span>${name} — ${cs.count} runder, gj.snitt netto ${avgNet}</span>
          <button class="btn-primary btn-sm" data-course="${name}">Vis hull</button>
        `;
        container.appendChild(div);
      });
      document.querySelectorAll('[data-course]').forEach(btn => {
        btn.onclick = () => showHoles(btn.dataset.course);
      });
    }

    // Vis hulldetaljer for en bane (alle spillere)
    function showHoles(courseName) {
      const cs = courseMap[courseName];
      document.getElementById('holesTitle').textContent = `Hulldetaljer — ${courseName}`;
      // Header
      const headerRow = document.getElementById('holesHeader');
      const players = Object.keys(cs.playerStats);
      headerRow.innerHTML = `<th class="px-2 py-1">Hull</th><th class="px-2 py-1">Par</th>` +
        players.map(p => `<th class="px-2 py-1">${p}</th>`).join('');
      // Body
      const tbody = document.getElementById('holesBody');
      tbody.innerHTML = '';
      cs.holes.forEach((h, i) => {
        let row = `<tr><td class="border px-2 py-1">${h.hole}</td><td class="border px-2 py-1">${h.par}</td>`;
        players.forEach(p => {
          const ps = cs.playerStats[p];
          const avg = ps.holeCounts[i] ? (ps.holeTotals[i] / ps.holeCounts[i]).toFixed(1) : '-';
          row += `<td class="border px-2 py-1">${avg}</td>`;
        });
        row += '</tr>';
        tbody.innerHTML += row;
      });
      document.getElementById('holesSection').classList.remove('hidden');
    }

    // Vis spillerstatistikk
    function showPlayer(name) {
      const pm = playerMap[name];
      document.getElementById('playerTitle').textContent = `Spiller — ${name}`;
      const container = document.getElementById('playerStats');
      container.innerHTML = '';
      // Oversikt
      const avgNet = (pm.totalNet / pm.rounds).toFixed(1);
      container.innerHTML += `<p>Runder: ${pm.rounds}, gj.snitt netto: ${avgNet}</p>`;
      // Stats per bane
      const courseList = Object.entries(pm.courseCounts)
        .map(([c, n]) => `${c}: ${n} runder`).join(', ');
      container.innerHTML += `<p>Banefordeling: ${courseList}</p>`;
      // Hullstatistikk
      let table = `<table class="w-full text-center text-sm"><thead><tr><th>Hull</th><th>Gj.snitt slag</th></tr></thead><tbody>`;
      pm.holeTotals.forEach((tot, i) => {
        const cnt = pm.holeCounts[i];
        const avg = cnt ? (tot / cnt).toFixed(1) : '-';
        table += `<tr><td class="border px-2 py-1">${i+1}</td><td class="border px-2 py-1">${avg}</td></tr>`;
      });
      table += '</tbody></table>';
      container.innerHTML += table;
      document.getElementById('playerSection').classList.remove('hidden');
    }

    // Lukk knapper
    document.getElementById('closeHoles').onclick = () => document.getElementById('holesSection').classList.add('hidden');
    document.getElementById('closePlayer').onclick = () => document.getElementById('playerSection').classList.add('hidden');

    // Initial load & intervall
    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
